<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>枢纽：天下之道</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
@font-face{font-family:'GF';src:local('STKaiti'),local('KaiTi'),local('楷体'),local('serif');}
:root{
  --ink:#1a1a2e;--paper:#f0ebe3;--gold:#c9a96e;--bright-gold:#dbb978;
  --zhongyuan:#b8860b;--caoyuan:#4a7c59;--xiyu:#a0522d;
  --gaoyuan:#4a6fa5;--xinan:#6b8e6b;--haiyang:#2980b9;--guodu:#8b7355;
  --red:#8b2500;--shadow:rgba(0,0,0,0.4);
}
body{font-family:'GF','STKaiti','KaiTi',serif;background:#0d0d1a;color:#ddd;overflow:hidden;height:100vh;user-select:none;}

/* ========== 开始画面 ========== */
#start-screen{
  position:fixed;inset:0;z-index:1000;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  background:linear-gradient(180deg,#0a0a15 0%,#1a1a30 40%,#0d1520 100%);
}
#start-screen::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at 30% 40%,rgba(201,169,110,0.08) 0%,transparent 50%),
             radial-gradient(circle at 70% 60%,rgba(41,128,185,0.06) 0%,transparent 50%);
}
.title-area{position:relative;text-align:center;margin-bottom:40px;}
.title-area h1{font-size:3.2em;color:var(--gold);letter-spacing:12px;text-shadow:0 0 30px rgba(201,169,110,0.3);}
.title-area .subtitle{color:#8a7a5a;font-size:1.1em;letter-spacing:6px;margin-top:8px;}
.title-area .author{color:#5a5040;font-size:0.85em;margin-top:16px;letter-spacing:3px;}
.poem{color:#6a6050;font-size:0.95em;line-height:2.2;text-align:center;margin-bottom:40px;position:relative;}
.start-btn{
  padding:16px 60px;font-size:1.2em;font-family:inherit;cursor:pointer;
  background:linear-gradient(135deg,rgba(201,169,110,0.2),rgba(201,169,110,0.1));
  color:var(--gold);border:1px solid var(--gold);border-radius:4px;
  letter-spacing:6px;transition:all 0.3s;position:relative;
}
.start-btn:hover{background:linear-gradient(135deg,rgba(201,169,110,0.3),rgba(201,169,110,0.15));box-shadow:0 0 30px rgba(201,169,110,0.2);}

/* ========== 主游戏布局 ========== */
#game{display:none;height:100vh;width:100vw;grid-template-columns:200px 1fr 220px;grid-template-rows:50px 1fr 48px;}
#game.active{display:grid;}

/* 顶部栏 */
#top-bar{
  grid-column:1/-1;background:linear-gradient(90deg,#0d0d1a,#1a1a30,#0d0d1a);
  display:flex;align-items:center;justify-content:space-between;padding:0 20px;
  border-bottom:1px solid rgba(201,169,110,0.3);font-size:0.9em;
}
.era-badge{color:var(--gold);font-size:1.05em;letter-spacing:3px;}
.turn-info{color:#8a7a5a;}
.resources{display:flex;gap:16px;}
.res-item{display:flex;align-items:center;gap:4px;color:#aaa;font-size:0.85em;}
.res-item span{color:var(--gold);}

/* 左侧面板 */
#left-panel{
  background:linear-gradient(180deg,#12121f,#0d0d1a);border-right:1px solid rgba(201,169,110,0.2);
  overflow-y:auto;padding:8px;
}
.panel-title{color:var(--gold);font-size:0.85em;text-align:center;padding:6px 0;border-bottom:1px solid rgba(201,169,110,0.15);margin-bottom:6px;letter-spacing:2px;}
.region-card{
  padding:8px 10px;margin-bottom:4px;border-radius:4px;cursor:pointer;
  border:1px solid transparent;transition:all 0.2s;background:rgba(255,255,255,0.03);
}
.region-card:hover{border-color:rgba(201,169,110,0.3);background:rgba(201,169,110,0.05);}
.region-card.selected{border-color:var(--gold);background:rgba(201,169,110,0.08);}
.region-name{font-size:0.9em;margin-bottom:4px;display:flex;align-items:center;gap:6px;}
.region-dot{width:8px;height:8px;border-radius:50%;display:inline-block;}
.stat-bars{display:flex;flex-direction:column;gap:2px;}
.stat-row{display:flex;align-items:center;gap:4px;font-size:0.7em;color:#888;}
.stat-label{width:24px;text-align:right;}
.stat-bar{flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;}
.stat-fill{height:100%;border-radius:3px;transition:width 0.5s;}

/* 中间主区域 */
#main-area{background:#0f0f1f;position:relative;overflow:hidden;}

/* SVG 地图 */
#map-svg{width:100%;height:100%;}
.region-node{cursor:pointer;transition:all 0.3s;}
.region-node:hover .node-circle{filter:brightness(1.3);}
.node-circle{transition:all 0.3s;}
.node-label{fill:#ccc;font-family:'GF',serif;font-size:14px;text-anchor:middle;pointer-events:none;}
.node-value{fill:#999;font-family:'GF',serif;font-size:11px;text-anchor:middle;pointer-events:none;}
.connection-line{stroke:rgba(201,169,110,0.15);stroke-width:1.5;stroke-dasharray:4,4;animation:dashFlow 4s linear infinite;}
@keyframes dashFlow{to{stroke-dashoffset:-16;}}

/* 事件卡片 */
#event-overlay{
  position:absolute;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:10;
}
#event-overlay.active{display:flex;}
#event-card{
  background:linear-gradient(135deg,#1a1a2e,#151525);border:1px solid rgba(201,169,110,0.3);
  border-radius:8px;padding:28px 32px;max-width:520px;width:90%;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.event-era-tag{font-size:0.75em;color:var(--gold);letter-spacing:2px;opacity:0.7;margin-bottom:4px;}
.event-title{font-size:1.4em;color:var(--bright-gold);margin-bottom:12px;letter-spacing:2px;}
.event-desc{font-size:0.95em;color:#bbb;line-height:1.8;margin-bottom:12px;}
.event-quote{font-size:0.85em;color:#7a7a6a;font-style:italic;margin-bottom:20px;padding-left:12px;border-left:2px solid rgba(201,169,110,0.3);}
.choice-btn{
  display:block;width:100%;padding:12px 16px;margin-bottom:8px;font-family:inherit;
  font-size:0.9em;cursor:pointer;background:rgba(201,169,110,0.06);
  color:#ccc;border:1px solid rgba(201,169,110,0.2);border-radius:4px;
  text-align:left;transition:all 0.2s;line-height:1.5;
}
.choice-btn:hover{background:rgba(201,169,110,0.12);border-color:var(--gold);color:var(--gold);transform:translateX(4px);}
.choice-btn.risk-high:hover::before{box-shadow:4px 0 12px rgba(139,37,0,0.4);}
.choice-btn .choice-num{color:var(--gold);margin-right:8px;}

/* 结果弹窗 */
#result-overlay{
  position:absolute;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);z-index:11;
}
#result-overlay.active{display:flex;}
#result-card{
  background:linear-gradient(135deg,#1a1a2e,#151525);border:1px solid rgba(201,169,110,0.3);
  border-radius:8px;padding:24px 28px;max-width:440px;width:85%;text-align:center;
}
.result-text{font-size:1em;color:#bbb;line-height:1.8;margin-bottom:16px;}
.effect-tags{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:16px;}
.effect-tag{font-size:0.8em;padding:3px 10px;border-radius:12px;border:1px solid;}
.effect-tag.positive{color:#6bba6b;border-color:rgba(107,186,107,0.3);background:rgba(107,186,107,0.08);}
.effect-tag.negative{color:#c56b6b;border-color:rgba(197,107,107,0.3);background:rgba(197,107,107,0.08);}
.continue-btn{
  padding:10px 40px;font-family:inherit;font-size:1em;cursor:pointer;
  background:rgba(201,169,110,0.1);color:var(--gold);border:1px solid var(--gold);
  border-radius:4px;letter-spacing:3px;transition:all 0.2s;
}
.continue-btn:hover{background:rgba(201,169,110,0.2);}

/* 右侧信息面板 */
#right-panel{
  background:linear-gradient(180deg,#12121f,#0d0d1a);border-left:1px solid rgba(201,169,110,0.2);
  overflow-y:auto;padding:8px;
}
.history-log{font-size:0.78em;color:#777;line-height:1.6;}
.log-entry{padding:4px 6px;border-bottom:1px solid rgba(255,255,255,0.05);margin-bottom:2px;}
.log-entry .log-turn{color:var(--gold);margin-right:4px;}

/* 底部栏 */
#bottom-bar{
  grid-column:1/-1;background:linear-gradient(90deg,#0d0d1a,#1a1a30,#0d0d1a);
  display:flex;align-items:center;justify-content:center;gap:20px;
  border-top:1px solid rgba(201,169,110,0.2);
}
.bottom-btn{
  padding:6px 20px;font-family:inherit;font-size:0.85em;cursor:pointer;
  background:transparent;color:#888;border:1px solid rgba(255,255,255,0.1);
  border-radius:3px;transition:all 0.2s;letter-spacing:2px;
}
.bottom-btn:hover{color:var(--gold);border-color:rgba(201,169,110,0.3);}

/* ========== 按钮触感 ========== */
.choice-btn:active{transform:scale(0.97) translateY(1px);filter:brightness(0.85);transition:transform 0.05s;}
.start-btn:active{transform:scale(0.95);}
.continue-btn:active{transform:scale(0.96);}
.bottom-btn:active{transform:scale(0.95);}

/* ========== 节点呼吸动画 ========== */
@keyframes nodeBreathe{0%,100%{opacity:0.7;}50%{opacity:0.85;}}

/* ========== 转型事件差异化 ========== */
#event-card.transformation{border:2px solid var(--gold);box-shadow:0 0 40px rgba(201,169,110,0.2);}

/* ========== 效果标签弹性入场 ========== */
@keyframes tagBounceUp{0%{opacity:0;transform:translateY(16px);}60%{opacity:1;transform:translateY(-4px);}100%{opacity:1;transform:translateY(0);}}
@keyframes tagShakeIn{0%{opacity:0;transform:translateX(-8px);}20%{opacity:1;transform:translateX(6px);}40%{transform:translateX(-4px);}60%{transform:translateX(3px);}80%{transform:translateX(-1px);}100%{opacity:1;transform:translateX(0);}}
.effect-tag.revealed.positive{animation:tagBounceUp 0.5s ease-out forwards;}
.effect-tag.revealed.negative{animation:tagShakeIn 0.5s ease-out forwards;}

/* ========== 顶部资源数字动画 ========== */
.res-item span, .ms-val{transition:transform 0.3s, color 0.3s;}
.res-item span.res-changed-up{animation:resNumPop 0.6s;}
.res-item span.res-changed-down{animation:resNumDrop 0.6s;}
@keyframes resNumPop{0%{color:var(--gold);}30%{color:#6bba6b;transform:scale(1.3);}100%{color:var(--gold);transform:scale(1);}}
@keyframes resNumDrop{0%{color:var(--gold);}30%{color:#c56b6b;transform:scale(1.3);}100%{color:var(--gold);transform:scale(1);}}

/* ========== 开场动画相关 ========== */
@keyframes titleGlow{0%,100%{text-shadow:0 0 30px rgba(201,169,110,0.3);}50%{text-shadow:0 0 50px rgba(201,169,110,0.6),0 0 80px rgba(201,169,110,0.2);}}
.title-area h1{animation:titleGlow 3s ease-in-out infinite;}

.poem-line{opacity:0;transform:translateY(12px);transition:opacity 0.8s ease,transform 0.8s ease;}
.poem-line.visible{opacity:1;transform:translateY(0);}
.poem-line.gold-line{color:var(--gold);font-size:1.15em;font-weight:bold;text-shadow:0 0 20px rgba(201,169,110,0.3);}

@keyframes btnPulse{0%,100%{box-shadow:0 0 10px rgba(201,169,110,0.1);}50%{box-shadow:0 0 30px rgba(201,169,110,0.35),0 0 60px rgba(201,169,110,0.1);}}
.start-btn.pulse-glow{animation:btnPulse 2.5s ease-in-out infinite;}

/* ========== 开场粒子效果 ========== */
.start-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.start-particle{position:absolute;width:2px;height:2px;background:rgba(201,169,110,0.4);border-radius:50%;animation:particleDrift linear infinite;}
@keyframes particleDrift{0%{transform:translate(0,0);opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{transform:translate(var(--dx),var(--dy));opacity:0;}}

/* ========== 标题入场动画 ========== */
@keyframes titleLetterCollapse{0%{letter-spacing:40px;opacity:0;}100%{letter-spacing:12px;opacity:1;}}
@keyframes subtitleFadeUp{0%{opacity:0;transform:translateY(16px);}100%{opacity:1;transform:translateY(0);}}
.title-area h1.animate-in{animation:titleLetterCollapse 1.5s ease-out forwards;}
.title-area .subtitle.animate-in{animation:subtitleFadeUp 0.8s ease-out forwards;}

/* 时代过渡动画 */
#era-transition{
  position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;
  background:#000;
}
#era-transition.active{display:flex;}
/* era-trans styles moved to enhanced section below */

/* 结局画面 */
#ending-screen{
  position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;
  flex-direction:column;background:linear-gradient(180deg,#0a0a15,#1a1a30,#0d1520);
}
#ending-screen.active{display:flex;}
#ending-screen h1{font-size:2.8em;color:var(--gold);letter-spacing:8px;margin-bottom:16px;}
#ending-screen .ending-desc{color:#aaa;font-size:1.05em;line-height:2;text-align:center;max-width:500px;margin-bottom:32px;}
#ending-screen .score{color:var(--gold);font-size:1.2em;margin-bottom:24px;}

/* 过渡动画 */
.fade-in{animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

/* 滚动条 */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(201,169,110,0.2);border-radius:2px;}

/* ========== 天命值 ========== */
.mandate-score{display:flex;align-items:center;gap:6px;color:var(--gold);font-size:0.95em;letter-spacing:2px;}
.mandate-score .ms-label{color:#8a7a5a;font-size:0.85em;}
.mandate-score .ms-val{font-size:1.15em;min-width:32px;text-align:center;transition:color 0.3s;}
.mandate-score.pulse-up .ms-val{animation:pulseGreen 0.6s;}
.mandate-score.pulse-down .ms-val{animation:pulseRed 0.6s;}
@keyframes pulseGreen{0%,100%{color:var(--gold);text-shadow:none;}50%{color:#6bba6b;text-shadow:0 0 12px rgba(107,186,107,0.6);}}
@keyframes pulseRed{0%,100%{color:var(--gold);text-shadow:none;}50%{color:#c56b6b;text-shadow:0 0 12px rgba(197,107,107,0.6);}}

/* ========== 效果逐帧揭示 ========== */
.effect-tag{opacity:0;transform:translateY(8px);transition:opacity 0.35s,transform 0.35s;}
.effect-tag.revealed{opacity:1;transform:translateY(0);}
.continue-btn.hidden{opacity:0;pointer-events:none;}

/* ========== 连锁反应飘字 ========== */
#chain-notifications{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:12;display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none;}
.chain-notif{font-size:0.82em;color:var(--bright-gold);background:rgba(0,0,0,0.75);padding:4px 14px;border-radius:12px;border:1px solid rgba(201,169,110,0.3);opacity:0;animation:chainFloat 2.5s forwards;white-space:nowrap;}
@keyframes chainFloat{0%{opacity:0;transform:translateY(10px);}15%{opacity:1;transform:translateY(0);}75%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-12px);}}
.connection-line.chain-active{stroke:var(--bright-gold)!important;stroke-width:3!important;stroke-dasharray:none!important;opacity:1;animation:lineFlash 1.2s;}
@keyframes lineFlash{0%,100%{opacity:0.3;}50%{opacity:1;}}

/* ========== 选项风险色带 ========== */
.choice-btn{position:relative;padding-left:24px;overflow:hidden;}
.choice-btn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;}
.choice-btn.risk-low::before{background:#4a7c59;}
.choice-btn.risk-medium::before{background:#b8860b;}
.choice-btn.risk-high::before{background:#8b2500;}

/* ========== 屏幕特效 ========== */
@keyframes screenShake{0%,100%{transform:translate(0);}10%{transform:translate(-4px,2px);}20%{transform:translate(3px,-3px);}30%{transform:translate(-3px,4px);}40%{transform:translate(4px,-2px);}50%{transform:translate(-2px,3px);}60%{transform:translate(3px,-1px);}70%{transform:translate(-3px,2px);}80%{transform:translate(2px,-3px);}90%{transform:translate(-1px,1px);}}
#main-area.shake{animation:screenShake 0.5s;}
#main-area.flash-gold::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(201,169,110,0.25) 0%,transparent 70%);pointer-events:none;animation:flashFade 0.8s forwards;}
#main-area.flash-red::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(180,40,40,0.2) 0%,transparent 70%);pointer-events:none;animation:flashFade 0.8s forwards;}
@keyframes flashFade{0%{opacity:1;}100%{opacity:0;}}

/* ========== 势力排行榜 ========== */
#power-ranking{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;}
.rank-item{display:flex;align-items:center;gap:3px;font-size:0.78em;color:#999;white-space:nowrap;}
.rank-item .rank-dot{width:6px;height:6px;border-radius:50%;display:inline-block;}
.rank-item .rank-val{color:var(--gold);font-size:0.85em;min-width:16px;text-align:right;}
.rank-item.rank-1{color:var(--bright-gold);font-size:0.88em;}
.rank-item.rank-1 .rank-val{font-weight:bold;}
#hegemony-notif{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:150;background:linear-gradient(135deg,rgba(30,25,15,0.95),rgba(20,18,12,0.95));border:2px solid var(--gold);border-radius:8px;padding:12px 28px;color:var(--bright-gold);font-size:1.1em;letter-spacing:3px;box-shadow:0 0 30px rgba(201,169,110,0.3);opacity:0;pointer-events:none;animation:hegemonyPop 3.5s forwards;}
@keyframes hegemonyPop{0%{opacity:0;transform:translateX(-50%) scale(0.8);}10%{opacity:1;transform:translateX(-50%) scale(1.05);}20%{transform:translateX(-50%) scale(1);}80%{opacity:1;}100%{opacity:0;}}

/* ========== 时代过渡升级 ========== */
.era-trans-content{text-align:center;max-width:520px;}
.era-trans-summary{color:#8a7a5a;font-size:0.9em;line-height:1.8;margin-bottom:20px;opacity:0;}
.era-trans-content h2{font-size:2.5em;color:var(--gold);letter-spacing:20px;margin-bottom:12px;opacity:0;}
.era-trans-line{width:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:12px auto;transition:width 0.8s;}
.era-trans-content p{font-size:1.1em;color:#8a7a5a;letter-spacing:3px;opacity:0;}
.era-trans-preview{color:#6a5a3a;font-size:0.85em;margin-top:16px;opacity:0;letter-spacing:2px;}

/* ========== 属性浮动数字 ========== */
.stat-row{position:relative;}
.stat-delta{position:absolute;right:-28px;top:-2px;font-size:0.75em;font-weight:bold;opacity:0;animation:floatDelta 1.2s forwards;pointer-events:none;}
.stat-delta.pos{color:#6bba6b;}
.stat-delta.neg{color:#c56b6b;}
@keyframes floatDelta{0%{opacity:0;transform:translateY(4px);}20%{opacity:1;transform:translateY(0);}80%{opacity:1;transform:translateY(-8px);}100%{opacity:0;transform:translateY(-14px);}}

/* ========== 事件卡分阶段入场 ========== */
.event-era-tag,.event-title,.event-desc,.event-quote,#ev-choices .choice-btn{opacity:0;transform:translateY(10px);transition:opacity 0.4s,transform 0.4s;}
.event-era-tag.visible,.event-title.visible,.event-desc.visible,.event-quote.visible,#ev-choices .choice-btn.visible{opacity:1;transform:translateY(0);}

/* ========== 成就系统 ========== */
#achievement-container{position:fixed;top:60px;right:16px;z-index:160;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.achievement-notif{background:linear-gradient(135deg,rgba(30,25,10,0.95),rgba(20,15,5,0.95));border:1px solid var(--gold);border-radius:6px;padding:10px 18px;color:var(--bright-gold);font-size:0.9em;letter-spacing:2px;box-shadow:0 0 20px rgba(201,169,110,0.25);opacity:0;transform:translateX(40px);animation:achieveSlide 3.5s forwards;}
.achievement-notif .ach-icon{font-size:1.2em;margin-right:6px;}
@keyframes achieveSlide{0%{opacity:0;transform:translateX(40px);}10%{opacity:1;transform:translateX(0);}80%{opacity:1;transform:translateX(0);}100%{opacity:0;transform:translateX(20px);}}

/* ========== 地图节点脉冲 ========== */
.node-circle.pulse{animation:nodePulse 0.6s;}
@keyframes nodePulse{0%,100%{filter:brightness(1);}50%{filter:brightness(1.6);}}

/* ================================================================
   移动端适配 (max-width: 768px)
   ================================================================ */
@media (max-width: 768px) {
  /* --- 基础重置 --- */
  html { font-size: 16px; }
  body { overflow: hidden; height: 100vh; height: 100dvh; -webkit-tap-highlight-color: transparent; }

  /* --- 开始画面 --- */
  #start-screen { padding: 20px; }
  .title-area { margin-bottom: 24px; }
  .title-area h1 { font-size: 2.2em; letter-spacing: 8px; }
  .title-area .subtitle { font-size: 0.95em; letter-spacing: 4px; }
  .title-area .author { font-size: 0.75em; margin-top: 10px; }
  .poem { font-size: 0.85em; line-height: 2; margin-bottom: 28px; padding: 0 12px; }
  .start-btn {
    padding: 14px 44px; font-size: 1.1em; letter-spacing: 4px;
    min-height: 48px; min-width: 180px;
  }

  /* --- 主游戏布局：移动端单列 --- */
  #game {
    grid-template-columns: 1fr !important;
    grid-template-rows: 44px 1fr 44px !important;
  }
  #game.active { display: grid; }

  /* --- 左侧面板：底部抽屉 --- */
  #left-panel {
    position: fixed; left: 0; right: 0; bottom: 44px;
    height: 55vh; z-index: 50;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    border-right: none; border-top: 1px solid rgba(201,169,110,0.3);
    border-radius: 16px 16px 0 0;
    background: linear-gradient(180deg, #16162a, #0d0d1a);
    padding: 8px 12px 60px 12px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  #left-panel.mobile-open {
    transform: translateY(0);
  }
  /* 抽屉拖拽把手 */
  #left-panel::before {
    content: '';
    display: block;
    width: 40px; height: 4px;
    background: rgba(201,169,110,0.4);
    border-radius: 2px;
    margin: 4px auto 8px auto;
  }
  .panel-title { font-size: 0.9em; padding: 4px 0; }
  .region-card { padding: 10px 12px; margin-bottom: 6px; min-height: 44px; }
  .region-name { font-size: 0.95em; }

  /* --- 右侧面板：浮层 --- */
  #right-panel {
    position: fixed; right: 0; top: 44px; bottom: 44px;
    width: 75vw; max-width: 300px; z-index: 50;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 1px solid rgba(201,169,110,0.3);
    background: linear-gradient(180deg, #16162a, #0d0d1a);
    padding: 8px 12px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  #right-panel.mobile-open {
    transform: translateX(0);
  }

  /* --- 遮罩层 --- */
  #mobile-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 45;
    background: rgba(0,0,0,0.5);
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
  }
  #mobile-overlay.active { display: block; }

  /* --- 顶栏 --- */
  #top-bar {
    grid-column: 1;
    padding: 0 10px;
    font-size: 0.78em;
    height: 44px;
    gap: 6px;
    flex-wrap: nowrap;
    overflow: hidden;
  }
  .era-badge { font-size: 0.9em; letter-spacing: 1px; white-space: nowrap; flex-shrink: 0; }
  .turn-info { display: none; }
  .mandate-score { flex-shrink: 0; }
  .mandate-score .ms-label { font-size: 0.8em; }
  .mandate-score .ms-val { font-size: 1em; }
  .resources { gap: 8px; flex-shrink: 1; overflow: hidden; }
  .res-item { font-size: 0.78em; white-space: nowrap; }

  /* --- 底栏 --- */
  #bottom-bar {
    grid-column: 1;
    height: 44px;
    gap: 8px;
    padding: 0 8px;
    flex-wrap: nowrap;
    overflow-x: auto;
    justify-content: flex-start;
    -webkit-overflow-scrolling: touch;
  }
  #power-ranking {
    display: none; /* 移到底部抽屉中或隐藏，节省空间 */
  }
  .bottom-btn {
    padding: 8px 14px; font-size: 0.82em;
    min-height: 36px; min-width: 44px;
    flex-shrink: 0;
    letter-spacing: 1px;
  }
  /* 移动端底栏控制按钮 */
  .mobile-toggle-btn {
    padding: 8px 14px; font-size: 0.82em;
    font-family: inherit; cursor: pointer;
    background: transparent; color: var(--gold);
    border: 1px solid rgba(201,169,110,0.3);
    border-radius: 3px; letter-spacing: 1px;
    min-height: 36px; min-width: 44px;
    flex-shrink: 0;
    transition: all 0.2s;
  }
  .mobile-toggle-btn:hover, .mobile-toggle-btn:active {
    background: rgba(201,169,110,0.1);
    border-color: var(--gold);
  }

  /* --- 中间主区域 --- */
  #main-area {
    grid-column: 1;
    grid-row: 2;
    overflow: hidden;
    touch-action: pan-x pan-y pinch-zoom;
  }

  /* SVG 地图：自适应 + 支持双指缩放 */
  #map-svg {
    width: 100%; height: 100%;
    touch-action: pinch-zoom pan-x pan-y;
  }
  .node-label { font-size: 12px; }
  .node-value { font-size: 10px; }

  /* --- 事件卡片：全屏展示 --- */
  #event-overlay {
    position: fixed; inset: 0;
    z-index: 60;
    padding: 0;
    align-items: flex-end;
  }
  #event-card {
    max-width: 100%; width: 100%;
    border-radius: 16px 16px 0 0;
    padding: 20px 16px 28px 16px;
    max-height: 85vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .event-era-tag { font-size: 0.72em; }
  .event-title { font-size: 1.2em; margin-bottom: 10px; letter-spacing: 1px; }
  .event-desc { font-size: 0.9em; line-height: 1.75; margin-bottom: 10px; }
  .event-quote { font-size: 0.82em; margin-bottom: 16px; padding-left: 10px; }
  .choice-btn {
    padding: 14px 16px 14px 24px;
    font-size: 0.92em;
    min-height: 48px;
    margin-bottom: 10px;
    line-height: 1.5;
    border-radius: 6px;
  }
  .choice-btn:active {
    background: rgba(201,169,110,0.18);
    border-color: var(--gold);
  }

  /* --- 结果弹窗 --- */
  #result-overlay {
    position: fixed; inset: 0;
    z-index: 61;
    padding: 0;
    align-items: flex-end;
  }
  #result-card {
    max-width: 100%; width: 100%;
    border-radius: 16px 16px 0 0;
    padding: 20px 16px 28px 16px;
    max-height: 80vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  .result-text { font-size: 0.95em; line-height: 1.75; }
  .effect-tags { gap: 8px; }
  .effect-tag { font-size: 0.82em; padding: 4px 12px; }
  .continue-btn {
    padding: 14px 44px; font-size: 1em;
    min-height: 48px; min-width: 160px;
    letter-spacing: 2px;
  }
  .continue-btn:active {
    background: rgba(201,169,110,0.25);
  }

  /* --- 时代过渡 --- */
  #era-transition { padding: 20px; }
  .era-trans-content { max-width: 90vw; }
  .era-trans-content h2 { font-size: 1.8em; letter-spacing: 12px; }
  .era-trans-content p { font-size: 0.95em; }
  .era-trans-summary { font-size: 0.82em; line-height: 1.7; }
  .era-trans-preview { font-size: 0.8em; }

  /* --- 结局画面 --- */
  #ending-screen { padding: 20px; }
  #ending-screen h1 { font-size: 2em; letter-spacing: 6px; }
  #ending-screen .ending-desc {
    font-size: 0.92em; line-height: 1.9;
    max-width: 90vw; margin-bottom: 24px;
    padding: 0 8px;
  }
  #ending-screen .score { font-size: 1em; margin-bottom: 20px; }

  /* --- 成就通知 --- */
  #achievement-container { right: 8px; top: 50px; }
  .achievement-notif { font-size: 0.82em; padding: 8px 14px; }

  /* --- 霸主通知 --- */
  #hegemony-notif { top: 50px; font-size: 0.95em; padding: 10px 20px; letter-spacing: 2px; }

  /* --- 连锁反应 --- */
  .chain-notif { font-size: 0.75em; padding: 3px 10px; }

  /* --- 底部势力排行 (移动端放到抽屉顶部) --- */
  #mobile-power-ranking {
    display: flex; flex-wrap: wrap; gap: 6px;
    padding: 6px 0; margin-bottom: 6px;
    border-bottom: 1px solid rgba(201,169,110,0.15);
  }
  #mobile-power-ranking .rank-item { font-size: 0.75em; }

  /* --- 移动端回合指示 --- */
  #mobile-turn-badge {
    position: absolute; top: 50px; left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: #8a7a5a;
    font-size: 0.72em;
    padding: 2px 10px;
    border-radius: 0 0 8px 8px;
    border: 1px solid rgba(201,169,110,0.15);
    border-top: none;
    z-index: 5;
    pointer-events: none;
  }

  /* --- 触摸优化：增大可点击区域 --- */
  button, .region-card, .choice-btn, .bottom-btn, .mobile-toggle-btn {
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }

  /* 防止文本选择干扰操作 */
  .region-card, .choice-btn, .bottom-btn, .mobile-toggle-btn, #top-bar, #bottom-bar {
    user-select: none;
    -webkit-user-select: none;
  }
}

/* 超小屏适配 (max-width: 380px) */
@media (max-width: 380px) {
  .title-area h1 { font-size: 1.8em; letter-spacing: 6px; }
  .poem { font-size: 0.8em; }
  .start-btn { padding: 12px 32px; font-size: 1em; }
  #top-bar { padding: 0 6px; font-size: 0.72em; }
  .era-badge { font-size: 0.82em; }
  .resources { gap: 5px; }
  .res-item { font-size: 0.72em; }
  .event-title { font-size: 1.1em; }
  .event-desc { font-size: 0.85em; }
  .choice-btn { font-size: 0.85em; padding: 12px 14px 12px 22px; }
  #ending-screen h1 { font-size: 1.6em; }
  #ending-screen .ending-desc { font-size: 0.85em; }
}

/* 横屏提示 (移动端横屏时) */
@media (max-width: 768px) and (orientation: landscape) {
  #event-card, #result-card {
    max-height: 90vh;
  }
  #event-overlay, #result-overlay {
    align-items: center;
  }
  #event-card, #result-card {
    border-radius: 8px;
    max-width: 90vw;
    width: 90vw;
  }
  #left-panel {
    height: 50vh;
    bottom: 44px;
  }
}

/* ================================================================
   史诗级开场视觉升级
   ================================================================ */

/* --- 底层：移动的星空 --- */
#start-screen .stars-layer{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:0;
}
#start-screen .stars-layer::before,
#start-screen .stars-layer::after{
  content:'';position:absolute;width:200%;height:200%;left:-50%;top:-50%;
  animation:starsDrift 60s linear infinite;
}
#start-screen .stars-layer::before{
  background:
    radial-gradient(1px 1px at 5% 8%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 12% 22%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 18% 45%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 25% 13%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 32% 67%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 38% 82%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 44% 5%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 50% 35%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 55% 55%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 60% 90%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1px 1px at 65% 18%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 70% 42%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 75% 72%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 80% 3%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 85% 58%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 90% 28%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 95% 80%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 3% 52%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 8% 95%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 15% 70%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 22% 38%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 28% 88%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1px 1px at 35% 15%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 42% 60%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 48% 78%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 53% 10%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 58% 48%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 63% 85%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 68% 25%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1px 1px at 73% 62%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 78% 40%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 83% 75%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 88% 12%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 93% 50%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 97% 33%, rgba(255,255,255,0.4) 50%, transparent 50%);
  background-size:100% 100%;
}
#start-screen .stars-layer::after{
  background:
    radial-gradient(1px 1px at 2% 30%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 7% 65%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 13% 10%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 20% 85%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 27% 48%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 33% 20%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 40% 73%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 47% 92%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 52% 40%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 57% 15%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 62% 58%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 67% 78%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 72% 33%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 77% 88%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 82% 52%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 87% 8%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 92% 68%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 96% 42%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 4% 77%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 10% 55%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 16% 35%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 23% 5%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 30% 62%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 36% 95%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 43% 25%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 49% 50%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 54% 83%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 59% 70%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 64% 2%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 69% 45%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 74% 18%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 79% 60%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 84% 38%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 89% 90%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 94% 22%, rgba(255,255,255,0.5) 50%, transparent 50%);
  background-size:100% 100%;
  animation-delay:-30s;
}
@keyframes starsDrift{
  0%{transform:translateY(0);}
  100%{transform:translateY(50%);}
}

/* --- 中层：远山剪影 --- */
#start-screen .mountains-layer{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:1;
}
.mountain-far,.mountain-mid,.mountain-near{
  position:absolute;bottom:0;width:120%;left:-10%;
}
.mountain-far{
  height:22%;
  background:linear-gradient(180deg, transparent 0%, #0a0b14 100%);
  clip-path:polygon(0% 100%, 0% 65%, 5% 55%, 12% 40%, 18% 50%, 25% 30%, 32% 45%, 38% 25%, 44% 38%, 50% 20%, 56% 35%, 62% 22%, 68% 40%, 75% 28%, 82% 42%, 88% 32%, 94% 48%, 100% 38%, 100% 100%);
  opacity:0.5;
  animation:mountainDriftLeft 80s linear infinite alternate;
}
.mountain-mid{
  height:18%;
  background:linear-gradient(180deg, transparent 0%, #0d0e1a 100%);
  clip-path:polygon(0% 100%, 0% 70%, 8% 50%, 15% 60%, 22% 35%, 30% 55%, 37% 30%, 43% 48%, 50% 25%, 58% 42%, 65% 30%, 72% 50%, 80% 35%, 87% 55%, 95% 40%, 100% 58%, 100% 100%);
  opacity:0.65;
  animation:mountainDriftRight 70s linear infinite alternate;
}
.mountain-near{
  height:12%;
  background:linear-gradient(180deg, #10111d 0%, #0d0e1a 100%);
  clip-path:polygon(0% 100%, 0% 60%, 6% 45%, 14% 55%, 22% 30%, 30% 50%, 40% 28%, 48% 45%, 55% 32%, 64% 50%, 72% 35%, 80% 55%, 90% 38%, 100% 50%, 100% 100%);
  opacity:0.8;
}
@keyframes mountainDriftLeft{
  0%{transform:translateX(0);}
  100%{transform:translateX(-3%);}
}
@keyframes mountainDriftRight{
  0%{transform:translateX(0);}
  100%{transform:translateX(2%);}
}

/* --- 上层：飘动云雾 --- */
#start-screen .clouds-layer{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:2;
}
.cloud{position:absolute;border-radius:50%;filter:blur(60px);opacity:0.12;}
.cloud-1{
  width:500px;height:200px;top:10%;left:-10%;
  background:radial-gradient(ellipse, rgba(201,169,110,0.25) 0%, transparent 70%);
  animation:cloudDrift1 40s ease-in-out infinite alternate;
}
.cloud-2{
  width:400px;height:180px;top:35%;right:-15%;
  background:radial-gradient(ellipse, rgba(41,128,185,0.2) 0%, transparent 70%);
  animation:cloudDrift2 35s ease-in-out infinite alternate;
}
.cloud-3{
  width:600px;height:150px;bottom:20%;left:20%;
  background:radial-gradient(ellipse, rgba(201,169,110,0.15) 0%, rgba(180,130,70,0.08) 40%, transparent 70%);
  animation:cloudDrift3 50s ease-in-out infinite alternate;
}
@keyframes cloudDrift1{0%{transform:translateX(0) translateY(0);}100%{transform:translateX(15vw) translateY(-20px);}}
@keyframes cloudDrift2{0%{transform:translateX(0) translateY(0);}100%{transform:translateX(-12vw) translateY(15px);}}
@keyframes cloudDrift3{0%{transform:translateX(0);}100%{transform:translateX(-10vw);}}

/* --- 火星/余烬粒子 --- */
.start-particle.ember{
  background:rgba(220,120,40,0.7);
  border-radius:50%;
  box-shadow:0 0 4px rgba(220,120,40,0.4);
}

/* --- 标题升级 --- */
.title-area h1{
  font-size:4.2em !important;
  font-weight:bold;
  position:relative;
  z-index:5;
}
/* 金色冲击波 */
.title-shockwave{
  position:absolute;top:50%;left:50%;
  width:0;height:0;border-radius:50%;
  transform:translate(-50%,-50%);
  background:radial-gradient(circle, rgba(201,169,110,0.5) 0%, rgba(201,169,110,0.1) 40%, transparent 70%);
  pointer-events:none;z-index:4;
  opacity:0;
}
.title-shockwave.active{
  animation:shockwaveExpand 0.8s ease-out forwards;
}
@keyframes shockwaveExpand{
  0%{width:0;height:0;opacity:0.8;}
  100%{width:600px;height:600px;opacity:0;}
}

/* 金色横线（标题下方） */
.title-gold-line{
  width:0;height:2px;margin:12px auto 0;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  transition:width 0.8s ease-out;
  z-index:5;position:relative;
}
.title-gold-line.expand{width:200px;}

/* --- 诗句光线扫过效果 --- */
.poem-line{position:relative;overflow:hidden;}
.poem-line::after{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent 0%,rgba(201,169,110,0.25) 50%,transparent 100%);
  pointer-events:none;opacity:0;
}
.poem-line.visible::after{
  animation:lineSweep 0.6s 0.15s ease-out forwards;
}
@keyframes lineSweep{
  0%{left:-100%;opacity:1;}
  100%{left:100%;opacity:0;}
}

/* --- "天命在手"出现时画面微震 --- */
@keyframes subtleShake{
  0%,100%{transform:translateY(0) translateX(0);}
  15%{transform:translateY(-2px) translateX(1px);}
  30%{transform:translateY(1px) translateX(-2px);}
  45%{transform:translateY(-1px) translateX(1px);}
  60%{transform:translateY(1px) translateX(-1px);}
  75%{transform:translateY(-1px) translateX(0);}
}
#start-screen.mandate-shake{animation:subtleShake 0.4s ease-out;}

/* --- 静音按钮 --- */
.mute-btn{
  position:relative;z-index:10;
  width:36px;height:36px;
  background:transparent;border:1px solid rgba(201,169,110,0.3);border-radius:50%;
  color:var(--gold);font-size:1.1em;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;line-height:1;padding:0;
  font-family:inherit;
}
.mute-btn:hover{background:rgba(201,169,110,0.1);border-color:var(--gold);}
.mute-btn:active{transform:scale(0.9);}
#start-mute-btn{position:absolute;top:16px;right:16px;z-index:20;}

/* --- 让 title-area / poem / btn 保持在所有层之上 --- */
.title-area,.poem,.start-btn,#start-particles{position:relative;z-index:5;}

@media (max-width: 768px) {
  .title-area h1{font-size:2.8em !important;}
  .title-shockwave.active{animation-name:shockwaveExpandMobile;}
  @keyframes shockwaveExpandMobile{0%{width:0;height:0;opacity:0.8;}100%{width:350px;height:350px;opacity:0;}}
  .title-gold-line.expand{width:140px;}
  .cloud{filter:blur(40px);}
  .cloud-1{width:300px;height:120px;}
  .cloud-2{width:250px;height:100px;}
  .cloud-3{width:350px;height:100px;}
  #start-mute-btn{top:10px;right:10px;}
}
@media (max-width: 380px) {
  .title-area h1{font-size:2.2em !important;}
}
</style>
</head>
<body>

<!-- ========== 开始画面 ========== -->
<div id="start-screen">
  <!-- 底层：星空 -->
  <div class="stars-layer"></div>
  <!-- 中层：远山剪影 -->
  <div class="mountains-layer">
    <div class="mountain-far"></div>
    <div class="mountain-mid"></div>
    <div class="mountain-near"></div>
  </div>
  <!-- 上层：飘动云雾 -->
  <div class="clouds-layer">
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>
    <div class="cloud cloud-3"></div>
  </div>
  <!-- 粒子 -->
  <div class="start-particles" id="start-particles"></div>
  <!-- 静音按钮 -->
  <button class="mute-btn" id="start-mute-btn" title="音效开关">&#x1f50a;</button>
  <!-- 冲击波 -->
  <div class="title-shockwave" id="title-shockwave"></div>
  <div class="title-area">
    <h1 id="main-title">枢纽</h1>
    <div class="subtitle" id="main-subtitle">天 下 之 道</div>
    <div class="title-gold-line" id="title-gold-line"></div>
    <div class="author">—— 基于施展《枢纽：3000年的中国》 ——</div>
  </div>
  <div class="poem" id="start-poem">
    <div class="poem-line">三千年风云际会</div>
    <div class="poem-line">七大空间，纵横捭阖</div>
    <div class="poem-line">铁骑踏破山河，丝路连通四海</div>
    <div class="poem-line gold-line">天命在手——你，将如何经略天下？</div>
  </div>
  <button class="start-btn pulse-glow" id="start-btn">执 掌 天 命</button>
</div>

<!-- ========== 时代过渡 ========== -->
<div id="era-transition">
  <div class="era-trans-content">
    <div class="era-trans-summary" id="era-trans-summary"></div>
    <h2 id="era-trans-title"></h2>
    <div class="era-trans-line" id="era-trans-line"></div>
    <p id="era-trans-desc"></p>
    <div class="era-trans-preview" id="era-trans-preview"></div>
  </div>
</div>

<!-- ========== 主游戏 ========== -->
<div id="game">
  <div id="top-bar">
    <div class="era-badge" id="era-display">第一纪 · 封建社会</div>
    <div class="turn-info">第 <span id="turn-num">1</span> 回合</div>
    <div class="mandate-score" id="mandate-display">
      <span class="ms-label">天命</span>
      <span class="ms-val" id="mandate-val">0</span>
    </div>
    <div class="resources">
      <div class="res-item">国力 <span id="res-power">50</span></div>
      <div class="res-item">民心 <span id="res-morale">50</span></div>
      <div class="res-item">文运 <span id="res-culture">50</span></div>
    </div>
  </div>

  <div id="left-panel">
    <div class="panel-title">七 大 空 间</div>
    <div id="mobile-power-ranking" style="display:none;"></div>
    <div id="region-list"></div>
  </div>

  <div id="main-area">
    <div id="mobile-turn-badge" style="display:none;">第 <span id="mobile-turn-num">1</span> 回合</div>
    <div id="chain-notifications"></div>
    <svg id="map-svg" viewBox="0 0 600 450">
      <!-- 连接线 -->
      <line class="connection-line" x1="300" y1="150" x2="160" y2="180"/>
      <line class="connection-line" x1="300" y1="150" x2="440" y2="160"/>
      <line class="connection-line" x1="300" y1="150" x2="300" y2="280"/>
      <line class="connection-line" x1="160" y1="180" x2="100" y2="300"/>
      <line class="connection-line" x1="440" y1="160" x2="500" y2="280"/>
      <line class="connection-line" x1="300" y1="280" x2="160" y2="180"/>
      <line class="connection-line" x1="300" y1="280" x2="440" y2="160"/>
      <line class="connection-line" x1="300" y1="280" x2="200" y2="380"/>
      <line class="connection-line" x1="300" y1="280" x2="400" y2="380"/>
      <line class="connection-line" x1="100" y1="300" x2="200" y2="380"/>
      <line class="connection-line" x1="500" y1="280" x2="400" y2="380"/>
      <!-- 区域节点由 JS 生成 -->
      <g id="map-nodes"></g>
    </svg>

    <!-- 事件覆盖层 -->
    <div id="event-overlay">
      <div id="event-card" class="fade-in">
        <div class="event-era-tag" id="ev-era"></div>
        <div class="event-title" id="ev-title"></div>
        <div class="event-desc" id="ev-desc"></div>
        <div class="event-quote" id="ev-quote"></div>
        <div id="ev-choices"></div>
      </div>
    </div>

    <!-- 结果覆盖层 -->
    <div id="result-overlay">
      <div id="result-card" class="fade-in">
        <div class="result-text" id="res-text"></div>
        <div class="effect-tags" id="res-effects"></div>
        <button class="continue-btn hidden" id="continue-btn">继 续</button>
      </div>
    </div>
  </div>

  <div id="right-panel">
    <div class="panel-title">历 史 长 卷</div>
    <div class="history-log" id="history-log"></div>
  </div>

  <div id="bottom-bar">
    <button class="mobile-toggle-btn" id="btn-toggle-regions" onclick="toggleRegionDrawer()" style="display:none;">空间</button>
    <div id="power-ranking"></div>
    <button class="bottom-btn" onclick="saveGame()">存档</button>
    <button class="bottom-btn" onclick="loadGame()">读档</button>
    <button class="bottom-btn" onclick="showHelp()">指南</button>
    <button class="mute-btn" id="game-mute-btn" title="音效开关">&#x1f50a;</button>
    <button class="mobile-toggle-btn" id="btn-toggle-history" onclick="toggleHistoryPanel()" style="display:none;">史卷</button>
  </div>
</div>

<!-- 移动端遮罩层 -->
<div id="mobile-overlay" onclick="closeMobilePanels()"></div>

<div id="achievement-container"></div>
<div id="hegemony-notif" style="display:none;"></div>

<!-- ========== 结局画面 ========== -->
<div id="ending-screen">
  <h1 id="ending-title"></h1>
  <div class="ending-desc" id="ending-desc"></div>
  <div class="score" id="ending-score"></div>
  <button class="start-btn" onclick="location.reload()">再 续 天 命</button>
</div>

<script>
// ==================== Web Audio API 音效系统 ====================

const SFX = {
  ctx: null,
  muted: false,
  ambientGain: null,
  ambientOscs: [],
  _initialized: false,

  init() {
    if (this._initialized) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      this._initialized = true;
      // Restore mute preference
      if (localStorage.getItem('pivot_muted') === '1') {
        this.muted = true;
        this._updateMuteButtons();
      }
    } catch(e) {
      console.warn('Web Audio API not available:', e);
    }
  },

  _updateMuteButtons() {
    const icon = this.muted ? '\u{1F507}' : '\u{1F50A}';
    document.querySelectorAll('.mute-btn').forEach(btn => { btn.textContent = icon; });
  },

  toggleMute() {
    this.muted = !this.muted;
    localStorage.setItem('pivot_muted', this.muted ? '1' : '0');
    this._updateMuteButtons();
    if (this.muted) {
      this.stopAmbient();
    }
  },

  // --- 开场环境音 ---
  ambient() {
    if (!this.ctx || this.muted) return;
    if (this.ambientOscs.length > 0) return; // already playing
    const ctx = this.ctx;
    const masterGain = ctx.createGain();
    masterGain.gain.setValueAtTime(0, ctx.currentTime);
    masterGain.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 2);
    masterGain.connect(ctx.destination);
    this.ambientGain = masterGain;

    // Low pad: two detuned oscillators through a low-pass filter
    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(200, ctx.currentTime);
    filter.Q.setValueAtTime(1, ctx.currentTime);
    filter.connect(masterGain);

    const freqs = [55, 55.5]; // slightly detuned A1
    freqs.forEach(freq => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.5, ctx.currentTime);
      osc.connect(g);
      g.connect(filter);
      osc.start();
      this.ambientOscs.push(osc);
    });

    // Add a subtle second harmonic
    const osc2 = ctx.createOscillator();
    osc2.type = 'triangle';
    osc2.frequency.setValueAtTime(110, ctx.currentTime);
    const g2 = ctx.createGain();
    g2.gain.setValueAtTime(0.15, ctx.currentTime);
    osc2.connect(g2);
    g2.connect(filter);
    osc2.start();
    this.ambientOscs.push(osc2);
  },

  fadeOutAmbient(duration) {
    if (!this.ambientGain || !this.ctx) return;
    const ctx = this.ctx;
    this.ambientGain.gain.linearRampToValueAtTime(0, ctx.currentTime + (duration || 1.5));
    const oscs = this.ambientOscs;
    setTimeout(() => {
      oscs.forEach(o => { try { o.stop(); } catch(e){} });
    }, (duration || 1.5) * 1000 + 100);
    this.ambientOscs = [];
    this.ambientGain = null;
  },

  stopAmbient() {
    if (this.ambientOscs.length > 0) {
      this.ambientOscs.forEach(o => { try { o.stop(); } catch(e){} });
      this.ambientOscs = [];
      this.ambientGain = null;
    }
  },

  // --- 按钮点击音 ---
  click() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    const osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.08);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.12);
  },

  // --- 选择确认音 ---
  choiceConfirm() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    // Fundamental
    const osc1 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(220, ctx.currentTime);
    const gain1 = ctx.createGain();
    gain1.gain.setValueAtTime(0.18, ctx.currentTime);
    gain1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    osc1.connect(gain1);
    gain1.connect(ctx.destination);
    osc1.start();
    osc1.stop(ctx.currentTime + 0.35);

    // Octave harmonic
    const osc2 = ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(440, ctx.currentTime);
    const gain2 = ctx.createGain();
    gain2.gain.setValueAtTime(0.08, ctx.currentTime);
    gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
    osc2.connect(gain2);
    gain2.connect(ctx.destination);
    osc2.start();
    osc2.stop(ctx.currentTime + 0.3);
  },

  // --- 正面效果音 ---
  positiveChime() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.1);
      gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + i * 0.1 + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.15);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.1);
      osc.stop(ctx.currentTime + i * 0.1 + 0.2);

      // Subtle harmonic
      const h = ctx.createOscillator();
      h.type = 'sine';
      h.frequency.setValueAtTime(freq * 2, ctx.currentTime);
      const hg = ctx.createGain();
      hg.gain.setValueAtTime(0, ctx.currentTime + i * 0.1);
      hg.gain.linearRampToValueAtTime(0.04, ctx.currentTime + i * 0.1 + 0.02);
      hg.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.12);
      h.connect(hg);
      hg.connect(ctx.destination);
      h.start(ctx.currentTime + i * 0.1);
      h.stop(ctx.currentTime + i * 0.1 + 0.15);
    });
  },

  // --- 负面效果音 ---
  negativeThud() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    const osc = ctx.createOscillator();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(200, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.3);

    // WaveShaper distortion
    const shaper = ctx.createWaveShaper();
    const curve = new Float32Array(256);
    for (let i = 0; i < 256; i++) {
      const x = (i / 128) - 1;
      curve[i] = (Math.PI + 3) * x / (Math.PI + 3 * Math.abs(x));
    }
    shaper.curve = curve;
    shaper.oversample = '2x';

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);

    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(300, ctx.currentTime);

    osc.connect(shaper);
    shaper.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.4);
  },

  // --- 时代过渡音（锣声） ---
  eraGong() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    // Low fundamental
    const osc1 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(65, ctx.currentTime);
    const g1 = ctx.createGain();
    g1.gain.setValueAtTime(0.2, ctx.currentTime);
    g1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 3);
    osc1.connect(g1);
    g1.connect(ctx.destination);
    osc1.start();
    osc1.stop(ctx.currentTime + 3.2);

    // High harmonic shimmer
    const osc2 = ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(520, ctx.currentTime);
    osc2.frequency.exponentialRampToValueAtTime(490, ctx.currentTime + 2);
    const g2 = ctx.createGain();
    g2.gain.setValueAtTime(0.06, ctx.currentTime);
    g2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2);
    osc2.connect(g2);
    g2.connect(ctx.destination);
    osc2.start();
    osc2.stop(ctx.currentTime + 2.2);

    // Mid-tone body
    const osc3 = ctx.createOscillator();
    osc3.type = 'triangle';
    osc3.frequency.setValueAtTime(130, ctx.currentTime);
    const g3 = ctx.createGain();
    g3.gain.setValueAtTime(0.12, ctx.currentTime);
    g3.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
    osc3.connect(g3);
    g3.connect(ctx.destination);
    osc3.start();
    osc3.stop(ctx.currentTime + 2.7);

    // Noise burst for attack
    const bufSize = ctx.sampleRate * 0.05;
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * 0.3;
    const noise = ctx.createBufferSource();
    noise.buffer = buf;
    const ng = ctx.createGain();
    ng.gain.setValueAtTime(0.15, ctx.currentTime);
    ng.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
    const nf = ctx.createBiquadFilter();
    nf.type = 'bandpass';
    nf.frequency.setValueAtTime(200, ctx.currentTime);
    nf.Q.setValueAtTime(2, ctx.currentTime);
    noise.connect(nf);
    nf.connect(ng);
    ng.connect(ctx.destination);
    noise.start();
  },

  // --- 屏幕震动音 ---
  warRumble() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    const bufSize = ctx.sampleRate * 0.5;
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
    const noise = ctx.createBufferSource();
    noise.buffer = buf;

    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(120, ctx.currentTime);
    filter.Q.setValueAtTime(5, ctx.currentTime);

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.05);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    noise.start();
    noise.stop(ctx.currentTime + 0.55);
  },

  // --- 成就音 ---
  achieveChime() {
    if (!this.ctx || this.muted) return;
    const ctx = this.ctx;
    // Rising arpeggio: C5, E5, G5, C6
    const notes = [523.25, 659.25, 783.99, 1046.5];
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.08);
      gain.gain.linearRampToValueAtTime(0.12, ctx.currentTime + i * 0.08 + 0.015);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.08 + 0.3);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.08);
      osc.stop(ctx.currentTime + i * 0.08 + 0.35);
    });
    // Shimmer high harmonic
    const shimmer = ctx.createOscillator();
    shimmer.type = 'sine';
    shimmer.frequency.setValueAtTime(2093, ctx.currentTime + 0.3);
    const sg = ctx.createGain();
    sg.gain.setValueAtTime(0, ctx.currentTime + 0.3);
    sg.gain.linearRampToValueAtTime(0.04, ctx.currentTime + 0.32);
    sg.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    shimmer.connect(sg);
    sg.connect(ctx.destination);
    shimmer.start(ctx.currentTime + 0.3);
    shimmer.stop(ctx.currentTime + 0.55);
  }
};

// ==================== 游戏数据 ====================

const REGION_META = {
  zhongyuan: {name:'中原', color:'#b8860b', x:300, y:150, desc:'农耕心脏，文明根基'},
  caoyuan:   {name:'草原', color:'#4a7c59', x:440, y:160, desc:'铁骑纵横，游牧雄风'},
  xiyu:      {name:'西域', color:'#a0522d', x:160, y:180, desc:'丝路枢纽，万邦交汇'},
  guodu:     {name:'过渡地带', color:'#8b7355', x:300, y:280, desc:'农牧交融，文明熔炉'},
  gaoyuan:   {name:'高原', color:'#4a6fa5', x:500, y:280, desc:'雪域圣境，精神高地'},
  xinan:     {name:'西南', color:'#6b8e6b', x:200, y:380, desc:'密林万族，多元共生'},
  haiyang:   {name:'海洋', color:'#2980b9', x:400, y:380, desc:'碧波万里，通达四海'}
};

const ERA_NAMES = ['','第一纪 · 封建社会','第二纪 · 豪族社会','第三纪 · 古代平民社会','第四纪 · 现代转型'];
const ERA_DESCS = ['','周天子分封天下，礼乐教化，诸侯并立','大一统帝国崛起，豪族门阀把持朝政','科举取士，商业繁荣，却也暗藏内卷危机','三千年未有之大变局，何去何从？'];

// ==================== 事件数据 ====================

const EVENTS = {
  1: [
    {id:'e1_1',title:'武王伐纣',description:'殷商末年，纣王无道，酒池肉林。西伯侯之子姬发联合八百诸侯，牧野一战，商朝覆灭。天命更迭，新的秩序等待建立。',quote:'"天视自我民视，天听自我民听。" ——《尚书》',choices:[
      {text:'大封诸侯，分享天下',effects:{zhongyuan:{p:2,m:-1,c:2,t:1},xinan:{p:1,m:0,c:1,t:0}},consequence:'诸侯遍布天下，周室威望远播，但军力分散。'},
      {text:'集中兵力，巩固王畿',effects:{zhongyuan:{p:1,m:2,c:0,t:0},caoyuan:{p:0,m:0,c:0,t:-1}},consequence:'王畿固若金汤，但远方诸侯心生不满。'},
      {text:'怀柔殷商遗民，以德服人',effects:{zhongyuan:{p:1,m:0,c:3,t:1},guodu:{p:1,m:0,c:1,t:0}},consequence:'殷商遗民归心，文化融合加速，但旧势力暗流涌动。'}
    ]},
    {id:'e1_2',title:'礼乐兴邦',description:'周公制礼作乐，"礼"定尊卑秩序，"乐"和人心情感。这套制度像无形的网，将天下万民编织进同一个文明体系。',quote:'"礼之用，和为贵。" ——《论语》',choices:[
      {text:'严格推行礼制，教化万方',effects:{zhongyuan:{p:1,m:0,c:3,t:0},xiyu:{p:0,m:0,c:1,t:0}},consequence:'礼乐文明远播，中原文化认同增强。'},
      {text:'因地制宜，各族自治',effects:{zhongyuan:{p:0,m:0,c:1,t:1},xinan:{p:1,m:0,c:1,t:1},gaoyuan:{p:1,m:0,c:0,t:0}},consequence:'各方安定，但文化凝聚力较弱。'},
      {text:'重礼也重武，文武并举',effects:{zhongyuan:{p:0,m:2,c:2,t:0},caoyuan:{p:0,m:-1,c:0,t:0}},consequence:'既有文治又有武备，但国力消耗不小。'}
    ]},
    {id:'e1_3',title:'犬戎之祸',description:'西北草原上，犬戎部落日益强大。当中原沉浸在礼乐文明的优雅中时，铁骑的阴影正从草原蔓延而来。烽火戏诸侯的故事背后，是一场文明存亡的危机。',quote:'"戎狄豺狼，不可厌也。" ——《左传》',choices:[
      {text:'全力抵御，修筑防线',effects:{zhongyuan:{p:-1,m:2,c:0,t:-1},caoyuan:{p:0,m:1,c:0,t:-1},guodu:{p:-1,m:1,c:0,t:0}},consequence:'防线稳固，但过渡地带成了长期战场。'},
      {text:'东迁洛邑，避其锋芒',effects:{zhongyuan:{p:-2,m:-1,c:1,t:0},caoyuan:{p:1,m:1,c:0,t:1},xiyu:{p:0,m:0,c:0,t:1}},consequence:'周室东迁，威望大降，但保存了文明火种。诸侯开始各自为政。'},
      {text:'和亲通商，化敌为友',effects:{zhongyuan:{p:0,m:0,c:1,t:2},caoyuan:{p:1,m:0,c:1,t:2},guodu:{p:1,m:0,c:1,t:1}},consequence:'草原与中原开始贸易往来，但边境安全隐患未除。'}
    ]},
    {id:'e1_4',title:'春秋争霸',description:'周室衰微，诸侯崛起。齐桓公、晋文公、楚庄王……各路英雄纷纷登场，打着"尊王攘夷"的旗号，行争霸之实。天下大势，分久必合？',quote:'"不鸣则已，一鸣惊人。" ——《史记》',choices:[
      {text:'扶持霸主，维持秩序',effects:{zhongyuan:{p:1,m:1,c:0,t:1},caoyuan:{p:0,m:-1,c:0,t:0}},consequence:'霸主号令天下，秩序暂时恢复，但弱国苦不堪言。'},
      {text:'各国变法图强，百花齐放',effects:{zhongyuan:{p:2,m:1,c:2,t:1},xinan:{p:1,m:0,c:1,t:0}},consequence:'各国竞相改革，技术文化井喷式发展。'},
      {text:'推动会盟，和平共处',effects:{zhongyuan:{p:1,m:-1,c:2,t:2},xiyu:{p:0,m:0,c:0,t:1}},consequence:'短暂和平，贸易繁荣，但野心家们蠢蠢欲动。'}
    ]},
    {id:'e1_5',title:'百家争鸣',description:'乱世出思想。孔子周游列国传播仁义，老子骑青牛出函谷关留下道德经，墨子带领弟子行侠仗义，韩非子冷眼旁观写下法术势。一个文明的精神基因，正在此刻定型。',quote:'"道可道，非常道。" ——《道德经》',choices:[
      {text:'独尊儒术，以礼治国',effects:{zhongyuan:{p:1,m:-1,c:3,t:0},guodu:{p:0,m:0,c:1,t:0}},consequence:'仁义道德深入人心，但法制建设滞后。'},
      {text:'兼收并蓄，百家共存',effects:{zhongyuan:{p:0,m:0,c:2,t:1},xiyu:{p:0,m:0,c:1,t:1},gaoyuan:{p:0,m:0,c:1,t:0}},consequence:'思想自由，创新涌现，但缺乏统一的价值标准。'},
      {text:'以法为本，强国利器',effects:{zhongyuan:{p:2,m:2,c:0,t:1},caoyuan:{p:0,m:-1,c:0,t:0}},consequence:'国力快速增强，但百姓生活在严刑峻法之下。'}
    ]},
    {id:'e1_6',title:'商鞅变法',description:'秦国偏居西陲，被中原诸国视为蛮夷。商鞅携一卷法书入秦，徙木立信，废井田、开阡陌、奖军功。秦国从此脱胎换骨，但变法者本人却难逃五马分尸的命运。',quote:'"治世不一道，便国不法古。" ——商鞅',choices:[
      {text:'全面推行法治改革',effects:{zhongyuan:{p:3,m:3,c:-1,t:1},guodu:{p:1,m:1,c:0,t:0}},consequence:'国力暴增，虎狼之师成型，但文化遭受压制。'},
      {text:'渐进改革，兼顾传统',effects:{zhongyuan:{p:2,m:1,c:1,t:1},xinan:{p:1,m:0,c:0,t:0}},consequence:'稳步发展，社会矛盾较小，但变革力度不足。'},
      {text:'以德为先，法律为辅',effects:{zhongyuan:{p:1,m:0,c:2,t:1},caoyuan:{p:0,m:0,c:1,t:1}},consequence:'社会和谐，但在列国争霸中竞争力不足。'}
    ]},
    {id:'e1_7',title:'合纵连横',description:'战国末期，七雄并立。苏秦佩六国相印合纵抗秦，张仪以三寸不烂之舌连横破盟。外交博弈的背后，是统一与分裂的终极较量。',quote:'"远交近攻。" ——范雎',choices:[
      {text:'合纵：联合弱国对抗强秦',effects:{zhongyuan:{p:0,m:-1,c:1,t:2},xiyu:{p:1,m:0,c:0,t:1},xinan:{p:1,m:0,c:0,t:1}},consequence:'各国暂时联合，但人心各异，联盟脆弱。'},
      {text:'连横：结盟强国，各个击破',effects:{zhongyuan:{p:1,m:2,c:-1,t:0},caoyuan:{p:-1,m:0,c:0,t:0}},consequence:'弱国被逐一吞并，统一进程加速，但战火蔓延。'},
      {text:'独善其身，发展经济',effects:{zhongyuan:{p:2,m:0,c:1,t:2},haiyang:{p:1,m:0,c:0,t:1}},consequence:'远离战火，经济繁荣，但终将面对统一大势的裹挟。'}
    ]},
    {id:'e1_8',title:'西域初通',description:'张骞凿空西域，一条横贯东西的贸易通道缓缓开启。来自远方的葡萄、汗血马和异域文明，冲击着中原人的认知边界。',quote:'"凿空西域，万里封侯。" ——《史记》',choices:[
      {text:'大力经营西域，设置都护',effects:{xiyu:{p:2,m:1,c:1,t:2},zhongyuan:{p:0,m:-1,c:1,t:1},caoyuan:{p:0,m:-1,c:0,t:0}},consequence:'丝绸之路畅通，但军事开支激增。'},
      {text:'以商通商，民间贸易为主',effects:{xiyu:{p:1,m:0,c:1,t:3},zhongyuan:{p:1,m:0,c:1,t:2}},consequence:'贸易繁荣，文化交流频繁，但缺乏政治控制力。'},
      {text:'谨慎观望，不深入介入',effects:{zhongyuan:{p:1,m:1,c:0,t:0},xiyu:{p:0,m:0,c:0,t:1}},consequence:'省下军费发展内部，但错失了连通世界的窗口。'}
    ]},
    // 转型事件
    {id:'e1_T',title:'【转型】天下一统',description:'六国已灭，秦王嬴政站在咸阳宫的最高处，俯瞰天下。书同文、车同轨、统一度量衡——一个前所未有的超大规模帝国即将诞生。但大一统之后，何去何从？',quote:'"六王毕，四海一。" ——杜牧《阿房宫赋》',isTransformation:true,choices:[
      {text:'严刑峻法，铁腕统一',effects:{zhongyuan:{p:2,m:3,c:-2,t:1},caoyuan:{p:-1,m:-1,c:0,t:-1},xiyu:{p:0,m:0,c:-1,t:0}},consequence:'帝国强盛但高压，草原虎视眈眈。进入豪族社会时，法治传统强但民心不稳。'},
      {text:'儒法并用，德刑兼施',effects:{zhongyuan:{p:2,m:1,c:2,t:1},guodu:{p:1,m:0,c:1,t:1},caoyuan:{p:0,m:0,c:1,t:0}},consequence:'文治武功兼备，各方平衡发展。进入豪族社会时起点最均衡。'},
      {text:'郡国并行，缓步整合',effects:{zhongyuan:{p:1,m:0,c:1,t:2},xinan:{p:1,m:0,c:1,t:1},haiyang:{p:0,m:0,c:0,t:1}},consequence:'各地保留一定自主权，整合较慢但社会稳定。进入豪族社会时地方势力较强。'}
    ]}
  ],
  2: [
    {id:'e2_1',title:'独尊儒术',description:'汉武帝采纳董仲舒建议，"罢黜百家，独尊儒术"。儒学从诸子之一跃升为帝国意识形态，太学遍设天下。但这把双刃剑，也将催生一个新的特权阶层——经学世家。',quote:'"天人感应，君权神授。" ——董仲舒',choices:[
      {text:'全面推行儒学教育',effects:{zhongyuan:{p:1,m:0,c:3,t:0},guodu:{p:0,m:0,c:1,t:0}},consequence:'文化统一，但思想渐趋僵化，经学世家开始垄断知识。'},
      {text:'儒法兼用，实用为上',effects:{zhongyuan:{p:2,m:1,c:1,t:1},caoyuan:{p:0,m:-1,c:0,t:0}},consequence:'外儒内法，帝国高效运转，但两面性也埋下隐患。'},
      {text:'保持思想多元',effects:{zhongyuan:{p:0,m:0,c:2,t:2},xiyu:{p:0,m:0,c:1,t:1},gaoyuan:{p:0,m:0,c:1,t:0}},consequence:'学术自由，各种思想交融，但缺乏主流价值观凝聚力。'}
    ]},
    {id:'e2_2',title:'匈奴南侵',description:'草原帝国与中原帝国的宿命对决。匈奴单于率十万铁骑南下，白登之围让汉高祖险些丧命。是屈辱和亲，还是倾国一战？这个选择将决定中原与草原的关系走向百年。',quote:'"但使龙城飞将在，不教胡马度阴山。" ——王昌龄',choices:[
      {text:'主动出击，远征漠北',effects:{caoyuan:{p:-2,m:-2,c:0,t:-1},zhongyuan:{p:-1,m:2,c:0,t:0},guodu:{p:-1,m:1,c:0,t:0}},consequence:'卫青霍去病横扫漠北，匈奴远遁，但国力消耗巨大。'},
      {text:'和亲通商，以柔克刚',effects:{caoyuan:{p:1,m:0,c:1,t:2},zhongyuan:{p:1,m:0,c:0,t:1},guodu:{p:1,m:0,c:1,t:1}},consequence:'边境和平，草原与中原开始融合，但面子上过不去。'},
      {text:'修长城，守边防',effects:{guodu:{p:0,m:2,c:0,t:0},zhongyuan:{p:-1,m:1,c:0,t:0},caoyuan:{p:0,m:0,c:0,t:-1}},consequence:'防线稳固，但长城成了文明的分隔线，双方渐行渐远。'}
    ]},
    {id:'e2_3',title:'丝路繁华',description:'驼铃声穿越大漠，丝绸、瓷器换来了琉璃、香料和佛经。西域三十六国成为东西文明的交汇点，敦煌莫高窟的第一铲挖了下去。',quote:'"使者相望于道，商旅不绝于途。" ——《汉书》',choices:[
      {text:'军事护商，设西域都护府',effects:{xiyu:{p:2,m:1,c:1,t:3},zhongyuan:{p:0,m:-1,c:1,t:2},caoyuan:{p:-1,m:0,c:0,t:0}},consequence:'丝路畅通无阻，但军费开支持续攀升。'},
      {text:'重商轻军，自由贸易',effects:{xiyu:{p:1,m:0,c:2,t:3},zhongyuan:{p:1,m:0,c:1,t:2},gaoyuan:{p:0,m:0,c:1,t:1}},consequence:'商贸繁盛，各族文化交融，但盗匪横行缺乏保障。'},
      {text:'选择性交往，控制风险',effects:{xiyu:{p:1,m:0,c:1,t:1},zhongyuan:{p:1,m:1,c:0,t:0}},consequence:'稳健经营，风险可控，但错失了大量贸易机会。'}
    ]},
    {id:'e2_4',title:'门阀崛起',description:'经学世家代代相传，四世三公的袁家、弘农杨氏、颍川荀氏……这些豪族掌握了土地、学问和入仕的通道。寒门子弟想要出头，难如登天。',quote:'"上品无寒门，下品无士族。" ——《晋书》',choices:[
      {text:'扶持寒门，制衡豪族',effects:{zhongyuan:{p:1,m:0,c:1,t:0},guodu:{p:1,m:0,c:0,t:0}},consequence:'寒门有了上升通道，但豪族暗中抵制，朝政动荡。'},
      {text:'与豪族合作，共治天下',effects:{zhongyuan:{p:2,m:1,c:0,t:1},xinan:{p:0,m:0,c:-1,t:0}},consequence:'政局稳定，但阶层固化，社会活力渐失。'},
      {text:'以战功替代门第',effects:{zhongyuan:{p:0,m:2,c:-1,t:0},caoyuan:{p:0,m:1,c:0,t:0},guodu:{p:1,m:1,c:0,t:0}},consequence:'武人地位上升，边疆得到开拓，但文治传统受损。'}
    ]},
    {id:'e2_5',title:'佛教东传',description:'白马驮经，佛法东来。从西域到中原，寺院拔地而起，石窟里凿出了另一个世界。佛教带来了全新的宇宙观和人生哲学，也带来了与儒学的深刻碰撞。',quote:'"色即是空，空即是色。" ——《心经》',choices:[
      {text:'大力弘扬佛法',effects:{gaoyuan:{p:1,m:0,c:2,t:1},zhongyuan:{p:0,m:-1,c:2,t:0},xiyu:{p:0,m:0,c:2,t:1}},consequence:'精神世界丰富，但大量人口出家，劳动力减少。'},
      {text:'儒佛融合，取长补短',effects:{zhongyuan:{p:1,m:0,c:2,t:1},gaoyuan:{p:1,m:0,c:1,t:1},guodu:{p:0,m:0,c:1,t:0}},consequence:'文化兼容并蓄，产生了独特的中国佛教传统。'},
      {text:'限制佛教，维护儒学正统',effects:{zhongyuan:{p:1,m:1,c:0,t:0},gaoyuan:{p:-1,m:0,c:-1,t:0}},consequence:'儒学地位巩固，但与高原地区的文化联系减弱。'}
    ]},
    {id:'e2_6',title:'大运河贯通',description:'隋炀帝以百万民夫之力，开凿出一条纵贯南北的大运河。运河将江南的粮食源源不断送往北方，南北经济命脉从此相连。代价是——民怨沸腾。',quote:'"尽道隋亡为此河，至今千里赖通波。" ——皮日休',choices:[
      {text:'不惜代价，全线贯通',effects:{zhongyuan:{p:3,m:-1,c:0,t:3},haiyang:{p:1,m:0,c:0,t:1},xinan:{p:0,m:0,c:0,t:1}},consequence:'经济大动脉形成，但民力耗尽，隋朝二世而亡。'},
      {text:'分段修建，减轻负担',effects:{zhongyuan:{p:2,m:0,c:0,t:2},haiyang:{p:0,m:0,c:0,t:1}},consequence:'运河缓慢成形，社会压力可控，但效果要几代人才能显现。'},
      {text:'放弃大工程，发展海运',effects:{haiyang:{p:2,m:1,c:0,t:2},zhongyuan:{p:0,m:0,c:0,t:1}},consequence:'海运贸易兴起，但南北陆路联系不够紧密。'}
    ]},
    {id:'e2_7',title:'安史之乱',description:'渔阳鼙鼓动地来，安禄山起兵叛唐。盛唐气象一夜之间崩塌，天子仓皇西逃，杨贵妃马嵬坡下香消玉殒。这场叛乱不仅终结了大唐盛世，更将彻底改变中国的社会结构。',quote:'"国破山河在，城春草木深。" ——杜甫',choices:[
      {text:'借回纥兵平叛',effects:{caoyuan:{p:1,m:1,c:0,t:1},zhongyuan:{p:-2,m:1,c:-1,t:0},guodu:{p:-1,m:0,c:0,t:0}},consequence:'叛乱平定，但草原势力深入中原，藩镇割据成为常态。'},
      {text:'依靠内部力量平叛',effects:{zhongyuan:{p:-1,m:2,c:0,t:-1},caoyuan:{p:0,m:0,c:0,t:0}},consequence:'自力更生，但平叛缓慢，百姓苦难深重。'},
      {text:'南迁中心，保存实力',effects:{zhongyuan:{p:-2,m:-1,c:0,t:0},haiyang:{p:2,m:0,c:1,t:2},xinan:{p:1,m:0,c:1,t:1}},consequence:'经济中心南移，海洋贸易崛起，但北方沦为战场。'}
    ]},
    {id:'e2_8',title:'科举初创',description:'隋唐之际，一种全新的人才选拔制度悄然诞生。不论出身，只要读书应考，寒门子弟也能鱼跃龙门。这是对持续数百年的门阀政治的釜底抽薪。',quote:'"朝为田舍郎，暮登天子堂。" ——汪洙',choices:[
      {text:'全面推行科举，废除门荫',effects:{zhongyuan:{p:1,m:0,c:3,t:0},guodu:{p:1,m:0,c:1,t:0}},consequence:'社会流动性大增，寒门崛起，豪族势力瓦解。'},
      {text:'科举与门荫并行',effects:{zhongyuan:{p:1,m:1,c:1,t:1},caoyuan:{p:0,m:0,c:0,t:0}},consequence:'渐进过渡，社会稳定，但改革不够彻底。'},
      {text:'以军功和实务取才',effects:{zhongyuan:{p:1,m:2,c:0,t:1},caoyuan:{p:0,m:1,c:0,t:0},guodu:{p:1,m:1,c:0,t:0}},consequence:'实用人才涌现，但缺乏文化根基的官僚体系隐患重重。'}
    ]},
    {id:'e2_T',title:'【转型】唐宋之变',description:'豪族消亡，科举兴盛，印刷术让知识不再是少数人的特权。一个全新的平民社会正在崛起。与此同时，北方游牧帝国比以往任何时候都更加强大。这个转型将决定：中国是向内收缩，还是向外开放？',quote:'"先天下之忧而忧，后天下之乐而乐。" ——范仲淹',isTransformation:true,choices:[
      {text:'重文轻武，发展经济和文化',effects:{zhongyuan:{p:3,m:-2,c:3,t:2},haiyang:{p:1,m:0,c:1,t:2},caoyuan:{p:0,m:1,c:0,t:0}},consequence:'经济文化达到巅峰，但军事孱弱。进入第三纪时富而不强。'},
      {text:'文武并重，内外平衡',effects:{zhongyuan:{p:2,m:1,c:2,t:1},caoyuan:{p:0,m:0,c:1,t:1},guodu:{p:1,m:1,c:0,t:0}},consequence:'综合国力均衡发展。进入第三纪时起点最平衡。'},
      {text:'积极开拓海洋，面向世界',effects:{haiyang:{p:3,m:1,c:1,t:3},zhongyuan:{p:1,m:0,c:1,t:1},xiyu:{p:0,m:0,c:0,t:1}},consequence:'海洋时代提前开启。进入第三纪时海洋维度领先。'}
    ]}
  ],
  3: [
    {id:'e3_1',title:'澶渊之盟',description:'宋辽对峙百年，契丹铁骑兵临城下。宋真宗在寇准的力劝下亲赴前线，最终以每年三十万岁币换来百年和平。是屈辱还是智慧？',quote:'"以地事秦，犹抱薪救火。" ——苏洵',choices:[
      {text:'签订和约，花钱买和平',effects:{zhongyuan:{p:2,m:0,c:1,t:2},caoyuan:{p:1,m:0,c:1,t:2},guodu:{p:1,m:0,c:0,t:1}},consequence:'百年无大战，经济文化繁荣，但军备日益松弛。'},
      {text:'拒绝和谈，决一死战',effects:{zhongyuan:{p:-2,m:2,c:0,t:-1},caoyuan:{p:-1,m:1,c:0,t:-1},guodu:{p:-2,m:1,c:0,t:0}},consequence:'战事惨烈，两败俱伤，但赢得了军事尊严。'},
      {text:'联合西夏，三方制衡',effects:{zhongyuan:{p:0,m:1,c:0,t:1},xiyu:{p:1,m:0,c:0,t:1},caoyuan:{p:-1,m:0,c:0,t:0}},consequence:'多方博弈，局势复杂但可控。'}
    ]},
    {id:'e3_2',title:'王安石变法',description:'"天变不足畏，祖宗不足法，人言不足恤。"王安石的变法触动了整个官僚阶层的利益。青苗法、免役法、保甲法——这是一场超前于时代的系统性改革。',quote:'"天变不足畏，祖宗不足法。" ——王安石',choices:[
      {text:'全面推行新法',effects:{zhongyuan:{p:3,m:1,c:-1,t:1},guodu:{p:1,m:1,c:0,t:0}},consequence:'国家财政大增，军力增强，但新旧党争撕裂朝廷。'},
      {text:'选择性改革，稳步推进',effects:{zhongyuan:{p:2,m:0,c:1,t:1},xinan:{p:1,m:0,c:0,t:0}},consequence:'改革温和推进，社会矛盾较小，但效果打了折扣。'},
      {text:'保守路线，维持现状',effects:{zhongyuan:{p:0,m:-1,c:2,t:0}},consequence:'士大夫阶层满意，但积弊越来越深，为后来的灾难埋下种子。'}
    ]},
    {id:'e3_3',title:'蒙古崛起',description:'草原深处，铁木真统一蒙古各部，号成吉思汗。一支前所未有的军事力量正在形成——从太平洋到多瑙河，蒙古铁骑将横扫一切。中原面临三千年来最大的外部冲击。',quote:'"长生天之下，皆为一统。" ——成吉思汗',choices:[
      {text:'联蒙灭金，再图恢复',effects:{caoyuan:{p:1,m:2,c:0,t:0},zhongyuan:{p:-1,m:-1,c:0,t:0},guodu:{p:-2,m:-1,c:0,t:0}},consequence:'金国覆灭，但唇亡齿寒，中原直接暴露在蒙古铁骑下。'},
      {text:'联金抗蒙，保持均势',effects:{zhongyuan:{p:0,m:1,c:0,t:0},caoyuan:{p:-1,m:0,c:0,t:-1},guodu:{p:0,m:1,c:0,t:0}},consequence:'北方暂时稳定，但两面受敌，压力巨大。'},
      {text:'全力发展南方和海洋',effects:{haiyang:{p:2,m:1,c:1,t:2},xinan:{p:1,m:0,c:1,t:1},zhongyuan:{p:-1,m:0,c:0,t:0}},consequence:'南方成为文明重心，海上贸易蓬勃发展，但北方沦陷。'}
    ]},
    {id:'e3_4',title:'郑和下西洋',description:'永乐帝派郑和率两百余艘宝船、两万七千人的庞大舰队七下西洋。这是人类历史上最大的远洋航海壮举——比哥伦布早了近一个世纪。但之后，中国关上了面向海洋的大门。',quote:'"观夫海洋，洪涛接天，巨浪如山。" ——郑和',choices:[
      {text:'继续航海，建立海上贸易网络',effects:{haiyang:{p:3,m:2,c:1,t:3},xinan:{p:1,m:0,c:0,t:1},zhongyuan:{p:-1,m:-1,c:0,t:1}},consequence:'海上帝国雏形初现，但内陆防御压力增大。'},
      {text:'适度航海，内外兼顾',effects:{haiyang:{p:2,m:1,c:1,t:2},zhongyuan:{p:0,m:0,c:1,t:1}},consequence:'海洋事业稳步发展，不过度消耗国力。'},
      {text:'停止航海，专注大陆',effects:{zhongyuan:{p:2,m:1,c:0,t:0},haiyang:{p:-2,m:-1,c:0,t:-2},caoyuan:{p:0,m:1,c:0,t:0}},consequence:'国力集中于大陆，但海上力量断崖式下降，历史机遇一去不返。'}
    ]},
    {id:'e3_5',title:'海禁与倭患',description:'沿海倭寇肆虐，朝廷下令海禁——"片板不许入海"。海禁本是防倭之策，却让沿海百万渔民商人断了生路，反而制造了更多的"倭寇"。',quote:'"封侯非我意，但愿海波平。" ——戚继光',choices:[
      {text:'开放海禁，以商制倭',effects:{haiyang:{p:2,m:0,c:1,t:3},zhongyuan:{p:1,m:0,c:0,t:1}},consequence:'海上贸易恢复，倭患渐消，但走私和海盗问题并存。'},
      {text:'军事剿倭，维持海禁',effects:{haiyang:{p:-1,m:2,c:0,t:-1},zhongyuan:{p:0,m:0,c:0,t:0}},consequence:'倭寇被打压，但海洋经济持续萎缩。'},
      {text:'有限开放，设市舶司管控',effects:{haiyang:{p:1,m:1,c:0,t:2},zhongyuan:{p:1,m:0,c:0,t:1}},consequence:'管控下的贸易，秩序与利润兼得。'}
    ]},
    {id:'e3_6',title:'康乾盛世',description:'清朝入主中原，这个起自满洲的少数民族王朝，创造了中国历史上最广阔的疆域。康熙平三藩、收台湾、征噶尔丹；乾隆十全武功。盛世之下，却是超大规模人口的隐忧。',quote:'"滋生人丁，永不加赋。" ——康熙帝',choices:[
      {text:'开疆拓土，经营边疆',effects:{xiyu:{p:2,m:1,c:1,t:1},gaoyuan:{p:1,m:0,c:1,t:1},caoyuan:{p:1,m:1,c:1,t:0},zhongyuan:{p:-1,m:-1,c:0,t:0}},consequence:'疆域极盛，多元一体，但财政压力巨大。'},
      {text:'守内虚外，发展经济',effects:{zhongyuan:{p:3,m:0,c:1,t:1},haiyang:{p:1,m:0,c:0,t:1}},consequence:'经济繁荣，人口暴增，但边疆控制力减弱。'},
      {text:'中学为体，开眼看世界',effects:{zhongyuan:{p:1,m:1,c:2,t:2},haiyang:{p:1,m:0,c:1,t:2},xiyu:{p:0,m:0,c:1,t:1}},consequence:'保持文化自信的同时吸收外来知识，为未来转型储备。'}
    ]},
    {id:'e3_7',title:'人口爆炸与内卷',description:'玉米、红薯等新大陆作物传入，人口从一亿暴增至四亿。大量剩余劳动力被困在有限的土地上，工资被压到极低——经济学家称之为"内卷化"。超大规模从优势变成了诅咒。',quote:'"人满之患，百倍于天灾。" ——洪亮吉',choices:[
      {text:'鼓励移民边疆和海外',effects:{xinan:{p:1,m:0,c:0,t:1},haiyang:{p:1,m:0,c:0,t:2},caoyuan:{p:1,m:0,c:0,t:0},zhongyuan:{p:1,m:0,c:0,t:0}},consequence:'人口压力缓解，但边疆和海外开发需要大量投入。'},
      {text:'发展手工业，吸收劳动力',effects:{zhongyuan:{p:2,m:0,c:0,t:2},haiyang:{p:0,m:0,c:0,t:1}},consequence:'手工业繁荣但始终未能突破为工业革命。'},
      {text:'限制人口，维持均衡',effects:{zhongyuan:{p:0,m:0,c:1,t:0}},consequence:'政策难以执行，人口惯性不可阻挡。'}
    ]},
    {id:'e3_8',title:'鸦片战争',description:'1840年，英国军舰驶入虎门。船坚炮利面前，天朝上国的迷梦碎了一地。"三千年未有之大变局"——这不仅是一场军事失败，更是整个世界观的崩塌。',quote:'"师夷长技以制夷。" ——魏源',choices:[
      {text:'奋起抵抗，全民动员',effects:{zhongyuan:{p:-2,m:2,c:0,t:-1},haiyang:{p:-1,m:1,c:0,t:-1}},consequence:'虽败犹荣，但现实差距太大，需要更深层的变革。'},
      {text:'忍辱负重，先学后战',effects:{zhongyuan:{p:-1,m:0,c:1,t:1},haiyang:{p:0,m:0,c:1,t:2}},consequence:'开始睁眼看世界，引入西方技术，但变革之路漫长。'},
      {text:'闭关锁国，拒绝变化',effects:{zhongyuan:{p:-1,m:-1,c:0,t:-2},haiyang:{p:-2,m:0,c:0,t:-2}},consequence:'固步自封，危机越陷越深，更大的灾难还在后面。'}
    ]},
    {id:'e3_T',title:'【转型】古今之变',description:'旧世界的大厦已经摇摇欲坠。科举废了，辫子剪了，皇帝退位了。三千年的帝制一朝终结。但新的中国应该是什么样子？没有人知道答案。这是最好的时代，也是最坏的时代。',quote:'"世界潮流，浩浩荡荡，顺之则昌，逆之则亡。" ——孙中山',isTransformation:true,choices:[
      {text:'全面西化，彻底革新',effects:{zhongyuan:{p:1,m:1,c:-1,t:2},haiyang:{p:2,m:0,c:0,t:2},caoyuan:{p:0,m:0,c:-1,t:0}},consequence:'快速现代化，但传统文化断裂，社会撕裂严重。'},
      {text:'中西结合，渐进转型',effects:{zhongyuan:{p:1,m:1,c:1,t:1},guodu:{p:1,m:0,c:1,t:1},xiyu:{p:0,m:0,c:0,t:1}},consequence:'稳健转型，但速度可能跟不上时代的急迫要求。'},
      {text:'走自己的路，独立探索',effects:{zhongyuan:{p:2,m:2,c:2,t:0},caoyuan:{p:1,m:0,c:1,t:0},gaoyuan:{p:1,m:0,c:1,t:0}},consequence:'民族自信，但可能走弯路，付出更大代价。'}
    ]}
  ],
  4: [
    {id:'e4_1',title:'洋务运动',description:'"自强""求富"的口号响彻朝野。张之洞的汉阳铁厂炉火通明，李鸿章的北洋水师战舰列阵。中国的现代化第一步，踉踉跄跄但毕竟迈出去了。',quote:'"中学为体，西学为用。" ——张之洞',choices:[
      {text:'大力引进西方技术',effects:{zhongyuan:{p:2,m:1,c:0,t:2},haiyang:{p:1,m:1,c:0,t:1}},consequence:'工业化起步，但只学技术不改制度，注定是修补。'},
      {text:'技术与制度同步改革',effects:{zhongyuan:{p:1,m:1,c:1,t:1},haiyang:{p:0,m:0,c:1,t:1}},consequence:'更深层的变革开始，但阻力也成倍增加。'},
      {text:'优先发展教育和人才',effects:{zhongyuan:{p:0,m:0,c:3,t:1},haiyang:{p:0,m:0,c:1,t:1}},consequence:'百年树人，留学生们将成为改变中国的种子。'}
    ]},
    {id:'e4_2',title:'辛亥革命',description:'武昌城头一声枪响，延续两千多年的帝制走到了终点。孙中山就任临时大总统，中华民国成立。然而推翻皇帝容易，建立新秩序难。',quote:'"革命尚未成功，同志仍须努力。" ——孙中山',choices:[
      {text:'建立强有力的中央政府',effects:{zhongyuan:{p:1,m:2,c:0,t:0},caoyuan:{p:0,m:-1,c:0,t:0},xiyu:{p:0,m:-1,c:0,t:0}},consequence:'中央集权恢复，但边疆离心力增大。'},
      {text:'联省自治，民主共和',effects:{zhongyuan:{p:0,m:-1,c:2,t:1},xinan:{p:1,m:0,c:1,t:1},haiyang:{p:1,m:0,c:0,t:1}},consequence:'民主实验开始，但军阀割据的阴影笼罩全国。'},
      {text:'社会革命优先，改造基层',effects:{zhongyuan:{p:-1,m:0,c:1,t:0},guodu:{p:1,m:1,c:1,t:0},xinan:{p:1,m:0,c:1,t:0}},consequence:'基层组织开始重建，但上层建筑混乱不堪。'}
    ]},
    {id:'e4_3',title:'五四运动',description:'"外争主权，内除国贼！"巴黎和会的屈辱点燃了一代青年的怒火。德先生和赛先生成为新的信仰，白话文运动让知识走出象牙塔。中国的精神世界正在经历一场地震。',quote:'"民主与科学。" ——陈独秀',choices:[
      {text:'全盘接受西方文化',effects:{zhongyuan:{p:0,m:0,c:2,t:2},haiyang:{p:1,m:0,c:1,t:1}},consequence:'思想解放，但传统文化遭受猛烈冲击。'},
      {text:'批判继承，中西融合',effects:{zhongyuan:{p:1,m:0,c:3,t:1},gaoyuan:{p:0,m:0,c:1,t:0}},consequence:'文化自觉开始萌芽，但道路漫长。'},
      {text:'以俄为师，走革命道路',effects:{zhongyuan:{p:0,m:1,c:1,t:0},caoyuan:{p:0,m:0,c:1,t:1},guodu:{p:1,m:1,c:0,t:0}},consequence:'一个全新的社会实验即将在中国大地上展开。'}
    ]},
    {id:'e4_4',title:'抗日战争',description:'卢沟桥事变，全面抗战爆发。这是中华民族最危险的时刻，也是各方力量空前团结的时刻。从中原到西南，从草原到海洋，一个民族在血与火中锻造出新的认同。',quote:'"地无分南北，人无分老幼，皆有守土抗战之责。" ——蒋介石',choices:[
      {text:'正面战场为主，阵地防御',effects:{zhongyuan:{p:-2,m:1,c:1,t:0},xinan:{p:1,m:1,c:1,t:0}},consequence:'正面抗击，伤亡惨重，但牵制了大量日军。'},
      {text:'正面+敌后双线作战',effects:{zhongyuan:{p:-1,m:2,c:1,t:0},guodu:{p:1,m:1,c:0,t:0},xinan:{p:1,m:0,c:1,t:0},caoyuan:{p:0,m:1,c:0,t:0}},consequence:'人民战争汪洋大海，全民族抗战格局形成。'},
      {text:'以空间换时间，战略转移',effects:{xinan:{p:2,m:1,c:2,t:1},zhongyuan:{p:-3,m:-1,c:0,t:-1},haiyang:{p:-1,m:0,c:0,t:0}},consequence:'西南成为大后方，保存了抗战力量，但东部沦陷区百姓苦不堪言。'}
    ]},
    {id:'e4_5',title:'新中国成立',description:'1949年10月1日，天安门城楼上那一声"中国人民从此站起来了"，宣告一个新时代的开始。但新中国面临的挑战堆积如山：百废待兴、冷战对峙、如何整合这个超大规模的国家？',quote:'"中国人民从此站起来了。" ——毛泽东',choices:[
      {text:'优先工业化，集中力量办大事',effects:{zhongyuan:{p:2,m:2,c:0,t:0},caoyuan:{p:1,m:1,c:0,t:0},xiyu:{p:1,m:0,c:0,t:0}},consequence:'重工业基础建立，但农业和消费品不足。'},
      {text:'均衡发展，工农并重',effects:{zhongyuan:{p:1,m:1,c:1,t:1},xinan:{p:1,m:0,c:1,t:0},guodu:{p:1,m:0,c:0,t:0}},consequence:'发展较均衡，但速度较慢，国际环境不等人。'},
      {text:'发展教育和科技，百年大计',effects:{zhongyuan:{p:0,m:0,c:3,t:1},gaoyuan:{p:0,m:0,c:1,t:0},haiyang:{p:0,m:0,c:1,t:1}},consequence:'人才储备丰厚，为未来腾飞打下根基。'}
    ]},
    {id:'e4_6',title:'改革开放',description:'1978年，一个历史性的转折。小岗村十八个红手印，深圳渔村变特区。中国重新打开了面向世界的大门，四亿劳动力即将成为全球经济的巨大变量。超大规模，从诅咒变为祝福。',quote:'"不管黑猫白猫，抓到老鼠就是好猫。" ——邓小平',choices:[
      {text:'大胆开放，全面融入世界',effects:{haiyang:{p:3,m:0,c:0,t:3},zhongyuan:{p:2,m:0,c:0,t:2},xiyu:{p:0,m:0,c:0,t:1}},consequence:'经济起飞，沿海繁荣，但地区差距拉大。'},
      {text:'渐进开放，摸着石头过河',effects:{haiyang:{p:2,m:0,c:0,t:2},zhongyuan:{p:2,m:1,c:1,t:1},guodu:{p:1,m:0,c:0,t:1}},consequence:'风险可控的发展，速度稍慢但更稳健。'},
      {text:'自力更生为主，选择性开放',effects:{zhongyuan:{p:2,m:2,c:1,t:0},caoyuan:{p:1,m:0,c:0,t:0}},consequence:'独立性强，但可能错过全球化的最佳窗口。'}
    ]},
    {id:'e4_7',title:'加入WTO',description:'2001年，中国加入世界贸易组织。超大规模的劳动力与全球市场对接，"世界工厂"诞生。中国在全球产业链中找到了独特的位置——连接发达国家和发展中国家的枢纽。',quote:'"与国际接轨。"',choices:[
      {text:'全面开放市场，深度参与全球化',effects:{haiyang:{p:2,m:0,c:0,t:3},zhongyuan:{p:2,m:0,c:-1,t:2},xiyu:{p:1,m:0,c:0,t:2}},consequence:'GDP飞速增长，但传统产业和文化受到冲击。'},
      {text:'有选择地开放，保护关键产业',effects:{zhongyuan:{p:2,m:1,c:1,t:2},haiyang:{p:1,m:0,c:0,t:2}},consequence:'经济稳步增长，关键产业得到保护和培育。'},
      {text:'以开放促改革，倒逼内部升级',effects:{zhongyuan:{p:1,m:0,c:2,t:2},haiyang:{p:1,m:0,c:1,t:2},xinan:{p:1,m:0,c:0,t:1}},consequence:'改革深化，各领域都在变，但阵痛也在所难免。'}
    ]},
    {id:'e4_8',title:'一带一路',description:'从古丝绸之路到21世纪海上丝绸之路，中国重新编织连接世界的网络。这不仅是贸易通道，更是一个超大规模国家试图重新定义自己与世界关系的宏大叙事。',quote:'"共商、共建、共享。"',choices:[
      {text:'大力推进，构建全球网络',effects:{xiyu:{p:2,m:0,c:1,t:3},haiyang:{p:2,m:0,c:0,t:2},gaoyuan:{p:1,m:0,c:1,t:1},caoyuan:{p:1,m:0,c:0,t:1}},consequence:'全球影响力大增，枢纽地位初步确立，但投入巨大。'},
      {text:'先近后远，稳扎稳打',effects:{xiyu:{p:1,m:0,c:1,t:2},caoyuan:{p:1,m:0,c:0,t:1},zhongyuan:{p:1,m:0,c:0,t:1}},consequence:'周边关系改善，区域枢纽逐步形成。'},
      {text:'经济为主，文化为辅',effects:{xiyu:{p:1,m:0,c:0,t:2},haiyang:{p:1,m:0,c:0,t:2},zhongyuan:{p:1,m:0,c:0,t:1}},consequence:'务实推进，经济效益明显，但缺乏深层文化纽带。'}
    ]},
    // 终局
    {id:'e4_T',title:'【终局】何谓中国？',description:'三千年跌宕起伏，从封建到平民，从闭关到开放。五大空间的互动塑造了一个独一无二的文明体系。现在，最终的问题摆在面前：中国将以什么姿态面对下一个三千年？',quote:'"周虽旧邦，其命维新。" ——《诗经》',isTransformation:true,isFinale:true,choices:[
      {text:'天下枢纽：多元共生，连接海陆',effects:{zhongyuan:{p:2,m:1,c:2,t:2},caoyuan:{p:1,m:0,c:1,t:1},xiyu:{p:1,m:0,c:1,t:2},gaoyuan:{p:1,m:0,c:1,t:1},xinan:{p:1,m:0,c:1,t:1},haiyang:{p:2,m:0,c:1,t:2},guodu:{p:1,m:0,c:1,t:1}},consequence:'天下枢纽',ending:'pivot'},
      {text:'中原帝国：以中原为本，辐射四方',effects:{zhongyuan:{p:3,m:2,c:2,t:1},caoyuan:{p:0,m:0,c:0,t:0},xiyu:{p:0,m:0,c:0,t:0}},consequence:'中原帝国',ending:'empire'},
      {text:'海洋时代：拥抱大海，融入世界',effects:{haiyang:{p:3,m:2,c:1,t:3},zhongyuan:{p:1,m:0,c:0,t:1}},consequence:'海洋时代',ending:'ocean'}
    ]}
  ]
};

const ENDINGS = {
  pivot: {title:'天下枢纽',desc:'你选择了多元共生之路。\n\n七大空间均衡发展，中原与草原握手言和，\n西域丝路再度繁华，海洋连通四海。\n\n中国不是某一个空间的独奏，\n而是所有空间的交响。\n\n正如施展所言：中国之所以成为枢纽，\n正因为它内在地就是一个体系。'},
  empire:{title:'中原帝国',desc:'你选择了以中原为本的道路。\n\n中原强盛，文明辉煌，\n但草原依旧不驯，西域渐行渐远，\n海洋成了别人的天下。\n\n一个伟大的帝国，但不是枢纽。\n历史证明：单一中心无法承载"中国"的全部含义。'},
  ocean: {title:'海洋时代',desc:'你选择了拥抱海洋的道路。\n\n沿海繁荣，贸易发达，\n与世界深度融合。\n但内陆被遗忘，草原与高原疏离，\n"中国"的概念收窄为一个沿海国家。\n\n或许繁荣，但失去了三千年积淀的深度。'},
  balanced:{title:'守成之局',desc:'你没有做出极端选择。\n\n各方面都还过得去，但没有突破。\n中国依然是那个中国，\n不好不坏，不上不下。\n\n历史不会记住平庸的选择。'},
  chaos:  {title:'天下大乱',desc:'你的选择导致了灾难。\n\n各空间分崩离析，\n中原衰败，草原入侵，\n海洋被封锁，西域断联。\n\n"中国"这个概念本身都岌岌可危。\n也许下一次，你会做出不同的选择。'}
};

// ==================== 游戏状态 ====================

let G = {
  era: 1,
  turn: 0,
  eventIdx: 0,
  regions: {},
  totalPower: 50,
  totalMorale: 50,
  totalCulture: 50,
  log: [],
  choices: [],
  mandateScore: 0,
  eraStartSnapshot: null,
  unlockedAchievements: []
};

// ==================== 防重入 & 计时器 ====================
let _mandateTimer = null;

// ==================== 成就定义 ====================
const ACHIEVEMENTS = [
  {id:'peak',name:'登峰造极',icon:'🏔️',desc:'任一区域属性达到10',check:()=>Object.values(G.regions).some(r=>r.prosperity>=10||r.military>=10||r.culture>=10||r.trade>=10)},
  {id:'ironEmpire',name:'铁血帝国',icon:'⚔️',desc:'总武力超过50',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.military,0)>50},
  {id:'silkRoad',name:'丝路繁华',icon:'🐪',desc:'总商贸超过50',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.trade,0)>50},
  {id:'harmony',name:'天下大同',icon:'☯️',desc:'七区域实力均衡（方差<4）',check:()=>{const v=Object.values(G.regions).map(r=>r.prosperity+r.military+r.culture+r.trade);const a=v.reduce((s,x)=>s+x,0)/v.length;return v.reduce((s,x)=>s+Math.pow(x-a,2),0)/v.length<4;}},
  {id:'cultural',name:'文运昌盛',icon:'📜',desc:'总文化超过50',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.culture,0)>50},
  {id:'prosperous',name:'国富民强',icon:'🏛️',desc:'总繁荣超过55',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.prosperity,0)>55},
  {id:'mandate80',name:'天命所归',icon:'👑',desc:'天命值超过180',check:()=>G.mandateScore>180},
  {id:'explorer',name:'万邦来朝',icon:'🌏',desc:'所有区域商贸≥5',check:()=>Object.values(G.regions).every(r=>r.trade>=5)}
];

function initRegions() {
  G.regions = {};
  for (let k in REGION_META) {
    G.regions[k] = {prosperity:5,military:5,culture:5,trade:5};
  }
  G.regions.zhongyuan = {prosperity:8,military:6,culture:8,trade:5};
  G.regions.caoyuan = {prosperity:4,military:8,culture:3,trade:4};
  G.regions.xiyu = {prosperity:4,military:4,culture:5,trade:7};
}

// ==================== 渲染函数 ====================

function renderRegionList() {
  const el = document.getElementById('region-list');
  const keys = Object.keys(REGION_META);
  const existingCards = el.querySelectorAll('.region-card');

  if (existingCards.length === keys.length) {
    // Diff update: only update stat-fill widths
    keys.forEach((k, i) => {
      const r = G.regions[k];
      const fills = existingCards[i].querySelectorAll('.stat-fill');
      if (fills[0]) fills[0].style.width = r.prosperity * 10 + '%';
      if (fills[1]) fills[1].style.width = r.military * 10 + '%';
      if (fills[2]) fills[2].style.width = r.culture * 10 + '%';
      if (fills[3]) fills[3].style.width = r.trade * 10 + '%';
    });
  } else {
    // Initial render
    let html = '';
    for (let k in REGION_META) {
      const m = REGION_META[k], r = G.regions[k];
      html += `<div class="region-card" onclick="selectRegion('${k}')">
        <div class="region-name"><span class="region-dot" style="background:${m.color}"></span>${m.name}</div>
        <div class="stat-bars">
          <div class="stat-row"><span class="stat-label">兴</span><div class="stat-bar"><div class="stat-fill" style="width:${r.prosperity*10}%;background:${m.color}"></div></div></div>
          <div class="stat-row"><span class="stat-label">武</span><div class="stat-bar"><div class="stat-fill" style="width:${r.military*10}%;background:${m.color}"></div></div></div>
          <div class="stat-row"><span class="stat-label">文</span><div class="stat-bar"><div class="stat-fill" style="width:${r.culture*10}%;background:${m.color}"></div></div></div>
          <div class="stat-row"><span class="stat-label">商</span><div class="stat-bar"><div class="stat-fill" style="width:${r.trade*10}%;background:${m.color}"></div></div></div>
        </div>
      </div>`;
    }
    el.innerHTML = html;
  }
}

function renderMap() {
  const g = document.getElementById('map-nodes');
  const keys = Object.keys(REGION_META);
  const existingNodes = g.querySelectorAll('.region-node');

  if (existingNodes.length === keys.length) {
    // Diff update: only update circle r and text content
    keys.forEach((k, i) => {
      const m = REGION_META[k], r = G.regions[k];
      const total = r.prosperity + r.military + r.culture + r.trade;
      const radius = Math.max(20, Math.min(40, 15 + total * 0.8));
      const node = existingNodes[i];
      const circle = node.querySelector('.node-circle');
      const valueText = node.querySelector('.node-value');
      if (circle) circle.setAttribute('r', radius);
      if (valueText) valueText.textContent = total;
    });
  } else {
    // Initial render: create all nodes
    let html = '';
    keys.forEach((k, i) => {
      const m = REGION_META[k], r = G.regions[k];
      const total = r.prosperity + r.military + r.culture + r.trade;
      const radius = Math.max(20, Math.min(40, 15 + total * 0.8));
      const breatheDelay = (i * 0.7).toFixed(1);
      html += `<g class="region-node" onclick="selectRegion('${k}')">
        <circle class="node-circle" cx="${m.x}" cy="${m.y}" r="${radius}" fill="${m.color}" opacity="0.7" stroke="${m.color}" stroke-width="2" style="animation:nodeBreathe 4s ease-in-out ${breatheDelay}s infinite;"/>
        <text class="node-label" x="${m.x}" y="${m.y-2}">${m.name}</text>
        <text class="node-value" x="${m.x}" y="${m.y+14}">${total}</text>
      </g>`;
    });
    g.innerHTML = html;
  }
}

function renderTopBar() {
  document.getElementById('era-display').textContent = ERA_NAMES[G.era];
  document.getElementById('turn-num').textContent = G.turn;
  let p=0,m=0,c=0;
  for (let k in G.regions) {
    const r = G.regions[k];
    p += r.prosperity; m += r.military; c += r.culture;
  }
  const oldP = G.totalPower, oldM = G.totalMorale, oldC = G.totalCulture;
  G.totalPower = p; G.totalMorale = m; G.totalCulture = c;

  // Animate resource numbers
  animateResNum('res-power', oldP, p);
  animateResNum('res-morale', oldM, m);
  animateResNum('res-culture', oldC, c);
}

function animateResNum(elId, oldVal, newVal) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (oldVal === newVal) { el.textContent = newVal; return; }
  const diff = newVal - oldVal;
  // Add flash class
  const cls = diff > 0 ? 'res-changed-up' : 'res-changed-down';
  el.classList.remove('res-changed-up','res-changed-down');
  void el.offsetWidth;
  el.classList.add(cls);
  // Counting animation
  let current = oldVal;
  const steps = 12;
  const stepVal = diff / steps;
  let step = 0;
  const t = setInterval(() => {
    step++;
    current += stepVal;
    el.textContent = Math.round(current);
    if (step >= steps) {
      clearInterval(t);
      el.textContent = newVal;
    }
  }, 35);
  setTimeout(() => el.classList.remove(cls), 700);
}

function calculateMandateScore() {
  let totalScore = 0;
  for (let k in G.regions) {
    const r = G.regions[k];
    totalScore += r.prosperity + r.military + r.culture + r.trade;
  }
  const vals = Object.values(G.regions).map(r => r.prosperity + r.military + r.culture + r.trade);
  const avg = vals.reduce((a,b) => a+b, 0) / vals.length;
  const variance = vals.reduce((a,v) => a + Math.pow(v-avg, 2), 0) / vals.length;
  totalScore += Math.max(0, Math.round(30 - variance));
  return totalScore;
}

function animateMandateScore(newScore) {
  const el = document.getElementById('mandate-val');
  const container = document.getElementById('mandate-display');
  const oldScore = G.mandateScore;
  if (newScore === oldScore) return;
  // Clear any existing animation timer
  if (_mandateTimer !== null) {
    clearInterval(_mandateTimer);
    _mandateTimer = null;
  }
  const diff = newScore - oldScore;
  const cls = diff > 0 ? 'pulse-up' : 'pulse-down';
  container.classList.remove('pulse-up','pulse-down');
  void container.offsetWidth;
  container.classList.add(cls);
  const steps = 20;
  const stepVal = diff / steps;
  let current = oldScore;
  let step = 0;
  _mandateTimer = setInterval(() => {
    step++;
    current += stepVal;
    el.textContent = Math.round(current);
    if (step >= steps) {
      clearInterval(_mandateTimer);
      _mandateTimer = null;
      el.textContent = newScore;
      G.mandateScore = newScore;
    }
  }, 30);
}

function addLog(text) {
  G.log.unshift({turn:G.turn, era:G.era, text});
  const el = document.getElementById('history-log');
  let html = '';
  G.log.slice(0,50).forEach(l => {
    html += `<div class="log-entry"><span class="log-turn">[${ERA_NAMES[l.era].slice(0,3)} ${l.turn}]</span>${l.text}</div>`;
  });
  el.innerHTML = html;
}

// ==================== 事件系统 ====================

function assessRisk(choice) {
  let negCount = 0, negSum = 0;
  for (let region in choice.effects) {
    const eff = choice.effects[region];
    for (let v of [eff.p,eff.m,eff.c,eff.t]) {
      if (v && v < 0) { negCount++; negSum += Math.abs(v); }
    }
  }
  if (negSum >= 4 || negCount >= 3) return 'high';
  if (negSum >= 2 || negCount >= 2) return 'medium';
  return 'low';
}

function showEvent() {
  const events = EVENTS[G.era];
  if (!events || G.eventIdx >= events.length) {
    if (G.era < 4) {
      nextEra();
    } else {
      showEnding();
    }
    return;
  }

  const ev = events[G.eventIdx];
  const eraTag = document.getElementById('ev-era');
  const titleEl = document.getElementById('ev-title');
  const descEl = document.getElementById('ev-desc');
  const quoteEl = document.getElementById('ev-quote');

  eraTag.textContent = ev.isTransformation ? '⚡ 历史转折点' : ERA_NAMES[G.era];
  titleEl.textContent = ev.title;
  descEl.textContent = ev.description;
  quoteEl.textContent = ev.quote;

  // Reset visibility
  [eraTag,titleEl,descEl,quoteEl].forEach(el => el.classList.remove('visible'));

  let choicesHtml = '';
  ev.choices.forEach((ch, i) => {
    const risk = assessRisk(ch);
    const riskLabel = risk === 'high' ? ' ⚡' : '';
    choicesHtml += `<button class="choice-btn risk-${risk}" onclick="makeChoice(${i})"><span class="choice-num">${['甲','乙','丙'][i]}</span>${ch.text}${riskLabel}</button>`;
  });
  document.getElementById('ev-choices').innerHTML = choicesHtml;

  // Transformation class
  const eventCard = document.getElementById('event-card');
  if (ev.isTransformation) {
    eventCard.classList.add('transformation');
  } else {
    eventCard.classList.remove('transformation');
  }

  document.getElementById('event-overlay').classList.add('active');

  // Staggered reveal (transformation events are 50% slower)
  const pace = ev.isTransformation ? 1.5 : 1.0;
  setTimeout(() => eraTag.classList.add('visible'), 100 * pace);
  setTimeout(() => titleEl.classList.add('visible'), 300 * pace);
  setTimeout(() => descEl.classList.add('visible'), 700 * pace);
  setTimeout(() => quoteEl.classList.add('visible'), 1100 * pace);
  const btns = document.querySelectorAll('#ev-choices .choice-btn');
  btns.forEach((btn, i) => {
    setTimeout(() => btn.classList.add('visible'), (1400 + i * 200) * pace);
  });
}

function makeChoice(idx) {
  if (G._choosing) return;
  G._choosing = true;
  SFX.choiceConfirm();

  const ev = EVENTS[G.era][G.eventIdx];
  const choice = ev.choices[idx];

  // Snapshot stats before change
  const beforeStats = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    beforeStats[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }

  // Apply effects (track actual deltas after clamping)
  const effectTags = [];
  const affectedRegions = new Set();
  for (let region in choice.effects) {
    const eff = choice.effects[region];
    const r = G.regions[region];
    if (!r) continue;
    affectedRegions.add(region);
    if (eff.p) { const before = r.prosperity; r.prosperity = clamp(r.prosperity + eff.p, 0, 10); const actual = r.prosperity - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'兴', val:actual}); }
    if (eff.m) { const before = r.military; r.military = clamp(r.military + eff.m, 0, 10); const actual = r.military - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'武', val:actual}); }
    if (eff.c) { const before = r.culture; r.culture = clamp(r.culture + eff.c, 0, 10); const actual = r.culture - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'文', val:actual}); }
    if (eff.t) { const before = r.trade; r.trade = clamp(r.trade + eff.t, 0, 10); const actual = r.trade - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'商', val:actual}); }
  }

  // Chain reactions
  const chains = applyChainReactions();

  // Screen effect
  screenEffect(ev, choice, effectTags);

  // Record
  G.choices.push({era:G.era, event:ev.id, choice:idx});
  addLog(`${ev.title} → ${choice.text.slice(0,12)}…`);

  // Show result overlay
  document.getElementById('event-overlay').classList.remove('active');
  document.getElementById('res-text').textContent = choice.consequence;

  // Build effect tags (hidden initially)
  let tagsHtml = '';
  effectTags.forEach(t => {
    const cls = t.val > 0 ? 'positive' : 'negative';
    const sign = t.val > 0 ? '+' : '';
    tagsHtml += `<span class="effect-tag ${cls}">${t.region} ${t.stat}${sign}${t.val}</span>`;
  });
  document.getElementById('res-effects').innerHTML = tagsHtml;

  // Hide continue button
  const contBtn = document.getElementById('continue-btn');
  contBtn.classList.add('hidden');

  document.getElementById('result-overlay').classList.add('active');

  // Sequential reveal of effect tags + map pulse
  const tags = document.querySelectorAll('#res-effects .effect-tag');
  let revealIdx = 0;
  const regionGroups = {};
  effectTags.forEach((t, i) => {
    if (!regionGroups[t.regionKey]) regionGroups[t.regionKey] = [];
    regionGroups[t.regionKey].push(i);
  });
  const groupKeys = Object.keys(regionGroups);
  groupKeys.forEach((rk, gi) => {
    setTimeout(() => {
      let hasPos = false, hasNeg = false;
      regionGroups[rk].forEach(ti => {
        if (tags[ti]) {
          tags[ti].classList.add('revealed');
          if (tags[ti].classList.contains('positive')) hasPos = true;
          if (tags[ti].classList.contains('negative')) hasNeg = true;
        }
      });
      // Play appropriate sound for this group
      if (hasNeg) SFX.negativeThud();
      else if (hasPos) SFX.positiveChime();
      pulseMapNode(rk);
    }, 400 * (gi + 1));
  });

  // Show continue after all revealed
  const totalRevealTime = 400 * (groupKeys.length + 1) + 300;
  setTimeout(() => {
    // Show chain notifications after effects
    if (chains.length > 0) {
      showChainNotifications(chains);
    }
  }, totalRevealTime);

  const chainTime = chains.length > 0 ? chains.length * 500 + 800 : 0;
  setTimeout(() => {
    contBtn.classList.remove('hidden');
  }, totalRevealTime + chainTime);

  // Finale handling
  if (ev.isFinale && choice.ending) {
    contBtn._customAction = () => showEnding(choice.ending);
  } else {
    contBtn._customAction = null;
  }

  renderMap();
  renderTopBar();

  // Show stat deltas on region list
  showStatDeltas(beforeStats);
  renderRegionList();

  // Update mandate score
  const newMandate = calculateMandateScore();
  animateMandateScore(newMandate);

  // Update power ranking
  renderPowerRanking();

  // Check achievements
  checkAchievements();
}

function pulseMapNode(regionKey) {
  const nodes = document.querySelectorAll('.region-node');
  const keys = Object.keys(REGION_META);
  const idx = keys.indexOf(regionKey);
  if (idx >= 0 && nodes[idx]) {
    const circle = nodes[idx].querySelector('.node-circle');
    if (circle) {
      circle.classList.remove('pulse');
      void circle.offsetWidth;
      circle.classList.add('pulse');
    }
  }
}

function screenEffect(ev, choice, effectTags) {
  const mainArea = document.getElementById('main-area');
  const title = ev.title;
  const negCount = effectTags.filter(t => t.val < 0).length;
  const bigPos = effectTags.filter(t => t.val >= 3).length;
  const isWar = /战|乱|侵|伐|叛|寇|兵/.test(title);
  const isDisaster = /祸|灾|亡|破|毁/.test(title);
  const isGlory = /盛世|繁华|昌|通|兴邦|变法|开放/.test(title) || ev.isTransformation;

  mainArea.classList.remove('shake','flash-gold','flash-red');
  void mainArea.offsetWidth;

  if (isWar || isDisaster) {
    mainArea.classList.add('shake');
    SFX.warRumble();
    if (negCount >= 3) mainArea.classList.add('flash-red');
  } else if (isGlory || bigPos > 0) {
    mainArea.classList.add('flash-gold');
  } else if (negCount >= 3) {
    mainArea.classList.add('flash-red');
  }

  setTimeout(() => {
    mainArea.classList.remove('shake','flash-gold','flash-red');
  }, 1000);
}

function showStatDeltas(beforeStats) {
  // Will be rendered after renderRegionList via floating numbers
  setTimeout(() => {
    const cards = document.querySelectorAll('.region-card');
    const keys = Object.keys(REGION_META);
    keys.forEach((k, ki) => {
      if (!cards[ki]) return;
      const b = beforeStats[k], a = G.regions[k];
      const statMap = [
        {key:'prosperity', before:b.prosperity, after:a.prosperity},
        {key:'military', before:b.military, after:a.military},
        {key:'culture', before:b.culture, after:a.culture},
        {key:'trade', before:b.trade, after:a.trade}
      ];
      const rows = cards[ki].querySelectorAll('.stat-row');
      statMap.forEach((s, si) => {
        const diff = s.after - s.before;
        if (diff !== 0 && rows[si]) {
          const delta = document.createElement('span');
          delta.className = `stat-delta ${diff > 0 ? 'pos' : 'neg'}`;
          delta.textContent = (diff > 0 ? '+' : '') + diff;
          rows[si].appendChild(delta);
          setTimeout(() => delta.remove(), 1300);
        }
      });
    });
  }, 50);
}

function applyChainReactions() {
  const chains = [];
  const zp = G.regions.zhongyuan.prosperity;
  if (zp > 7) {
    G.regions.caoyuan.military = clamp(G.regions.caoyuan.military + 1, 0, 10);
    G.regions.guodu.trade = clamp(G.regions.guodu.trade + 1, 0, 10);
    chains.push({from:'zhongyuan',to:'caoyuan',text:'中原繁荣 → 草原武力+1'});
    chains.push({from:'zhongyuan',to:'guodu',text:'中原繁荣 → 过渡商贸+1'});
  }
  if (G.regions.caoyuan.military > 8) {
    G.regions.guodu.prosperity = clamp(G.regions.guodu.prosperity - 1, 0, 10);
    chains.push({from:'caoyuan',to:'guodu',text:'草原强盛 → 过渡地带动荡-1'});
  }
  if (G.regions.haiyang.trade > 7) {
    G.regions.xinan.trade = clamp(G.regions.xinan.trade + 1, 0, 10);
    chains.push({from:'haiyang',to:'xinan',text:'海洋通商 → 西南商贸+1'});
  }
  return chains;
}

function showChainNotifications(chains) {
  const container = document.getElementById('chain-notifications');
  container.innerHTML = '';
  chains.forEach((ch, i) => {
    setTimeout(() => {
      const notif = document.createElement('div');
      notif.className = 'chain-notif';
      notif.textContent = '⚡ ' + ch.text;
      container.appendChild(notif);
      highlightConnection(ch.from, ch.to);
      pulseMapNode(ch.to);
      setTimeout(() => notif.remove(), 2600);
    }, i * 500);
  });
}

function highlightConnection(fromKey, toKey) {
  const fromM = REGION_META[fromKey], toM = REGION_META[toKey];
  if (!fromM || !toM) return;
  const lines = document.querySelectorAll('.connection-line');
  lines.forEach(line => {
    const x1=+line.getAttribute('x1'),y1=+line.getAttribute('y1');
    const x2=+line.getAttribute('x2'),y2=+line.getAttribute('y2');
    const matchA = (Math.abs(x1-fromM.x)<5 && Math.abs(y1-fromM.y)<5 && Math.abs(x2-toM.x)<5 && Math.abs(y2-toM.y)<5);
    const matchB = (Math.abs(x2-fromM.x)<5 && Math.abs(y2-fromM.y)<5 && Math.abs(x1-toM.x)<5 && Math.abs(y1-toM.y)<5);
    if (matchA || matchB) {
      line.classList.add('chain-active');
      setTimeout(() => line.classList.remove('chain-active'), 1200);
    }
  });
}

function nextTurn() {
  G._choosing = false;
  document.getElementById('result-overlay').classList.remove('active');
  document.getElementById('event-card').classList.remove('transformation');
  G.turn++;
  G.eventIdx++;
  showEvent();
}

function nextEra() {
  // Compute era summary before advancing
  let summaryText = '';
  if (G.eraStartSnapshot) {
    const deltas = [];
    for (let k in G.regions) {
      const now = G.regions[k];
      const was = G.eraStartSnapshot[k];
      if (!was) continue;
      const totalNow = now.prosperity + now.military + now.culture + now.trade;
      const totalWas = was.prosperity + was.military + was.culture + was.trade;
      const diff = totalNow - totalWas;
      if (diff !== 0) deltas.push(`${REGION_META[k].name} ${diff>0?'+':''}${diff}`);
    }
    if (deltas.length > 0) summaryText = '本纪变化：' + deltas.join('  ');
  }

  G.era++;
  G.eventIdx = 0;

  // Snapshot for next era
  G.eraStartSnapshot = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    G.eraStartSnapshot[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }

  const trans = document.getElementById('era-transition');
  const summary = document.getElementById('era-trans-summary');
  const title = document.getElementById('era-trans-title');
  const line = document.getElementById('era-trans-line');
  const desc = document.getElementById('era-trans-desc');
  const preview = document.getElementById('era-trans-preview');

  // Reset
  summary.style.opacity = '0'; summary.textContent = summaryText;
  title.textContent = ERA_NAMES[G.era]; title.style.opacity = '0'; title.style.letterSpacing = '20px';
  line.style.width = '0';
  desc.textContent = ERA_DESCS[G.era]; desc.style.opacity = '0';
  preview.textContent = G.era < 4 ? `下一纪：${ERA_NAMES[G.era+1]||''}` : ''; preview.style.opacity = '0';

  trans.classList.add('active');
  SFX.eraGong();
  addLog(`═══ 进入${ERA_NAMES[G.era]} ═══`);

  // Phase 1: Summary (0.5s)
  setTimeout(() => { summary.style.transition = 'opacity 0.8s'; summary.style.opacity = '1'; }, 500);
  // Phase 2: Title with letter-spacing collapse (1.5s)
  setTimeout(() => { title.style.transition = 'opacity 1s, letter-spacing 1.2s'; title.style.opacity = '1'; title.style.letterSpacing = '8px'; }, 1500);
  // Phase 3: Line expand (2.8s)
  setTimeout(() => { line.style.width = '200px'; }, 2800);
  // Phase 4: Description (3.5s)
  setTimeout(() => { desc.style.transition = 'opacity 0.8s'; desc.style.opacity = '1'; }, 3500);
  // Phase 5: Preview (4.2s)
  setTimeout(() => { preview.style.transition = 'opacity 0.6s'; preview.style.opacity = '1'; }, 4200);
  // Phase 6: Close (5.5s)
  setTimeout(() => {
    trans.classList.remove('active');
    renderTopBar();
    renderPowerRanking();
    showEvent();
  }, 5500);
}

function showEnding(endingKey) {
  G._choosing = false;
  document.getElementById('result-overlay').classList.remove('active');
  document.getElementById('event-overlay').classList.remove('active');
  document.getElementById('event-card').classList.remove('transformation');

  // 如果没有指定结局，根据状态判断
  if (!endingKey) {
    endingKey = calculateEnding();
  }

  const ending = ENDINGS[endingKey] || ENDINGS.balanced;
  document.getElementById('ending-title').textContent = ending.title;
  document.getElementById('ending-desc').textContent = ending.desc;

  // 计算分数
  let totalScore = 0;
  for (let k in G.regions) {
    const r = G.regions[k];
    totalScore += r.prosperity + r.military + r.culture + r.trade;
  }
  // 均衡度加分
  const vals = Object.values(G.regions).map(r => r.prosperity + r.military + r.culture + r.trade);
  const avg = vals.reduce((a,b) => a+b, 0) / vals.length;
  const variance = vals.reduce((a,v) => a + Math.pow(v-avg, 2), 0) / vals.length;
  const balanceBonus = Math.max(0, Math.round(30 - variance));
  totalScore += balanceBonus;

  document.getElementById('ending-score').textContent = `天命值：${totalScore}（均衡加成 +${balanceBonus}）`;

  document.getElementById('game').classList.remove('active');
  document.getElementById('ending-screen').classList.add('active');
}

function calculateEnding() {
  const totals = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    totals[k] = r.prosperity + r.military + r.culture + r.trade;
  }
  // 判断结局
  const zhTotal = totals.zhongyuan;
  const hyTotal = totals.haiyang;
  const allTotal = Object.values(totals).reduce((a,b) => a+b, 0);
  const avg = allTotal / 7;
  const maxDev = Math.max(...Object.values(totals).map(v => Math.abs(v - avg)));

  if (maxDev < 6 && allTotal > 140) return 'pivot';
  if (zhTotal > 30 && zhTotal > hyTotal * 1.5) return 'empire';
  if (hyTotal > 25 && hyTotal > zhTotal) return 'ocean';
  if (allTotal < 100) return 'chaos';
  return 'balanced';
}

// ==================== 工具函数 ====================

function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function selectRegion(k) {
  document.querySelectorAll('.region-card').forEach(el => el.classList.remove('selected'));
  // 高亮对应的卡片
  const cards = document.querySelectorAll('.region-card');
  const keys = Object.keys(REGION_META);
  const idx = keys.indexOf(k);
  if (idx >= 0 && cards[idx]) cards[idx].classList.add('selected');
}

function saveGame() {
  SFX.click();
  localStorage.setItem('pivot_save', JSON.stringify(G));
  addLog('📜 存档成功');
}

function loadGame() {
  SFX.click();
  const data = localStorage.getItem('pivot_save');
  if (data) {
    // Clear all overlay active states first
    document.getElementById('event-overlay').classList.remove('active');
    document.getElementById('result-overlay').classList.remove('active');
    document.getElementById('era-transition').classList.remove('active');
    document.getElementById('ending-screen').classList.remove('active');
    document.getElementById('event-card').classList.remove('transformation');

    G = JSON.parse(data);
    // Default value protection for old saves
    G.mandateScore = G.mandateScore || 0;
    G.unlockedAchievements = G.unlockedAchievements || [];
    G.eraStartSnapshot = G.eraStartSnapshot || null;
    G._choosing = false;

    renderAll();
    addLog('📜 读档成功');
    showEvent();
  }
}

function showHelp() {
  SFX.click();
  alert('【枢纽：天下之道】\n\n'
    + '你将经历中国3000年历史的四个纪元。\n'
    + '每个事件有三种选择，影响七大空间的发展。\n\n'
    + '四项指标：兴(经济)、武(军事)、文(文化)、商(贸易)\n\n'
    + '核心原则：没有任何一个空间能单独定义"中国"。\n'
    + '多元共生、均衡发展才能达成最佳结局。\n\n'
    + '—— 基于施展《枢纽：3000年的中国》');
}

function renderPowerRanking() {
  const ranked = Object.keys(REGION_META).map(k => {
    const r = G.regions[k];
    return {key:k, name:REGION_META[k].name, color:REGION_META[k].color, total:r.prosperity+r.military+r.culture+r.trade};
  }).sort((a,b) => b.total - a.total);

  let html = '';
  ranked.forEach((item, i) => {
    const crown = i === 0 ? '👑 ' : '';
    html += `<div class="rank-item ${i===0?'rank-1':''}"><span class="rank-dot" style="background:${item.color}"></span>${crown}${item.name} <span class="rank-val">${item.total}</span></div>`;
  });
  document.getElementById('power-ranking').innerHTML = html;

  // Hegemony check
  if (ranked.length >= 2 && ranked[0].total > ranked[1].total * 1.5) {
    showHegemonyNotif(ranked[0].name);
  }
}

function showHegemonyNotif(name) {
  const el = document.getElementById('hegemony-notif');
  el.textContent = `👑 ${name} 称霸天下！`;
  el.style.display = 'block';
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = 'hegemonyPop 3.5s forwards';
  setTimeout(() => { el.style.display = 'none'; }, 3600);
}

function checkAchievements() {
  ACHIEVEMENTS.forEach(ach => {
    if (G.unlockedAchievements.includes(ach.id)) return;
    if (ach.check()) {
      G.unlockedAchievements.push(ach.id);
      showAchievementNotif(ach);
    }
  });
}

function showAchievementNotif(ach) {
  SFX.achieveChime();
  const container = document.getElementById('achievement-container');
  const notif = document.createElement('div');
  notif.className = 'achievement-notif';
  notif.innerHTML = `<span class="ach-icon">${ach.icon}</span>${ach.name}`;
  container.appendChild(notif);
  setTimeout(() => notif.remove(), 3600);
}

function renderAll() {
  renderMap();
  renderRegionList();
  renderTopBar();
  renderPowerRanking();
  const newMandate = calculateMandateScore();
  document.getElementById('mandate-val').textContent = newMandate;
  G.mandateScore = newMandate;
}

// ==================== 启动 ====================

// Opening screen animation
function initStartScreen() {
  // Generate particles: 50 gold particles + 8 ember particles
  const particleContainer = document.getElementById('start-particles');
  if (particleContainer) {
    for (let i = 0; i < 50; i++) {
      const p = document.createElement('div');
      p.className = 'start-particle';
      p.style.left = Math.random() * 100 + '%';
      p.style.top = Math.random() * 100 + '%';
      p.style.setProperty('--dx', (Math.random() * 80 - 40) + 'px');
      p.style.setProperty('--dy', (Math.random() * 80 - 40) + 'px');
      p.style.animationDuration = (8 + Math.random() * 12) + 's';
      p.style.animationDelay = (Math.random() * 6) + 's';
      p.style.width = (1.5 + Math.random() * 2) + 'px';
      p.style.height = p.style.width;
      particleContainer.appendChild(p);
    }
    // Ember particles (larger, orange-red, slow rise)
    for (let i = 0; i < 8; i++) {
      const p = document.createElement('div');
      p.className = 'start-particle ember';
      p.style.left = Math.random() * 100 + '%';
      p.style.top = (60 + Math.random() * 40) + '%';
      p.style.setProperty('--dx', (Math.random() * 40 - 20) + 'px');
      p.style.setProperty('--dy', -(80 + Math.random() * 60) + 'px');
      p.style.animationDuration = (12 + Math.random() * 10) + 's';
      p.style.animationDelay = (Math.random() * 8) + 's';
      const size = (3 + Math.random() * 2) + 'px';
      p.style.width = size;
      p.style.height = size;
      particleContainer.appendChild(p);
    }
  }

  // Title animation with shockwave
  const mainTitle = document.getElementById('main-title');
  const mainSubtitle = document.getElementById('main-subtitle');
  if (mainTitle) {
    mainTitle.style.opacity = '0';
    mainTitle.style.letterSpacing = '40px';
    setTimeout(() => {
      mainTitle.classList.add('animate-in');
      // Trigger shockwave when title appears
      setTimeout(() => {
        const sw = document.getElementById('title-shockwave');
        if (sw) sw.classList.add('active');
      }, 600);
    }, 200);
  }
  if (mainSubtitle) {
    mainSubtitle.style.opacity = '0';
    setTimeout(() => {
      mainSubtitle.classList.add('animate-in');
      // Trigger gold line after subtitle appears
      setTimeout(() => {
        const gl = document.getElementById('title-gold-line');
        if (gl) gl.classList.add('expand');
      }, 400);
    }, 1200);
  }

  // Staggered poem lines
  const poemLines = document.querySelectorAll('.poem-line');
  poemLines.forEach((line, i) => {
    const delay = 1800 + i * 700;
    // Last line (gold) has extra delay + mandate shake
    const extra = line.classList.contains('gold-line') ? 500 : 0;
    setTimeout(() => {
      line.classList.add('visible');
      // "天命在手" shake
      if (line.classList.contains('gold-line')) {
        const screen = document.getElementById('start-screen');
        screen.classList.add('mandate-shake');
        setTimeout(() => screen.classList.remove('mandate-shake'), 500);
      }
    }, delay + extra);
  });

  // Show start button after poems
  const startBtn = document.getElementById('start-btn');
  if (startBtn) {
    startBtn.style.opacity = '0';
    startBtn.style.transition = 'opacity 0.8s ease';
    setTimeout(() => { startBtn.style.opacity = '1'; }, 1800 + poemLines.length * 700 + 600);
  }

  // Bind start button click
  if (startBtn) {
    startBtn.addEventListener('click', startGame);
  }

  // Bind continue button via JS (no HTML onclick)
  const contBtn = document.getElementById('continue-btn');
  if (contBtn) {
    contBtn.addEventListener('click', function() {
      SFX.click();
      if (this._customAction) { this._customAction(); }
      else { nextTurn(); }
    });
  }

  // Bind mute buttons
  document.querySelectorAll('.mute-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      // Init audio context on first interaction
      if (!SFX._initialized) SFX.init();
      SFX.toggleMute();
    });
  });

  // Restore mute state from localStorage on load
  if (localStorage.getItem('pivot_muted') === '1') {
    SFX.muted = true;
    document.querySelectorAll('.mute-btn').forEach(btn => { btn.textContent = '\u{1F507}'; });
  }

  // Start ambient sound on first user interaction with the start screen
  const startScreen = document.getElementById('start-screen');
  const _startAmbient = () => {
    if (!SFX._initialized) SFX.init();
    SFX.ambient();
    startScreen.removeEventListener('click', _startAmbient);
    startScreen.removeEventListener('touchstart', _startAmbient);
  };
  startScreen.addEventListener('click', _startAmbient);
  startScreen.addEventListener('touchstart', _startAmbient, {passive:true});
}

function startGame() {
  // Init audio on first user interaction and play effects
  if (!SFX._initialized) SFX.init();
  SFX.click();
  SFX.fadeOutAmbient(1.5);

  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('game').classList.add('active');
  initRegions();
  G.turn = 1;
  G.era = 1;
  G.eventIdx = 0;
  G.log = [];
  G.choices = [];
  G.mandateScore = 0;
  G._choosing = false;
  G.unlockedAchievements = [];
  // Snapshot for era 1
  G.eraStartSnapshot = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    G.eraStartSnapshot[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }
  renderAll();
  addLog('天命初开，经略天下');

  setTimeout(() => showEvent(), 500);
}

// ==================== 移动端适配 ====================

const isMobile = () => window.innerWidth <= 768;

function initMobile() {
  if (!isMobile()) return;

  // 显示移动端控件
  document.getElementById('btn-toggle-regions').style.display = '';
  document.getElementById('btn-toggle-history').style.display = '';
  document.getElementById('mobile-turn-badge').style.display = '';
  document.getElementById('mobile-power-ranking').style.display = '';

  // 给左面板添加触摸滑动关闭
  setupDrawerSwipe();

  // SVG 地图双指缩放
  setupMapPinchZoom();
}

function toggleRegionDrawer() {
  const panel = document.getElementById('left-panel');
  const overlay = document.getElementById('mobile-overlay');
  const rightPanel = document.getElementById('right-panel');

  // 关闭右侧面板
  rightPanel.classList.remove('mobile-open');

  if (panel.classList.contains('mobile-open')) {
    panel.classList.remove('mobile-open');
    overlay.classList.remove('active');
  } else {
    panel.classList.add('mobile-open');
    overlay.classList.add('active');
  }
}

function toggleHistoryPanel() {
  const panel = document.getElementById('right-panel');
  const overlay = document.getElementById('mobile-overlay');
  const leftPanel = document.getElementById('left-panel');

  // 关闭左侧面板
  leftPanel.classList.remove('mobile-open');

  if (panel.classList.contains('mobile-open')) {
    panel.classList.remove('mobile-open');
    overlay.classList.remove('active');
  } else {
    panel.classList.add('mobile-open');
    overlay.classList.add('active');
  }
}

function closeMobilePanels() {
  document.getElementById('left-panel').classList.remove('mobile-open');
  document.getElementById('right-panel').classList.remove('mobile-open');
  document.getElementById('mobile-overlay').classList.remove('active');
}

function setupDrawerSwipe() {
  const drawer = document.getElementById('left-panel');
  let startY = 0, currentY = 0, isDragging = false;

  drawer.addEventListener('touchstart', (e) => {
    // 仅在抽屉顶部区域触发拖拽
    const rect = drawer.getBoundingClientRect();
    const touchY = e.touches[0].clientY;
    if (touchY - rect.top > 40) return; // 只在把手区域
    startY = e.touches[0].clientY;
    isDragging = true;
  }, { passive: true });

  drawer.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    currentY = e.touches[0].clientY;
    const diff = currentY - startY;
    if (diff > 0) {
      drawer.style.transition = 'none';
      drawer.style.transform = `translateY(${diff}px)`;
    }
  }, { passive: true });

  drawer.addEventListener('touchend', () => {
    if (!isDragging) return;
    isDragging = false;
    const diff = currentY - startY;
    drawer.style.transition = '';
    drawer.style.transform = '';
    if (diff > 80) {
      closeMobilePanels();
    }
  }, { passive: true });
}

function setupMapPinchZoom() {
  const svg = document.getElementById('map-svg');
  if (!svg) return;

  let scale = 1, originX = 300, originY = 225;
  let startDist = 0, startScale = 1;
  let lastPanX = 0, lastPanY = 0;
  let isPanning = false;

  svg.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      startDist = getTouchDist(e.touches);
      startScale = scale;
    } else if (e.touches.length === 1 && scale > 1) {
      lastPanX = e.touches[0].clientX;
      lastPanY = e.touches[0].clientY;
      isPanning = true;
    }
  }, { passive: false });

  svg.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const dist = getTouchDist(e.touches);
      scale = Math.min(3, Math.max(1, startScale * (dist / startDist)));
      applyMapTransform(svg, scale, originX, originY);
    } else if (e.touches.length === 1 && isPanning && scale > 1) {
      const dx = e.touches[0].clientX - lastPanX;
      const dy = e.touches[0].clientY - lastPanY;
      lastPanX = e.touches[0].clientX;
      lastPanY = e.touches[0].clientY;
      originX -= dx / scale;
      originY -= dy / scale;
      originX = Math.max(0, Math.min(600, originX));
      originY = Math.max(0, Math.min(450, originY));
      applyMapTransform(svg, scale, originX, originY);
    }
  }, { passive: false });

  svg.addEventListener('touchend', (e) => {
    if (e.touches.length < 2) {
      isPanning = false;
    }
    // 如果缩放回到1，重置原点
    if (scale <= 1) {
      scale = 1;
      originX = 300;
      originY = 225;
      applyMapTransform(svg, 1, 300, 225);
    }
  }, { passive: true });

  // 双击重置缩放
  let lastTap = 0;
  svg.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300 && e.changedTouches.length === 1) {
      scale = 1;
      originX = 300;
      originY = 225;
      svg.style.transition = 'transform 0.3s';
      applyMapTransform(svg, 1, 300, 225);
      setTimeout(() => { svg.style.transition = ''; }, 300);
    }
    lastTap = now;
  }, { passive: true });
}

function getTouchDist(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

function applyMapTransform(svg, scale, ox, oy) {
  if (scale <= 1) {
    svg.removeAttribute('style');
    return;
  }
  // Use viewBox manipulation for SVG zoom
  const w = 600 / scale, h = 450 / scale;
  const vx = Math.max(0, Math.min(600 - w, ox - w / 2));
  const vy = Math.max(0, Math.min(450 - h, oy - h / 2));
  svg.setAttribute('viewBox', `${vx} ${vy} ${w} ${h}`);
}

// 更新移动端回合显示
function updateMobileTurn() {
  const el = document.getElementById('mobile-turn-num');
  if (el) el.textContent = G.turn;
}

// 移动端势力排行
function renderMobilePowerRanking() {
  if (!isMobile()) return;
  const container = document.getElementById('mobile-power-ranking');
  if (!container) return;
  const ranked = Object.keys(REGION_META).map(k => {
    const r = G.regions[k];
    return {key:k, name:REGION_META[k].name, color:REGION_META[k].color, total:r.prosperity+r.military+r.culture+r.trade};
  }).sort((a,b) => b.total - a.total);

  let html = '';
  ranked.forEach((item, i) => {
    const crown = i === 0 ? '👑 ' : '';
    html += `<div class="rank-item ${i===0?'rank-1':''}"><span class="rank-dot" style="background:${item.color}"></span>${crown}${item.name} <span class="rank-val">${item.total}</span></div>`;
  });
  container.innerHTML = html;
}

// 覆盖原始的 renderPowerRanking 以也刷新移动端
const _origRenderPowerRanking = renderPowerRanking;
renderPowerRanking = function() {
  _origRenderPowerRanking();
  renderMobilePowerRanking();
};

// 覆盖原始的 renderTopBar 以更新移动端回合
const _origRenderTopBar = renderTopBar;
renderTopBar = function() {
  _origRenderTopBar();
  updateMobileTurn();
};

// 响应窗口大小变化
window.addEventListener('resize', () => {
  if (isMobile()) {
    document.getElementById('btn-toggle-regions').style.display = '';
    document.getElementById('btn-toggle-history').style.display = '';
    document.getElementById('mobile-turn-badge').style.display = '';
    document.getElementById('mobile-power-ranking').style.display = '';
  } else {
    document.getElementById('btn-toggle-regions').style.display = 'none';
    document.getElementById('btn-toggle-history').style.display = 'none';
    document.getElementById('mobile-turn-badge').style.display = 'none';
    document.getElementById('mobile-power-ranking').style.display = 'none';
    closeMobilePanels();
    // 重置 SVG viewBox
    const svg = document.getElementById('map-svg');
    if (svg) svg.setAttribute('viewBox', '0 0 600 450');
  }
});

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  initStartScreen();
  initMobile();
});

// 覆盖原始的 startGame 以在启动时初始化移动端
const _origStartGame = startGame;
startGame = function() {
  _origStartGame();
  if (isMobile()) {
    initMobile();
    renderMobilePowerRanking();
    updateMobileTurn();
  }
};
</script>
</body>
</html>
