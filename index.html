<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>枢纽：天下之道</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
@font-face{font-family:'GF';src:local('STKaiti'),local('KaiTi'),local('楷体'),local('serif');}
:root{
  --ink:#1a1a2e;--paper:#f0ebe3;--gold:#c9a96e;--bright-gold:#dbb978;
  --zhongyuan:#b8860b;--caoyuan:#4a7c59;--xiyu:#a0522d;
  --gaoyuan:#4a6fa5;--xinan:#6b8e6b;--haiyang:#2980b9;--guodu:#8b7355;
  --red:#8b2500;--shadow:rgba(0,0,0,0.4);
}
body{font-family:'GF','STKaiti','KaiTi',serif;background:#121218;color:#ddd;overflow:hidden;height:100vh;user-select:none;}

/* ========== 开始画面 ========== */
#start-screen{
  position:fixed;inset:0;z-index:1000;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  background:linear-gradient(180deg,#1a0e05 0%,#2a1508 20%,#3d2010 40%,#1a1520 70%,#0d0d1a 100%);
}
#start-screen::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at 30% 40%,rgba(201,169,110,0.15) 0%,transparent 50%),
             radial-gradient(circle at 70% 60%,rgba(180,130,60,0.1) 0%,transparent 50%);
}
.title-area{position:relative;text-align:center;margin-bottom:40px;}
.title-area h1{font-size:3.2em;color:var(--gold);letter-spacing:12px;text-shadow:0 0 30px rgba(201,169,110,0.3);}
.title-area .subtitle{color:#8a7a5a;font-size:1.1em;letter-spacing:6px;margin-top:8px;}
.title-area .author{color:#5a5040;font-size:0.85em;margin-top:16px;letter-spacing:3px;}
.poem{color:#6a6050;font-size:0.95em;line-height:2.2;text-align:center;margin-bottom:40px;position:relative;}
.start-btn{
  padding:16px 60px;font-size:1.2em;font-family:inherit;cursor:pointer;
  background:linear-gradient(135deg,rgba(201,169,110,0.2),rgba(201,169,110,0.1));
  color:var(--gold);border:1px solid var(--gold);border-radius:4px;
  letter-spacing:6px;transition:all 0.3s;position:relative;
}
.start-btn:hover{background:linear-gradient(135deg,rgba(201,169,110,0.3),rgba(201,169,110,0.15));box-shadow:0 0 30px rgba(201,169,110,0.2);}

/* ========== 主游戏布局 (Crisis Mode) ========== */
#game{display:none;height:100vh;width:100vw;grid-template-columns:1fr;grid-template-rows:auto auto auto 1fr auto;}
#game.active{display:grid;}

/* ========== Timeline Bar ========== */
#timeline-bar{
  grid-column:1/-1;background:linear-gradient(180deg,rgba(18,18,30,0.95),rgba(13,13,26,0.95));
  backdrop-filter:blur(12px);padding:8px 20px;position:relative;z-index:20;
  border-bottom:1px solid rgba(201,169,110,0.15);
}
.timeline-track{position:relative;height:40px;display:flex;align-items:center;}
.timeline-eras{display:flex;width:100%;height:10px;border-radius:5px;overflow:hidden;position:relative;}
.timeline-era-seg{height:100%;position:relative;transition:all 0.3s;}
.timeline-era-seg[data-era="1"]{background:linear-gradient(90deg,#8B6914,#A07828);flex:0.28;}
.timeline-era-seg[data-era="2"]{background:linear-gradient(90deg,#8B2500,#A03020);flex:0.28;}
.timeline-era-seg[data-era="3"]{background:linear-gradient(90deg,#2B4F8C,#3A6BA5);flex:0.28;}
.timeline-era-seg[data-era="4"]{background:linear-gradient(90deg,#1B6B3A,#2D8B4E);flex:0.16;}
.timeline-era-seg.active-era{filter:brightness(1.4);box-shadow:0 0 8px currentColor;}
.timeline-dots{position:absolute;top:0;left:0;right:0;height:100%;display:flex;align-items:center;pointer-events:none;}
.timeline-dot{width:16px;height:16px;border-radius:50%;position:absolute;transform:translateX(-50%);cursor:pointer;pointer-events:auto;transition:all 0.25s;z-index:2;}
.timeline-dot.completed{background:var(--gold);box-shadow:0 0 6px rgba(201,169,110,0.6);}
.timeline-dot.completed:hover{transform:translateX(-50%) scale(1.5);box-shadow:0 0 16px rgba(201,169,110,1);z-index:5;}
.timeline-dot.completed:active{transform:translateX(-50%) scale(1.2);}
.timeline-dot.current{width:18px;height:18px;background:var(--bright-gold);box-shadow:0 0 12px rgba(201,169,110,0.8);animation:dotPulse 1.5s ease-in-out infinite;}
.timeline-dot.future{width:12px;height:12px;background:rgba(201,169,110,0.15);border:1px solid rgba(201,169,110,0.25);}
.timeline-dot.future:hover{background:rgba(201,169,110,0.35);border-color:rgba(201,169,110,0.5);transform:translateX(-50%) scale(1.3);}
.timeline-dot .dot-label{position:absolute;top:calc(100% + 4px);left:50%;transform:translateX(-50%);font-size:0.6em;color:var(--gold);white-space:nowrap;opacity:0;transition:opacity 0.2s;pointer-events:none;}
.timeline-dot:hover .dot-label{opacity:1;}
@keyframes dotPulse{0%,100%{box-shadow:0 0 6px rgba(201,169,110,0.6);}50%{box-shadow:0 0 16px rgba(201,169,110,1),0 0 24px rgba(201,169,110,0.4);}}
.timeline-markers{display:flex;justify-content:space-between;margin-top:2px;font-size:0.6em;color:rgba(201,169,110,0.4);letter-spacing:1px;}
.timeline-marker{position:relative;}
.timeline-tooltip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:rgba(18,18,30,0.95);backdrop-filter:blur(12px);border:1px solid rgba(201,169,110,0.3);border-radius:6px;padding:6px 10px;font-size:0.75em;color:#bbb;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:30;}
.timeline-dot:hover .timeline-tooltip{opacity:1;}

/* ========== 顶部资源栏 ========== */
#top-bar{
  grid-column:1/-1;
  background:linear-gradient(90deg,rgba(13,13,26,0.95),rgba(26,26,48,0.95),rgba(13,13,26,0.95));
  backdrop-filter:blur(12px);
  display:flex;align-items:center;justify-content:space-between;padding:0 20px;
  border-bottom:none;font-size:0.9em;position:relative;height:44px;
}
#top-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 0%,rgba(201,169,110,0.1) 15%,rgba(201,169,110,0.5) 50%,rgba(201,169,110,0.1) 85%,transparent 100%);}
.era-badge{color:var(--gold);font-size:1.05em;letter-spacing:3px;}
.turn-info{color:#8a7a5a;}
.resources{display:flex;gap:16px;}
.res-item{display:flex;align-items:center;gap:3px;color:#aaa;font-size:0.82em;}
.res-item span{color:var(--gold);}
.res-max{color:#555 !important;font-size:0.8em;}
.res-item.critical span{color:#c56b6b;animation:resCriticalPulse 1s infinite;}
@keyframes resCriticalPulse{0%,100%{opacity:1;text-shadow:none;}50%{opacity:0.6;text-shadow:0 0 8px rgba(197,107,107,0.8);}}

/* ========== Main Game Area (Map + Crisis Panel) ========== */
#game-body{
  grid-column:1/-1;display:grid;
  grid-template-columns:55% 45%;
  height:100%;overflow:hidden;position:relative;
}

/* ========== 左侧：地图区 ========== */
#map-area{
  background:radial-gradient(ellipse at 50% 50%,#1a1a28 0%,#121218 70%);
  position:relative;overflow:hidden;
}

/* Game particles */
#game-particles{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0;}
.game-particle{position:absolute;width:2px;height:2px;background:rgba(201,169,110,0.15);border-radius:50%;animation:gameParticleDrift linear infinite;}
@keyframes gameParticleDrift{0%{transform:translateY(0) translateX(0);opacity:0;}10%{opacity:0.6;}90%{opacity:0.6;}100%{transform:translateY(-100vh) translateX(30px);opacity:0;}}

/* SVG 地图 */
#map-svg{width:100%;height:100%;position:relative;z-index:1;}
.region-path{cursor:pointer;stroke:rgba(201,169,110,0.2);stroke-width:1;transition:all 0.6s ease;opacity:0.7;}
.region-path:hover{filter:brightness(1.3);stroke:rgba(201,169,110,0.6);stroke-width:1.5;opacity:0.9;}
.region-path.selected{stroke:var(--bright-gold);stroke-width:2;opacity:0.95;filter:brightness(1.4);}
.region-path.event-affected{animation:eventAffectedPulse 2s ease-in-out infinite;stroke:rgba(201,169,110,0.6);stroke-width:1.5;}
.region-path.choice-hover{animation:choiceHoverGlow 0.8s ease-in-out infinite;stroke:var(--bright-gold);stroke-width:2.5;filter:brightness(1.5) drop-shadow(0 0 8px currentColor);}
@keyframes eventAffectedPulse{0%,100%{opacity:0.75;filter:brightness(1);}50%{opacity:0.95;filter:brightness(1.25);}}
@keyframes choiceHoverGlow{0%,100%{filter:brightness(1.3) drop-shadow(0 0 6px currentColor);}50%{filter:brightness(1.6) drop-shadow(0 0 14px currentColor);}}
.event-background{background:rgba(201,169,110,0.06);border-left:3px solid var(--gold);padding:10px 14px;margin:10px 0;font-size:0.88em;color:#b8a878;line-height:1.7;border-radius:0 4px 4px 0;opacity:0;transform:translateY(10px);transition:opacity 0.4s,transform 0.4s;}
.event-background.visible{opacity:1;transform:translateY(0);}
.event-background .bg-label{color:var(--gold);font-weight:bold;font-size:0.85em;letter-spacing:2px;margin-bottom:4px;}
.rd-dynamics{background:rgba(201,169,110,0.06);border-left:3px solid rgba(201,169,110,0.3);padding:10px 14px;margin:10px 0;font-size:0.85em;color:#a89868;line-height:1.65;border-radius:0 4px 4px 0;}
.rd-dynamics h3{color:var(--gold);margin:0 0 6px;}
.region-node{cursor:pointer;transition:all 0.3s;}
.region-node:hover .node-circle{filter:brightness(1.4) drop-shadow(0 0 12px currentColor);}
.node-circle{transition:all 0.3s;}
.node-glow{pointer-events:none;}
.node-label{fill:#ddd;font-family:'GF',serif;font-size:13px;text-anchor:middle;pointer-events:none;font-weight:bold;text-shadow:0 1px 3px rgba(0,0,0,0.8);}
.node-value{fill:#aaa;font-family:'GF',serif;font-size:10px;text-anchor:middle;pointer-events:none;}
.connection-line{stroke:rgba(201,169,110,0.12);stroke-width:1.5;stroke-dasharray:6,4;fill:none;animation:dashFlow 6s linear infinite;transition:stroke-width 0.5s,stroke-opacity 0.5s,stroke 0.5s;}
.connection-line.trade-high{stroke:rgba(219,185,120,0.7);stroke-width:3;stroke-dasharray:none;}
.connection-line.trade-mid{stroke:rgba(201,169,110,0.35);stroke-width:2;}
.connection-line.trade-low{stroke:rgba(201,169,110,0.06);stroke-width:1;}
@keyframes dashFlow{to{stroke-dashoffset:-20;}}
.trade-dot{fill:var(--bright-gold);opacity:0;filter:drop-shadow(0 0 3px rgba(201,169,110,0.8));}
.trade-dot.active{opacity:0.9;}

/* ========== Map Region Tooltip ========== */
#map-tooltip{
  position:absolute;z-index:25;pointer-events:none;
  background:rgba(18,18,30,0.9);backdrop-filter:blur(16px);
  border:1px solid rgba(201,169,110,0.3);border-radius:10px;
  padding:14px 18px;min-width:200px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
  opacity:0;transform:translateY(8px);transition:opacity 0.25s,transform 0.25s;
}
#map-tooltip.visible{opacity:1;transform:translateY(0);}
#map-tooltip .tt-name{color:var(--bright-gold);font-size:1.1em;letter-spacing:2px;margin-bottom:2px;}
#map-tooltip .tt-desc{color:#8a7a5a;font-size:0.8em;margin-bottom:8px;}
#map-tooltip .tt-stats{display:grid;grid-template-columns:1fr 1fr;gap:4px;}
#map-tooltip .tt-stat{display:flex;align-items:center;gap:4px;font-size:0.8em;color:#aaa;}
#map-tooltip .tt-stat-label{width:16px;color:var(--gold);}
#map-tooltip .tt-stat-bar{flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;}
#map-tooltip .tt-stat-fill{height:100%;border-radius:3px;transition:width 0.3s;}
#map-tooltip .tt-stat-val{width:18px;text-align:right;font-size:0.85em;color:var(--gold);}

/* ========== 右侧：Crisis Briefing Panel ========== */
#crisis-panel{
  background:rgba(18,18,30,0.85);backdrop-filter:blur(12px);
  border-left:1px solid rgba(201,169,110,0.15);
  display:flex;flex-direction:column;overflow:hidden;position:relative;
}
/* Animated gradient border on left edge */
#crisis-panel::before{
  content:'';position:absolute;left:-1px;top:0;bottom:0;width:2px;z-index:2;
  background:linear-gradient(180deg,transparent,var(--gold),rgba(201,169,110,0.3),var(--gold),transparent);
  background-size:100% 200%;animation:borderGradientFlow 4s linear infinite;
}
@keyframes borderGradientFlow{0%{background-position:0 0;}100%{background-position:0 200%;};}

/* Crisis type tinting */
#crisis-panel.crisis-war{background:rgba(30,15,15,0.88);}
#crisis-panel.crisis-gov{background:rgba(30,25,12,0.88);}
#crisis-panel.crisis-trade{background:rgba(12,20,35,0.88);}
#crisis-panel.crisis-culture{background:rgba(25,15,35,0.88);}
#crisis-panel.crisis-transform{background:rgba(30,28,12,0.88);}
#crisis-panel.crisis-finale{background:rgba(25,22,10,0.9);}

#crisis-content{
  flex:1;overflow-y:auto;padding:24px 24px 16px;
  scrollbar-width:thin;scrollbar-color:rgba(201,169,110,0.2) transparent;
}

/* Crisis Level Tag */
.crisis-tag{
  display:inline-flex;align-items:center;gap:6px;
  font-size:0.8em;padding:4px 12px;border-radius:16px;
  letter-spacing:1px;margin-bottom:10px;
  border:1px solid;
}
.crisis-tag.tag-war{color:#e74c3c;border-color:rgba(231,76,60,0.4);background:rgba(231,76,60,0.08);text-shadow:0 0 8px rgba(231,76,60,0.3);}
.crisis-tag.tag-gov{color:#dbb978;border-color:rgba(219,185,120,0.4);background:rgba(219,185,120,0.08);text-shadow:0 0 8px rgba(219,185,120,0.3);}
.crisis-tag.tag-trade{color:#3498db;border-color:rgba(52,152,219,0.4);background:rgba(52,152,219,0.08);text-shadow:0 0 8px rgba(52,152,219,0.3);}
.crisis-tag.tag-culture{color:#9b59b6;border-color:rgba(155,89,182,0.4);background:rgba(155,89,182,0.08);text-shadow:0 0 8px rgba(155,89,182,0.3);}
.crisis-tag.tag-transform{color:#f1c40f;border-color:rgba(241,196,15,0.5);background:rgba(241,196,15,0.1);text-shadow:0 0 10px rgba(241,196,15,0.4);animation:transformPulse 2s infinite;}
.crisis-tag.tag-finale{color:#f1c40f;border-color:rgba(241,196,15,0.6);background:linear-gradient(135deg,rgba(241,196,15,0.1),rgba(201,169,110,0.1));text-shadow:0 0 12px rgba(241,196,15,0.5);animation:finalePulse 1.5s infinite;}
@keyframes transformPulse{0%,100%{box-shadow:0 0 4px rgba(241,196,15,0.2);}50%{box-shadow:0 0 16px rgba(241,196,15,0.5);}}
@keyframes finalePulse{0%,100%{box-shadow:0 0 6px rgba(241,196,15,0.3);}50%{box-shadow:0 0 20px rgba(241,196,15,0.6),0 0 40px rgba(201,169,110,0.2);}}

.event-progress-bar{height:4px;background:linear-gradient(90deg,var(--gold),var(--bright-gold));border-radius:2px;transition:width 0.5s ease;margin-bottom:10px;box-shadow:0 0 6px rgba(201,169,110,0.25);}
.event-title{font-size:2.2em;color:var(--bright-gold);margin-bottom:8px;letter-spacing:4px;line-height:1.3;font-weight:bold;text-align:center;}
.event-desc{font-size:0.92em;color:#aaa;line-height:1.6;margin-bottom:10px;text-align:center;}
.event-expand-btn{font-size:0.75em;color:rgba(201,169,110,0.5);text-align:center;cursor:pointer;padding:4px 0 10px;letter-spacing:1px;transition:color 0.2s;}
.event-expand-btn:hover{color:var(--gold);}
.event-detail-panel{background:rgba(201,169,110,0.03);border-radius:6px;padding:12px;margin-bottom:10px;animation:fadeInUp 0.3s ease;}
.choice-btn{
  display:block;width:100%;padding:14px 16px 10px;margin-bottom:10px;font-family:inherit;
  font-size:0.95em;cursor:pointer;background:rgba(201,169,110,0.04);
  color:#ddd;border:1px solid rgba(201,169,110,0.18);border-radius:8px;
  text-align:left;transition:all 0.2s cubic-bezier(.4,0,.2,1);line-height:1.4;
  position:relative;overflow:hidden;
}
.choice-btn:hover,.choice-btn:active{
  background:rgba(201,169,110,0.12);border-color:var(--gold);color:#fff;
  transform:translateX(6px);box-shadow:0 2px 16px rgba(201,169,110,0.2);
}
.choice-btn.risk-high{border-left:3px solid rgba(139,37,0,0.6);}
.choice-btn.risk-medium{border-left:3px solid rgba(184,134,11,0.5);}
.choice-btn.risk-low{border-left:3px solid rgba(74,124,89,0.5);}
.choice-btn .choice-label{font-weight:bold;color:var(--bright-gold);font-size:1.05em;display:block;margin-bottom:4px;}
.choice-btn .choice-effects{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
.choice-btn .ce-region{font-size:0.8em;padding:2px 8px;border-radius:10px;background:rgba(255,255,255,0.06);display:inline-flex;align-items:center;gap:3px;}
.choice-btn .ce-arrow{font-weight:bold;font-size:0.9em;}
.ce-arrow.up{color:#6bba6b;}.ce-arrow.down{color:#c56b6b;}
.choice-btn .choice-risk{font-size:0.72em;color:#888;position:absolute;top:8px;right:10px;letter-spacing:1px;}
.auto-advance-bar{position:absolute;bottom:0;left:0;height:3px;background:var(--gold);border-radius:2px;animation:autoAdvance 2.5s linear forwards;}
@keyframes autoAdvance{from{width:0}to{width:100%}}

/* Crisis panel border glows by type */
#crisis-panel.crisis-war{border-left-color:rgba(231,76,60,0.4);}
#crisis-panel.crisis-gov{border-left-color:rgba(219,185,120,0.4);}
#crisis-panel.crisis-trade{border-left-color:rgba(52,152,219,0.4);}
#crisis-panel.crisis-culture{border-left-color:rgba(155,89,182,0.4);}
#crisis-panel.crisis-transform #crisis-panel::before{background:linear-gradient(180deg,transparent,#f1c40f,rgba(241,196,15,0.3),#f1c40f,transparent);}

/* ========== Result area (inline in crisis panel) ========== */
.result-section{padding-top:16px;}
.result-event-title{color:var(--gold);font-size:1.1em;letter-spacing:3px;margin-bottom:8px;text-align:center;}
.result-chosen{font-size:0.85em;color:#999;font-style:italic;margin-bottom:12px;text-align:center;}
.result-divider{width:60%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:0 auto 14px;opacity:0.5;}
.result-text{font-size:1em;color:#bbb;line-height:1.8;margin-bottom:16px;text-align:center;}
.effect-tags{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:16px;}
.effect-tag{font-size:0.8em;padding:4px 12px;border-radius:12px;border:1px solid;}
.effect-tag.positive{color:#6bba6b;border-color:rgba(107,186,107,0.3);background:rgba(107,186,107,0.08);}
.effect-tag.negative{color:#c56b6b;border-color:rgba(197,107,107,0.3);background:rgba(197,107,107,0.08);}
.continue-btn{
  display:block;margin:8px auto 0;padding:12px 44px;font-family:inherit;font-size:1em;cursor:pointer;
  background:rgba(201,169,110,0.08);color:var(--gold);border:1px solid var(--gold);
  border-radius:6px;letter-spacing:3px;transition:all 0.25s;
}
.continue-btn:hover{background:rgba(201,169,110,0.18);box-shadow:0 0 20px rgba(201,169,110,0.2);transform:scale(1.03);}

/* No-event placeholder */
.crisis-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#555;font-size:1em;letter-spacing:2px;}

/* ========== History Log Modal ========== */
#history-modal{
  position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);
}
#history-modal.active{display:flex;}
.history-card{
  background:rgba(18,18,30,0.95);backdrop-filter:blur(16px);border:1px solid rgba(201,169,110,0.3);
  border-radius:10px;padding:24px 28px;max-width:480px;width:90%;max-height:75vh;overflow-y:auto;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.history-card h2{color:var(--gold);font-size:1.3em;letter-spacing:4px;margin-bottom:12px;text-align:center;}
.history-log{font-size:0.78em;color:#777;line-height:1.6;}
.log-entry{padding:4px 6px;border-bottom:1px solid rgba(255,255,255,0.05);margin-bottom:2px;}
.log-entry .log-turn{color:var(--gold);margin-right:4px;}
.history-dismiss{
  display:block;margin:12px auto 0;padding:8px 32px;font-family:inherit;font-size:0.95em;cursor:pointer;
  background:rgba(201,169,110,0.08);color:var(--gold);border:1px solid var(--gold);border-radius:4px;letter-spacing:3px;transition:all 0.2s;
}
.history-dismiss:hover{background:rgba(201,169,110,0.18);}

/* ========== 底部栏 ========== */
#bottom-bar{
  grid-column:1/-1;
  background:linear-gradient(90deg,rgba(13,13,26,0.95),rgba(26,26,48,0.95),rgba(13,13,26,0.95));
  backdrop-filter:blur(12px);
  display:flex;align-items:center;justify-content:center;gap:12px;
  padding:0 16px;height:52px;
  border-top:none;position:relative;
}
#bottom-bar::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 0%,rgba(201,169,110,0.1) 15%,rgba(201,169,110,0.4) 50%,rgba(201,169,110,0.1) 85%,transparent 100%);}
#power-ranking{display:flex;align-items:center;gap:8px;flex-wrap:nowrap;margin-right:auto;}
.bottom-btn{
  padding:8px 20px;font-family:inherit;font-size:0.85em;cursor:pointer;
  background:rgba(201,169,110,0.04);color:#888;border:1px solid rgba(255,255,255,0.1);
  border-radius:6px;transition:all 0.25s;letter-spacing:2px;
}
.bottom-btn:hover{color:var(--gold);border-color:rgba(201,169,110,0.3);background:rgba(201,169,110,0.08);transform:scale(1.04);box-shadow:0 0 12px rgba(201,169,110,0.1);}

/* ========== 按钮触感 ========== */
.choice-btn:active{transform:scale(0.97) translateY(1px);filter:brightness(0.85);transition:transform 0.05s;}
.start-btn:active{transform:scale(0.95);}
.continue-btn:active{transform:scale(0.96);}
.bottom-btn:active{transform:scale(0.95);}

/* Hidden utility */
.hidden{opacity:0;pointer-events:none;}

/* ========== 节点呼吸动画 ========== */
@keyframes nodeBreathe{0%,100%{opacity:0.7;}50%{opacity:0.85;}}

/* ========== 转型事件差异化 ========== */
#crisis-panel.crisis-transform{box-shadow:inset 0 0 60px rgba(201,169,110,0.08);}
#crisis-panel.crisis-finale{box-shadow:inset 0 0 80px rgba(201,169,110,0.12);}

/* ========== 效果标签弹性入场 ========== */
@keyframes tagBounceUp{0%{opacity:0;transform:translateY(16px);}60%{opacity:1;transform:translateY(-4px);}100%{opacity:1;transform:translateY(0);}}
@keyframes tagShakeIn{0%{opacity:0;transform:translateX(-8px);}20%{opacity:1;transform:translateX(6px);}40%{transform:translateX(-4px);}60%{transform:translateX(3px);}80%{transform:translateX(-1px);}100%{opacity:1;transform:translateX(0);}}
.effect-tag.revealed.positive{animation:tagBounceUp 0.5s ease-out forwards;}
.effect-tag.revealed.negative{animation:tagShakeIn 0.5s ease-out forwards;}

/* ========== 顶部资源数字动画 ========== */
.res-item span, .ms-val{transition:transform 0.3s, color 0.3s;}
.res-item span.res-changed-up{animation:resNumPop 0.6s;}
.res-item span.res-changed-down{animation:resNumDrop 0.6s;}
@keyframes resNumPop{0%{color:var(--gold);}30%{color:#6bba6b;transform:scale(1.3);}100%{color:var(--gold);transform:scale(1);}}
@keyframes resNumDrop{0%{color:var(--gold);}30%{color:#c56b6b;transform:scale(1.3);}100%{color:var(--gold);transform:scale(1);}}

/* ========== 开场动画相关 ========== */
@keyframes titleGlow{0%,100%{text-shadow:0 0 30px rgba(201,169,110,0.3);}50%{text-shadow:0 0 50px rgba(201,169,110,0.6),0 0 80px rgba(201,169,110,0.2);}}
.title-area h1{animation:titleGlow 3s ease-in-out infinite;}

.poem-line{opacity:0;transform:translateY(12px);transition:opacity 0.8s ease,transform 0.8s ease;}
.poem-line.visible{opacity:1;transform:translateY(0);}
.poem-line.gold-line{color:var(--gold);font-size:1.15em;font-weight:bold;text-shadow:0 0 20px rgba(201,169,110,0.3);}

@keyframes btnPulse{0%,100%{box-shadow:0 0 10px rgba(201,169,110,0.1);}50%{box-shadow:0 0 30px rgba(201,169,110,0.35),0 0 60px rgba(201,169,110,0.1);}}
.start-btn.pulse-glow{animation:btnPulse 2.5s ease-in-out infinite;}

/* ========== 开场粒子效果 ========== */
.start-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none;}
.start-particle{position:absolute;width:2px;height:2px;background:rgba(201,169,110,0.4);border-radius:50%;animation:particleDrift linear infinite;}
@keyframes particleDrift{0%{transform:translate(0,0);opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{transform:translate(var(--dx),var(--dy));opacity:0;}}

/* ========== 标题入场动画 ========== */
@keyframes titleLetterCollapse{0%{letter-spacing:40px;opacity:0;}100%{letter-spacing:12px;opacity:1;}}
@keyframes subtitleFadeUp{0%{opacity:0;transform:translateY(16px);}100%{opacity:1;transform:translateY(0);}}
.title-area h1.animate-in{animation:titleLetterCollapse 1.5s ease-out forwards;}
.title-area .subtitle.animate-in{animation:subtitleFadeUp 0.8s ease-out forwards;}

/* 时代过渡动画 */
#era-transition{
  position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;
  background:#000;
}
#era-transition.active{display:flex;}
#era-transition.era-to-2{background:radial-gradient(ellipse at 50% 50%,rgba(201,169,110,0.08),#000 70%);}
#era-transition.era-to-3{background:radial-gradient(ellipse at 50% 50%,rgba(74,111,165,0.08),#000 70%);}
#era-transition.era-to-4{background:radial-gradient(ellipse at 50% 50%,rgba(74,124,89,0.08),#000 70%);}
/* era-trans styles moved to enhanced section below */

/* 结局画面 */
#ending-screen{
  position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;
  flex-direction:column;background:#000;
}
#ending-screen.active{display:flex;animation:endingFadeIn 2s ease forwards;}
@keyframes endingFadeIn{0%{background:#000;}100%{background:linear-gradient(180deg,#0a0a15,#1a1a30,#0d1520);}}
#ending-screen h1{font-size:2.8em;color:var(--gold);letter-spacing:8px;margin-bottom:16px;opacity:0;transform:scale(0.8);transition:opacity 0.8s ease,transform 1s ease,letter-spacing 1s ease;}
#ending-screen h1.ending-visible{opacity:1;transform:scale(1);letter-spacing:8px;}
#ending-screen .ending-desc{color:#aaa;font-size:1.05em;line-height:2;text-align:center;max-width:500px;margin-bottom:32px;}
#ending-screen .ending-desc .ending-line{opacity:0;transform:translateY(8px);transition:opacity 0.5s ease,transform 0.5s ease;}
#ending-screen .ending-desc .ending-line.ending-visible{opacity:1;transform:translateY(0);}
#ending-screen .score{color:var(--gold);font-size:1.2em;margin-bottom:24px;opacity:0;transition:opacity 0.5s ease;}
#ending-screen .score.ending-visible{opacity:1;}
#ending-screen .start-btn{opacity:0;transition:opacity 0.5s ease;}
#ending-screen .start-btn.ending-visible{opacity:1;}
@keyframes endingBtnPulse{0%,100%{box-shadow:0 0 10px rgba(201,169,110,0.1);}50%{box-shadow:0 0 30px rgba(201,169,110,0.4),0 0 60px rgba(201,169,110,0.15);}}

/* 过渡动画 */
.fade-in{animation:fadeIn 0.3s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

/* 滚动条 */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(201,169,110,0.2);border-radius:2px;}

/* ========== 天命值 ========== */
.mandate-score{display:flex;align-items:center;gap:6px;color:var(--gold);font-size:0.95em;letter-spacing:2px;}
.mandate-score .ms-label{color:#8a7a5a;font-size:0.85em;}
.mandate-score .ms-val{font-size:1.15em;min-width:32px;text-align:center;transition:color 0.3s;}
.mandate-score.pulse-up .ms-val{animation:pulseGreen 0.6s;}
.mandate-score.pulse-down .ms-val{animation:pulseRed 0.6s;}
@keyframes pulseGreen{0%,100%{color:var(--gold);text-shadow:none;}50%{color:#6bba6b;text-shadow:0 0 12px rgba(107,186,107,0.6);}}
@keyframes pulseRed{0%,100%{color:var(--gold);text-shadow:none;}50%{color:#c56b6b;text-shadow:0 0 12px rgba(197,107,107,0.6);}}

/* ========== 效果逐帧揭示 ========== */
.effect-tag{opacity:0;transform:translateY(8px);transition:opacity 0.35s,transform 0.35s;}
.effect-tag.revealed{opacity:1;transform:translateY(0);}

/* ========== 连锁反应飘字 ========== */
#chain-notifications{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:15;display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none;}
.chain-notif{font-size:0.82em;color:var(--bright-gold);background:rgba(0,0,0,0.75);padding:4px 14px;border-radius:12px;border:1px solid rgba(201,169,110,0.3);opacity:0;animation:chainFloat 2.5s forwards;white-space:nowrap;}
@keyframes chainFloat{0%{opacity:0;transform:translateY(10px);}15%{opacity:1;transform:translateY(0);}75%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-12px);}}
.connection-line.chain-active{stroke:var(--bright-gold)!important;stroke-width:3!important;stroke-dasharray:none!important;opacity:1;animation:lineFlash 1.2s;}
@keyframes lineFlash{0%,100%{opacity:0.3;}50%{opacity:1;}}

/* ========== 墨水涟漪效果 ========== */
.ink-ripple{
  position:absolute;border-radius:50%;
  background:rgba(201,169,110,0.2);
  transform:scale(0);animation:inkSpread 0.5s ease-out forwards;
  pointer-events:none;
}
@keyframes inkSpread{to{transform:scale(25);opacity:0;}}

/* ========== 选项效果预览 ========== */
.choice-btn{position:relative;}
.choice-preview{
  display:none;position:absolute;left:24px;right:8px;top:100%;margin-top:2px;
  background:rgba(0,0,0,0.85);border:1px solid rgba(201,169,110,0.2);border-radius:4px;
  padding:6px 10px;font-size:0.75em;line-height:1.6;z-index:5;
  opacity:0;transition:opacity 0.2s ease;pointer-events:none;
  font-style:normal;letter-spacing:0;white-space:normal;
}
.choice-btn:hover .choice-preview{display:block;opacity:1;}
.choice-preview .cp-pos{color:#6bba6b;}
.choice-preview .cp-neg{color:#c56b6b;}
.choice-preview .cp-region{color:var(--gold);margin-right:2px;}

/* ========== 选项风险色带 ========== */
.choice-btn{position:relative;padding-left:24px;overflow:visible;}
.choice-btn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;}
.choice-btn.risk-low::before{background:#4a7c59;}
.choice-btn.risk-medium::before{background:#b8860b;}
.choice-btn.risk-high::before{background:#8b2500;}

/* ========== 屏幕特效 ========== */
@keyframes screenShake{0%,100%{transform:translate(0);}10%{transform:translate(-4px,2px);}20%{transform:translate(3px,-3px);}30%{transform:translate(-3px,4px);}40%{transform:translate(4px,-2px);}50%{transform:translate(-2px,3px);}60%{transform:translate(3px,-1px);}70%{transform:translate(-3px,2px);}80%{transform:translate(2px,-3px);}90%{transform:translate(-1px,1px);}}
#map-area.shake{animation:screenShake 0.5s;}
#map-area.flash-gold::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(201,169,110,0.25) 0%,transparent 70%);pointer-events:none;animation:flashFade 0.8s forwards;z-index:10;}
#map-area.flash-red::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,rgba(180,40,40,0.2) 0%,transparent 70%);pointer-events:none;animation:flashFade 0.8s forwards;z-index:10;}
@keyframes flashFade{0%{opacity:1;}100%{opacity:0;}}

/* ========== 势力排行榜 ========== */
.rank-item{display:flex;align-items:center;gap:3px;font-size:0.78em;color:#999;white-space:nowrap;}
.rank-item .rank-dot{width:6px;height:6px;border-radius:50%;display:inline-block;}
.rank-item .rank-val{color:var(--gold);font-size:0.85em;min-width:16px;text-align:right;}
.rank-item.rank-1{color:var(--bright-gold);font-size:0.88em;}
.rank-item.rank-1 .rank-val{font-weight:bold;}
#hegemony-notif{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:150;background:linear-gradient(135deg,rgba(30,25,15,0.95),rgba(20,18,12,0.95));border:2px solid var(--gold);border-radius:8px;padding:12px 28px;color:var(--bright-gold);font-size:1.1em;letter-spacing:3px;box-shadow:0 0 30px rgba(201,169,110,0.3);opacity:0;pointer-events:none;animation:hegemonyPop 3.5s forwards;}
@keyframes hegemonyPop{0%{opacity:0;transform:translateX(-50%) scale(0.8);}10%{opacity:1;transform:translateX(-50%) scale(1.05);}20%{transform:translateX(-50%) scale(1);}80%{opacity:1;}100%{opacity:0;}}

/* ========== 时代过渡升级 ========== */
.era-trans-content{text-align:center;max-width:520px;}
.era-trans-summary{color:#8a7a5a;font-size:0.9em;line-height:1.8;margin-bottom:20px;opacity:0;}
.era-trans-content h2{font-size:2.5em;color:var(--gold);letter-spacing:20px;margin-bottom:12px;opacity:0;}
.era-trans-line{width:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:12px auto;transition:width 0.8s;}
.era-trans-content p{font-size:1.1em;color:#8a7a5a;letter-spacing:3px;opacity:0;}
.era-trans-preview{color:#6a5a3a;font-size:0.85em;margin-top:16px;opacity:0;letter-spacing:2px;}

/* ========== 属性浮动数字 ========== */
.stat-row{position:relative;}
.stat-delta{position:absolute;right:-28px;top:-2px;font-size:0.75em;font-weight:bold;opacity:0;animation:floatDelta 1.2s forwards;pointer-events:none;}
.stat-delta.pos{color:#6bba6b;}
.stat-delta.neg{color:#c56b6b;}
@keyframes floatDelta{0%{opacity:0;transform:translateY(4px);}20%{opacity:1;transform:translateY(0);}80%{opacity:1;transform:translateY(-8px);}100%{opacity:0;transform:translateY(-14px);}}

/* ========== 事件卡分阶段入场 ========== */
#crisis-content .event-title,#crisis-content .event-desc,#crisis-content .choice-btn{opacity:0;transform:translateY(8px);transition:opacity 0.3s,transform 0.3s;}
#crisis-content .event-title.visible,#crisis-content .event-desc.visible,#crisis-content .choice-btn.visible{opacity:1;transform:translateY(0);}

/* ========== 成就系统 ========== */
#achievement-container{position:fixed;top:60px;right:16px;z-index:160;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.achievement-notif{background:linear-gradient(135deg,rgba(30,25,10,0.95),rgba(20,15,5,0.95));border:1px solid var(--gold);border-radius:6px;padding:10px 18px;color:var(--bright-gold);font-size:0.9em;letter-spacing:2px;box-shadow:0 0 20px rgba(201,169,110,0.25);opacity:0;transform:translateX(40px);animation:achieveSlide 3.5s forwards;}
.achievement-notif .ach-icon{font-size:1.2em;margin-right:6px;}
@keyframes achieveSlide{0%{opacity:0;transform:translateX(40px);}10%{opacity:1;transform:translateX(0);}80%{opacity:1;transform:translateX(0);}100%{opacity:0;transform:translateX(20px);}}

/* ========== 帮助弹窗 ========== */
#help-modal{
  position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);
}
#help-modal.active{display:flex;}
.help-card{
  background:linear-gradient(135deg,#1e1c2a,#181620);border:1px solid rgba(201,169,110,0.3);
  border-radius:8px;padding:28px 32px;max-width:480px;width:90%;max-height:80vh;overflow-y:auto;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.help-card h2{color:var(--gold);font-size:1.4em;letter-spacing:4px;margin-bottom:16px;text-align:center;}
.help-card .help-section{margin-bottom:16px;}
.help-card .help-section h3{color:var(--bright-gold);font-size:1em;margin-bottom:8px;letter-spacing:2px;}
.help-card .help-section p{color:#bbb;font-size:0.9em;line-height:1.8;}
.help-card .help-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0;}
.help-card .help-stat{color:#aaa;font-size:0.85em;padding:4px 8px;background:rgba(201,169,110,0.05);border-radius:4px;border-left:3px solid var(--gold);}
.help-card .help-stat b{color:var(--gold);}
.help-card .help-tip{color:#8a8a7a;font-size:0.85em;font-style:italic;padding:8px 12px;border-left:2px solid rgba(201,169,110,0.2);margin-top:12px;line-height:1.7;}
.help-dismiss{
  display:block;margin:16px auto 0;padding:10px 36px;font-family:inherit;font-size:1em;cursor:pointer;
  background:rgba(201,169,110,0.1);color:var(--gold);border:1px solid var(--gold);
  border-radius:4px;letter-spacing:3px;transition:all 0.2s;
}
.help-dismiss:hover{background:rgba(201,169,110,0.2);}

/* ========== 地图节点脉冲 ========== */
.node-circle.pulse{animation:nodePulse 0.6s;}
@keyframes nodePulse{0%,100%{filter:brightness(1);}50%{filter:brightness(1.6);}}

/* ================================================================
   移动端适配 (max-width: 768px)
   ================================================================ */
@media (max-width: 768px) {
  html { font-size: 16px; }
  body { overflow: hidden; height: 100vh; height: 100dvh; -webkit-tap-highlight-color: transparent; }

  #start-screen { padding: 20px; }
  .title-area { margin-bottom: 24px; }
  .title-area h1 { font-size: 2.2em; letter-spacing: 8px; }
  .title-area .subtitle { font-size: 0.95em; letter-spacing: 4px; }
  .title-area .author { font-size: 0.75em; margin-top: 10px; }
  .poem { font-size: 0.85em; line-height: 2; margin-bottom: 28px; padding: 0 12px; }
  .start-btn { padding: 14px 44px; font-size: 1.1em; letter-spacing: 4px; min-height: 48px; min-width: 180px; }

  /* Mobile: tab switching mode */
  #game { grid-template-rows: auto auto auto 1fr auto !important; }
  #game-body { grid-template-columns: 1fr !important; grid-template-rows: 1fr !important; }

  #timeline-bar { padding: 6px 10px; }
  .timeline-track { height: 24px; }
  .timeline-markers { font-size: 0.5em; }

  #top-bar { padding: 0 10px; font-size: 0.78em; height: 40px; gap: 6px; overflow: hidden; }
  .era-badge { font-size: 0.88em; letter-spacing: 1px; white-space: nowrap; flex-shrink: 0; }
  .turn-info { display: none; }
  .mandate-score { flex-shrink: 0; }
  .mandate-score .ms-label { font-size: 0.8em; }
  .mandate-score .ms-val { font-size: 1em; }
  .resources { gap: 6px; flex-shrink: 1; overflow: hidden; }
  .res-item { font-size: 0.75em; white-space: nowrap; }

  #map-area { min-height: 0; }
  #map-tooltip { display: none !important; } /* Use tap instead on mobile */

  #crisis-panel::before { display: none; }
  #crisis-content { padding: 16px 14px 12px; }
  .event-title { font-size: 1.4em; letter-spacing: 1px; }
  .event-desc { font-size: 0.95em; line-height: 1.8; }
  .event-quote { font-size: 0.88em; padding-left: 10px; }
  .choice-btn { padding: 16px 16px 16px 24px; font-size: 0.95em; min-height: 54px; margin-bottom: 10px; }
  .choice-btn:active { background: rgba(201,169,110,0.18); border-color: var(--gold); }
  .continue-btn { padding: 16px 44px; font-size: 1.05em; min-height: 52px; }
  .event-progress-bar { height: 5px; margin-bottom: 16px; }
  .event-icon-scene { height: 60px; margin-bottom: 8px; }
  .result-stat-card { min-width: 50px; padding: 6px 8px; }
  .result-stat-card .rsc-val { font-size: 1.3em; }
  .event-bg-toggle { padding: 6px 0; }

  #bottom-bar { height: 44px; gap: 6px; padding: 0 8px; overflow-x: auto; justify-content: flex-start; }
  #power-ranking { display: none; }
  .bottom-btn { padding: 8px 14px; font-size: 0.82em; min-height: 36px; flex-shrink: 0; }

  #era-transition { padding: 20px; }
  .era-trans-content { max-width: 90vw; }
  .era-trans-content h2 { font-size: 1.8em; letter-spacing: 12px; }
  .era-trans-summary { font-size: 0.82em; }

  #ending-screen { padding: 20px; }
  #ending-screen h1 { font-size: 2em; letter-spacing: 6px; }
  #ending-screen .ending-desc { font-size: 0.92em; max-width: 90vw; }

  #achievement-container { right: 8px; top: 50px; }
  .achievement-notif { font-size: 0.82em; padding: 8px 14px; }
  #hegemony-notif { top: 50px; font-size: 0.95em; }
  .chain-notif { font-size: 0.75em; padding: 3px 10px; }
  .help-card { padding: 20px 16px; max-height: 85vh; }
  .choice-preview { font-size: 0.7em; }
  .choice-btn:active .choice-preview { display:block; opacity:1; }

  button, .choice-btn, .bottom-btn { cursor: pointer; -webkit-tap-highlight-color: transparent; }
  .choice-btn, .bottom-btn, #top-bar, #bottom-bar { user-select: none; -webkit-user-select: none; }
}

@media (max-width: 380px) {
  .title-area h1 { font-size: 1.8em; letter-spacing: 6px; }
  .poem { font-size: 0.8em; }
  .start-btn { padding: 12px 32px; font-size: 1em; }
  #top-bar { padding: 0 6px; font-size: 0.72em; }
  .event-title { font-size: 1.2em; }
  .event-desc { font-size: 0.85em; }
  #ending-screen h1 { font-size: 1.6em; }
}

/* ================================================================
   史诗级开场视觉升级
   ================================================================ */

/* --- 底层：移动的星空 --- */
#start-screen .stars-layer{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:0;
}
#start-screen .stars-layer::before,
#start-screen .stars-layer::after{
  content:'';position:absolute;width:200%;height:200%;left:-50%;top:-50%;
  animation:starsDrift 60s linear infinite;
}
#start-screen .stars-layer::before{
  background:
    radial-gradient(1px 1px at 5% 8%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 12% 22%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 18% 45%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 25% 13%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 32% 67%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 38% 82%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 44% 5%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 50% 35%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 55% 55%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 60% 90%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1px 1px at 65% 18%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 70% 42%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 75% 72%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 80% 3%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 85% 58%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 90% 28%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 95% 80%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 3% 52%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 8% 95%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 15% 70%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 22% 38%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 28% 88%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1px 1px at 35% 15%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 42% 60%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 48% 78%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 53% 10%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 58% 48%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 63% 85%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 68% 25%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1px 1px at 73% 62%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 78% 40%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 83% 75%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 88% 12%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 93% 50%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 97% 33%, rgba(255,255,255,0.4) 50%, transparent 50%);
  background-size:100% 100%;
}
#start-screen .stars-layer::after{
  background:
    radial-gradient(1px 1px at 2% 30%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 7% 65%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 13% 10%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 20% 85%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 27% 48%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 33% 20%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 40% 73%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 47% 92%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 52% 40%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 57% 15%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 62% 58%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 67% 78%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 72% 33%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 77% 88%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 82% 52%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 87% 8%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 92% 68%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 96% 42%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 4% 77%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 10% 55%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 16% 35%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 23% 5%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 30% 62%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 36% 95%, rgba(255,255,255,0.7) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 43% 25%, rgba(201,169,110,0.4) 50%, transparent 50%),
    radial-gradient(1px 1px at 49% 50%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 54% 83%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.5px 1.5px at 59% 70%, rgba(201,169,110,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 64% 2%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 69% 45%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 74% 18%, rgba(255,255,255,0.4) 50%, transparent 50%),
    radial-gradient(1.2px 1.2px at 79% 60%, rgba(201,169,110,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 84% 38%, rgba(255,255,255,0.5) 50%, transparent 50%),
    radial-gradient(1px 1px at 89% 90%, rgba(255,255,255,0.6) 50%, transparent 50%),
    radial-gradient(1px 1px at 94% 22%, rgba(255,255,255,0.5) 50%, transparent 50%);
  background-size:100% 100%;
  animation-delay:-30s;
}
@keyframes starsDrift{
  0%{transform:translateY(0);}
  100%{transform:translateY(50%);}
}

/* --- 中层：远山剪影 --- */
#start-screen .mountains-layer{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:1;
}
.mountain-far,.mountain-mid,.mountain-near{
  position:absolute;bottom:0;width:120%;left:-10%;
}
.mountain-far{
  height:28%;
  background:linear-gradient(180deg, transparent 0%, #1a0e05 100%);
  clip-path:polygon(0% 100%, 0% 65%, 5% 55%, 12% 40%, 18% 50%, 25% 30%, 32% 45%, 38% 25%, 44% 38%, 50% 20%, 56% 35%, 62% 22%, 68% 40%, 75% 28%, 82% 42%, 88% 32%, 94% 48%, 100% 38%, 100% 100%);
  opacity:0.5;
  animation:mountainDriftLeft 80s linear infinite alternate;
}
.mountain-mid{
  height:22%;
  background:linear-gradient(180deg, transparent 0%, #1a1008 100%);
  clip-path:polygon(0% 100%, 0% 70%, 8% 50%, 15% 60%, 22% 35%, 30% 55%, 37% 30%, 43% 48%, 50% 25%, 58% 42%, 65% 30%, 72% 50%, 80% 35%, 87% 55%, 95% 40%, 100% 58%, 100% 100%);
  opacity:0.65;
  animation:mountainDriftRight 70s linear infinite alternate;
}
.mountain-near{
  height:15%;
  background:linear-gradient(180deg, #1a0e05 0%, #150a02 100%);
  clip-path:polygon(0% 100%, 0% 60%, 6% 45%, 14% 55%, 22% 30%, 30% 50%, 40% 28%, 48% 45%, 55% 32%, 64% 50%, 72% 35%, 80% 55%, 90% 38%, 100% 50%, 100% 100%);
  opacity:0.8;
}
@keyframes mountainDriftLeft{
  0%{transform:translateX(0);}
  100%{transform:translateX(-3%);}
}
@keyframes mountainDriftRight{
  0%{transform:translateX(0);}
  100%{transform:translateX(2%);}
}

/* --- 上层：飘动云雾 --- */
#start-screen .clouds-layer{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:2;
}
.cloud{position:absolute;border-radius:50%;filter:blur(60px);opacity:0.12;}
.cloud-1{
  width:500px;height:200px;top:10%;left:-10%;
  background:radial-gradient(ellipse, rgba(180,130,60,0.25) 0%, transparent 70%);
  animation:cloudDrift1 40s ease-in-out infinite alternate;
}
.cloud-2{
  width:400px;height:180px;top:35%;right:-15%;
  background:radial-gradient(ellipse, rgba(160,120,60,0.15) 0%, transparent 70%);
  animation:cloudDrift2 35s ease-in-out infinite alternate;
}
.cloud-3{
  width:600px;height:150px;bottom:20%;left:20%;
  background:radial-gradient(ellipse, rgba(180,130,60,0.18) 0%, rgba(180,130,60,0.08) 40%, transparent 70%);
  animation:cloudDrift3 50s ease-in-out infinite alternate;
}
@keyframes cloudDrift1{0%{transform:translateX(0) translateY(0);}100%{transform:translateX(15vw) translateY(-20px);}}
@keyframes cloudDrift2{0%{transform:translateX(0) translateY(0);}100%{transform:translateX(-12vw) translateY(15px);}}
@keyframes cloudDrift3{0%{transform:translateX(0);}100%{transform:translateX(-10vw);}}

/* --- 火星/余烬粒子 --- */
.start-particle.ember{
  background:rgba(220,120,40,0.7);
  border-radius:50%;
  box-shadow:0 0 4px rgba(220,120,40,0.4);
}

/* --- 标题升级 --- */
.title-area h1{
  font-size:4.2em !important;
  font-weight:bold;
  position:relative;
  z-index:5;
  text-shadow:0 0 30px rgba(201,169,110,0.3), 0 4px 0 rgba(0,0,0,0.5), 0 8px 20px rgba(0,0,0,0.6);
  -webkit-text-stroke:0.5px rgba(201,169,110,0.3);
}
/* 金色冲击波 */
.title-shockwave{
  position:absolute;top:50%;left:50%;
  width:0;height:0;border-radius:50%;
  transform:translate(-50%,-50%);
  background:radial-gradient(circle, rgba(201,169,110,0.5) 0%, rgba(201,169,110,0.1) 40%, transparent 70%);
  pointer-events:none;z-index:4;
  opacity:0;
}
.title-shockwave.active{
  animation:shockwaveExpand 0.8s ease-out forwards;
}
@keyframes shockwaveExpand{
  0%{width:0;height:0;opacity:0.8;}
  100%{width:600px;height:600px;opacity:0;}
}

/* 金色横线（标题下方） */
.title-gold-line{
  width:0;height:2px;margin:12px auto 0;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  transition:width 0.8s ease-out;
  z-index:5;position:relative;
}
.title-gold-line.expand{width:200px;}

/* --- 诗句光线扫过效果 --- */
.poem-line{position:relative;overflow:hidden;}
.poem-line::after{
  content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent 0%,rgba(201,169,110,0.25) 50%,transparent 100%);
  pointer-events:none;opacity:0;
}
.poem-line.visible::after{
  animation:lineSweep 0.6s 0.15s ease-out forwards;
}
@keyframes lineSweep{
  0%{left:-100%;opacity:1;}
  100%{left:100%;opacity:0;}
}

/* --- "天命在手"出现时画面微震 --- */
@keyframes subtleShake{
  0%,100%{transform:translateY(0) translateX(0);}
  15%{transform:translateY(-2px) translateX(1px);}
  30%{transform:translateY(1px) translateX(-2px);}
  45%{transform:translateY(-1px) translateX(1px);}
  60%{transform:translateY(1px) translateX(-1px);}
  75%{transform:translateY(-1px) translateX(0);}
}
#start-screen.mandate-shake{animation:subtleShake 0.4s ease-out;}

/* --- 静音按钮 --- */
.mute-btn{
  position:relative;z-index:10;
  width:36px;height:36px;
  background:transparent;border:1px solid rgba(201,169,110,0.3);border-radius:50%;
  color:var(--gold);font-size:1.1em;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;line-height:1;padding:0;
  font-family:inherit;
}
.mute-btn:hover{background:rgba(201,169,110,0.1);border-color:var(--gold);}
.mute-btn:active{transform:scale(0.9);}
#start-mute-btn{position:absolute;top:16px;right:16px;z-index:20;}

/* --- 让 title-area / poem / btn 保持在所有层之上 --- */
.title-area,.poem,.start-btn,#start-particles{position:relative;z-index:5;}

@media (max-width: 768px) {
  .title-area h1{font-size:2.8em !important;}
  .title-shockwave.active{animation-name:shockwaveExpandMobile;}
  @keyframes shockwaveExpandMobile{0%{width:0;height:0;opacity:0.8;}100%{width:350px;height:350px;opacity:0;}}
  .title-gold-line.expand{width:140px;}
  .cloud{filter:blur(40px);}
  .cloud-1{width:300px;height:120px;}
  .cloud-2{width:250px;height:100px;}
  .cloud-3{width:350px;height:100px;}
  #start-mute-btn{top:10px;right:10px;}
}
@media (max-width: 380px) {
  .title-area h1{font-size:2.2em !important;}
}

/* ========== Event Review Modal ========== */
#event-review-modal{
  position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);
}
#event-review-modal.active{display:flex;}
.review-card{
  background:linear-gradient(135deg,rgba(18,18,30,0.97),rgba(26,22,40,0.97));
  border:1px solid rgba(201,169,110,0.35);border-radius:12px;
  padding:28px 32px;max-width:520px;width:92%;max-height:80vh;overflow-y:auto;
  box-shadow:0 12px 48px rgba(0,0,0,0.6);
}
.review-card h2{color:var(--gold);font-size:1.5em;letter-spacing:3px;margin-bottom:6px;text-shadow:0 0 12px rgba(201,169,110,0.3);}
.review-card .review-era{color:#8a7a5a;font-size:0.8em;letter-spacing:2px;margin-bottom:12px;}
.review-card .review-desc{color:#bbb;font-size:0.92em;line-height:1.9;margin-bottom:12px;}
.review-card .review-quote{font-size:0.85em;color:#8a8a7a;font-style:italic;padding:8px 14px;border-left:2px solid rgba(201,169,110,0.3);margin-bottom:14px;background:rgba(201,169,110,0.03);border-radius:0 6px 6px 0;}
.review-card .review-choice{color:var(--gold);font-size:0.9em;margin-bottom:6px;letter-spacing:1px;}
.review-card .review-consequence{color:#aaa;font-size:0.88em;line-height:1.7;margin-bottom:14px;padding:8px 12px;background:rgba(201,169,110,0.04);border-radius:6px;}
.review-card .review-effects{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.review-card .review-effects .effect-tag{opacity:1;transform:none;}
.review-dismiss{
  display:block;margin:8px auto 0;padding:10px 36px;font-family:inherit;font-size:0.95em;cursor:pointer;
  background:rgba(201,169,110,0.08);color:var(--gold);border:1px solid var(--gold);border-radius:4px;letter-spacing:3px;transition:all 0.2s;
}
.review-dismiss:hover{background:rgba(201,169,110,0.2);}

/* ========== Region Detail Panel ========== */
#region-detail{display:none;}
#region-detail.active{display:block;}
.region-detail-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.region-detail-header .rd-dot{width:14px;height:14px;border-radius:50%;box-shadow:0 0 10px currentColor;}
.region-detail-header h2{color:var(--bright-gold);font-size:1.6em;letter-spacing:4px;flex:1;}
.rd-back-btn{
  padding:6px 16px;font-family:inherit;font-size:0.85em;cursor:pointer;
  background:rgba(201,169,110,0.08);color:var(--gold);border:1px solid rgba(201,169,110,0.3);
  border-radius:4px;letter-spacing:2px;transition:all 0.2s;
}
.rd-back-btn:hover{background:rgba(201,169,110,0.18);border-color:var(--gold);}
.rd-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.rd-stat{padding:8px 12px;background:rgba(201,169,110,0.04);border-radius:6px;border-left:3px solid var(--gold);}
.rd-stat .rd-stat-label{font-size:0.78em;color:#8a7a5a;margin-bottom:4px;letter-spacing:1px;}
.rd-stat .rd-stat-bar{height:8px;background:rgba(255,255,255,0.08);border-radius:4px;overflow:hidden;margin-bottom:2px;}
.rd-stat .rd-stat-fill{height:100%;border-radius:4px;transition:width 0.4s;box-shadow:0 0 6px currentColor;}
.rd-stat .rd-stat-val{font-size:0.9em;color:var(--gold);text-align:right;white-space:nowrap;min-width:60px;}
.rd-stat .rd-stat-val small{font-size:0.75em;opacity:0.8;}
.rd-lore{margin-bottom:16px;}
.rd-lore h3{color:var(--gold);font-size:1em;letter-spacing:2px;margin-bottom:8px;}
.rd-lore p{color:#bbb;font-size:0.9em;line-height:1.9;}
.rd-figures{margin-bottom:16px;}
.rd-figures h3{color:var(--gold);font-size:1em;letter-spacing:2px;margin-bottom:8px;}
.rd-figures .rd-figure{display:inline-block;padding:4px 12px;margin:3px 4px;font-size:0.85em;color:#ccc;background:rgba(201,169,110,0.06);border:1px solid rgba(201,169,110,0.15);border-radius:16px;}
.rd-history{margin-bottom:16px;}
.rd-history h3{color:var(--gold);font-size:1em;letter-spacing:2px;margin-bottom:8px;}
.rd-history .rd-event-entry{font-size:0.82em;color:#999;padding:4px 8px;border-bottom:1px solid rgba(255,255,255,0.04);line-height:1.6;}
.rd-history .rd-event-entry span{color:var(--gold);}

/* ========== Strategic Phase ========== */
.strategic-phase{text-align:center;}
.strategic-phase .sp-title{font-size:1.8em;color:var(--bright-gold);letter-spacing:5px;margin-bottom:8px;text-shadow:0 0 16px rgba(201,169,110,0.3);}
.strategic-phase .sp-era-context{color:#8a7a5a;font-size:0.88em;letter-spacing:2px;margin-bottom:16px;}
.strategic-phase .sp-divider{width:60%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:12px auto;opacity:0.5;}
.strategic-phase .sp-knowledge{padding:14px 18px;background:rgba(201,169,110,0.04);border-radius:8px;margin-bottom:16px;text-align:left;}
.strategic-phase .sp-knowledge h3{color:var(--gold);font-size:0.95em;letter-spacing:2px;margin-bottom:8px;}
.strategic-phase .sp-knowledge p{color:#bbb;font-size:0.88em;line-height:1.8;}
.strategic-phase .sp-knowledge .sp-world{color:#8a8a7a;font-size:0.82em;margin-top:8px;font-style:italic;}
.strategic-phase .sp-summary{color:#aaa;font-size:0.9em;line-height:1.8;margin-bottom:16px;text-align:left;}
.strategic-phase .sp-hint{color:#6a5a3a;font-size:0.82em;margin-bottom:16px;letter-spacing:1px;}
.sp-next-btn{
  display:inline-block;padding:14px 48px;font-family:inherit;font-size:1.1em;cursor:pointer;
  background:linear-gradient(135deg,rgba(201,169,110,0.12),rgba(201,169,110,0.06));
  color:var(--bright-gold);border:1px solid var(--gold);border-radius:6px;
  letter-spacing:5px;transition:all 0.3s;margin-top:8px;
  animation:spBtnPulse 2.5s ease-in-out infinite;
}
.sp-next-btn:hover{background:linear-gradient(135deg,rgba(201,169,110,0.25),rgba(201,169,110,0.12));box-shadow:0 0 30px rgba(201,169,110,0.25);transform:scale(1.04);}
@keyframes spBtnPulse{0%,100%{box-shadow:0 0 8px rgba(201,169,110,0.15);}50%{box-shadow:0 0 24px rgba(201,169,110,0.4),0 0 48px rgba(201,169,110,0.1);}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
@keyframes mandateSpin{0%{transform:rotate(0deg) scale(1);}50%{transform:rotate(180deg) scale(1.3);}100%{transform:rotate(360deg) scale(1);}}

/* ========== Strategic Investment ========== */
.sp-invest{margin:12px 0;padding:10px 14px;background:rgba(201,169,110,0.04);border:1px solid rgba(201,169,110,0.12);border-radius:8px;}
.sp-invest strong{color:var(--bright-gold);font-size:0.92em;}
.sp-invest-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:4px;}
.sp-invest-btn{padding:8px 4px;font-family:inherit;font-size:0.82em;cursor:pointer;
  background:rgba(201,169,110,0.06);color:#ccc;border:1px solid rgba(201,169,110,0.15);
  border-radius:6px;transition:all 0.2s;letter-spacing:1px;}
.sp-invest-btn:hover{background:rgba(201,169,110,0.18);color:var(--bright-gold);box-shadow:0 0 10px rgba(201,169,110,0.2);}

/* ========== Era Objectives ========== */
.sp-objectives{margin:12px 0;padding:10px 14px;background:rgba(201,169,110,0.06);border:1px solid rgba(201,169,110,0.15);border-radius:8px;}
.sp-objectives strong{color:var(--bright-gold);font-size:0.95em;display:block;margin-bottom:8px;}
.sp-obj{font-size:0.88em;padding:4px 0;color:#bbb;}
.sp-obj.obj-met{color:#7cb87c;}
.sp-obj.obj-unmet{color:#aaa;}
.ms-trend{font-size:0.7em;margin-left:2px;}

/* ========== Advisor System ========== */
.advisor-section{margin:16px 0 12px;border-top:1px solid rgba(201,169,110,0.1);padding-top:14px;}
.advisor-section h3{color:var(--gold);font-size:0.9em;letter-spacing:2px;margin-bottom:10px;text-align:center;}
.advisor-quotes{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.advisor-quote{
  display:flex;align-items:flex-start;gap:10px;padding:10px 14px;
  background:rgba(201,169,110,0.03);border:1px solid rgba(201,169,110,0.1);
  border-radius:8px;cursor:pointer;transition:all 0.25s;font-size:0.88em;
}
.advisor-quote:hover{background:rgba(201,169,110,0.08);border-color:rgba(201,169,110,0.3);transform:translateX(3px);}
.advisor-quote .aq-icon{font-size:1.4em;flex-shrink:0;margin-top:2px;}
.advisor-quote .aq-body{flex:1;}
.advisor-quote .aq-name{color:var(--gold);font-size:0.85em;letter-spacing:1px;margin-bottom:3px;}
.advisor-quote .aq-text{color:#aaa;line-height:1.6;font-size:0.92em;}
.advisor-quote .aq-rec{color:#8a7a5a;font-size:0.8em;margin-top:4px;font-style:italic;}
.advisor-detail{
  display:none;padding:12px 16px;margin:-4px 0 8px;
  background:rgba(201,169,110,0.05);border:1px solid rgba(201,169,110,0.15);
  border-radius:0 0 8px 8px;font-size:0.85em;color:#bbb;line-height:1.8;
}
.advisor-detail.active{display:block;}

/* ========== Scene Backgrounds ========== */
.scene-particles{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:1;}
.scene-particle{position:absolute;border-radius:50%;animation:sceneParticleDrift linear infinite;pointer-events:none;}
@keyframes sceneParticleDrift{
  0%{transform:translateY(0) translateX(0) scale(0.5);opacity:0;}
  15%{opacity:0.8;}
  85%{opacity:0.6;}
  100%{transform:translateY(-120%) translateX(var(--sdx,20px)) scale(1.2);opacity:0;}
}
#crisis-panel.scene-war{background:linear-gradient(180deg,rgba(50,15,15,0.92),rgba(25,8,8,0.95)) !important;}
#crisis-panel.scene-trade{background:linear-gradient(180deg,rgba(45,35,12,0.92),rgba(20,15,5,0.95)) !important;}
#crisis-panel.scene-culture{background:linear-gradient(180deg,rgba(20,15,40,0.92),rgba(12,8,25,0.95)) !important;}
#crisis-panel.scene-gov{background:linear-gradient(180deg,rgba(40,35,12,0.92),rgba(20,18,8,0.95)) !important;}
#crisis-panel.scene-transform{background:linear-gradient(180deg,rgba(10,10,10,0.95),rgba(40,35,10,0.92)) !important;}
#crisis-panel.scene-finale{background:linear-gradient(180deg,rgba(10,10,10,0.95),rgba(50,40,15,0.92)) !important;}

/* ========== Enhanced Event Title ========== */
.event-title.dramatic{
  font-size:2.2em !important;
  text-shadow:0 0 20px rgba(201,169,110,0.4),0 4px 8px rgba(0,0,0,0.5) !important;
}

/* ========== Choice Advisor Indicator ========== */
.choice-btn .choice-advisor-icon{
  float:right;font-size:0.9em;opacity:0.6;margin-left:6px;
}

/* ========== Map Scene Overlays ========== */
#map-scene-layer{pointer-events:none;}
.scene-label{font-family:'GF','STKaiti','KaiTi',serif;fill-opacity:0;animation:sceneLabelIn 0.6s ease forwards;}
.scene-label.size-large{font-size:14px;font-weight:bold;letter-spacing:2px;}
.scene-label.size-medium{font-size:11px;font-weight:bold;}
.scene-label.size-small{font-size:9px;}
.scene-label.style-fading{fill-opacity:0.4 !important;}
.scene-label.style-glowing{filter:drop-shadow(0 0 6px currentColor);}
.scene-label.style-ancient{font-style:italic;fill-opacity:0.5 !important;}
@keyframes sceneLabelIn{0%{fill-opacity:0;transform:translateY(8px);}100%{fill-opacity:0.9;transform:translateY(0);}}

.scene-arrow{stroke-dasharray:6 4;stroke-dashoffset:60;animation:sceneDash 1.5s linear forwards;}
.scene-arrow.type-military{stroke:#c56b6b;stroke-width:2;}
.scene-arrow.type-trade{stroke:#dbb978;stroke-width:1.5;}
.scene-arrow.type-culture{stroke:#9b7ed8;stroke-width:1.5;}
.scene-arrow.type-alliance{stroke:#6bba6b;stroke-width:2;stroke-dasharray:4 3;}
.scene-arrow.type-migration{stroke:#5b9bd5;stroke-width:1.5;}
.scene-arrow.type-expansion{stroke:#d4944a;stroke-width:2;}
@keyframes sceneDash{0%{stroke-dashoffset:60;opacity:0.3;}100%{stroke-dashoffset:0;opacity:1;}}

.scene-arrowhead{fill-opacity:0;animation:sceneFadeIn 0.5s 0.8s ease forwards;}
.scene-arrow-label{font-size:8px;fill:#aaa;fill-opacity:0;animation:sceneFadeIn 0.4s 1s ease forwards;}
@keyframes sceneFadeIn{to{fill-opacity:0.8;}}

.scene-icon{fill-opacity:0;animation:sceneIconPop 0.4s ease forwards;}
@keyframes sceneIconPop{0%{fill-opacity:0;transform:scale(0.3);}60%{transform:scale(1.2);}100%{fill-opacity:0.85;transform:scale(1);}}

/* Region event highlight */
.region-path.scene-highlight{animation:sceneHighlight 2s ease-in-out infinite;}
@keyframes sceneHighlight{0%,100%{stroke:rgba(201,169,110,0.3);stroke-width:1;}50%{stroke:rgba(201,169,110,0.7);stroke-width:2.5;}}

/* Before/After delta fly animation */
.delta-fly{position:absolute;font-size:1.2em;font-weight:bold;pointer-events:none;z-index:20;animation:deltaFlyUp 1.8s ease-out forwards;}
.delta-fly.pos{color:#6bba6b;text-shadow:0 0 8px rgba(107,186,107,0.4);}
.delta-fly.neg{color:#c56b6b;text-shadow:0 0 8px rgba(197,107,107,0.4);}
@keyframes deltaFlyUp{0%{opacity:0;transform:translateY(10px) scale(0.7);}20%{opacity:1;transform:translateY(0) scale(1.1);}40%{transform:translateY(-8px) scale(1);}100%{opacity:0;transform:translateY(-30px) scale(0.8);}}

/* Scene atmosphere overlays */
#map-area.atmo-war::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 55% 40%,rgba(180,40,40,0.08) 0%,transparent 60%);pointer-events:none;z-index:5;animation:atmoFade 0.8s ease;}
#map-area.atmo-crisis::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(160,80,20,0.08) 0%,transparent 60%);pointer-events:none;z-index:5;animation:atmoFade 0.8s ease;}
#map-area.atmo-trade::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 45% 55%,rgba(220,190,60,0.06) 0%,transparent 60%);pointer-events:none;z-index:5;animation:atmoFade 0.8s ease;}
#map-area.atmo-culture::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 45%,rgba(120,80,200,0.06) 0%,transparent 60%);pointer-events:none;z-index:5;animation:atmoFade 0.8s ease;}
#map-area.atmo-peace::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(107,186,107,0.05) 0%,transparent 60%);pointer-events:none;z-index:5;animation:atmoFade 0.8s ease;}
#map-area.atmo-transformation::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(201,169,110,0.1) 0%,transparent 50%);pointer-events:none;z-index:5;animation:atmoFade 0.8s ease;}
@keyframes atmoFade{0%{opacity:0;}100%{opacity:1;}}

/* ========== Map Era Tinting ========== */
#map-area.era-1{background:radial-gradient(ellipse at 50% 50%,rgba(139,105,20,0.08),rgba(18,18,24,1) 70%) !important;}
#map-area.era-2{background:radial-gradient(ellipse at 50% 50%,rgba(139,37,0,0.08),rgba(18,18,24,1) 70%) !important;}
#map-area.era-3{background:radial-gradient(ellipse at 50% 50%,rgba(43,79,140,0.08),rgba(18,18,24,1) 70%) !important;}
#map-area.era-4{background:radial-gradient(ellipse at 50% 50%,rgba(27,107,58,0.08),rgba(18,18,24,1) 70%) !important;}

/* ========== Map World Layer: Living World ========== */
#map-world-layer{pointer-events:none;opacity:0.9;}
/* Buildings */
.world-building{font-size:7px;fill:#c9a96e;opacity:0;animation:worldFadeIn 0.8s ease forwards;}
.world-building.type-palace{font-size:10px;fill:#e8c060;}
.world-building.type-city{font-size:8px;fill:#c9a96e;}
.world-building.type-fort{font-size:7px;fill:#c07050;}
.world-building.type-temple{font-size:8px;fill:#9b7ed8;}
.world-building.type-market{font-size:7px;fill:#dbb978;}
.world-building.type-port{font-size:8px;fill:#5b9bd5;}
.world-building.type-wall{font-size:6px;fill:#8b7355;}
.world-building.type-camp{font-size:7px;fill:#6b8e6b;}
.world-building.type-academy{font-size:8px;fill:#7b9fc7;}
.world-building-label{font-size:5px;fill:rgba(201,169,110,0.6);font-family:serif;}
/* Landmarks */
.world-landmark{opacity:0.2;fill:none;stroke:rgba(201,169,110,0.25);stroke-width:0.5;}
.world-landmark-label{font-size:4.5px;fill:rgba(201,169,110,0.35);font-family:serif;letter-spacing:1px;}
.world-river{fill:none;stroke:rgba(80,140,200,0.15);stroke-width:1.5;stroke-linecap:round;}
.world-mountain{fill:rgba(160,140,110,0.08);stroke:rgba(160,140,110,0.15);stroke-width:0.5;}
/* Population */
.world-pop-dot{fill:rgba(201,169,110,0.3);animation:popPulse 3s ease-in-out infinite;}
.world-pop-cluster{opacity:0.4;}
/* Weather */
.world-cloud{fill:rgba(200,200,220,0.04);animation:cloudDrift 35s linear infinite;}
.world-snow{fill:rgba(220,230,250,0.5);animation:snowFall 6s linear infinite;}
.world-sand{fill:rgba(210,180,120,0.35);animation:sandBlow 5s ease-in-out infinite;}
.world-rain{fill:rgba(100,150,220,0.3);animation:rainFall 1.5s linear infinite;}
.world-wave{fill:none;stroke:rgba(80,140,200,0.12);stroke-width:0.8;animation:waveDrift 4s ease-in-out infinite;}
/* Ambient elements */
.world-caravan{opacity:0;animation:caravanMove 12s linear infinite;}
.world-bird{opacity:0;animation:birdFly 8s ease-in-out infinite;}
.world-boat{opacity:0;animation:boatFloat 10s ease-in-out infinite;}
.world-banner{font-size:8px;opacity:0.6;animation:bannerWave 2s ease-in-out infinite;}
.world-culture-tag{font-size:4px;fill:rgba(201,169,110,0.4);font-family:serif;letter-spacing:0.5px;}
/* Animations */
@keyframes worldFadeIn{0%{opacity:0;transform:translateY(3px);}100%{opacity:0.7;transform:translateY(0);}}
@keyframes cloudDrift{0%{transform:translateX(-20px);}100%{transform:translateX(40px);}}
@keyframes snowFall{0%{transform:translateY(-5px);opacity:0.5;}100%{transform:translateY(20px);opacity:0;}}
@keyframes sandBlow{0%,100%{transform:translateX(0);opacity:0.15;}50%{transform:translateX(12px);opacity:0.4;}}
@keyframes rainFall{0%{transform:translateY(-3px);opacity:0.4;}100%{transform:translateY(15px);opacity:0;}}
@keyframes waveDrift{0%,100%{transform:translateY(0);}50%{transform:translateY(2px);}}
@keyframes popPulse{0%,100%{r:1.5;opacity:0.25;}50%{r:2.5;opacity:0.5;}}
@keyframes caravanMove{0%{opacity:0;transform:translate(var(--cx,0),var(--cy,0));}15%{opacity:0.5;}85%{opacity:0.5;}100%{opacity:0;transform:translate(var(--tx,30px),var(--ty,0));}}
@keyframes birdFly{0%{opacity:0;transform:translate(0,0);}20%{opacity:0.4;}80%{opacity:0.4;}100%{opacity:0;transform:translate(var(--bx,60px),var(--by,-20px));}}
@keyframes boatFloat{0%{opacity:0;transform:translate(0,0);}20%{opacity:0.5;}80%{opacity:0.5;}100%{opacity:0;transform:translate(var(--sx,20px),var(--sy,5px));}}
@keyframes bannerWave{0%,100%{transform:rotate(-3deg);}50%{transform:rotate(3deg);}}

/* ========== Map Node Critical Pulse ========== */
@keyframes nodeCriticalPulse{0%,100%{filter:brightness(1);stroke-opacity:0.7;}50%{filter:brightness(1.8) drop-shadow(0 0 12px #c56b6b);stroke-opacity:1;}}
.node-circle.critical-pulse{animation:nodeCriticalPulse 1.2s ease-in-out infinite !important;}

/* ========== Map Node Selected Glow ========== */
.region-node.selected .node-circle{filter:brightness(1.6) drop-shadow(0 0 16px currentColor) !important;}

/* ========== Timeline Era Segment Click ========== */
.timeline-era-seg{cursor:pointer;transition:all 0.3s;}
.timeline-era-seg:hover{filter:brightness(1.6);}

/* ========== Mobile additions ========== */
@media (max-width: 768px) {
  .review-card{padding:20px 16px;max-height:85vh;}
  .rd-stats{grid-template-columns:1fr;}
  .advisor-quote{padding:8px 10px;font-size:0.82em;}
  .strategic-phase .sp-title{font-size:1.4em;}
  .sp-next-btn{padding:12px 36px;font-size:1em;}
  .scene-particles{display:none;}
}

/* ========== Mobile Tab Mode ========== */
#mobile-tabs{display:none;}
#mobile-region-sheet{display:none;}

@media (max-width: 768px) {
  #game-body{grid-template-rows:1fr !important;position:relative;overflow:hidden;}
  #map-area{position:absolute;inset:0;z-index:1;opacity:0;pointer-events:none;transition:opacity 0.3s;}
  #crisis-panel{position:absolute;inset:0;z-index:2;transition:opacity 0.3s;border-left:none !important;}
  #map-area.tab-active{opacity:1;pointer-events:auto;z-index:2;}
  #crisis-panel.tab-active{opacity:1;pointer-events:auto;z-index:2;}
  #crisis-panel:not(.tab-active){opacity:0;pointer-events:none;z-index:1;}

  #mobile-tabs{
    display:flex;position:absolute;bottom:0;left:0;right:0;z-index:10;
    background:linear-gradient(180deg,transparent,rgba(13,13,26,0.98) 20%);
    padding:8px 16px env(safe-area-inset-bottom,8px);gap:8px;
  }
  .mobile-tab{
    flex:1;padding:10px 0;text-align:center;font-family:inherit;font-size:0.88em;
    cursor:pointer;border:1px solid rgba(201,169,110,0.15);border-radius:8px;
    background:rgba(201,169,110,0.04);color:#888;letter-spacing:2px;transition:all 0.25s;
  }
  .mobile-tab.active{color:var(--gold);border-color:var(--gold);background:rgba(201,169,110,0.12);box-shadow:0 0 12px rgba(201,169,110,0.15);}
  .mobile-tab.has-update{animation:tabPulse 1.5s ease-in-out infinite;}
  @keyframes tabPulse{0%,100%{box-shadow:none;}50%{box-shadow:0 0 16px rgba(201,169,110,0.4);}}

  /* Mobile region bottom sheet */
  #mobile-region-sheet{
    display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;
    background:linear-gradient(180deg,rgba(18,18,30,0.98),rgba(13,13,20,0.99));
    border-top:1px solid rgba(201,169,110,0.3);border-radius:16px 16px 0 0;
    padding:16px 20px calc(16px + env(safe-area-inset-bottom,0px));
    max-height:55vh;overflow-y:auto;
    transform:translateY(100%);transition:transform 0.35s ease;
    -webkit-overflow-scrolling:touch;overscroll-behavior:contain;
  }
  #mobile-region-sheet.visible{display:block;transform:translateY(0);}
  #mobile-region-sheet .sheet-handle{width:40px;height:4px;background:rgba(201,169,110,0.3);border-radius:2px;margin:0 auto 12px;}
  #mobile-region-sheet .sheet-name{color:var(--bright-gold);font-size:1.2em;letter-spacing:3px;margin-bottom:4px;}
  #mobile-region-sheet .sheet-desc{color:#8a7a5a;font-size:0.82em;margin-bottom:10px;}
  #mobile-region-sheet .sheet-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;}
  #mobile-region-sheet .sheet-stat{display:flex;align-items:center;gap:6px;font-size:0.85em;color:#aaa;}
  #mobile-region-sheet .sheet-stat-label{color:var(--gold);width:16px;}
  #mobile-region-sheet .sheet-stat-bar{flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;}
  #mobile-region-sheet .sheet-stat-fill{height:100%;border-radius:3px;}
  #mobile-region-sheet .sheet-stat-val{width:20px;text-align:right;color:var(--gold);font-size:0.9em;}
  #mobile-region-sheet .sheet-lore{color:#bbb;font-size:0.85em;line-height:1.8;}

  /* Safe area support */
  #bottom-bar{padding-bottom:env(safe-area-inset-bottom,0px);}
  #crisis-content{-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding-bottom:60px;}
  .choice-btn{min-height:48px;}
}

/* ========== Event Insight ("施展说") ========== */
/* ========== Tutorial Overlay ========== */
#tutorial-overlay{position:fixed;inset:0;z-index:500;display:flex;align-items:center;justify-content:center;}
.tutorial-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.75);}
.tutorial-card{position:relative;z-index:1;max-width:420px;width:90%;padding:28px 24px;
  background:linear-gradient(180deg,rgba(26,26,46,0.98),rgba(18,18,30,0.99));
  border:1px solid rgba(201,169,110,0.4);border-radius:12px;text-align:center;
  box-shadow:0 0 40px rgba(201,169,110,0.15);animation:tutorialFadeIn 0.4s;}
@keyframes tutorialFadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
.tutorial-step{color:#ddd;font-size:0.95em;line-height:1.8;margin-bottom:16px;}
.tutorial-step b{color:var(--bright-gold);}
.tutorial-step .tutorial-icon{font-size:1.8em;display:block;margin-bottom:10px;}
.tutorial-progress{display:flex;gap:6px;justify-content:center;margin-bottom:14px;}
.tutorial-dot{width:8px;height:8px;border-radius:50%;background:rgba(201,169,110,0.2);}
.tutorial-dot.active{background:var(--gold);}
.tutorial-btn{padding:10px 36px;font-family:inherit;font-size:0.95em;cursor:pointer;
  background:rgba(201,169,110,0.12);color:var(--bright-gold);border:1px solid var(--gold);
  border-radius:6px;letter-spacing:3px;transition:all 0.3s;}
.tutorial-btn:hover{background:rgba(201,169,110,0.25);box-shadow:0 0 20px rgba(201,169,110,0.2);}

.event-insight{
  margin-top:12px;padding:10px 14px;
  background:rgba(201,169,110,0.04);border-left:3px solid rgba(201,169,110,0.3);
  border-radius:0 6px 6px 0;font-size:0.85em;color:#9a8a6a;line-height:1.7;
}
.event-insight::before{content:'📖 施展说：';color:var(--gold);font-weight:bold;}

/* ========== Random Event Popup ========== */
.random-event-popup{
  text-align:center;padding:16px 0;
}
.random-event-popup .re-title{color:var(--bright-gold);font-size:1.2em;letter-spacing:2px;margin-bottom:8px;}
.random-event-popup .re-desc{color:#bbb;font-size:0.9em;line-height:1.7;margin-bottom:10px;}
.random-event-popup .re-effects{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}

/* ========== Civ VI Cinematic Light Beams ========== */
#start-screen .light-beams{
  position:absolute;inset:0;overflow:hidden;pointer-events:none;z-index:1;
}
#start-screen .light-beams::before,
#start-screen .light-beams::after{
  content:'';
  position:absolute;
  top:-20%;
  width:150px;
  height:120%;
  background:linear-gradient(180deg, rgba(201,169,110,0.12) 0%, transparent 80%);
  filter:blur(40px);
  transform-origin:top center;
}
#start-screen .light-beams::before{
  left:25%;
  transform:rotate(-8deg);
  animation:beamSway1 12s ease-in-out infinite alternate;
}
#start-screen .light-beams::after{
  right:20%;
  width:100px;
  transform:rotate(5deg);
  animation:beamSway2 15s ease-in-out infinite alternate;
  opacity:0.7;
}
@keyframes beamSway1{0%{transform:rotate(-8deg);}100%{transform:rotate(-3deg);}}
@keyframes beamSway2{0%{transform:rotate(5deg);}100%{transform:rotate(10deg);}}

/* ========== Cinematic Letterbox Bars ========== */
#start-screen .letterbox-top,
#start-screen .letterbox-bottom{
  position:absolute;
  left:0;right:0;
  height:8vh;
  background:#000;
  z-index:3;
  pointer-events:none;
}
#start-screen .letterbox-top{top:0;}
#start-screen .letterbox-bottom{bottom:0;}

/* ========== Mobile responsive for cinematic elements ========== */
@media (max-width: 768px) {
  #start-screen .letterbox-top,
  #start-screen .letterbox-bottom{height:5vh;}
  #start-screen .light-beams::before{width:100px;}
  #start-screen .light-beams::after{width:70px;}
}

/* ========== Crisis Type Animated Icons ========== */
.event-icon-scene{
  width:100%;height:80px;display:flex;align-items:center;justify-content:center;
  margin-bottom:12px;position:relative;overflow:hidden;
}
/* War: crossed swords with sparks */
.event-icon-scene.icon-war::before,
.event-icon-scene.icon-war::after{
  content:'';position:absolute;width:4px;height:48px;
  background:linear-gradient(180deg,#e74c3c,#ffd700);border-radius:2px;
  transform-origin:center bottom;
}
.event-icon-scene.icon-war::before{transform:rotate(-30deg);left:calc(50% - 14px);animation:swordClashL 1.2s ease-in-out infinite;}
.event-icon-scene.icon-war::after{transform:rotate(30deg);left:calc(50% + 10px);animation:swordClashR 1.2s ease-in-out infinite;}
@keyframes swordClashL{0%,100%{transform:rotate(-40deg);}50%{transform:rotate(-15deg);}}
@keyframes swordClashR{0%,100%{transform:rotate(40deg);}50%{transform:rotate(15deg);}}
.event-icon-scene.icon-war .spark{
  position:absolute;width:6px;height:6px;background:#ffd700;border-radius:50%;
  top:20px;left:50%;opacity:0;
}
.event-icon-scene.icon-war .spark:nth-child(1){animation:sparkBurst 1.2s 0.45s ease-out infinite;}
.event-icon-scene.icon-war .spark:nth-child(2){animation:sparkBurst 1.2s 0.55s ease-out infinite;--sx:-12px;--sy:-8px;}
.event-icon-scene.icon-war .spark:nth-child(3){animation:sparkBurst 1.2s 0.5s ease-out infinite;--sx:10px;--sy:-14px;}
@keyframes sparkBurst{
  0%{opacity:0;transform:translate(0,0) scale(1);}
  20%{opacity:1;}
  100%{opacity:0;transform:translate(var(--sx,8px),var(--sy,-18px)) scale(0.2);}
}

/* Trade: flowing coin/silk */
.event-icon-scene.icon-trade .coin{
  width:28px;height:28px;border-radius:50%;border:3px solid #dbb978;
  position:relative;display:flex;align-items:center;justify-content:center;
  color:#dbb978;font-size:0.85em;font-weight:bold;
  animation:coinFloat 2s ease-in-out infinite;
}
.event-icon-scene.icon-trade .coin::after{content:'通';font-family:inherit;}
.event-icon-scene.icon-trade .silk{
  position:absolute;width:60px;height:2px;
  background:linear-gradient(90deg,transparent,#dbb978,transparent);
  animation:silkFlow 2s linear infinite;
}
.event-icon-scene.icon-trade .silk:nth-child(2){top:28px;animation-delay:0.4s;opacity:0.6;}
.event-icon-scene.icon-trade .silk:nth-child(3){top:52px;animation-delay:0.8s;opacity:0.4;}
@keyframes coinFloat{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
@keyframes silkFlow{0%{transform:translateX(-40px);opacity:0;}50%{opacity:1;}100%{transform:translateX(40px);opacity:0;}}

/* Culture: brush stroke */
.event-icon-scene.icon-culture .brush{
  width:4px;height:36px;background:linear-gradient(180deg,#4a3020,#2a1a10);
  border-radius:2px;position:relative;
  animation:brushWrite 2s ease-in-out infinite;
  transform-origin:bottom center;
}
.event-icon-scene.icon-culture .brush::after{
  content:'';position:absolute;bottom:-6px;left:-4px;
  width:12px;height:8px;background:#333;border-radius:0 0 6px 6px;
}
.event-icon-scene.icon-culture .ink-trail{
  position:absolute;bottom:10px;left:50%;width:0;height:3px;
  background:linear-gradient(90deg,rgba(155,89,182,0.8),transparent);
  animation:inkStroke 2s ease-out infinite;transform-origin:left;
}
@keyframes brushWrite{0%,100%{transform:translateX(-20px) rotate(-5deg);}50%{transform:translateX(20px) rotate(5deg);}}
@keyframes inkStroke{0%{width:0;left:calc(50% - 20px);opacity:0.8;}50%{width:50px;opacity:0.6;}100%{width:60px;opacity:0;}}

/* Governance: seal/stamp dropping */
.event-icon-scene.icon-gov .seal{
  width:36px;height:36px;border:3px solid #dbb978;border-radius:4px;
  display:flex;align-items:center;justify-content:center;
  color:#dbb978;font-size:0.9em;font-weight:bold;
  animation:sealDrop 2s ease-in-out infinite;
  box-shadow:0 0 12px rgba(219,185,120,0.3);
}
.event-icon-scene.icon-gov .seal::after{content:'令';font-family:inherit;}
.event-icon-scene.icon-gov .stamp-ring{
  position:absolute;width:44px;height:44px;border:2px solid rgba(219,185,120,0.4);
  border-radius:50%;opacity:0;
  animation:stampRing 2s 0.3s ease-out infinite;
}
@keyframes sealDrop{0%{transform:translateY(-16px) scale(0.9);opacity:0.5;}30%{transform:translateY(2px) scale(1.05);}50%{transform:translateY(0) scale(1);}100%{transform:translateY(0) scale(1);}}
@keyframes stampRing{0%{transform:scale(0.8);opacity:0.6;}100%{transform:scale(1.8);opacity:0;}}

/* Transform: lightning crack */
.event-icon-scene.icon-transform .bolt{
  width:0;height:0;position:relative;
}
.event-icon-scene.icon-transform .bolt::before{
  content:'';position:absolute;left:-8px;top:-24px;
  width:16px;height:48px;
  background:linear-gradient(180deg,#f1c40f,#ff8c00);
  clip-path:polygon(40% 0%,55% 0%,45% 38%,65% 38%,30% 100%,42% 50%,25% 50%);
  animation:boltFlash 1.5s ease-in-out infinite;
  filter:drop-shadow(0 0 8px rgba(241,196,15,0.8));
}
.event-icon-scene.icon-transform .bolt-glow{
  position:absolute;width:60px;height:60px;border-radius:50%;
  background:radial-gradient(circle,rgba(241,196,15,0.2),transparent 70%);
  animation:boltGlow 1.5s ease-in-out infinite;
}
@keyframes boltFlash{0%,100%{opacity:0.4;transform:scale(0.95);}50%{opacity:1;transform:scale(1.1);}}
@keyframes boltGlow{0%,100%{opacity:0.3;transform:scale(0.8);}50%{opacity:0.8;transform:scale(1.2);}}

/* Finale: crown icon */
.event-icon-scene.icon-finale .crown{
  font-size:2.8em;
  animation:crownRise 2s ease-in-out infinite;
  filter:drop-shadow(0 0 16px rgba(241,196,15,0.6));
}
@keyframes crownRise{0%,100%{transform:translateY(0) scale(1);filter:drop-shadow(0 0 12px rgba(241,196,15,0.4));}50%{transform:translateY(-6px) scale(1.1);filter:drop-shadow(0 0 24px rgba(241,196,15,0.8));}}

/* ========== Collapsible Event Background Toggle ========== */
.event-bg-toggle{
  display:flex;align-items:center;gap:6px;cursor:pointer;
  color:var(--gold);font-size:0.82em;letter-spacing:1px;
  padding:8px 0;opacity:0.7;transition:opacity 0.2s;user-select:none;
}
.event-bg-toggle:hover{opacity:1;}
.event-bg-toggle .toggle-arrow{
  display:inline-block;transition:transform 0.3s;font-size:0.8em;
}
.event-bg-toggle.expanded .toggle-arrow{transform:rotate(90deg);}
.event-background.collapsed{
  max-height:0;overflow:hidden;opacity:0;margin:0;padding:0;
  transition:max-height 0.4s ease,opacity 0.3s,margin 0.3s,padding 0.3s;
}
.event-background.expanded{
  max-height:500px;opacity:1;margin:4px 0 10px;padding:10px 14px;
  transition:max-height 0.5s ease,opacity 0.4s,margin 0.3s,padding 0.3s;
}

/* ========== Enhanced Choice Button Hover ========== */
.choice-btn{
  transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);
}
.choice-btn:hover{
  transform:translateX(6px) scale(1.02);
  box-shadow:0 4px 24px rgba(201,169,110,0.2),inset 0 0 20px rgba(201,169,110,0.03);
}
.choice-btn::after{
  content:'';position:absolute;inset:0;border-radius:6px;
  box-shadow:0 0 0 0 rgba(201,169,110,0);
  transition:box-shadow 0.3s;
}
.choice-btn:hover::after{
  box-shadow:0 0 16px rgba(201,169,110,0.15);
}

/* ========== Result Screen Large Stat Numbers ========== */
.result-stat-big{
  display:inline-flex;align-items:center;justify-content:center;
  font-size:1.6em;font-weight:bold;margin:0 4px;
  animation:statNumPop 0.6s cubic-bezier(0.34,1.56,0.64,1) forwards;
  opacity:0;
}
.result-stat-big.positive{color:#6bba6b;text-shadow:0 0 12px rgba(107,186,107,0.4);}
.result-stat-big.negative{color:#c56b6b;text-shadow:0 0 12px rgba(197,107,107,0.4);}
@keyframes statNumPop{
  0%{opacity:0;transform:scale(0.3) translateY(10px);}
  60%{opacity:1;transform:scale(1.2) translateY(-2px);}
  100%{opacity:1;transform:scale(1) translateY(0);}
}
.result-verdict{
  font-size:1.15em;color:var(--bright-gold);text-align:center;
  margin-bottom:12px;letter-spacing:2px;
  text-shadow:0 0 16px rgba(201,169,110,0.4);
  animation:verdictFade 0.6s ease forwards;
}
@keyframes verdictFade{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}

/* Visual stat change cards in results */
.result-stat-cards{
  display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0 16px;
}
.result-stat-card{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  padding:8px 12px;border-radius:8px;min-width:60px;
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);
  animation:statCardIn 0.5s ease forwards;opacity:0;
}
.result-stat-card .rsc-region{font-size:0.7em;color:#888;letter-spacing:1px;}
.result-stat-card .rsc-stat{font-size:0.75em;color:#aaa;}
.result-stat-card .rsc-val{font-size:1.5em;font-weight:bold;}
.result-stat-card .rsc-val.pos{color:#6bba6b;text-shadow:0 0 8px rgba(107,186,107,0.3);}
.result-stat-card .rsc-val.neg{color:#c56b6b;text-shadow:0 0 8px rgba(197,107,107,0.3);}
@keyframes statCardIn{
  0%{opacity:0;transform:translateY(12px) scale(0.9);}
  100%{opacity:1;transform:translateY(0) scale(1);}
}
.result-stat-card{cursor:pointer;transition:border-color 0.2s,background 0.2s;}
.result-stat-card:hover{border-color:rgba(201,169,110,0.3);background:rgba(201,169,110,0.06);}
.result-stat-card:active{transform:scale(0.95);}
.result-stat-card::after{content:'?';position:absolute;top:2px;right:4px;font-size:0.55em;color:rgba(201,169,110,0.4);font-weight:bold;}
.result-stat-card{position:relative;}

/* Stat explanation popup */
#stat-explain-overlay{
  position:fixed;inset:0;z-index:900;background:rgba(0,0,0,0.6);
  display:none;align-items:center;justify-content:center;
  animation:fadeIn 0.2s ease;
}
#stat-explain-overlay.active{display:flex;}
#stat-explain-box{
  max-width:420px;width:90%;max-height:70vh;overflow-y:auto;
  background:linear-gradient(160deg,#1a1a2e,#22223a);
  border:1px solid rgba(201,169,110,0.25);border-radius:12px;
  padding:20px;box-shadow:0 8px 40px rgba(0,0,0,0.5);
  animation:popIn 0.25s ease;
}
@keyframes popIn{0%{opacity:0;transform:scale(0.9);}100%{opacity:1;transform:scale(1);}}
.se-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.se-region{font-size:1em;color:var(--gold);font-weight:bold;}
.se-val{font-size:1.4em;font-weight:bold;}
.se-val.pos{color:#6bba6b;}.se-val.neg{color:#c56b6b;}
.se-stat-label{font-size:0.85em;color:#aaa;}
.se-reason{color:#ccc;font-size:0.9em;line-height:1.7;margin:10px 0;padding:10px 12px;background:rgba(201,169,110,0.05);border-radius:6px;border-left:3px solid rgba(201,169,110,0.2);}
.se-consequence{color:#999;font-size:0.85em;line-height:1.6;margin:8px 0;padding:8px 12px;background:rgba(255,255,255,0.02);border-radius:6px;}
.se-knowledge{margin-top:10px;padding:10px 12px;background:rgba(201,169,110,0.04);border-radius:6px;}
.se-knowledge div{font-size:0.82em;line-height:1.6;margin-bottom:6px;}
.se-knowledge .se-insight{color:#c9a96e;font-style:italic;}
.se-knowledge .se-dilemma{color:#c07060;}
.se-close{display:block;margin:12px auto 0;padding:6px 24px;background:rgba(201,169,110,0.1);border:1px solid rgba(201,169,110,0.3);border-radius:6px;color:var(--gold);cursor:pointer;font-family:inherit;font-size:0.85em;}
.se-close:hover{background:rgba(201,169,110,0.2);}

/* ========== Section Dividers ========== */
.section-divider{
  width:40%;height:1px;margin:10px auto;
  background:linear-gradient(90deg,transparent,rgba(201,169,110,0.3),transparent);
}
.section-divider.wide{width:70%;}

/* ========== Enhanced Quote Section ========== */
.event-quote{
  position:relative;
  background:rgba(201,169,110,0.04);
  border-radius:0 8px 8px 0;
}
.event-quote::before{
  content:'\201C';position:absolute;top:-12px;left:6px;
  font-size:2.5em;color:rgba(201,169,110,0.3);font-style:normal;line-height:1;
}
.event-quote::after{
  content:'\201D';font-size:1.8em;color:rgba(201,169,110,0.3);
  font-style:normal;vertical-align:-0.3em;margin-left:6px;
}

/* ========== Advisor Compact Mode ========== */
.advisor-section-compact{margin:10px 0 8px;border-top:1px solid rgba(201,169,110,0.1);padding-top:10px;}
.advisor-section-compact h3{color:var(--gold);font-size:0.85em;letter-spacing:2px;margin-bottom:6px;text-align:center;}
.advisor-icons-row{display:flex;gap:6px;justify-content:center;margin-bottom:10px;}
.advisor-icon-btn{
  width:36px;height:36px;border-radius:50%;
  background:rgba(201,169,110,0.06);border:1px solid rgba(201,169,110,0.15);
  display:flex;align-items:center;justify-content:center;
  font-size:1.1em;cursor:pointer;transition:all 0.25s;
}
.advisor-icon-btn:hover,.advisor-icon-btn.active{
  background:rgba(201,169,110,0.15);border-color:var(--gold);
  transform:scale(1.15);box-shadow:0 0 10px rgba(201,169,110,0.2);
}
.advisor-expand-content{
  max-height:0;overflow:hidden;transition:max-height 0.35s ease;
  text-align:left;
}
.advisor-expand-content.open{max-height:200px;}
.advisor-expand-text{
  padding:8px 12px;background:rgba(201,169,110,0.04);
  border-radius:6px;font-size:0.85em;color:#aaa;line-height:1.6;margin-bottom:8px;
}
.advisor-expand-text .aq-name{color:var(--gold);font-size:0.82em;margin-bottom:2px;}
.advisor-expand-text .aq-rec{color:#8a7a5a;font-size:0.78em;margin-top:3px;font-style:italic;}

/* ========== HERO'S JOURNEY: Prologue Overlay ========== */
#prologue-overlay{
  position:fixed;inset:0;z-index:1100;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  background:linear-gradient(180deg,#0a0608 0%,#1a0e05 30%,#2a1508 60%,#0d0d1a 100%);
  opacity:0;animation:prologueFadeIn 1s ease forwards;
  padding:20px;overflow-y:auto;
}
@keyframes prologueFadeIn{from{opacity:0;}to{opacity:1;}}
.prologue-content{max-width:520px;width:100%;text-align:center;position:relative;z-index:2;}
.prologue-book{
  color:#a89868;font-size:0.92em;line-height:2;margin-bottom:28px;
  opacity:0;transform:translateY(20px);
  padding:0 16px;
}
.prologue-book.visible{opacity:1;transform:translateY(0);transition:opacity 0.8s,transform 0.8s;}
.prologue-book .book-title{color:var(--gold);font-size:1.1em;font-weight:bold;letter-spacing:2px;}
.prologue-role{
  color:#ddd;font-size:1.05em;line-height:2;margin-bottom:28px;
  opacity:0;transform:translateY(20px);padding:0 12px;
}
.prologue-role.visible{opacity:1;transform:translateY(0);transition:opacity 0.8s,transform 0.8s;}
.prologue-role .role-name{
  color:var(--bright-gold);font-size:1.4em;font-weight:bold;letter-spacing:4px;
  text-shadow:0 0 20px rgba(201,169,110,0.4);display:block;margin:8px 0;
}
.prologue-howto{
  color:#8a7a5a;font-size:0.88em;line-height:1.9;margin-bottom:32px;
  padding:12px 18px;border:1px solid rgba(201,169,110,0.15);border-radius:8px;
  background:rgba(201,169,110,0.04);
  opacity:0;transform:translateY(20px);
}
.prologue-howto.visible{opacity:1;transform:translateY(0);transition:opacity 0.8s,transform 0.8s;}
.prologue-howto b{color:var(--gold);}
.prologue-divider{
  width:0;height:1px;margin:0 auto 24px;
  background:linear-gradient(90deg,transparent,var(--gold),transparent);
  transition:width 1s ease;
}
.prologue-divider.expand{width:200px;}
.prologue-cta{
  padding:18px 64px;font-size:1.3em;font-family:inherit;cursor:pointer;
  background:linear-gradient(135deg,rgba(201,169,110,0.2),rgba(201,169,110,0.08));
  color:var(--bright-gold);border:2px solid var(--gold);border-radius:6px;
  letter-spacing:8px;transition:all 0.3s;opacity:0;transform:scale(0.9);
  text-shadow:0 0 12px rgba(201,169,110,0.3);
}
.prologue-cta.visible{opacity:1;transform:scale(1);transition:opacity 0.6s,transform 0.6s;}
.prologue-cta:hover{
  background:linear-gradient(135deg,rgba(201,169,110,0.35),rgba(201,169,110,0.15));
  box-shadow:0 0 40px rgba(201,169,110,0.3);transform:scale(1.05);
}
.prologue-cta:active{transform:scale(0.97);}
@keyframes prologueBtnPulse{0%,100%{box-shadow:0 0 10px rgba(201,169,110,0.15);}50%{box-shadow:0 0 35px rgba(201,169,110,0.45),0 0 70px rgba(201,169,110,0.1);}}
.prologue-cta.pulse{animation:prologueBtnPulse 2.5s ease-in-out infinite;}

/* ========== HERO'S JOURNEY: Score & Rank in Top Bar ========== */
.hero-score{display:flex;align-items:center;gap:4px;color:var(--gold);font-size:0.88em;white-space:nowrap;}
.hero-score .score-val{font-size:1.1em;min-width:32px;text-align:center;font-weight:bold;transition:color 0.3s;}
.hero-rank{
  font-size:0.72em;padding:2px 8px;border-radius:10px;
  background:rgba(201,169,110,0.08);border:1px solid rgba(201,169,110,0.2);
  color:var(--bright-gold);letter-spacing:1px;white-space:nowrap;transition:all 0.3s;
}

/* ========== HERO'S JOURNEY: Progress Bar ========== */
#journey-progress{
  grid-column:1/-1;height:6px;background:rgba(255,255,255,0.04);position:relative;overflow:hidden;
}
#journey-progress-fill{
  height:100%;border-radius:0 3px 3px 0;
  background:linear-gradient(90deg,#8B6914,#A07828,#8B2500,#A03020,#2B4F8C,#3A6BA5,#1B6B3A,#2D8B4E);
  background-size:400% 100%;
  transition:width 0.6s ease;box-shadow:0 0 8px rgba(201,169,110,0.3);
}
#journey-progress-text{
  position:absolute;right:8px;top:50%;transform:translateY(-50%);
  font-size:0.6em;color:rgba(201,169,110,0.6);letter-spacing:1px;line-height:1;
}

/* ========== HERO'S JOURNEY: Floating Score Animation ========== */
.floating-score{
  position:fixed;z-index:500;font-size:1.5em;font-weight:bold;
  pointer-events:none;opacity:0;
  animation:floatingScore 1.5s ease-out forwards;
  text-shadow:0 2px 8px rgba(0,0,0,0.5);
  font-family:'GF','STKaiti','KaiTi',serif;letter-spacing:2px;
}
.floating-score.gain{color:#6bba6b;}
.floating-score.loss{color:#c56b6b;}
@keyframes floatingScore{
  0%{opacity:0;transform:translateY(0) scale(0.8);}
  20%{opacity:1;transform:translateY(-10px) scale(1.2);}
  40%{transform:translateY(-20px) scale(1);}
  100%{opacity:0;transform:translateY(-60px) scale(0.9);}
}

/* ========== HERO'S JOURNEY: Streak Badge ========== */
.streak-badge{
  position:fixed;top:90px;left:50%;transform:translateX(-50%);z-index:160;
  background:linear-gradient(135deg,rgba(40,20,5,0.95),rgba(25,12,2,0.95));
  border:2px solid #f1c40f;border-radius:8px;padding:10px 24px;
  color:#f1c40f;font-size:1.1em;letter-spacing:3px;
  box-shadow:0 0 30px rgba(241,196,15,0.3);
  opacity:0;pointer-events:none;animation:streakPop 3s forwards;
  text-shadow:0 0 8px rgba(241,196,15,0.5);
}
@keyframes streakPop{
  0%{opacity:0;transform:translateX(-50%) scale(0.7);}
  10%{opacity:1;transform:translateX(-50%) scale(1.1);}
  20%{transform:translateX(-50%) scale(1);}
  80%{opacity:1;}
  100%{opacity:0;transform:translateX(-50%) translateY(-10px);}
}

/* ========== HERO'S JOURNEY: Rank Up Notification ========== */
.rankup-notif{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:600;
  background:linear-gradient(135deg,rgba(30,20,5,0.97),rgba(15,10,2,0.97));
  border:2px solid var(--gold);border-radius:12px;padding:28px 40px;
  text-align:center;box-shadow:0 0 60px rgba(201,169,110,0.4),0 0 120px rgba(201,169,110,0.15);
  opacity:0;pointer-events:none;animation:rankUpAppear 4s forwards;
}
.rankup-notif .ru-label{color:#8a7a5a;font-size:0.85em;letter-spacing:3px;margin-bottom:8px;}
.rankup-notif .ru-title{
  color:var(--bright-gold);font-size:2em;letter-spacing:6px;
  text-shadow:0 0 24px rgba(201,169,110,0.5);margin-bottom:4px;
}
.rankup-notif .ru-arrow{color:#8a7a5a;font-size:0.9em;margin-bottom:4px;}
.rankup-notif .ru-old{color:#666;font-size:0.9em;letter-spacing:2px;}
@keyframes rankUpAppear{
  0%{opacity:0;transform:translate(-50%,-50%) scale(0.5);}
  10%{opacity:1;transform:translate(-50%,-50%) scale(1.08);}
  18%{transform:translate(-50%,-50%) scale(1);}
  80%{opacity:1;transform:translate(-50%,-50%) scale(1);}
  100%{opacity:0;transform:translate(-50%,-50%) scale(0.95) translateY(-15px);}
}

/* ========== HERO'S JOURNEY: Event Score Display ========== */
.event-score-display{
  font-size:1.8em;font-weight:bold;text-align:center;margin:12px 0 8px;
  letter-spacing:4px;opacity:0;animation:eventScorePop 0.8s 0.3s ease forwards;
}
.event-score-display.positive{color:#6bba6b;text-shadow:0 0 16px rgba(107,186,107,0.4);}
.event-score-display.negative{color:#c56b6b;text-shadow:0 0 16px rgba(197,107,107,0.4);}
@keyframes eventScorePop{
  0%{opacity:0;transform:scale(0.4);}
  50%{opacity:1;transform:scale(1.3);}
  100%{opacity:1;transform:scale(1);}
}
.event-perfect{
  color:#f1c40f;font-size:1em;text-align:center;letter-spacing:3px;margin:4px 0;
  text-shadow:0 0 12px rgba(241,196,15,0.4);
  opacity:0;animation:perfectPop 0.6s 0.6s ease forwards;
}
@keyframes perfectPop{0%{opacity:0;transform:scale(0.6);}60%{transform:scale(1.15);}100%{opacity:1;transform:scale(1);}}
.event-streak-display{
  color:#f1c40f;font-size:0.9em;text-align:center;letter-spacing:2px;margin:4px 0;
  opacity:0;animation:perfectPop 0.5s 0.8s ease forwards;
}

/* ========== HERO'S JOURNEY: Mandate Health Bar Enhancement ========== */
.mandate-score.mandate-high .ms-val{color:#f1c40f;text-shadow:0 0 12px rgba(241,196,15,0.5);}
.mandate-score.mandate-ok .ms-val{color:#6bba6b;}
.mandate-score.mandate-warn .ms-val{color:#e67e22;animation:mandateWarnPulse 1.2s infinite;}
.mandate-score.mandate-danger .ms-val{color:#e74c3c;animation:mandateDangerPulse 0.8s infinite;}
@keyframes mandateWarnPulse{0%,100%{text-shadow:none;}50%{text-shadow:0 0 12px rgba(230,126,34,0.6);}}
@keyframes mandateDangerPulse{0%,100%{text-shadow:none;transform:scale(1);}50%{text-shadow:0 0 16px rgba(231,76,60,0.8);transform:scale(1.1);}}

/* Mandate warning popup */
.mandate-warning{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:400;
  background:linear-gradient(135deg,rgba(40,10,10,0.95),rgba(20,5,5,0.95));
  border:2px solid #e74c3c;border-radius:10px;padding:20px 36px;
  text-align:center;
  box-shadow:0 0 40px rgba(231,76,60,0.4);
  opacity:0;pointer-events:none;animation:mandateWarnPop 3s forwards;
}
.mandate-warning .mw-icon{font-size:2em;margin-bottom:6px;}
.mandate-warning .mw-text{color:#e74c3c;font-size:1.2em;letter-spacing:3px;text-shadow:0 0 10px rgba(231,76,60,0.4);}
@keyframes mandateWarnPop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(0.8);}
  10%{opacity:1;transform:translate(-50%,-50%) scale(1.05);}
  20%{transform:translate(-50%,-50%) scale(1);}
  80%{opacity:1;}
  100%{opacity:0;}
}

/* Screen red edge glow for critical mandate */
.screen-danger-glow{
  position:fixed;inset:0;z-index:50;pointer-events:none;
  box-shadow:inset 0 0 80px rgba(231,76,60,0.3),inset 0 0 160px rgba(180,40,40,0.15);
  animation:dangerGlowPulse 2s ease-in-out infinite;
}
@keyframes dangerGlowPulse{0%,100%{opacity:0.4;}50%{opacity:1;}}

/* Golden glow for high mandate */
.screen-golden-glow{
  position:fixed;inset:0;z-index:50;pointer-events:none;
  box-shadow:inset 0 0 60px rgba(241,196,15,0.1),inset 0 0 120px rgba(201,169,110,0.05);
  opacity:0.6;
}

/* ========== HERO'S JOURNEY: Game Over Screen ========== */
#gameover-overlay{
  position:fixed;inset:0;z-index:700;display:none;align-items:center;justify-content:center;
  flex-direction:column;background:rgba(0,0,0,0.95);
}
#gameover-overlay.active{display:flex;animation:gameoverFade 2s ease forwards;}
@keyframes gameoverFade{0%{background:rgba(0,0,0,0);}100%{background:rgba(0,0,0,0.95);}}
#gameover-overlay h1{
  font-size:3em;color:#e74c3c;letter-spacing:10px;
  text-shadow:0 0 40px rgba(231,76,60,0.5);
  opacity:0;animation:gameoverTitle 1s 1s ease forwards;
}
@keyframes gameoverTitle{0%{opacity:0;transform:scale(0.6);}100%{opacity:1;transform:scale(1);}}
#gameover-overlay .go-desc{
  color:#888;font-size:1em;line-height:2;text-align:center;max-width:400px;
  margin:16px 0 28px;opacity:0;animation:fadeIn 0.8s 2s ease forwards;
}
#gameover-overlay .go-score{
  color:var(--gold);font-size:1em;margin-bottom:24px;
  opacity:0;animation:fadeIn 0.8s 2.5s ease forwards;
}
#gameover-overlay .start-btn{opacity:0;animation:fadeIn 0.8s 3s ease forwards;}

/* ========== HERO'S JOURNEY: Score Milestone Flash ========== */
.score-milestone{
  position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);z-index:500;
  color:var(--bright-gold);font-size:1.8em;letter-spacing:6px;
  text-shadow:0 0 30px rgba(201,169,110,0.5);
  opacity:0;pointer-events:none;animation:milestonePop 2.5s forwards;
}
@keyframes milestonePop{
  0%{opacity:0;transform:translate(-50%,-50%) scale(0.5);}
  15%{opacity:1;transform:translate(-50%,-50%) scale(1.15);}
  25%{transform:translate(-50%,-50%) scale(1);}
  75%{opacity:1;}
  100%{opacity:0;transform:translate(-50%,-50%) translateY(-20px);}
}

/* ========== HERO'S JOURNEY: Responsive adjustments ========== */
@media (max-width: 768px) {
  #prologue-overlay{padding:16px;}
  .prologue-content{max-width:95vw;}
  .prologue-book{font-size:0.85em;}
  .prologue-role{font-size:0.95em;}
  .prologue-role .role-name{font-size:1.2em;}
  .prologue-howto{font-size:0.82em;padding:10px 14px;}
  .prologue-cta{padding:14px 40px;font-size:1.1em;letter-spacing:5px;}
  .hero-rank{font-size:0.65em;padding:1px 6px;}
  .hero-score{font-size:0.78em;}
  .hero-score .score-val{font-size:1em;min-width:24px;}
  #journey-progress{height:4px;}
  #journey-progress-text{font-size:0.5em;}
  .floating-score{font-size:1.2em;}
  .streak-badge{font-size:0.9em;padding:8px 18px;}
  .rankup-notif{padding:20px 28px;max-width:90vw;}
  .rankup-notif .ru-title{font-size:1.5em;}
  .event-score-display{font-size:1.4em;}
  .mandate-warning{padding:16px 24px;}
  #gameover-overlay h1{font-size:2.2em;letter-spacing:6px;}
}
</style>
</head>
<body>

<!-- ========== 英雄序章 (Prologue) ========== -->
<div id="prologue-overlay" style="display:none;">
  <div class="prologue-content">
    <div class="prologue-book" id="prologue-book">
      <span class="book-title">《枢纽：3000年的中国》</span><br>
      讲述了一个文明体的故事——<br>
      中国不是一个简单的国家，而是由<br>
      <b>中原、草原、西域、高原、海洋</b><br>
      五大空间交织而成的世界。
    </div>
    <div class="prologue-divider" id="prologue-divider"></div>
    <div class="prologue-role" id="prologue-role">
      你将扮演<br>
      <span class="role-name">天 命 执 掌 者</span>
      超越时空的文明引导者<br>
      你的每一个决策，都将塑造华夏三千年的命运走向。
    </div>
    <div class="prologue-howto" id="prologue-howto">
      <b>目标</b>：维持天命值在 100 以上，引导七大区域走向繁荣<br>
      <b>胜利</b>：七区均衡强盛 = 最佳结局「天下枢纽」<br>
      <b>危机</b>：天命归零，文明陨落 = 游戏结束
    </div>
    <button class="prologue-cta" id="prologue-cta" onclick="closePrologueAndStart()">执 掌 天 命</button>
  </div>
</div>

<!-- ========== 游戏结束 (Game Over) ========== -->
<div id="gameover-overlay">
  <h1>天 命 陨 落</h1>
  <div class="go-desc">天命值归零，文明的火种在历史长河中黯然熄灭。<br>三千年的辉煌，终归尘土。<br>然而历史从不止步——你是否愿意重新执掌天命？</div>
  <div class="go-score" id="gameover-score">最终得分：0</div>
  <button class="start-btn" onclick="location.reload()">再 续 天 命</button>
</div>

<!-- ========== Screen Glow Effects ========== -->
<div id="screen-glow" style="display:none;"></div>

<!-- ========== 开始画面 ========== -->
<div id="start-screen">
  <!-- 光束 -->
  <div class="light-beams"></div>
  <!-- 底层：星空 -->
  <div class="stars-layer"></div>
  <!-- 中层：远山剪影 -->
  <div class="mountains-layer">
    <div class="mountain-far"></div>
    <div class="mountain-mid"></div>
    <div class="mountain-near"></div>
  </div>
  <!-- 上层：飘动云雾 -->
  <div class="clouds-layer">
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>
    <div class="cloud cloud-3"></div>
  </div>
  <!-- 电影宽银幕黑边 -->
  <div class="letterbox-top"></div>
  <div class="letterbox-bottom"></div>
  <!-- 粒子 -->
  <div class="start-particles" id="start-particles"></div>
  <!-- 静音按钮 -->
  <button class="mute-btn" id="start-mute-btn" title="音效开关">&#x1f50a;</button>
  <!-- 冲击波 -->
  <div class="title-shockwave" id="title-shockwave"></div>
  <div class="title-area">
    <h1 id="main-title">枢纽</h1>
    <div class="subtitle" id="main-subtitle">天 下 之 道</div>
    <div class="title-gold-line" id="title-gold-line"></div>
    <div class="author">—— 基于施展《枢纽：3000年的中国》 ——</div>
  </div>
  <div class="poem" id="start-poem">
    <div class="poem-line">三千年风云际会</div>
    <div class="poem-line">七大空间，纵横捭阖</div>
    <div class="poem-line">铁骑踏破山河，丝路连通四海</div>
    <div class="poem-line gold-line">天命在手——你，将如何经略天下？</div>
  </div>
  <button class="start-btn pulse-glow" id="start-btn">执 掌 天 命</button>
</div>

<!-- ========== 时代过渡 ========== -->
<div id="era-transition">
  <div class="era-trans-content">
    <div class="era-trans-summary" id="era-trans-summary"></div>
    <h2 id="era-trans-title"></h2>
    <div class="era-trans-line" id="era-trans-line"></div>
    <p id="era-trans-desc"></p>
    <div class="era-trans-preview" id="era-trans-preview"></div>
  </div>
</div>

<!-- ========== 主游戏 ========== -->
<div id="game">
  <!-- Timeline Bar -->
  <div id="timeline-bar">
    <div class="timeline-track">
      <div class="timeline-eras" id="timeline-eras">
        <div class="timeline-era-seg" data-era="1"></div>
        <div class="timeline-era-seg" data-era="2"></div>
        <div class="timeline-era-seg" data-era="3"></div>
        <div class="timeline-era-seg" data-era="4"></div>
      </div>
      <div class="timeline-dots" id="timeline-dots"></div>
    </div>
    <div class="timeline-markers">
      <span>前1046 武王伐纣</span>
      <span>前221 秦统一</span>
      <span>618 唐</span>
      <span>960 宋</span>
      <span>1840 鸦片战争</span>
      <span>1949 新中国</span>
    </div>
  </div>

  <!-- Journey Progress Bar -->
  <div id="journey-progress">
    <div id="journey-progress-fill" style="width:0%"></div>
    <div id="journey-progress-text">旅程 0/36</div>
  </div>

  <!-- Top Bar with Resources -->
  <div id="top-bar">
    <div class="era-badge" id="era-display">第一纪 · 封建社会</div>
    <div class="turn-info">第 <span id="turn-num">1</span> 回合</div>
    <div class="mandate-score" id="mandate-display" title="天命 = 七区总实力 + 均衡加成（区域越均衡，加成越高）">
      <span class="ms-label">天命</span>
      <span class="ms-val" id="mandate-val">0</span>
      <span class="ms-trend" id="mandate-trend"></span>
    </div>
    <div class="hero-score" title="得分">
      <span style="color:#8a7a5a;font-size:0.85em;">分</span>
      <span class="score-val" id="score-display">0</span>
    </div>
    <div class="hero-rank" id="rank-display" title="称号">草莽布衣</div>
    <div class="resources">
      <div class="res-item" id="ri-power" title="七区经济繁荣度之和（满分70）">兴 <span id="res-power">50</span><span class="res-max">/70</span></div>
      <div class="res-item" id="ri-military" title="七区军事力量之和（满分70）">武 <span id="res-military">50</span><span class="res-max">/70</span></div>
      <div class="res-item" id="ri-culture" title="七区文化影响之和（满分70）">文 <span id="res-culture">50</span><span class="res-max">/70</span></div>
      <div class="res-item" id="ri-trade" title="七区商贸活力之和（满分70）">商 <span id="res-trade">50</span><span class="res-max">/70</span></div>
    </div>
  </div>

  <!-- Game Body: Map + Crisis Panel -->
  <div id="game-body">
    <!-- Left: Map Area -->
    <div id="map-area">
      <div id="game-particles"></div>
      <div id="chain-notifications"></div>
      <svg id="map-svg" viewBox="0 0 600 450">
        <defs>
          <radialGradient id="terrainGrad" cx="50%" cy="45%" r="55%">
            <stop offset="0%" stop-color="rgba(201,169,110,0.06)"/>
            <stop offset="50%" stop-color="rgba(201,169,110,0.03)"/>
            <stop offset="100%" stop-color="transparent"/>
          </radialGradient>
          <filter id="nodeGlow">
            <feGaussianBlur stdDeviation="6" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <filter id="statusGlow-military"><feGaussianBlur stdDeviation="8" result="b"/><feFlood flood-color="rgba(220,60,40,0.35)" result="c"/><feComposite in="c" in2="b" operator="in" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <filter id="statusGlow-culture"><feGaussianBlur stdDeviation="8" result="b"/><feFlood flood-color="rgba(120,80,200,0.35)" result="c"/><feComposite in="c" in2="b" operator="in" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <filter id="statusGlow-trade"><feGaussianBlur stdDeviation="8" result="b"/><feFlood flood-color="rgba(220,190,60,0.35)" result="c"/><feComposite in="c" in2="b" operator="in" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <filter id="statusGlow-weak"><feGaussianBlur stdDeviation="4" result="b"/><feFlood flood-color="rgba(80,80,80,0.5)" result="c"/><feComposite in="c" in2="b" operator="in" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <!-- Region fill paths (real China geography) -->
        <g id="map-regions">
          <!-- 草原 Steppe: Inner Mongolia, NE -->
          <path data-region="caoyuan" class="region-path" d="M200,30 L240,25 L300,20 L370,22 L440,28 L500,40 L540,58 L555,75 L540,95 L510,105 L470,100 L430,95 L400,100 L370,105 L340,100 L310,95 L280,100 L260,95 L240,85 L220,70 L200,55 Z"/>
          <!-- 西域 Western Regions: Xinjiang, Gansu corridor -->
          <path data-region="xiyu" class="region-path" d="M60,70 L100,55 L140,50 L180,48 L200,55 L200,30 L180,48 L160,60 L130,80 L110,105 L95,130 L85,160 L80,190 L85,210 L100,225 L120,230 L140,220 L155,205 L170,195 L185,190 L195,195 L190,210 L175,228 L160,240 L140,245 L120,242 L100,238 L85,225 L75,205 L68,180 L65,155 L68,125 L75,100 L85,80 Z"/>
          <!-- 高原 Plateau: Tibet, Qinghai -->
          <path data-region="gaoyuan" class="region-path" d="M85,225 L120,242 L140,245 L165,248 L190,250 L210,255 L230,265 L245,280 L250,300 L240,320 L220,330 L195,335 L170,330 L145,318 L125,305 L110,285 L95,265 L85,245 Z"/>
          <!-- 中原 Central Plains: Henan, Hebei, Shandong, Shaanxi -->
          <path data-region="zhongyuan" class="region-path" d="M260,95 L280,100 L310,95 L340,100 L370,105 L400,100 L430,95 L440,105 L435,125 L420,145 L400,160 L385,175 L370,185 L350,195 L330,200 L310,198 L290,195 L270,200 L255,210 L245,225 L240,210 L240,195 L245,175 L250,155 L255,135 L258,115 Z"/>
          <!-- 过渡地带 Transition Zone -->
          <path data-region="guodu" class="region-path" d="M195,195 L220,190 L240,195 L245,225 L255,210 L270,200 L290,195 L310,198 L330,200 L345,210 L355,225 L358,245 L350,265 L335,278 L315,285 L295,282 L275,275 L255,268 L240,260 L230,265 L210,255 L190,250 L190,210 Z"/>
          <!-- 西南 Southwest: Yunnan, Guizhou, Sichuan west -->
          <path data-region="xinan" class="region-path" d="M170,330 L195,335 L220,330 L240,320 L250,300 L255,268 L275,275 L295,282 L310,290 L300,310 L285,328 L270,345 L255,360 L240,375 L225,388 L210,398 L195,405 L178,400 L165,388 L155,372 L150,355 L155,340 Z"/>
          <!-- 海洋 Maritime: Coast, SE, Taiwan -->
          <path data-region="haiyang" class="region-path" d="M440,105 L470,100 L510,105 L540,95 L555,110 L560,135 L558,165 L550,195 L540,225 L525,255 L510,280 L495,300 L478,315 L460,328 L445,340 L430,355 L415,370 L400,382 L385,390 L370,395 L355,392 L345,380 L340,365 L340,345 L345,325 L350,308 L350,265 L355,225 L345,210 L330,200 L350,195 L370,185 L385,175 L400,160 L420,145 L435,125 Z"/>
        </g>
        <!-- Trade route connections -->
        <g id="trade-routes">
          <path class="connection-line" data-from="zhongyuan" data-to="xiyu" d="M290,160 Q220,175 150,185"/>
          <path class="connection-line" data-from="zhongyuan" data-to="caoyuan" d="M330,100 Q370,70 400,55"/>
          <path class="connection-line" data-from="zhongyuan" data-to="guodu" d="M300,200 Q295,230 290,260"/>
          <path class="connection-line" data-from="xiyu" data-to="gaoyuan" d="M110,230 Q130,250 160,260"/>
          <path class="connection-line" data-from="zhongyuan" data-to="haiyang" d="M400,160 Q440,150 480,160"/>
          <path class="connection-line" data-from="guodu" data-to="xinan" d="M270,280 Q260,310 250,340"/>
          <path class="connection-line" data-from="guodu" data-to="haiyang" d="M340,270 Q380,290 420,310"/>
          <path class="connection-line" data-from="gaoyuan" data-to="xinan" d="M180,335 Q175,350 185,370"/>
          <path class="connection-line" data-from="haiyang" data-to="xinan" d="M400,380 Q340,395 260,385"/>
          <path class="connection-line" data-from="caoyuan" data-to="xiyu" d="M230,50 Q180,55 140,65"/>
          <path class="connection-line" data-from="caoyuan" data-to="haiyang" d="M500,55 Q530,80 545,110"/>
        </g>
        <!-- World layer: living world elements (weather, buildings, population) -->
        <g id="map-world-layer"></g>
        <!-- Region labels (rendered by JS) -->
        <g id="map-labels"></g>
        <!-- Event scene overlay (arrows, labels, icons) -->
        <g id="map-scene-layer"></g>
        <!-- Animated trade dots container -->
        <g id="trade-dots"></g>
      </svg>
      <!-- Map Tooltip -->
      <div id="map-tooltip">
        <div class="tt-name" id="tt-name"></div>
        <div class="tt-desc" id="tt-desc"></div>
        <div class="tt-stats" id="tt-stats"></div>
      </div>
    </div>

    <!-- Right: Crisis Briefing Panel -->
    <div id="crisis-panel">
      <div id="crisis-content">
        <div class="crisis-placeholder" id="crisis-placeholder">
          <div style="font-size:2em;margin-bottom:8px;opacity:0.3;">&#x2694;&#xFE0F;</div>
          <div>等待天命降临...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Tabs -->
  <div id="mobile-tabs">
    <button class="mobile-tab active" data-tab="event" onclick="switchMobileTab('event')">事 件</button>
    <button class="mobile-tab" data-tab="map" onclick="switchMobileTab('map')">天 下</button>
  </div>

  <!-- Mobile Region Bottom Sheet -->
  <div id="mobile-region-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-name" id="sheet-name"></div>
    <div class="sheet-desc" id="sheet-desc"></div>
    <div class="sheet-stats" id="sheet-stats"></div>
    <div class="sheet-lore" id="sheet-lore"></div>
  </div>

  <!-- Bottom Bar -->
  <div id="bottom-bar">
    <div id="power-ranking"></div>
    <button class="bottom-btn" onclick="showHistory()">史卷</button>
    <button class="bottom-btn" onclick="saveGame()">存档</button>
    <button class="bottom-btn" onclick="loadGame()">读档</button>
    <button class="bottom-btn" onclick="showHelp()">指南</button>
    <button class="mute-btn" id="game-mute-btn" title="音效开关">&#x1f50a;</button>
  </div>
</div>

<!-- History Log Modal -->
<div id="history-modal">
  <div class="history-card">
    <h2>历 史 长 卷</h2>
    <div class="history-log" id="history-log"></div>
    <button class="history-dismiss" onclick="closeHistory()">关 闭</button>
  </div>
</div>

<!-- 帮助弹窗 -->
<div id="help-modal">
  <div class="help-card">
    <h2>枢纽：天下之道</h2>
    <div class="help-section">
      <h3>玩法说明</h3>
      <p>你将经历中国3000年历史的四个纪元，每个事件有三种选择，影响七大空间的发展走向。</p>
    </div>
    <div class="help-section">
      <h3>四项指标（每区域 0-10 分）</h3>
      <div class="help-stats">
        <div class="help-stat"><b>兴</b> 经济繁荣 — 民生根基，影响连锁反应</div>
        <div class="help-stat"><b>武</b> 军事力量 — 攻防实力，过高引发入侵</div>
        <div class="help-stat"><b>文</b> 文化影响 — 精神纽带，传播至邻近区域</div>
        <div class="help-stat"><b>商</b> 商贸活力 — 区域连接，贸易路线越亮越通畅</div>
      </div>
      <div class="help-tip" style="margin-top:6px;">顶栏显示的是七区总和（满分70）。地图数字为单区总实力（满分40）：<br>≤12=危 · ≤20=弱 · ≤28=平 · ≤35=盛 · 36+=极</div>
    </div>
    <div class="help-section">
      <h3>目标：追求均衡</h3>
      <p>没有任何一个空间能单独定义"中国"。天命值 = 七区总实力 + 均衡加成（区域越均衡加成越高）。追求多元共生而非一家独大。</p>
    </div>
    <div class="help-section">
      <h3>可能的结局</h3>
      <div class="help-tip">
        🌐 <b>天下枢纽</b> — 七区均衡且强盛（最佳结局）<br>
        🏛 <b>中原帝国</b> — 中原一家独大<br>
        ⛵ <b>海洋时代</b> — 海洋实力压倒中原<br>
        📖 <b>文运昌隆</b> — 全区文化总和极高<br>
        ⚔ <b>武定天下</b> — 全区军事总和极高<br>
        💰 <b>商通四海</b> — 全区商贸总和极高<br>
        ⚖ <b>守成之局</b> — 平庸但稳定<br>
        💀 <b>天下大乱</b> — 总实力过低
      </div>
    </div>
    <div class="help-section">
      <h3>操作提示</h3>
      <div class="help-tip">
        悬停选项可预览效果 | 点击地图区域查看详情<br>
        左侧色带：绿=稳妥 · 黄=有风险 · 红=高风险<br>
        注意连锁反应：你的选择会在区域间产生涟漪效应
      </div>
    </div>
    <div class="help-section" style="text-align:center;">
      <p style="color:#6a5a3a;font-size:0.8em;">基于施展《枢纽：3000年的中国》</p>
    </div>
    <button class="help-dismiss" onclick="closeHelp()">知 道 了</button>
  </div>
</div>

<!-- Tutorial Overlay -->
<div id="tutorial-overlay" style="display:none;">
  <div class="tutorial-backdrop"></div>
  <div class="tutorial-card" id="tutorial-card">
    <div class="tutorial-step" id="tutorial-step-text"></div>
    <div class="tutorial-progress" id="tutorial-progress"></div>
    <button class="tutorial-btn" id="tutorial-btn" onclick="advanceTutorial()">知道了</button>
  </div>
</div>

<!-- Event Review Modal -->
<div id="event-review-modal" onclick="if(event.target===this)closeEventReview()">
  <div class="review-card" id="review-card-content">
  </div>
</div>

<div id="achievement-container"></div>
<div id="hegemony-notif" style="display:none;"></div>

<!-- ========== 结局画面 ========== -->
<div id="ending-screen">
  <h1 id="ending-title"></h1>
  <div class="ending-desc" id="ending-desc"></div>
  <div class="score" id="ending-score"></div>
  <button class="start-btn" onclick="location.reload()">再 续 天 命</button>
</div>

<!-- Stat explanation popup -->
<div id="stat-explain-overlay" onclick="closeStatExplain(event)">
  <div id="stat-explain-box"></div>
</div>

<script src="events-extra.js"></script>
<script src="events-hard.js"></script>
<script src="deep-knowledge.js"></script>
<script src="effect-reasons.js"></script>
<script src="map-scenes.js"></script>
<script src="map-world.js"></script>
<script src="historical-outcomes.js"></script>
<script src="trap-choices.js"></script>
<script>
// ==================== Web Audio API 音效系统 ====================

const SFX = {
  ctx: null,
  muted: false,
  ambientGain: null,
  ambientOscs: [],
  _initialized: false,

  init() {
    if (this._initialized) return;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = this.ctx;
      // Resume suspended AudioContext (browser autoplay policy)
      if (ctx.state === 'suspended') {
        ctx.resume();
      }
      // iOS/Safari unlock trick: play a silent buffer to activate the context
      try {
        const silentBuf = ctx.createBuffer(1, 1, ctx.sampleRate);
        const src = ctx.createBufferSource();
        src.buffer = silentBuf;
        src.connect(ctx.destination);
        src.start();
      } catch(e2) {}
      this._initialized = true;
      // Restore mute preference
      if (localStorage.getItem('pivot_muted') === '1') {
        this.muted = true;
        this._updateMuteButtons();
      }
    } catch(e) {
      console.warn('Web Audio API not available:', e);
    }
  },

  // Ensure AudioContext is running (call before any playback)
  _ensureResumed() {
    if (this.ctx && this.ctx.state === 'suspended') {
      this.ctx.resume();
    }
  },

  _updateMuteButtons() {
    const icon = this.muted ? '\u{1F507}' : '\u{1F50A}';
    document.querySelectorAll('.mute-btn').forEach(btn => { btn.textContent = icon; });
  },

  toggleMute() {
    this.muted = !this.muted;
    localStorage.setItem('pivot_muted', this.muted ? '1' : '0');
    this._updateMuteButtons();
    if (this.muted) {
      this.stopAmbient();
    } else {
      // Unmuting: resume context and restart ambient
      this._ensureResumed();
      this.ambient(); // ambient() already checks if already playing
    }
  },

  // --- 开场环境音 ---
  ambient() {
    if (!this.ctx || this.muted) return;
    if (this.ambientOscs.length > 0) return; // already playing
    this._ensureResumed();
    const ctx = this.ctx;
    const masterGain = ctx.createGain();
    masterGain.gain.setValueAtTime(0, ctx.currentTime);
    masterGain.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 2);
    masterGain.connect(ctx.destination);
    this.ambientGain = masterGain;

    // Low pad: two detuned oscillators through a low-pass filter
    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(200, ctx.currentTime);
    filter.Q.setValueAtTime(1, ctx.currentTime);
    filter.connect(masterGain);

    const freqs = [55, 55.5]; // slightly detuned A1
    freqs.forEach(freq => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.5, ctx.currentTime);
      osc.connect(g);
      g.connect(filter);
      osc.start();
      this.ambientOscs.push(osc);
    });

    // Add a subtle second harmonic
    const osc2 = ctx.createOscillator();
    osc2.type = 'triangle';
    osc2.frequency.setValueAtTime(110, ctx.currentTime);
    const g2 = ctx.createGain();
    g2.gain.setValueAtTime(0.15, ctx.currentTime);
    osc2.connect(g2);
    g2.connect(filter);
    osc2.start();
    this.ambientOscs.push(osc2);
  },

  fadeOutAmbient(duration) {
    if (!this.ambientGain || !this.ctx) return;
    const ctx = this.ctx;
    this.ambientGain.gain.linearRampToValueAtTime(0, ctx.currentTime + (duration || 1.5));
    const oscs = this.ambientOscs;
    setTimeout(() => {
      oscs.forEach(o => { try { o.stop(); } catch(e){} });
    }, (duration || 1.5) * 1000 + 100);
    this.ambientOscs = [];
    this.ambientGain = null;
  },

  stopAmbient() {
    if (this.ambientOscs.length > 0) {
      this.ambientOscs.forEach(o => { try { o.stop(); } catch(e){} });
      this.ambientOscs = [];
      this.ambientGain = null;
    }
  },

  // --- 开场洪钟/号角声 (first interaction) ---
  openingGong() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Deep gong
    const osc1 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(50, ctx.currentTime);
    const g1 = ctx.createGain();
    g1.gain.setValueAtTime(0.25, ctx.currentTime);
    g1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 3.5);
    osc1.connect(g1); g1.connect(ctx.destination);
    osc1.start(); osc1.stop(ctx.currentTime + 3.7);
    // Mid resonance
    const osc2 = ctx.createOscillator();
    osc2.type = 'triangle';
    osc2.frequency.setValueAtTime(100, ctx.currentTime);
    const g2 = ctx.createGain();
    g2.gain.setValueAtTime(0.12, ctx.currentTime);
    g2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
    osc2.connect(g2); g2.connect(ctx.destination);
    osc2.start(); osc2.stop(ctx.currentTime + 2.7);
    // Impact noise
    const bufSize = ctx.sampleRate * 0.08;
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * 0.4;
    const noise = ctx.createBufferSource();
    noise.buffer = buf;
    const nf = ctx.createBiquadFilter();
    nf.type = 'lowpass'; nf.frequency.setValueAtTime(150, ctx.currentTime);
    const ng = ctx.createGain();
    ng.gain.setValueAtTime(0.2, ctx.currentTime);
    ng.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
    noise.connect(nf); nf.connect(ng); ng.connect(ctx.destination);
    noise.start();
  },

  // --- 游戏开始：上升和弦 ---
  gameStartChord() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Rising chord: D3, A3, D4, F#4, A4
    const notes = [146.83, 220, 293.66, 369.99, 440];
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = i < 2 ? 'triangle' : 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.15);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.15);
      gain.gain.linearRampToValueAtTime(0.12, ctx.currentTime + i * 0.15 + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 1.5);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.15);
      osc.stop(ctx.currentTime + i * 0.15 + 1.6);
    });
    // Shimmer at the peak
    setTimeout(() => {
      if (!this.ctx || this.muted) return;
      const shimmer = ctx.createOscillator();
      shimmer.type = 'sine';
      shimmer.frequency.setValueAtTime(880, ctx.currentTime);
      const sg = ctx.createGain();
      sg.gain.setValueAtTime(0.05, ctx.currentTime);
      sg.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
      shimmer.connect(sg); sg.connect(ctx.destination);
      shimmer.start(); shimmer.stop(ctx.currentTime + 0.9);
    }, 700);
  },

  // --- 按钮点击音 ---
  click() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    const osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(150, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.08);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.12);
  },

  // --- 选择确认音 ---
  choiceConfirm() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Fundamental
    const osc1 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(220, ctx.currentTime);
    const gain1 = ctx.createGain();
    gain1.gain.setValueAtTime(0.18, ctx.currentTime);
    gain1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
    osc1.connect(gain1);
    gain1.connect(ctx.destination);
    osc1.start();
    osc1.stop(ctx.currentTime + 0.35);

    // Octave harmonic
    const osc2 = ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(440, ctx.currentTime);
    const gain2 = ctx.createGain();
    gain2.gain.setValueAtTime(0.08, ctx.currentTime);
    gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
    osc2.connect(gain2);
    gain2.connect(ctx.destination);
    osc2.start();
    osc2.stop(ctx.currentTime + 0.3);
  },

  // --- 正面效果音 ---
  positiveChime() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.1);
      gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + i * 0.1 + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.15);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.1);
      osc.stop(ctx.currentTime + i * 0.1 + 0.2);

      // Subtle harmonic
      const h = ctx.createOscillator();
      h.type = 'sine';
      h.frequency.setValueAtTime(freq * 2, ctx.currentTime);
      const hg = ctx.createGain();
      hg.gain.setValueAtTime(0, ctx.currentTime + i * 0.1);
      hg.gain.linearRampToValueAtTime(0.04, ctx.currentTime + i * 0.1 + 0.02);
      hg.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.12);
      h.connect(hg);
      hg.connect(ctx.destination);
      h.start(ctx.currentTime + i * 0.1);
      h.stop(ctx.currentTime + i * 0.1 + 0.15);
    });
  },

  // --- 负面效果音 ---
  negativeThud() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    const osc = ctx.createOscillator();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(200, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.3);

    // WaveShaper distortion
    const shaper = ctx.createWaveShaper();
    const curve = new Float32Array(256);
    for (let i = 0; i < 256; i++) {
      const x = (i / 128) - 1;
      curve[i] = (Math.PI + 3) * x / (Math.PI + 3 * Math.abs(x));
    }
    shaper.curve = curve;
    shaper.oversample = '2x';

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.35);

    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(300, ctx.currentTime);

    osc.connect(shaper);
    shaper.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.4);
  },

  // --- 陷阱揭示音（不和谐下降音） ---
  trapReveal() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Dissonant descending chord
    [200, 253, 300].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(freq * 0.3, ctx.currentTime + 0.8);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.12, ctx.currentTime + i * 0.05);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);
      const f = ctx.createBiquadFilter();
      f.type = 'lowpass';
      f.frequency.setValueAtTime(800, ctx.currentTime);
      f.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.8);
      osc.connect(f); f.connect(g); g.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.05);
      osc.stop(ctx.currentTime + 1.1);
    });
  },

  // --- 时代过渡音（锣声） ---
  eraGong() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Low fundamental
    const osc1 = ctx.createOscillator();
    osc1.type = 'sine';
    osc1.frequency.setValueAtTime(65, ctx.currentTime);
    const g1 = ctx.createGain();
    g1.gain.setValueAtTime(0.2, ctx.currentTime);
    g1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 3);
    osc1.connect(g1);
    g1.connect(ctx.destination);
    osc1.start();
    osc1.stop(ctx.currentTime + 3.2);

    // High harmonic shimmer
    const osc2 = ctx.createOscillator();
    osc2.type = 'sine';
    osc2.frequency.setValueAtTime(520, ctx.currentTime);
    osc2.frequency.exponentialRampToValueAtTime(490, ctx.currentTime + 2);
    const g2 = ctx.createGain();
    g2.gain.setValueAtTime(0.06, ctx.currentTime);
    g2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2);
    osc2.connect(g2);
    g2.connect(ctx.destination);
    osc2.start();
    osc2.stop(ctx.currentTime + 2.2);

    // Mid-tone body
    const osc3 = ctx.createOscillator();
    osc3.type = 'triangle';
    osc3.frequency.setValueAtTime(130, ctx.currentTime);
    const g3 = ctx.createGain();
    g3.gain.setValueAtTime(0.12, ctx.currentTime);
    g3.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.5);
    osc3.connect(g3);
    g3.connect(ctx.destination);
    osc3.start();
    osc3.stop(ctx.currentTime + 2.7);

    // Noise burst for attack
    const bufSize = ctx.sampleRate * 0.05;
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * 0.3;
    const noise = ctx.createBufferSource();
    noise.buffer = buf;
    const ng = ctx.createGain();
    ng.gain.setValueAtTime(0.15, ctx.currentTime);
    ng.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
    const nf = ctx.createBiquadFilter();
    nf.type = 'bandpass';
    nf.frequency.setValueAtTime(200, ctx.currentTime);
    nf.Q.setValueAtTime(2, ctx.currentTime);
    noise.connect(nf);
    nf.connect(ng);
    ng.connect(ctx.destination);
    noise.start();
  },

  // --- 屏幕震动音 ---
  warRumble() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    const bufSize = ctx.sampleRate * 0.5;
    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
    const noise = ctx.createBufferSource();
    noise.buffer = buf;

    const filter = ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(120, ctx.currentTime);
    filter.Q.setValueAtTime(5, ctx.currentTime);

    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.05);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    noise.start();
    noise.stop(ctx.currentTime + 0.55);
  },

  // --- 成就音 ---
  achieveChime() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Rising arpeggio: C5, E5, G5, C6
    const notes = [523.25, 659.25, 783.99, 1046.5];
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.08);
      gain.gain.linearRampToValueAtTime(0.12, ctx.currentTime + i * 0.08 + 0.015);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.08 + 0.3);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.08);
      osc.stop(ctx.currentTime + i * 0.08 + 0.35);
    });
    // Shimmer high harmonic
    const shimmer = ctx.createOscillator();
    shimmer.type = 'sine';
    shimmer.frequency.setValueAtTime(2093, ctx.currentTime + 0.3);
    const sg = ctx.createGain();
    sg.gain.setValueAtTime(0, ctx.currentTime + 0.3);
    sg.gain.linearRampToValueAtTime(0.04, ctx.currentTime + 0.32);
    sg.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
    shimmer.connect(sg);
    sg.connect(ctx.destination);
    shimmer.start(ctx.currentTime + 0.3);
    shimmer.stop(ctx.currentTime + 0.55);
  },

  // --- Map scene sounds (triggered by map changes) ---
  mapWar() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Distant war drums
    [0, 0.2, 0.4].forEach(t => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(60, ctx.currentTime + t);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.12, ctx.currentTime + t);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + t + 0.18);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(ctx.currentTime + t); osc.stop(ctx.currentTime + t + 0.2);
    });
  },

  mapTrade() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Gentle bell-like tones (market sounds)
    [440, 554, 660].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0, ctx.currentTime + i * 0.12);
      g.gain.linearRampToValueAtTime(0.06, ctx.currentTime + i * 0.12 + 0.02);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.12 + 0.3);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.12); osc.stop(ctx.currentTime + i * 0.12 + 0.35);
    });
  },

  mapCulture() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Gentle wind-chime (pentatonic)
    [262, 294, 330, 392, 440].forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.15);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.04, ctx.currentTime + i * 0.15);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.5);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.15); osc.stop(ctx.currentTime + i * 0.15 + 0.55);
    });
  },

  mapPeace() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Soft sustained pad note
    const osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(220, ctx.currentTime);
    const g = ctx.createGain();
    g.gain.setValueAtTime(0, ctx.currentTime);
    g.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 0.3);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.5);
    osc.connect(g); g.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 1.6);
  },

  mapCrisis() {
    if (!this.ctx || this.muted) return;
    this._ensureResumed();
    const ctx = this.ctx;
    // Ominous low rumble + dissonant tone
    const osc1 = ctx.createOscillator();
    osc1.type = 'sawtooth';
    osc1.frequency.setValueAtTime(55, ctx.currentTime);
    const f = ctx.createBiquadFilter();
    f.type = 'lowpass'; f.frequency.setValueAtTime(100, ctx.currentTime);
    const g1 = ctx.createGain();
    g1.gain.setValueAtTime(0.1, ctx.currentTime);
    g1.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
    osc1.connect(f); f.connect(g1); g1.connect(ctx.destination);
    osc1.start(); osc1.stop(ctx.currentTime + 0.9);
  }
};

// ==================== 游戏数据 ====================

const REGION_META = {
  zhongyuan: {name:'中原', color:'#b8860b', x:330, y:155, desc:'农耕心脏，文明根基'},
  caoyuan:   {name:'草原', color:'#4a7c59', x:380, y:55, desc:'铁骑纵横，游牧雄风'},
  xiyu:      {name:'西域', color:'#a0522d', x:120, y:155, desc:'丝路枢纽，万邦交汇'},
  guodu:     {name:'过渡地带', color:'#8b7355', x:280, y:240, desc:'农牧交融，文明熔炉'},
  gaoyuan:   {name:'高原', color:'#4a6fa5', x:155, y:280, desc:'雪域圣境，精神高地'},
  xinan:     {name:'西南', color:'#6b8e6b', x:230, y:355, desc:'密林万族，多元共生'},
  haiyang:   {name:'海洋', color:'#2980b9', x:470, y:250, desc:'碧波万里，通达四海'}
};

const ERA_NAMES = ['','第一纪 · 封建社会','第二纪 · 豪族社会','第三纪 · 古代平民社会','第四纪 · 现代转型'];
const ERA_DESCS = ['','周天子分封天下，礼乐教化，诸侯并立','大一统帝国崛起，豪族门阀把持朝政','科举取士，商业繁荣，却也暗藏内卷危机','三千年未有之大变局，何去何从？'];

// ==================== 事件数据（从 events-hard.js 加载） ====================

const EVENTS = (typeof EVENTS_HARD !== "undefined") ? EVENTS_HARD : {};

const ENDINGS = {
  pivot: {title:'天下枢纽',desc:'你选择了多元共生之路。\n\n七大空间均衡发展，中原与草原握手言和，\n西域丝路再度繁华，海洋连通四海。\n\n中国不是某一个空间的独奏，\n而是所有空间的交响。\n\n正如施展所言：中国之所以成为枢纽，\n正因为它内在地就是一个体系。'},
  empire:{title:'中原帝国',desc:'你选择了以中原为本的道路。\n\n中原强盛，文明辉煌，\n但草原依旧不驯，西域渐行渐远，\n海洋成了别人的天下。\n\n一个伟大的帝国，但不是枢纽。\n历史证明：单一中心无法承载"中国"的全部含义。'},
  ocean: {title:'海洋时代',desc:'你选择了拥抱海洋的道路。\n\n沿海繁荣，贸易发达，\n与世界深度融合。\n但内陆被遗忘，草原与高原疏离，\n"中国"的概念收窄为一个沿海国家。\n\n或许繁荣，但失去了三千年积淀的深度。'},
  balanced:{title:'守成之局',desc:'你没有做出极端选择。\n\n各方面都还过得去，但没有突破。\n中国依然是那个中国，\n不好不坏，不上不下。\n\n历史不会记住平庸的选择。'},
  chaos:  {title:'天下大乱',desc:'你的选择导致了灾难。\n\n各空间分崩离析，\n中原衰败，草原入侵，\n海洋被封锁，西域断联。\n\n"中国"这个概念本身都岌岌可危。\n也许下一次，你会做出不同的选择。'},
  culture_peak:{title:'文运昌隆',desc:'笔墨纸砚铸就了另一种帝国。\n\n从百家争鸣到理学心学，\n从敦煌壁画到青花瓷器，\n文化的力量超越了刀剑。\n\n天下各族虽未必臣服于武力，\n却心悦诚服于文明的光辉。\n这是一个以思想征服人心的时代。'},
  military_hegemony:{title:'武定天下',desc:'铁骑踏遍山河，旌旗插遍四海。\n\n从长城内外到西域天山，\n从高原雪域到南海碧波，\n军威所至，莫敢不从。\n\n但施展在书中警示：\n以武力维系的帝国，注定要为军费所累。\n剑锋所指之处，未必是人心所向。'},
  trade_empire:{title:'商通四海',desc:'金银如水，流遍天下每个角落。\n\n丝路驼铃与海上帆影交相辉映，\n中原的丝绸换来了西域的珠宝，\n南方的茶叶远销万里。\n\n当所有人都在做生意时，\n谁还愿意打仗？\n商业编织的网络，比长城更能连接天下。'}
};

// ==================== 场景与知识数据 ====================

const SCENE_CONFIGS = {
  war:       {gradient:'linear-gradient(180deg,rgba(50,15,15,0.92),rgba(25,8,8,0.95))',particleColor:'rgba(220,80,40,0.6)',particleCount:12},
  trade:     {gradient:'linear-gradient(180deg,rgba(45,35,12,0.92),rgba(20,15,5,0.95))',particleColor:'rgba(220,190,80,0.5)',particleCount:10},
  culture:   {gradient:'linear-gradient(180deg,rgba(20,15,40,0.92),rgba(12,8,25,0.95))',particleColor:'rgba(140,100,200,0.5)',particleCount:8},
  gov:       {gradient:'linear-gradient(180deg,rgba(40,35,12,0.92),rgba(20,18,8,0.95))',particleColor:'rgba(200,170,80,0.4)',particleCount:8},
  transform: {gradient:'linear-gradient(180deg,rgba(10,10,10,0.95),rgba(40,35,10,0.92))',particleColor:'rgba(241,196,15,0.6)',particleCount:15},
  finale:    {gradient:'linear-gradient(180deg,rgba(10,10,10,0.95),rgba(50,40,15,0.92))',particleColor:'rgba(241,196,15,0.7)',particleCount:18}
};

const ADVISORS = [
  {id:'legalist',name:'法家谋士',icon:'\u2696\uFE0F',style:'以法治国，实力为尊'},
  {id:'confucian',name:'儒家贤者',icon:'\uD83D\uDCDC',style:'仁义为本，教化天下'},
  {id:'strategist',name:'纵横家',icon:'\uD83C\uDFAD',style:'合纵连横，权谋制衡'}
];

const ADVISOR_COMMENTS = {
  e1_1:{legalist:'封诸侯则力散，当集权于王畿，以法度统御四方。',confucian:'分封天下，礼乐教化，方能长治久安。仁德服人，胜于刀兵。',strategist:'怀柔旧族乃上策，以殷商旧臣制衡新贵，方可左右逢源。',recs:[1,0,2]},
  e1_2:{legalist:'礼乐虽美，不如刑律严明。文武并举方为正道。',confucian:'礼乐乃文明根基，严格推行方可化人心、定秩序。',strategist:'因地制宜最为务实，各族自治可减少冲突，以时间换空间。',recs:[2,0,1]},
  e1_3:{legalist:'修筑防线，以工事克骑兵，此乃万世之基。',confucian:'东迁保文明火种，留得青山在，不怕没柴烧。',strategist:'和亲通商，化敌为友，不战而屈人之兵。',recs:[0,1,2]},
  e1_4:{legalist:'各国变法，优胜劣汰，强者自然胜出。',confucian:'会盟和平，止戈为武，天下苍生免受战火。',strategist:'扶持霸主维持秩序，借他人之力行己之事。',recs:[1,2,0]},
  e1_5:{legalist:'以法为本！商鞅之术可富国强兵，这才是乱世生存之道。',confucian:'独尊儒术，以仁义治天下，方能让文明薪火相传。',strategist:'百家共存最为高明，各取所长，方能应对万变之局。',recs:[2,0,1]},
  e1_6:{legalist:'全面法治！废旧制、立新法，国力必然暴增。代价？值得。',confucian:'渐进改革，兼顾传统，方不伤民本。急功近利终非善策。',strategist:'以德为先可安内部，但列国虎视，不可不防。折中为上。',recs:[0,1,2]},
  e1_7:{legalist:'连横！结盟强者，各个击破，统一进程不可逆。',confucian:'独善其身，发展经济，以不变应万变。',strategist:'合纵对抗强秦，以弱胜强，联盟之术在此一举。',recs:[1,2,0]},
  e1_8:{legalist:'设置都护府，以军事保障贸易，掌控西域命脉。',confucian:'以商通商，和平交流，文明互鉴才是长久之道。',strategist:'深度介入西域，既得商路之利，又可牵制草原。',recs:[0,1,0]},
  e1_T:{legalist:'严刑峻法！大一统需要铁腕，秦之强在于法度森严。',confucian:'儒法并用，刚柔相济，方能长治久安。单用严法必招反噬。',strategist:'郡国并行最为灵活，给地方自主权可减缓整合阵痛。',recs:[0,1,2]},
  e2_1:{legalist:'儒法兼用，外儒内法，才是帝国运转的秘诀。',confucian:'全面推行儒学！统一思想才能统一天下人心。',strategist:'保持多元，各种思想为我所用，何必拘泥一家？',recs:[1,0,2]},
  e2_2:{legalist:'主动出击！匈奴不灭，边患不止。卫青霍去病可为榜样。',confucian:'和亲通商，以柔克刚，化干戈为玉帛方为上策。',strategist:'修长城守边防，以防御换发展时间。',recs:[0,1,2]},
  e2_3:{legalist:'军事护商，设都护府。商路需要刀剑守护。',confucian:'重商轻军，自由贸易，文化交融才是丝路真义。',strategist:'选择性交往，控制风险，稳健经营。',recs:[0,1,2]},
  e2_4:{legalist:'扶持寒门制衡豪族，打破阶层固化。',confucian:'与豪族合作共治，维护社会稳定。',strategist:'以战功替代门第，让实力说话。',recs:[0,1,2]},
  e2_5:{legalist:'限制佛教，维护秩序，寺院不纳税不服役，国之蛀虫。',confucian:'儒佛融合，取长补短，丰富文明内涵。',strategist:'大力弘扬佛法，可安抚民心，也可联络西域高原。',recs:[2,1,0]},
  e2_6:{legalist:'不惜代价全线贯通！大运河乃国之命脉。',confucian:'分段修建，减轻百姓负担，仁者爱人。',strategist:'放弃大工程，发展海运，另辟蹊径。',recs:[0,1,2]},
  e2_7:{legalist:'依靠内部力量平叛，外力介入后患无穷。',confucian:'南迁保存实力，经济中心南移亦为大势所趋。',strategist:'借回纥兵是最快平叛之策，虽有代价但止血要紧。',recs:[1,2,0]},
  e2_8:{legalist:'全面推行科举，废除门荫！人才选拔必须公平。',confucian:'科举是千古善政，让天下读书人皆有出路。',strategist:'科举与门荫并行，渐进过渡最为稳妥。',recs:[0,0,1]},
  e2_T:{legalist:'文武并重，内外平衡，方能立于不败之地。',confucian:'重文轻武，发展经济文化，方为盛世之道。',strategist:'积极开拓海洋！面向世界才有未来。',recs:[1,0,2]},
  e3_1:{legalist:'拒绝和谈！花钱买和平是软骨头行为。',confucian:'签约换百年和平，百姓安居乐业才是正道。',strategist:'联合西夏三方制衡，外交博弈方显高明。',recs:[1,0,2]},
  e3_2:{legalist:'全面推行新法！不破不立，国家财政必须改革。',confucian:'选择性改革，稳步推进，不可操之过急。',strategist:'保守路线风险最小，但积弊日深…… 难。',recs:[0,1,2]},
  e3_3:{legalist:'联金抗蒙，保持均势。唇亡齿寒不可不知。',confucian:'全力发展南方和海洋，文明重心南移方可保全。',strategist:'联蒙灭金虽险，但可借势破局。',recs:[1,2,0]},
  e3_4:{legalist:'适度航海，内外兼顾。海洋与大陆都不可偏废。',confucian:'继续航海！郑和壮举不可断绝，海上文明交流意义深远。',strategist:'适度即可，国力有限不宜铺得太大。',recs:[1,0,1]},
  e3_5:{legalist:'军事剿倭，维持海禁。秩序为先。',confucian:'开放海禁！让百姓有活路，倭患自然平息。',strategist:'有限开放，设市舶司管控，利润与秩序两全。',recs:[1,0,2]},
  e3_6:{legalist:'开疆拓土！盛世当有盛世之版图。',confucian:'守内虚外，让百姓安居乐业才是仁政。',strategist:'开眼看世界，中学为体、西学为用，未雨绸缪。',recs:[0,1,2]},
  e3_7:{legalist:'发展手工业，吸收劳动力，工商致富。',confucian:'鼓励移民边疆和海外，减轻人口压力。',strategist:'限制人口……这恐怕难以执行。还是移民吧。',recs:[1,0,0]},
  e3_8:{legalist:'奋起抵抗！宁可战死也不跪着生。',confucian:'忍辱负重，先学后战。知耻近乎勇。',strategist:'先学西方之长技，再图反击。实力才是硬道理。',recs:[0,1,1]},
  e3_T:{legalist:'走自己的路！三千年文明底蕴不可丢弃。',confucian:'中西结合，渐进转型，取长补短。',strategist:'全面西化虽激进，但时不我待，快速追赶方为上策。',recs:[2,1,0]},
  e4_1:{legalist:'大力引进技术！落后就要挨打。',confucian:'优先教育和人才，百年大计。',strategist:'技术与制度同步改革，标本兼治。',recs:[0,2,1]},
  e4_2:{legalist:'建立强力中央政府！乱世需要秩序。',confucian:'联省自治，民主共和，还政于民。',strategist:'社会革命改造基层，根基稳则大厦安。',recs:[0,1,2]},
  e4_3:{legalist:'以俄为师，走革命道路。彻底改造。',confucian:'批判继承，中西融合，文化自觉。',strategist:'全盘接受西方文化，加速追赶。',recs:[2,1,0]},
  e4_4:{legalist:'正面加敌后双线作战，全民族抗战。',confucian:'以空间换时间，保存实力。',strategist:'双线作战最为全面，敌后战场意义重大。',recs:[1,2,1]},
  e4_5:{legalist:'优先工业化！集中力量办大事。',confucian:'发展教育和科技，百年树人。',strategist:'均衡发展，工农并重，不走极端。',recs:[0,2,1]},
  e4_6:{legalist:'大胆开放！四亿劳动力就是最大优势。',confucian:'渐进开放，摸着石头过河，稳健为上。',strategist:'大胆开放收益最大，但需控制风险。',recs:[0,1,0]},
  e4_7:{legalist:'有选择地开放，保护关键产业。',confucian:'以开放促改革，倒逼升级。',strategist:'全面开放深度参与，抓住全球化机遇。',recs:[1,2,0]},
  e4_8:{legalist:'大力推进，构建全球网络！',confucian:'先近后远，稳扎稳打。',strategist:'经济为主，务实推进，切勿好大喜功。',recs:[0,1,2]},
  e4_T:{legalist:'中原帝国之路，以中原为本辐射四方。',confucian:'天下枢纽，多元共生，方为正道。',strategist:'海洋时代，拥抱大海融入世界。',recs:[1,0,2]}
};

const ERA_OBJECTIVES = {
  1: [
    {text:'中原繁荣度(兴)达到7以上', check: () => G.regions.zhongyuan.prosperity >= 7},
    {text:'至少2个区域商贸达到5', check: () => Object.values(G.regions).filter(r => r.trade >= 5).length >= 2},
    {text:'无区域陷入衰落（总实力≤12）', check: () => !Object.values(G.regions).some(r => r.prosperity+r.military+r.culture+r.trade <= 12)}
  ],
  2: [
    {text:'西域商贸达到7（丝路繁荣）', check: () => G.regions.xiyu.trade >= 7},
    {text:'过渡地带总实力不低于18', check: () => {const r=G.regions.guodu; return r.prosperity+r.military+r.culture+r.trade >= 18;}},
    {text:'天命值达到160', check: () => G.mandateScore >= 160}
  ],
  3: [
    {text:'海洋总实力达到25', check: () => {const r=G.regions.haiyang; return r.prosperity+r.military+r.culture+r.trade >= 25;}},
    {text:'七区方差<8（均衡发展）', check: () => {const vals=Object.values(G.regions).map(r=>r.prosperity+r.military+r.culture+r.trade); const avg=vals.reduce((a,b)=>a+b,0)/vals.length; return vals.reduce((a,v)=>a+Math.pow(v-avg,2),0)/vals.length < 8;}},
    {text:'天命值达到180', check: () => G.mandateScore >= 180}
  ],
  4: [
    {text:'所有区域商贸≥5（全球连通）', check: () => Object.values(G.regions).every(r => r.trade >= 5)},
    {text:'总实力超过200', check: () => {let s=0; for(let k in G.regions){const r=G.regions[k]; s+=r.prosperity+r.military+r.culture+r.trade;} return s > 200;}},
    {text:'七区方差<6', check: () => {const vals=Object.values(G.regions).map(r=>r.prosperity+r.military+r.culture+r.trade); const avg=vals.reduce((a,b)=>a+b,0)/vals.length; return vals.reduce((a,v)=>a+Math.pow(v-avg,2),0)/vals.length < 6;}}
  ]
};

const ERA_KNOWLEDGE = {
  1:{theme:'封建秩序如何演变为大一统帝国？',insight:'施展认为：周的分封制本质上是一种"低成本扩张"策略，用血缘纽带编织出华夏认同。但分封的逻辑终将走向自我瓦解——诸侯壮大后必然挑战中央。',world:'同时期，地中海的希腊城邦也在探索不同的政治形态——民主制、寡头制、僭主制。东西方文明在不同的地理条件下，走上了截然不同的道路。'},
  2:{theme:'超大规模帝国如何维持统治？',insight:'施展指出：大一统帝国面临的核心难题是"信息成本"——皇帝无法直接管理每一寸土地。豪族门阀的崛起，本质上是帝国不得不依赖地方精英来降低治理成本。',world:'同时期，罗马帝国也面临类似困境。东西方帝国都发现：帝国越大，对地方精英的依赖越深，而这恰恰会瓦解中央权威。'},
  3:{theme:'从内卷到开放，中国错过了什么？',insight:'施展提出"内卷化"概念：当人口超过土地承载力，劳动力变得极其廉价，技术创新的经济动力反而消失了。宋代的商业繁荣为何没有演化为工业革命？因为超大规模的人口反而成了创新的阻碍。',world:'同时期，欧洲正在经历大航海时代和文艺复兴。地理大发现让欧洲获得了新大陆的资源，而中国却在海禁中错失机遇。'},
  4:{theme:'中国如何在现代世界重新定位自己？',insight:'施展的核心论点："枢纽"——中国的独特性在于它既不是纯粹的大陆国家，也不是纯粹的海洋国家，而是连接海洋与大陆的枢纽。这个枢纽位置，是三千年历史积淀的结果。',world:'21世纪的世界正在经历百年未有之大变局。全球化与逆全球化并存，中国的超大规模和枢纽位置，使它成为全球产业链中不可替代的节点。'}
};

const REGION_LORE = {
  zhongyuan:{
    1:'黄河之滨，农耕文明的摇篮。武王伐纣，定鼎中原。礼乐教化从此发源，井田制度养育万民。诸侯争霸，百家争鸣，思想的种子在这片土地上生根发芽。',
    2:'秦汉一统，中原成为天下之心。长安洛阳，帝都气象。丝绸之路从这里出发，连通万邦。太学立于京师，经学世家代代相传，门阀豪族把持着通往权力的阶梯。',
    3:'科举取士，寒门崛起。汴京繁华甲天下，清明上河图不过冰山一角。活字印刷、火药、指南针——技术创新层出不穷。然而人口膨胀，内卷之患日益严重。',
    4:'三千年未有之大变局。洋务运动、戊戌变法、辛亥革命——中原在剧变中寻找新的方向。从农业文明到工业文明，这片古老的土地正在经历前所未有的转型。'
  },
  caoyuan:{
    1:'茫茫草原，逐水草而居。犬戎、北狄，铁骑纵横。他们是中原文明的对手，也是催化剂——没有草原的威胁，中原或许不会走向统一。',
    2:'匈奴帝国与中原帝国南北对峙。冒顿单于控弦之士三十万，白登之围震动天下。和亲、远征、长城——草原与中原的互动定义了帝国的边界。',
    3:'契丹、女真、蒙古——草原帝国一浪高过一浪。成吉思汗建立人类历史上最大的陆地帝国，从太平洋到多瑙河。草原的力量达到了历史巅峰。',
    4:'草原融入现代中国，游牧文明与农耕文明的千年对话画上句号。铁路公路穿越草原，牧民定居城镇。但草原的精神——自由与勇敢，依然流淌在血脉中。'
  },
  xiyu:{
    1:'葱岭以东，大漠之中，散落着无数绿洲城邦。楼兰、龟兹、于阗——丝路上的明珠。东西方文明在此交汇，佛经与丝绸同行，葡萄酒与玉石并行。',
    2:'张骞凿空，丝路繁华。西域都护府的设立标志着中原对这片土地的经营。驼铃声声，商队络绎不绝。敦煌莫高窟的第一铲挖了下去，千年艺术就此诞生。',
    3:'西域在宋代一度与中原疏离。但蒙古帝国的建立重新打通了欧亚大陆，马可·波罗沿着这条路来到中国。西域再次成为连接东西方的桥梁。',
    4:'一带一路让古丝绸之路焕发新生。铁路穿越天山，贸易口岸繁忙。西域的枢纽地位在现代地缘政治中再次凸显，连接中亚、南亚与东亚。'
  },
  guodu:{
    1:'农牧交错地带，文明的断裂线也是融合带。华夏与戎狄在此碰撞、交融。这里不属于任何一方，却又是双方都无法忽视的战略要地。',
    2:'长城沿线，战争与贸易并存。榷场上的交易与关隘上的烽火交替上演。过渡地带的人们学会了在两种文明之间游走，成为天然的翻译者和中间人。',
    3:'辽金时期，过渡地带成为多政权并存的核心区域。契丹人在此建立了独特的"二元制"——以国制治契丹，以汉制治汉人。这种灵活性正是过渡地带的特色。',
    4:'现代中国的工业化浪潮中，过渡地带从边缘走向中心。它连接东部沿海与西部内陆，是"西部大开发"战略的关键纽带。'
  },
  gaoyuan:{
    1:'世界屋脊，神秘的雪域高原。象雄文明在此萌芽，苯教信仰弥漫在稀薄的空气中。高原的地理隔绝造就了独特的文明，也使它成为外部力量难以征服的堡垒。',
    2:'佛教从印度传入高原，与苯教融合形成藏传佛教。吐蕃帝国崛起，松赞干布统一高原，文成公主入藏。高原第一次与中原建立深层联系。',
    3:'元朝将高原纳入版图，设宣政院管理藏区事务。寺院成为政治、经济、文化的中心。活佛转世制度确立，宗教权威与世俗权力紧密交织。',
    4:'青藏铁路穿越冻土带，天路通达。现代化浪潮冲击着古老的传统，但藏传佛教的精神影响力依然深远。高原正在寻找传统与现代的平衡点。'
  },
  xinan:{
    1:'密林万族，多元共生。百越、百濮、巴蜀——无数族群在西南的崇山峻岭中繁衍生息。梯田顺山而下，吊脚楼临水而居。这里是文明的避难所，也是多样性的宝库。',
    2:'秦开五尺道，汉通西南夷。中原势力渐渐渗透进来，但西南的地理屏障让同化过程极为缓慢。诸葛亮七擒孟获，以心战为上——强攻不如怀柔。',
    3:'改土归流，中央对西南的控制逐渐加强。茶马古道连接高原与平原，普洱茶从此闻名天下。西南成为抗战大后方，昆明的西南联大培养了一代精英。',
    4:'西南大开发，基建穿山越岭。这里是中国生物多样性的宝库，也是少数民族文化的百花园。在全球化时代，西南独特的文化资源正在成为新的竞争优势。'
  },
  haiyang:{
    1:'碧波万里，先民已开始近海捕捞和航行。百越族群擅长造船，南岛语族从中国东南沿海向太平洋扩散。海洋文明的种子已经播下，只待时机破土而出。',
    2:'徐福东渡的传说背后，是先秦时期已有的海上往来。汉代海上丝路从番禺出发，经南海到达印度。海洋贸易悄然兴起，但始终不是帝国关注的重点。',
    3:'宋代海上贸易空前繁荣，泉州成为世界最大港口。郑和七下西洋，宝船巨舰震撼四海。然而明清海禁，中国关上了面向海洋的大门，历史机遇一去不返。',
    4:'改革开放，沿海经济特区引领发展。深圳从渔村变为大都市，上海浦东拔地而起。中国重新拥抱海洋，海军走向深蓝，海上丝路再次连通世界。'
  }
};

const REGION_FIGURES = {
  zhongyuan:{1:['周公旦','姜子牙','孔子','老子','商鞅'],2:['秦始皇','汉武帝','董仲舒','曹操','诸葛亮'],3:['赵匡胤','王安石','朱元璋','康熙帝','曹雪芹'],4:['孙中山','毛泽东','邓小平']},
  caoyuan:{1:['犬戎','北狄','林胡','楼烦'],2:['冒顿单于','呼韩邪','鲜卑檀石槐'],3:['耶律阿保机','完颜阿骨打','成吉思汗','忽必烈'],4:['僧格林沁','乌兰夫']},
  xiyu:{1:['楼兰王','月氏人'],2:['张骞','班超','鸠摩罗什'],3:['高昌王','马可·波罗','陆羽'],4:['左宗棠','林则徐']},
  guodu:{1:['义渠王','中山国君'],2:['李广','卫青','花木兰'],3:['杨家将','岳飞','耶律楚材'],4:['张学良','傅作义']},
  gaoyuan:{1:['象雄王'],2:['松赞干布','文成公主','金城公主'],3:['八思巴','宗喀巴','五世达赖'],4:['十世班禅']},
  xinan:{1:['蜀王蚕丛','夜郎王'],2:['诸葛亮','孟获','南诏王'],3:['段誉(大理)','沐英','吴三桂'],4:['蔡锷','龙云','西南联大师生']},
  haiyang:{1:['百越先民','南岛航海者'],2:['徐福','赵佗(南越)'],3:['郑和','戚继光','郑成功'],4:['孙中山','厦门特区建设者']}
};

// ==================== 游戏状态 ====================

let G = {
  era: 1,
  turn: 0,
  eventIdx: 0,
  regions: {},
  totalPower: 50,
  totalMilitary: 50,
  totalCulture: 50,
  totalTrade: 50,
  log: [],
  choices: [],
  mandateScore: 0,
  eraStartSnapshot: null,
  unlockedAchievements: []
};

// ==================== 防重入 & 计时器 ====================
let _mandateTimer = null;

// ==================== 成就定义 ====================
const ACHIEVEMENTS = [
  {id:'peak',name:'登峰造极',icon:'🏔️',desc:'任一区域属性达到10',check:()=>Object.values(G.regions).some(r=>r.prosperity>=10||r.military>=10||r.culture>=10||r.trade>=10)},
  {id:'ironEmpire',name:'铁血帝国',icon:'⚔️',desc:'总武力超过50',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.military,0)>50},
  {id:'silkRoad',name:'丝路繁华',icon:'🐪',desc:'总商贸超过50',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.trade,0)>50},
  {id:'harmony',name:'天下大同',icon:'☯️',desc:'七区域实力均衡（方差<4）',check:()=>{const v=Object.values(G.regions).map(r=>r.prosperity+r.military+r.culture+r.trade);const a=v.reduce((s,x)=>s+x,0)/v.length;return v.reduce((s,x)=>s+Math.pow(x-a,2),0)/v.length<4;}},
  {id:'cultural',name:'文运昌盛',icon:'📜',desc:'总文化超过50',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.culture,0)>50},
  {id:'prosperous',name:'国富民强',icon:'🏛️',desc:'总繁荣超过55',check:()=>Object.values(G.regions).reduce((s,r)=>s+r.prosperity,0)>55},
  {id:'mandate80',name:'天命所归',icon:'👑',desc:'天命值超过180',check:()=>G.mandateScore>180},
  {id:'explorer',name:'万邦来朝',icon:'🌏',desc:'所有区域商贸≥5',check:()=>Object.values(G.regions).every(r=>r.trade>=5)}
];

function initRegions() {
  G.regions = {};
  for (let k in REGION_META) {
    G.regions[k] = {prosperity:5,military:5,culture:5,trade:5};
  }
  G.regions.zhongyuan = {prosperity:8,military:6,culture:8,trade:5};
  G.regions.caoyuan = {prosperity:4,military:8,culture:3,trade:4};
  G.regions.xiyu = {prosperity:4,military:4,culture:5,trade:7};
}

// ==================== 渲染函数 ====================

function renderRegionList() {
  const el = document.getElementById('region-list');
  const keys = Object.keys(REGION_META);
  const existingCards = el.querySelectorAll('.region-card');

  if (existingCards.length === keys.length) {
    // Diff update: update stat-fill widths and total power
    keys.forEach((k, i) => {
      const r = G.regions[k];
      const fills = existingCards[i].querySelectorAll('.stat-fill');
      if (fills[0]) fills[0].style.width = r.prosperity * 10 + '%';
      if (fills[1]) fills[1].style.width = r.military * 10 + '%';
      if (fills[2]) fills[2].style.width = r.culture * 10 + '%';
      if (fills[3]) fills[3].style.width = r.trade * 10 + '%';
      // Update total power display
      const totalSpan = existingCards[i].querySelector('.region-name span:last-child');
      if (totalSpan && totalSpan.style) totalSpan.textContent = r.prosperity + r.military + r.culture + r.trade;
    });
  } else {
    // Initial render
    let html = '';
    for (let k in REGION_META) {
      const m = REGION_META[k], r = G.regions[k];
      const total = r.prosperity + r.military + r.culture + r.trade;
      html += `<div class="region-card" onclick="selectRegion('${k}')" style="background:linear-gradient(135deg,rgba(255,255,255,0.03),${m.color}08);">
        <div class="region-name"><span class="region-dot" style="background:${m.color};color:${m.color}"></span>${m.name}<span style="margin-left:auto;font-size:0.75em;color:var(--gold);opacity:0.7;">${total}</span></div>
        <div class="stat-bars">
          <div class="stat-row"><span class="stat-label" title="经济繁荣">兴</span><div class="stat-bar"><div class="stat-fill" style="width:${r.prosperity*10}%;background:${m.color}"></div></div></div>
          <div class="stat-row"><span class="stat-label" title="军事力量">武</span><div class="stat-bar"><div class="stat-fill" style="width:${r.military*10}%;background:${m.color}"></div></div></div>
          <div class="stat-row"><span class="stat-label" title="文化影响">文</span><div class="stat-bar"><div class="stat-fill" style="width:${r.culture*10}%;background:${m.color}"></div></div></div>
          <div class="stat-row"><span class="stat-label" title="商贸活力">商</span><div class="stat-bar"><div class="stat-fill" style="width:${r.trade*10}%;background:${m.color}"></div></div></div>
        </div>
      </div>`;
    }
    el.innerHTML = html;
  }
}

function renderMap() {
  const keys = Object.keys(REGION_META);

  // Update region fill paths
  keys.forEach(k => {
    const path = document.querySelector(`[data-region="${k}"]`);
    if (!path) return;
    const m = REGION_META[k], r = G.regions[k];
    const total = r.prosperity + r.military + r.culture + r.trade;
    const prosperity = r.prosperity / 10;
    const opacity = 0.35 + prosperity * 0.45;
    path.style.fill = m.color;
    path.style.opacity = opacity;
    path.onclick = () => selectRegion(k);

    // Scale transform: strong regions "expand", weak regions "shrink"
    const scale = 0.92 + (total / 40) * 0.16; // range 0.92 ~ 1.08
    const cx = m.x, cy = m.y;
    path.style.transformOrigin = `${cx}px ${cy}px`;
    path.style.transform = `scale(${scale.toFixed(3)})`;

    // Status glow based on dominant stat
    const maxStat = Math.max(r.military, r.culture, r.trade);
    if (total <= 12) {
      path.style.filter = 'url(#statusGlow-weak)';
    } else if (r.military >= 8 && r.military === maxStat) {
      path.style.filter = 'url(#statusGlow-military)';
    } else if (r.culture >= 8 && r.culture === maxStat) {
      path.style.filter = 'url(#statusGlow-culture)';
    } else if (r.trade >= 8 && r.trade === maxStat) {
      path.style.filter = 'url(#statusGlow-trade)';
    } else {
      path.style.filter = '';
    }
  });

  // Update labels with tier indicators
  const labelsG = document.getElementById('map-labels');
  let labelsHtml = '';
  keys.forEach(k => {
    const m = REGION_META[k], r = G.regions[k];
    const total = r.prosperity + r.military + r.culture + r.trade;
    const tier = total <= 12 ? '危' : total <= 20 ? '弱' : total <= 28 ? '平' : total <= 35 ? '盛' : '极';
    const tierColor = total <= 12 ? '#c56b6b' : total <= 20 ? '#b8860b' : total <= 28 ? '#aaa' : total <= 35 ? '#7cb87c' : '#dbb978';
    // Dominant stat icon
    const domStat = r.military >= r.culture && r.military >= r.trade ? (r.military >= 7 ? '⚔' : '') :
                    r.culture >= r.trade ? (r.culture >= 7 ? '📜' : '') : (r.trade >= 7 ? '💰' : '');
    labelsHtml += `<text class="node-label" x="${m.x}" y="${m.y-4}">${m.name}</text>`;
    labelsHtml += `<text class="node-value" x="${m.x}" y="${m.y+12}">${total}</text>`;
    labelsHtml += `<text x="${m.x+18}" y="${m.y+12}" fill="${tierColor}" font-size="9" text-anchor="start" style="font-weight:bold">${tier}</text>`;
    if (domStat) labelsHtml += `<text x="${m.x-20}" y="${m.y+13}" font-size="10" text-anchor="end">${domStat}</text>`;

    // Mini stat bars under region name
    const barW = 28, barH = 3, barY = m.y + 18;
    const stats = [{v:r.prosperity,c:'#6bba6b'},{v:r.military,c:'#c56b6b'},{v:r.culture,c:'#9b7ed8'},{v:r.trade,c:'#dbb978'}];
    stats.forEach((s, si) => {
      const bx = m.x - barW/2 + si * (barW/4 + 1) - 4;
      labelsHtml += `<rect x="${bx}" y="${barY}" width="${barW/4}" height="${barH}" rx="1" fill="rgba(255,255,255,0.08)"/>`;
      labelsHtml += `<rect x="${bx}" y="${barY}" width="${(s.v/10)*(barW/4)}" height="${barH}" rx="1" fill="${s.c}" opacity="0.7"/>`;
    });
  });
  labelsG.innerHTML = labelsHtml;

  // Update trade routes
  updateTradeRoutes();
}

function updateTradeRoutes() {
  const routes = document.querySelectorAll('#trade-routes .connection-line');
  const dotsG = document.getElementById('trade-dots');
  let dotsHtml = '';

  routes.forEach(route => {
    const fromKey = route.getAttribute('data-from');
    const toKey = route.getAttribute('data-to');
    if (!fromKey || !toKey || !G.regions[fromKey] || !G.regions[toKey]) return;

    const fromTrade = G.regions[fromKey].trade;
    const toTrade = G.regions[toKey].trade;
    const avgTrade = (fromTrade + toTrade) / 2;

    route.classList.remove('trade-high','trade-mid','trade-low');
    if (avgTrade >= 7) {
      route.classList.add('trade-high');
      // Add animated dot for high-trade routes
      const pathId = 'tp-' + fromKey + '-' + toKey;
      route.id = pathId;
      dotsHtml += `<circle class="trade-dot active" r="3"><animateMotion dur="${6 + Math.random()*4}s" repeatCount="indefinite"><mpath href="#${pathId}"/></animateMotion></circle>`;
    } else if (avgTrade >= 4) {
      route.classList.add('trade-mid');
    } else {
      route.classList.add('trade-low');
    }
  });

  if (dotsG) dotsG.innerHTML = dotsHtml;
}

// ==================== Map Scene System ====================

const ICON_SYMBOLS = {
  battle:'⚔', capital:'🏛', fortress:'🏰', port:'⚓', temple:'🛕',
  market:'🏪', nomad:'🐎', fleet:'⛵', scholar:'📜', rebellion:'🔥',
  alliance:'🤝', wall:'🧱'
};

function renderMapScene(eventId) {
  const layer = document.getElementById('map-scene-layer');
  if (!layer) return;
  layer.innerHTML = '';

  const scene = (typeof MAP_SCENES !== 'undefined') ? MAP_SCENES[eventId] : null;
  if (!scene) return;

  let html = '';
  const ns = 'http://www.w3.org/2000/svg';

  // --- Atmosphere ---
  const mapArea = document.getElementById('map-area');
  mapArea.classList.remove('atmo-war','atmo-peace','atmo-trade','atmo-culture','atmo-crisis','atmo-transformation');
  if (scene.atmosphere) mapArea.classList.add('atmo-' + scene.atmosphere);

  // Play map sound based on atmosphere type
  const _mapSounds = {war:'mapWar',trade:'mapTrade',culture:'mapCulture',peace:'mapPeace',crisis:'mapCrisis',transformation:'mapCrisis'};
  const _sfxMethod = _mapSounds[scene.atmosphere];
  if (_sfxMethod && SFX[_sfxMethod]) setTimeout(() => SFX[_sfxMethod](), 400);

  // --- Region highlights ---
  document.querySelectorAll('.region-path').forEach(p => p.classList.remove('scene-highlight'));
  if (scene.highlights) {
    scene.highlights.forEach(rk => {
      const p = document.querySelector(`[data-region="${rk}"]`);
      if (p) p.classList.add('scene-highlight');
    });
  }

  // --- Arrows with arrowheads ---
  if (scene.arrows) {
    // Arrowhead marker def
    html += '<defs>';
    ['military','trade','culture','alliance','migration','expansion'].forEach(t => {
      const colors = {military:'#c56b6b',trade:'#dbb978',culture:'#9b7ed8',alliance:'#6bba6b',migration:'#5b9bd5',expansion:'#d4944a'};
      html += `<marker id="ah-${t}" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="${colors[t]}" opacity="0.8"/></marker>`;
    });
    html += '</defs>';

    scene.arrows.forEach((a, i) => {
      const [fx, fy] = a.from;
      const [tx, ty] = a.to;
      const mx = (fx+tx)/2 + (Math.random()-0.5)*20;
      const my = (fy+ty)/2 + (Math.random()-0.5)*20;
      const delay = i * 0.3;
      html += `<path class="scene-arrow type-${a.type||'military'}" d="M${fx},${fy} Q${mx},${my} ${tx},${ty}" fill="none" marker-end="url(#ah-${a.type||'military'})" style="animation-delay:${delay}s"/>`;
      if (a.label) {
        const lx = (fx+tx)/2, ly = (fy+ty)/2 - 6;
        html += `<text class="scene-arrow-label" x="${lx}" y="${ly}" text-anchor="middle" style="animation-delay:${delay+0.5}s">${a.label}</text>`;
      }
    });
  }

  // --- Labels ---
  if (scene.labels) {
    scene.labels.forEach((lb, i) => {
      const sizeClass = 'size-' + (lb.size || 'medium');
      const styleClass = lb.style ? 'style-' + lb.style : '';
      const delay = 0.15 + i * 0.12;
      html += `<text class="scene-label ${sizeClass} ${styleClass}" x="${lb.x}" y="${lb.y}" text-anchor="middle" fill="${lb.color || '#c9a96e'}" style="animation-delay:${delay}s">${lb.text}</text>`;
    });
  }

  // --- Icons ---
  if (scene.icons) {
    scene.icons.forEach((ic, i) => {
      const sym = ICON_SYMBOLS[ic.type] || '●';
      const delay = 0.3 + i * 0.2;
      html += `<text class="scene-icon" x="${ic.x}" y="${ic.y}" text-anchor="middle" font-size="14" style="animation-delay:${delay}s">${sym}</text>`;
    });
  }

  layer.innerHTML = html;

  // Also render event-specific world layer extras
  renderEventWorldExtras(eventId);
}

function clearMapScene() {
  const layer = document.getElementById('map-scene-layer');
  if (layer) layer.innerHTML = '';
  document.querySelectorAll('.region-path').forEach(p => p.classList.remove('scene-highlight'));
  const mapArea = document.getElementById('map-area');
  if (mapArea) mapArea.classList.remove('atmo-war','atmo-peace','atmo-trade','atmo-culture','atmo-crisis','atmo-transformation');
}

// ==================== Map Delta Fly Animation ====================

function showMapDeltas(effectTags) {
  const mapArea = document.getElementById('map-area');
  const svg = document.getElementById('map-svg');
  if (!mapArea || !svg) return;

  // Get SVG bounding rect for coordinate conversion
  const svgRect = svg.getBoundingClientRect();
  const mapRect = mapArea.getBoundingClientRect();

  effectTags.forEach((t, i) => {
    const regionKey = t.regionKey;
    if (!regionKey || !REGION_META[regionKey]) return;

    const m = REGION_META[regionKey];
    // Convert SVG coords to screen coords
    const svgW = 600, svgH = 450;
    const scaleX = svgRect.width / svgW;
    const scaleY = svgRect.height / svgH;
    const screenX = svgRect.left - mapRect.left + m.x * scaleX;
    const screenY = svgRect.top - mapRect.top + m.y * scaleY;

    const el = document.createElement('div');
    el.className = 'delta-fly ' + (t.val > 0 ? 'pos' : 'neg');
    const sign = t.val > 0 ? '+' : '';
    el.textContent = t.stat + sign + t.val;
    el.style.left = (screenX + (i % 3 - 1) * 28) + 'px';
    el.style.top = (screenY - 15 + Math.floor(i / 3) * 22) + 'px';
    el.style.animationDelay = (i * 0.15) + 's';
    mapArea.appendChild(el);

    setTimeout(() => el.remove(), 2200);
  });
}

// ==================== Choice Preview on Map ====================

function previewChoiceOnMap(choiceIdx) {
  const ev = EVENTS[G.era] && EVENTS[G.era][G.eventIdx];
  if (!ev || !ev.choices[choiceIdx]) return;

  const choice = ev.choices[choiceIdx];
  const svg = document.getElementById('map-svg');
  if (!svg) return;

  // Highlight affected regions with glow
  document.querySelectorAll('.region-path').forEach(p => {
    p.style.transition = 'opacity 0.3s, stroke 0.3s';
    p.classList.remove('preview-affected');
  });

  for (const region in choice.effects) {
    const path = document.querySelector(`[data-region="${region}"]`);
    if (!path) continue;
    const eff = choice.effects[region];
    const net = (eff.p||0) + (eff.m||0) + (eff.c||0) + (eff.t||0);
    if (net > 0) {
      path.style.stroke = 'rgba(107,186,107,0.6)';
      path.style.strokeWidth = '2';
    } else if (net < 0) {
      path.style.stroke = 'rgba(197,107,107,0.6)';
      path.style.strokeWidth = '2';
    }
  }
}

function clearChoicePreview() {
  document.querySelectorAll('.region-path').forEach(p => {
    p.style.stroke = '';
    p.style.strokeWidth = '';
  });
}

function renderTopBar() {
  document.getElementById('era-display').textContent = ERA_NAMES[G.era];
  document.getElementById('turn-num').textContent = G.turn;
  let p=0,m=0,c=0,t=0;
  for (let k in G.regions) {
    const r = G.regions[k];
    p += r.prosperity; m += r.military; c += r.culture; t += r.trade;
  }
  const oldP = G.totalPower||p, oldM = G.totalMilitary||m, oldC = G.totalCulture||c, oldT = G.totalTrade||t;
  G.totalPower = p; G.totalMilitary = m; G.totalCulture = c; G.totalTrade = t;

  // Animate resource numbers
  animateResNum('res-power', oldP, p);
  animateResNum('res-military', oldM, m);
  animateResNum('res-culture', oldC, c);
  animateResNum('res-trade', oldT, t);
}

function animateResNum(elId, oldVal, newVal) {
  const el = document.getElementById(elId);
  if (!el) return;
  if (oldVal === newVal) { el.textContent = newVal; return; }
  const diff = newVal - oldVal;
  // Add flash class
  const cls = diff > 0 ? 'res-changed-up' : 'res-changed-down';
  el.classList.remove('res-changed-up','res-changed-down');
  void el.offsetWidth;
  el.classList.add(cls);
  // Counting animation
  let current = oldVal;
  const steps = 12;
  const stepVal = diff / steps;
  let step = 0;
  const t = setInterval(() => {
    step++;
    current += stepVal;
    el.textContent = Math.round(current);
    if (step >= steps) {
      clearInterval(t);
      el.textContent = newVal;
    }
  }, 35);
  setTimeout(() => el.classList.remove(cls), 700);
}

function calculateMandateScore() {
  let totalScore = 0;
  for (let k in G.regions) {
    const r = G.regions[k];
    totalScore += r.prosperity + r.military + r.culture + r.trade;
  }
  const vals = Object.values(G.regions).map(r => r.prosperity + r.military + r.culture + r.trade);
  const avg = vals.reduce((a,b) => a+b, 0) / vals.length;
  const variance = vals.reduce((a,v) => a + Math.pow(v-avg, 2), 0) / vals.length;
  totalScore += Math.max(0, Math.round(30 - variance));
  return totalScore;
}

function animateMandateScore(newScore) {
  const el = document.getElementById('mandate-val');
  const container = document.getElementById('mandate-display');
  const oldScore = G.mandateScore;
  if (newScore === oldScore) return;
  // Clear any existing animation timer
  if (_mandateTimer !== null) {
    clearInterval(_mandateTimer);
    _mandateTimer = null;
  }
  const diff = newScore - oldScore;
  const cls = diff > 0 ? 'pulse-up' : 'pulse-down';
  container.classList.remove('pulse-up','pulse-down');
  void container.offsetWidth;
  container.classList.add(cls);
  const steps = 20;
  const stepVal = diff / steps;
  let current = oldScore;
  let step = 0;
  _mandateTimer = setInterval(() => {
    step++;
    current += stepVal;
    el.textContent = Math.round(current);
    if (step >= steps) {
      clearInterval(_mandateTimer);
      _mandateTimer = null;
      el.textContent = newScore;
      // Update trend arrow
      const trend = document.getElementById('mandate-trend');
      if (trend) {
        if (newScore > oldScore) { trend.textContent = '▲'; trend.style.color = '#7cb87c'; }
        else if (newScore < oldScore) { trend.textContent = '▼'; trend.style.color = '#c56b6b'; }
        else { trend.textContent = ''; }
      }
      G.mandateScore = newScore;
    }
  }, 30);
}

function addLog(text) {
  G.log.unshift({turn:G.turn, era:G.era, text});
  const el = document.getElementById('history-log');
  let html = '';
  G.log.slice(0,50).forEach(l => {
    html += `<div class="log-entry"><span class="log-turn">[${ERA_NAMES[l.era].slice(0,3)} ${l.turn}]</span>${l.text}</div>`;
  });
  el.innerHTML = html;
}

// ==================== 事件系统 ====================

function assessRisk(choice) {
  let negCount = 0, negSum = 0;
  for (let region in choice.effects) {
    const eff = choice.effects[region];
    for (let v of [eff.p,eff.m,eff.c,eff.t]) {
      if (v && v < 0) { negCount++; negSum += Math.abs(v); }
    }
  }
  if (negSum >= 4 || negCount >= 3) return 'high';
  if (negSum >= 2 || negCount >= 2) return 'medium';
  return 'low';
}

function getCrisisType(ev) {
  const t = ev.title + ev.description;
  if (ev.isFinale) return {type:'finale', label:'\u{1F451} 终极抉择', cls:'tag-finale'};
  if (ev.isTransformation) return {type:'transform', label:'\u26A1 历史剧变', cls:'tag-transform'};
  if (/战|乱|侵|伐|叛|寇|兵/.test(t)) return {type:'war', label:'\u{1F525} 军事危机', cls:'tag-war'};
  if (/法|制|治|革|政/.test(t)) return {type:'gov', label:'\u2696\uFE0F 治国抉择', cls:'tag-gov'};
  if (/通|路|商|贸|航|洋/.test(t)) return {type:'trade', label:'\u{1F310} 贸易机遇', cls:'tag-trade'};
  if (/佛|儒|道|文|学|诗/.test(t)) return {type:'culture', label:'\u{1F4DC} 文化转折', cls:'tag-culture'};
  return {type:'gov', label:'\u2696\uFE0F 治国抉择', cls:'tag-gov'};
}

function showEvent() {
  const events = EVENTS[G.era];
  if (!events || G.eventIdx >= events.length) {
    if (G.era < 4) {
      nextEra();
    } else {
      showEnding();
    }
    return;
  }

  const ev = events[G.eventIdx];
  const crisis = getCrisisType(ev);
  const panel = document.getElementById('crisis-panel');
  const content = document.getElementById('crisis-content');

  // Clear region detail state
  _regionDetailActive = false;
  _crisisPanelBackup = '';

  // Set crisis type class on panel (preserve tab-active for mobile)
  const hadTabActive = panel.classList.contains('tab-active');
  panel.className = 'crisis-' + crisis.type;
  panel.id = 'crisis-panel';
  if (hadTabActive) panel.classList.add('tab-active');

  // Apply scene background
  applySceneBackground(crisis.type);

  // Progress
  const totalEvents = events.length;
  const currentNum = G.eventIdx + 1;

  // Build HTML — minimal text, maximum visual
  let html = '';
  html += `<div class="event-progress-bar" style="width:${currentNum/totalEvents*100}%"></div>`;

  // Animated event icon
  html += _buildEventIcon(crisis.type);

  // Title is the HERO — big and bold
  html += `<div class="event-title dramatic" id="ev-title">${ev.title}</div>`;

  // Full event description — narrative is the content
  html += `<div class="event-desc" id="ev-desc">${ev.description}</div>`;

  // Quote inline (if exists)
  if (ev.quote) html += `<div style="color:#8a7a5a;font-style:italic;font-size:0.85em;margin-bottom:10px;padding-left:10px;border-left:2px solid rgba(201,169,110,0.2);">${ev.quote}</div>`;

  // Background knowledge — collapsible but clearly visible
  const bg = (typeof EVENT_BACKGROUND !== 'undefined') ? EVENT_BACKGROUND[ev.id] : '';
  const dk = (typeof DEEP_KNOWLEDGE !== 'undefined') ? DEEP_KNOWLEDGE[ev.id] : null;
  if (bg || dk) {
    html += `<div class="event-expand-btn" onclick="toggleEventDetail()" id="ev-expand">📖 施展视角</div>`;
    html += `<div class="event-detail-panel" id="ev-detail" style="display:none;">`;
    if (bg) {
      html += `<div style="color:#a89868;font-size:0.85em;line-height:1.7;padding:8px 12px;background:rgba(201,169,110,0.04);border-radius:4px;">${bg}</div>`;
    }
    if (dk) {
      html += `<div style="margin-top:8px;padding:8px 12px;background:rgba(201,169,110,0.06);border-radius:4px;border-left:3px solid rgba(201,169,110,0.3);">`;
      if (dk.context) html += `<div style="color:#b8a878;font-size:0.85em;line-height:1.7;margin-bottom:6px;">📜 ${dk.context}</div>`;
      if (dk.shiZhanInsight) html += `<div style="color:#c9a96e;font-size:0.85em;line-height:1.7;margin-bottom:6px;font-style:italic;">💡 施展洞见：${dk.shiZhanInsight}</div>`;
      if (dk.dilemma) html += `<div style="color:#c07060;font-size:0.85em;line-height:1.7;margin-bottom:6px;">⚖️ 真实困境：${dk.dilemma}</div>`;
      if (dk.counterFact) html += `<div style="color:#7a9a8a;font-size:0.85em;line-height:1.7;">🔮 反事实推演：${dk.counterFact}</div>`;
      html += `</div>`;
    }
    html += `</div>`;
  }

  // Visual choice cards — no exam numbering
  html += '<div id="ev-choices">';
  // Build all choices including trap
  const allChoices = [...ev.choices];
  const trapChoice = (typeof TRAP_CHOICES !== 'undefined') && TRAP_CHOICES[ev.id];
  if (trapChoice) {
    allChoices.push({...trapChoice, _isTrap: true, _trapReason: trapChoice.trapReason});
  }
  // Shuffle choices so trap isn't always last (Fisher-Yates on indices)
  const choiceOrder = allChoices.map((_, i) => i);
  for (let i = choiceOrder.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [choiceOrder[i], choiceOrder[j]] = [choiceOrder[j], choiceOrder[i]];
  }
  // Store mapping for makeChoice
  ev._choiceOrder = choiceOrder;
  ev._allChoices = allChoices;

  choiceOrder.forEach((origIdx, displayIdx) => {
    const ch = allChoices[origIdx];
    const risk = assessRisk(ch);
    const riskLabels = {low:'稳健',medium:'有险',high:'⚡高险'};
    // Build visual effect arrows per region (trap choices hide true effects)
    let effectsHtml = '';
    if (ch._isTrap) {
      // Trap: show misleading "positive" preview
      effectsHtml = '<span class="ce-region" style="color:#c9a96e;">✨ 看似完美的选择</span>';
    } else {
      for (let region in ch.effects) {
        const eff = ch.effects[region];
        const rn = REGION_META[region] ? REGION_META[region].name : region;
        let arrows = '';
        const sum = (eff.p||0) + (eff.m||0) + (eff.c||0) + (eff.t||0);
        const count = Math.min(Math.abs(sum), 4);
        const dir = sum >= 0 ? 'up' : 'down';
        const arrow = sum >= 0 ? '▲' : '▼';
        for (let a = 0; a < Math.max(count, 1); a++) arrows += arrow;
        effectsHtml += `<span class="ce-region"><span style="color:${REGION_META[region]?REGION_META[region].color:'#aaa'}">${rn}</span> <span class="ce-arrow ${dir}">${arrows}</span></span>`;
      }
    }
    html += `<button class="choice-btn risk-${ch._isTrap ? 'low' : risk}" onclick="makeChoice(${origIdx},event)" data-choice="${origIdx}">`;
    html += `<span class="choice-label">${ch.text}</span>`;
    html += `<div class="choice-effects">${effectsHtml}</div>`;
    html += `<span class="choice-risk">${ch._isTrap ? '稳健' : riskLabels[risk]}</span>`;
    html += `</button>`;
  });
  html += '</div>';

  content.innerHTML = html;

  // Update timeline
  renderTimeline();

  // FAST reveal — game feel, not reading
  const titleEl = content.querySelector('.event-title');
  const descEl = content.querySelector('.event-desc');
  setTimeout(() => titleEl && titleEl.classList.add('visible'), 100);
  setTimeout(() => descEl && descEl.classList.add('visible'), 250);
  const btns = content.querySelectorAll('.choice-btn');
  btns.forEach((btn, i) => {
    setTimeout(() => btn.classList.add('visible'), 400 + i * 120);
  });

  // Render event scene on map (historical labels, arrows, icons)
  renderMapScene(ev.id);

  // Highlight affected regions on map
  _highlightEventRegions(ev);

  // Choice hover → map region preview (green/red glow + original highlight)
  btns.forEach((btn) => {
    const origIdx = parseInt(btn.getAttribute('data-choice'));
    const ch = allChoices[origIdx];
    if (!ch || !ch.effects) return;
    const regions = Object.keys(ch.effects);
    btn.addEventListener('mouseenter', () => {
      _clearMapHighlights();
      // For trap choices, don't show the real (devastating) preview
      if (!ch._isTrap) previewChoiceOnMap(origIdx);
      regions.forEach(k => {
        const p = document.querySelector(`[data-region="${k}"]`);
        if (p) p.classList.add('choice-hover');
      });
    });
    btn.addEventListener('mouseleave', () => {
      clearChoicePreview();
      _clearMapHighlights();
      _highlightEventRegions(ev);
    });
  });

  // Scroll to top of crisis content
  content.scrollTop = 0;
}

function _highlightEventRegions(ev) {
  _clearMapHighlights();
  const choices = ev._allChoices || ev.choices;
  if (!choices) return;
  const allRegions = new Set();
  choices.forEach(ch => {
    if (ch.effects) Object.keys(ch.effects).forEach(k => allRegions.add(k));
  });
  allRegions.forEach(k => {
    const p = document.querySelector(`[data-region="${k}"]`);
    if (p) p.classList.add('event-affected');
  });
}

function _clearMapHighlights() {
  document.querySelectorAll('.region-path.event-affected,.region-path.choice-hover').forEach(p => {
    p.classList.remove('event-affected', 'choice-hover');
  });
}

function makeChoice(idx, evt) {
  if (G._choosing) return;
  G._choosing = true;
  SFX.choiceConfirm();
  _clearMapHighlights();

  // Ink ripple effect
  if (evt && evt.currentTarget) {
    const btn = evt.currentTarget;
    const rect = btn.getBoundingClientRect();
    const ripple = document.createElement('div');
    ripple.className = 'ink-ripple';
    const x = evt.clientX - rect.left;
    const y = evt.clientY - rect.top;
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.style.width = '10px';
    ripple.style.height = '10px';
    ripple.style.marginLeft = '-5px';
    ripple.style.marginTop = '-5px';
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  }

  // Show "天命运转" resolution moment
  const content = document.getElementById('crisis-content');
  content.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;min-height:100px;"><div style="font-size:2em;animation:mandateSpin 0.6s ease-in-out;">☯</div></div>';

  const ev = EVENTS[G.era][G.eventIdx];
  // Use _allChoices (includes trap) if available, otherwise fall back to ev.choices
  const allChoices = ev._allChoices || ev.choices;
  const choice = allChoices[idx] || ev.choices[idx];
  // Fast result display
  setTimeout(() => { _executeChoice(idx, ev, choice); }, 600);
}

function _executeChoice(idx, ev, choice) {

  // Snapshot stats before change
  const beforeStats = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    beforeStats[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }

  // Apply effects
  const effectTags = [];
  const affectedRegions = new Set();
  for (let region in choice.effects) {
    const eff = choice.effects[region];
    const r = G.regions[region];
    if (!r) continue;
    affectedRegions.add(region);
    if (eff.p) { const before = r.prosperity; r.prosperity = clamp(r.prosperity + eff.p, 0, 10); const actual = r.prosperity - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'\u5174', val:actual}); }
    if (eff.m) { const before = r.military; r.military = clamp(r.military + eff.m, 0, 10); const actual = r.military - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'\u6B66', val:actual}); }
    if (eff.c) { const before = r.culture; r.culture = clamp(r.culture + eff.c, 0, 10); const actual = r.culture - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'\u6587', val:actual}); }
    if (eff.t) { const before = r.trade; r.trade = clamp(r.trade + eff.t, 0, 10); const actual = r.trade - before; if (actual !== 0) effectTags.push({region:REGION_META[region].name, regionKey:region, stat:'\u5546', val:actual}); }
  }

  // Chain reactions
  const chains = applyChainReactions();

  // Screen effect on map area
  screenEffect(ev, choice, effectTags);

  // Trap reveal sound
  if (choice._isTrap) {
    setTimeout(() => SFX.trapReveal(), 200);
  }

  // Clear scene overlay and show stat deltas on map
  clearChoicePreview();
  clearMapScene();
  setTimeout(() => showMapDeltas(effectTags), 300);

  // Record
  G.choices.push({era:G.era, event:ev.id, choice:idx});
  addLog(ev.title + ' \u2192 ' + choice.text.slice(0,12) + '\u2026');

  // Replace crisis panel content with result (inline)
  const content = document.getElementById('crisis-content');

  // Generate a verdict summary
  const posCount = effectTags.filter(t => t.val > 0).length;
  const negCount = effectTags.filter(t => t.val < 0).length;
  let verdict = '';
  if (posCount > 0 && negCount === 0) verdict = '天命眷顾，国运昌隆';
  else if (negCount > 0 && posCount === 0) verdict = '天命示警，当思变通';
  else if (posCount > negCount) verdict = '利弊相权，略有所得';
  else if (negCount > posCount) verdict = '祸福相依，代价不轻';
  else verdict = '天道无常，尚需观望';

  const conseq = choice.consequence || '';

  let html = '<div class="result-section" style="text-align:center;">';
  html += '<div class="result-verdict" style="font-size:1.6em;color:var(--bright-gold);letter-spacing:4px;margin:16px 0 8px;text-shadow:0 0 20px rgba(201,169,110,0.3);">' + verdict + '</div>';
  html += '<div style="color:#888;font-size:0.85em;margin-bottom:16px;">' + ev.title + '</div>';

  // Big animated stat change cards
  html += '<div class="result-stat-cards" id="res-stat-cards">';
  effectTags.forEach((t, i) => {
    const cls = t.val > 0 ? 'pos' : 'neg';
    const sign = t.val > 0 ? '+' : '';
    const statKeyMap = {'\u5174':'p','\u6B66':'m','\u6587':'c','\u5546':'t'};
    const sk = statKeyMap[t.stat] || '';
    html += `<div class="result-stat-card" style="animation-delay:${i*0.12}s" onclick="showStatExplain('${ev.id}',${idx},'${t.regionKey||''}','${t.stat}',${t.val},'${sk}')">`;
    html += `<div class="rsc-region">${t.region}</div>`;
    html += `<div class="rsc-val ${cls}">${sign}${t.val}</div>`;
    html += `<div class="rsc-stat">${t.stat}</div>`;
    html += '</div>';
  });
  html += '</div>';

  // Effect tags (hidden) — keep for sound/cascade logic
  html += '<div class="effect-tags" id="res-effects" style="display:none;">';
  effectTags.forEach(t => {
    const cls = t.val > 0 ? 'positive' : 'negative';
    const sign = t.val > 0 ? '+' : '';
    html += '<span class="effect-tag ' + cls + '">' + t.region + ' ' + t.stat + sign + t.val + '</span>';
  });
  html += '</div>';

  // Trap reveal — if player fell for the trap
  if (choice._isTrap) {
    html += '<div style="margin:12px 0;padding:10px 14px;background:rgba(220,60,60,0.08);border-radius:6px;border-left:3px solid #c04040;animation:fadeIn 0.5s ease;">';
    html += '<div style="color:#e06060;font-size:1em;font-weight:bold;margin-bottom:6px;">⚠ 陷阱！你上当了</div>';
    html += '<div style="color:#c08080;font-size:0.85em;line-height:1.7;">' + (choice._trapReason || choice.trapReason || '') + '</div>';
    html += '</div>';
  }

  // Consequence text
  if (conseq) {
    html += '<div style="color:#999;font-size:0.88em;line-height:1.7;margin:12px 0;padding:8px 14px;background:rgba(201,169,110,0.04);border-radius:6px;border-left:2px solid rgba(201,169,110,0.15);">' + conseq + '</div>';
  }

  // Historical outcome — what actually happened in history
  const histOutcome = (typeof HISTORICAL_OUTCOMES !== 'undefined') && HISTORICAL_OUTCOMES[ev.id];
  if (histOutcome) {
    html += '<div style="margin:12px 0;padding:10px 14px;background:rgba(100,140,180,0.06);border-radius:6px;border-left:3px solid rgba(100,140,180,0.4);">';
    html += '<div style="color:#8ab4d0;font-size:0.9em;font-weight:bold;margin-bottom:6px;">📖 历史上的真实选择</div>';
    html += '<div style="color:#9aaa9a;font-size:0.85em;line-height:1.7;margin-bottom:6px;">' + histOutcome.realHistory + '</div>';
    html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
    html += '<div style="flex:1;min-width:120px;padding:6px 8px;background:rgba(80,180,80,0.06);border-radius:4px;"><span style="color:#6a9a6a;font-size:0.82em;">✅ ' + histOutcome.realPros + '</span></div>';
    html += '<div style="flex:1;min-width:120px;padding:6px 8px;background:rgba(180,80,80,0.06);border-radius:4px;"><span style="color:#b07070;font-size:0.82em;">❌ ' + histOutcome.realCons + '</span></div>';
    html += '</div>';
    html += '<div style="color:#c9a96e;font-size:0.82em;margin-top:6px;font-style:italic;">💡 ' + histOutcome.lesson + '</div>';
    html += '</div>';
  }

  // Continue button
  html += '<button class="continue-btn hidden" id="res-continue">继 续</button>';
  html += '</div>';
  content.innerHTML = html;
  content.scrollTop = 0;

  // Wire up continue button
  const isFinaleChoice = ev.isFinale && choice.ending;
  const advanceFn = isFinaleChoice ? () => showEnding(choice.ending) : () => nextTurn();
  const contBtn = document.getElementById('res-continue');
  if (contBtn) {
    contBtn.addEventListener('click', () => {
      SFX.click();
      advanceFn();
    });
  }

  // Sequential reveal of effect tags + map pulse
  const tags = document.querySelectorAll('#res-effects .effect-tag');
  const regionGroups = {};
  effectTags.forEach((t, i) => {
    if (!regionGroups[t.regionKey]) regionGroups[t.regionKey] = [];
    regionGroups[t.regionKey].push(i);
  });
  const groupKeys = Object.keys(regionGroups);
  groupKeys.forEach((rk, gi) => {
    setTimeout(() => {
      let hasPos = false, hasNeg = false;
      regionGroups[rk].forEach(ti => {
        if (tags[ti]) {
          tags[ti].classList.add('revealed');
          if (tags[ti].classList.contains('positive')) hasPos = true;
          if (tags[ti].classList.contains('negative')) hasNeg = true;
        }
      });
      // Play appropriate sound for this group
      if (hasNeg) SFX.negativeThud();
      else if (hasPos) SFX.positiveChime();
      pulseMapNode(rk);
    }, 250 * (gi + 1));
  });

  // Show chains simultaneously with last tags reveal
  const totalRevealTime = 250 * (groupKeys.length + 1);
  setTimeout(() => {
    if (chains.length > 0) {
      showChainNotifications(chains);
    }
  }, totalRevealTime);

  // Show continue button 500ms after last tags
  setTimeout(() => {
    contBtn.classList.remove('hidden');
  }, totalRevealTime + 500);

  renderMap();
  renderTopBar();
  renderTimeline();
  updateMapNodeCritical();

  // Update mandate score
  const newMandate = calculateMandateScore();
  animateMandateScore(newMandate);

  // Update power ranking
  renderPowerRanking();

  // Check achievements
  checkAchievements();

  // Inject event insight after tags are revealed
  if (typeof _injectEventInsight === 'function') {
    setTimeout(_injectEventInsight, totalRevealTime + 300);
  }
}

function pulseMapNode(regionKey) {
  const nodes = document.querySelectorAll('.region-node');
  const keys = Object.keys(REGION_META);
  const idx = keys.indexOf(regionKey);
  if (idx >= 0 && nodes[idx]) {
    const circle = nodes[idx].querySelector('.node-circle');
    if (circle) {
      circle.classList.remove('pulse');
      void circle.offsetWidth;
      circle.classList.add('pulse');
    }
  }
}

function screenEffect(ev, choice, effectTags) {
  const mapArea = document.getElementById('map-area');
  if (!mapArea) return;
  const title = ev.title;
  const negCount = effectTags.filter(t => t.val < 0).length;
  const bigPos = effectTags.filter(t => t.val >= 3).length;
  const isWar = /战|乱|侵|伐|叛|寇|兵/.test(title);
  const isDisaster = /祸|灾|亡|破|毁/.test(title);
  const isGlory = /盛世|繁华|昌|通|兴邦|变法|开放/.test(title) || ev.isTransformation;

  mapArea.classList.remove('shake','flash-gold','flash-red');
  void mapArea.offsetWidth;

  if (isWar || isDisaster) {
    mapArea.classList.add('shake');
    SFX.warRumble();
    if (negCount >= 3) mapArea.classList.add('flash-red');
  } else if (isGlory || bigPos > 0) {
    mapArea.classList.add('flash-gold');
  } else if (negCount >= 3) {
    mapArea.classList.add('flash-red');
  }

  setTimeout(() => {
    mapArea.classList.remove('shake','flash-gold','flash-red');
  }, 1000);
}

function showStatDeltas(beforeStats) {
  // No longer uses region cards - stats visible on map tooltip
}

function applyChainReactions() {
  const chains = [];
  const r = G.regions;
  const statNames = {prosperity:'兴',military:'武',culture:'文',trade:'商'};

  // === NEGATIVE CHAINS (threats & costs — fire more often) ===

  // 1. 草原劫掠：草原武力强 → 中原繁荣-1, 过渡地带繁荣-1
  if (r.caoyuan.military > 6) {
    r.zhongyuan.prosperity = clamp(r.zhongyuan.prosperity - 1, 0, 10);
    r.guodu.prosperity = clamp(r.guodu.prosperity - 1, 0, 10);
    chains.push({from:'caoyuan',to:'zhongyuan',text:'草原劫掠 → 中原繁荣-1'});
    chains.push({from:'caoyuan',to:'guodu',text:'草原劫掠 → 过渡动荡-1'});
  }

  // 2. 军费消耗：中原重武 → 繁荣-1（养兵如养虎）
  if (r.zhongyuan.military > 7) {
    r.zhongyuan.prosperity = clamp(r.zhongyuan.prosperity - 1, 0, 10);
    chains.push({from:'zhongyuan',to:'zhongyuan',text:'军费浩繁 → 中原繁荣-1'});
  }

  // 3. 文化僵化：任何区域文化极高但商贸低 → 商贸再-1
  for (let k in r) {
    if (r[k].culture > 8 && r[k].trade < 4) {
      r[k].trade = clamp(r[k].trade - 1, 0, 10);
      chains.push({from:k,to:k,text:`${REGION_META[k].name}文化保守 → 商贸-1`});
    }
  }

  // 4. 海盗滋扰：海洋武力低 → 海洋商贸-1
  if (r.haiyang.military < 4 && r.haiyang.trade > 5) {
    r.haiyang.trade = clamp(r.haiyang.trade - 1, 0, 10);
    chains.push({from:'haiyang',to:'haiyang',text:'海盗横行 → 海洋商贸-1'});
  }

  // 5. 边疆离心：西域/高原/西南繁荣高但中原文化低 → 该区域文化-1
  ['xiyu','gaoyuan','xinan'].forEach(k => {
    if (r[k].prosperity > 6 && r.zhongyuan.culture < 5) {
      r[k].culture = clamp(r[k].culture - 1, 0, 10);
      chains.push({from:'zhongyuan',to:k,text:`中原文弱 → ${REGION_META[k].name}离心-1`});
    }
  });

  // 6. 马太效应：强弱差距过大 → 最弱区域繁荣-1，武力-1
  const totals = Object.keys(r).map(k => ({k, t:r[k].prosperity+r[k].military+r[k].culture+r[k].trade}));
  const maxT = Math.max(...totals.map(x=>x.t));
  const minEntry = totals.reduce((a,b)=>a.t<b.t?a:b);
  if (maxT - minEntry.t > 12) {
    r[minEntry.k].prosperity = clamp(r[minEntry.k].prosperity - 1, 0, 10);
    r[minEntry.k].military = clamp(r[minEntry.k].military - 1, 0, 10);
    chains.push({from:totals.find(x=>x.t===maxT).k,to:minEntry.k,text:`${REGION_META[minEntry.k].name}积弱 → 兴-1 武-1`});
  }

  // 7. 衰落螺旋：总实力<12的区域随机属性-1（更容易触发）
  totals.forEach(({k, t}) => {
    if (t < 12) {
      const stats = ['prosperity','military','culture','trade'];
      const rstat = stats[Math.floor(Math.random()*4)];
      r[k][rstat] = clamp(r[k][rstat] - 1, 0, 10);
      chains.push({from:k,to:k,text:`${REGION_META[k].name}衰落 → ${statNames[rstat]}-1`});
    }
  });

  // 8. 贸易依赖：商贸极高但军事低 → 被掠夺，繁荣-1
  for (let k in r) {
    if (r[k].trade > 7 && r[k].military < 3) {
      r[k].prosperity = clamp(r[k].prosperity - 1, 0, 10);
      chains.push({from:k,to:k,text:`${REGION_META[k].name}富而不强 → 繁荣-1`});
    }
  }

  // === POSITIVE CHAINS (rewards — harder to trigger) ===

  // 9. 丝路繁盛：西域商贸极高 → 中原商贸+1（需要>8才触发）
  if (r.xiyu.trade > 8) {
    r.zhongyuan.trade = clamp(r.zhongyuan.trade + 1, 0, 10);
    chains.push({from:'xiyu',to:'zhongyuan',text:'丝路繁盛 → 中原商贸+1'});
  }

  // 10. 海洋带动南方：海洋商贸极高 → 西南商贸+1
  if (r.haiyang.trade > 8) {
    r.xinan.trade = clamp(r.xinan.trade + 1, 0, 10);
    chains.push({from:'haiyang',to:'xinan',text:'海路畅通 → 西南商贸+1'});
  }

  // 11. 文化辐射：中原文化极高 → 过渡文化+1（仅限过渡）
  if (r.zhongyuan.culture > 8) {
    r.guodu.culture = clamp(r.guodu.culture + 1, 0, 10);
    chains.push({from:'zhongyuan',to:'guodu',text:'文运昌隆 → 过渡文化+1'});
  }

  // 12. 过渡枢纽：过渡地带ALL属性>6 → 中原商贸+1（高门槛）
  const gd = r.guodu;
  if (gd.prosperity > 6 && gd.military > 6 && gd.culture > 6 && gd.trade > 6) {
    r.zhongyuan.trade = clamp(r.zhongyuan.trade + 1, 0, 10);
    chains.push({from:'guodu',to:'zhongyuan',text:'过渡枢纽 → 中原商贸+1'});
  }

  // 13. 军事威慑通商：中原军威极强 → 草原商贸+1（需>9）
  if (r.zhongyuan.military > 9) {
    r.caoyuan.trade = clamp(r.caoyuan.trade + 1, 0, 10);
    chains.push({from:'zhongyuan',to:'caoyuan',text:'军威震慑 → 草原通商+1'});
  }

  // 14. 高原佛法化草原（需极高阈值）
  if (r.gaoyuan.culture > 8) {
    r.caoyuan.culture = clamp(r.caoyuan.culture + 1, 0, 10);
    chains.push({from:'gaoyuan',to:'caoyuan',text:'佛法东传 → 草原文化+1'});
  }

  return chains;
}

function showChainNotifications(chains) {
  const container = document.getElementById('chain-notifications');
  container.innerHTML = '';
  chains.forEach((ch, i) => {
    setTimeout(() => {
      const notif = document.createElement('div');
      notif.className = 'chain-notif';
      notif.textContent = '⚡ ' + ch.text;
      container.appendChild(notif);
      highlightConnection(ch.from, ch.to);
      pulseMapNode(ch.to);
      setTimeout(() => notif.remove(), 2600);
    }, i * 500);
  });
}

function highlightConnection(fromKey, toKey) {
  const fromM = REGION_META[fromKey], toM = REGION_META[toKey];
  if (!fromM || !toM) return;
  const lines = document.querySelectorAll('.connection-line');
  lines.forEach(line => {
    // For path elements, parse the d attribute to find start/end points
    const d = line.getAttribute('d');
    if (!d) return;
    // Extract start point (M x,y) and end point (last x,y)
    const mMatch = d.match(/^M\s*([\d.]+)[,\s]+([\d.]+)/);
    const endMatch = d.match(/([\d.]+)[,\s]+([\d.]+)\s*$/);
    if (!mMatch || !endMatch) return;
    const x1 = +mMatch[1], y1 = +mMatch[2];
    const x2 = +endMatch[1], y2 = +endMatch[2];
    const matchA = (Math.abs(x1-fromM.x)<15 && Math.abs(y1-fromM.y)<15 && Math.abs(x2-toM.x)<15 && Math.abs(y2-toM.y)<15);
    const matchB = (Math.abs(x2-fromM.x)<15 && Math.abs(y2-fromM.y)<15 && Math.abs(x1-toM.x)<15 && Math.abs(y1-toM.y)<15);
    if (matchA || matchB) {
      line.classList.add('chain-active');
      setTimeout(() => line.classList.remove('chain-active'), 1200);
    }
  });
}

function nextTurn() {
  G._choosing = false;
  G.turn++;
  G.eventIdx++;

  // Check if we need an era transition or ending
  const events = EVENTS[G.era];
  if (!events || G.eventIdx >= events.length) {
    if (G.era < 4) {
      nextEra();
    } else {
      showEnding();
    }
    return;
  }

  // Only show strategic phase every 3 events (not after every single one)
  if (G.eventIdx % 3 === 0 && G.eventIdx > 0) {
    showStrategicPhase();
  } else {
    showEvent();
  }
}

function nextEra() {
  // Compute era summary before advancing
  let summaryText = '';
  if (G.eraStartSnapshot) {
    const deltas = [];
    for (let k in G.regions) {
      const now = G.regions[k];
      const was = G.eraStartSnapshot[k];
      if (!was) continue;
      const totalNow = now.prosperity + now.military + now.culture + now.trade;
      const totalWas = was.prosperity + was.military + was.culture + was.trade;
      const diff = totalNow - totalWas;
      if (diff !== 0) deltas.push(`${REGION_META[k].name} ${diff>0?'+':''}${diff}`);
    }
    if (deltas.length > 0) summaryText = '本纪变化：' + deltas.join('  ');
  }

  G.era++;
  G.eventIdx = 0;
  _worldEra = 0; // Force world re-render for new era

  // Snapshot for next era
  G.eraStartSnapshot = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    G.eraStartSnapshot[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }

  const trans = document.getElementById('era-transition');
  const summary = document.getElementById('era-trans-summary');
  const title = document.getElementById('era-trans-title');
  const line = document.getElementById('era-trans-line');
  const desc = document.getElementById('era-trans-desc');
  const preview = document.getElementById('era-trans-preview');

  // Reset
  summary.style.opacity = '0'; summary.textContent = summaryText;
  title.textContent = ERA_NAMES[G.era]; title.style.opacity = '0'; title.style.letterSpacing = '20px';
  line.style.width = '0';
  desc.textContent = ERA_DESCS[G.era]; desc.style.opacity = '0';
  preview.textContent = G.era < 4 ? `下一纪：${ERA_NAMES[G.era+1]||''}` : ''; preview.style.opacity = '0';

  // Apply era-specific background color
  trans.classList.remove('era-to-2','era-to-3','era-to-4');
  if (G.era >= 2 && G.era <= 4) trans.classList.add('era-to-' + G.era);
  trans.classList.add('active');
  SFX.eraGong();
  addLog(`═══ 进入${ERA_NAMES[G.era]} ═══`);

  // Phase 1: Summary (0.5s)
  setTimeout(() => { summary.style.transition = 'opacity 0.8s'; summary.style.opacity = '1'; }, 500);
  // Phase 2: Title with letter-spacing collapse (1.5s)
  setTimeout(() => { title.style.transition = 'opacity 1s, letter-spacing 1.2s'; title.style.opacity = '1'; title.style.letterSpacing = '8px'; }, 1500);
  // Phase 3: Line expand (2.8s)
  setTimeout(() => { line.style.width = '200px'; }, 2800);
  // Phase 4: Description (3.5s)
  setTimeout(() => { desc.style.transition = 'opacity 0.8s'; desc.style.opacity = '1'; }, 3500);
  // Phase 5: Preview (4.2s)
  setTimeout(() => { preview.style.transition = 'opacity 0.6s'; preview.style.opacity = '1'; }, 4200);
  // Phase 6: Close (5.5s)
  setTimeout(() => {
    trans.classList.remove('active');
    renderTopBar();
    renderPowerRanking();
    updateMapEraTint();
    updateMapNodeCritical();
    showEvent();
  }, 5500);
}

function showEnding(endingKey) {
  G._choosing = false;

  // 如果没有指定结局，根据状态判断
  if (!endingKey) {
    endingKey = calculateEnding();
  }

  const ending = ENDINGS[endingKey] || ENDINGS.balanced;
  const endingTitle = document.getElementById('ending-title');
  const endingDesc = document.getElementById('ending-desc');
  const endingScoreEl = document.getElementById('ending-score');
  const endingBtn = document.querySelector('#ending-screen .start-btn');

  // Reset animation classes
  endingTitle.classList.remove('ending-visible');
  endingScoreEl.classList.remove('ending-visible');
  if (endingBtn) endingBtn.classList.remove('ending-visible');

  endingTitle.textContent = ending.title;

  // Split description into lines for staggered reveal
  const descLines = ending.desc.split('\n').filter(l => l.trim() !== '');
  endingDesc.innerHTML = descLines.map(l => `<div class="ending-line">${l}</div>`).join('');

  // 计算分数
  let totalScore = 0;
  for (let k in G.regions) {
    const r = G.regions[k];
    totalScore += r.prosperity + r.military + r.culture + r.trade;
  }
  // 均衡度加分
  const vals = Object.values(G.regions).map(r => r.prosperity + r.military + r.culture + r.trade);
  const avg = vals.reduce((a,b) => a+b, 0) / vals.length;
  const variance = vals.reduce((a,v) => a + Math.pow(v-avg, 2), 0) / vals.length;
  const balanceBonus = Math.max(0, Math.round(30 - variance));
  totalScore += balanceBonus;

  endingScoreEl.textContent = `天命值：0（均衡加成 +${balanceBonus}）`;

  document.getElementById('game').classList.remove('active');
  document.getElementById('ending-screen').classList.add('active');

  // Cinematic entrance sequence
  // Phase 1: Title scales in (after 1.5s fade from black)
  setTimeout(() => endingTitle.classList.add('ending-visible'), 1500);

  // Phase 2: Description lines appear one by one
  const lines = endingDesc.querySelectorAll('.ending-line');
  lines.forEach((line, i) => {
    setTimeout(() => line.classList.add('ending-visible'), 2500 + i * 300);
  });

  // Phase 3: Score counts up
  const scoreDelay = 2500 + lines.length * 300 + 500;
  setTimeout(() => {
    endingScoreEl.classList.add('ending-visible');
    // Count-up animation
    let current = 0;
    const steps = 30;
    const stepVal = totalScore / steps;
    let step = 0;
    const scoreTimer = setInterval(() => {
      step++;
      current += stepVal;
      endingScoreEl.textContent = `天命值：${Math.round(current)}（均衡加成 +${balanceBonus}）`;
      if (step >= steps) {
        clearInterval(scoreTimer);
        endingScoreEl.textContent = `天命值：${totalScore}（均衡加成 +${balanceBonus}）`;
      }
    }, 40);
  }, scoreDelay);

  // Phase 4: Button appears last with pulse glow
  const btnDelay = scoreDelay + 1500;
  setTimeout(() => {
    if (endingBtn) {
      endingBtn.classList.add('ending-visible');
      endingBtn.style.animation = 'endingBtnPulse 2.5s ease-in-out infinite';
    }
  }, btnDelay);
}

function calculateEnding() {
  const totals = {};
  let totalCulture = 0, totalMilitary = 0, totalTrade = 0;
  for (let k in G.regions) {
    const r = G.regions[k];
    totals[k] = r.prosperity + r.military + r.culture + r.trade;
    totalCulture += r.culture;
    totalMilitary += r.military;
    totalTrade += r.trade;
  }
  const zhTotal = totals.zhongyuan;
  const hyTotal = totals.haiyang;
  const allTotal = Object.values(totals).reduce((a,b) => a+b, 0);
  const avg = allTotal / 7;
  const maxDev = Math.max(...Object.values(totals).map(v => Math.abs(v - avg)));

  // New specialist endings (check first, they require extreme focus)
  if (totalCulture > 55) return 'culture_peak';
  if (totalMilitary > 55) return 'military_hegemony';
  if (totalTrade > 55) return 'trade_empire';

  if (maxDev < 6 && allTotal > 140) return 'pivot';
  if (zhTotal > 30 && zhTotal > hyTotal * 1.5) return 'empire';
  if (hyTotal > 25 && hyTotal > zhTotal) return 'ocean';
  if (allTotal < 100) return 'chaos';
  return 'balanced';
}

// ==================== 工具函数 ====================

function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

// ==================== Event Review (clickable timeline) ====================

function showEventReview(eventId) {
  // Find the event across all eras
  let ev = null, evEra = 0;
  for (let era = 1; era <= 4; era++) {
    const found = EVENTS[era].find(e => e.id === eventId);
    if (found) { ev = found; evEra = era; break; }
  }
  if (!ev) return;

  const choiceRecord = G.choices.find(c => c.event === eventId);
  const modal = document.getElementById('event-review-modal');
  const card = document.getElementById('review-card-content');

  let html = '<h2>' + ev.title + '</h2>';
  html += '<div class="review-era">' + ERA_NAMES[evEra] + '</div>';
  html += '<div class="review-desc">' + ev.description + '</div>';
  html += '<div class="review-quote">' + ev.quote + '</div>';

  if (choiceRecord) {
    const ch = ev.choices[choiceRecord.choice];
    if (ch) {
      html += '<div class="review-choice">\u2714 \u4F60\u7684\u62C9\u62E9\uFF1A' + ['\u7532','\u4E59','\u4E19'][choiceRecord.choice] + ' \u00B7 ' + ch.text + '</div>';
      html += '<div class="review-consequence">' + ch.consequence + '</div>';
      // Show effects
      html += '<div class="review-effects">';
      for (let region in ch.effects) {
        const eff = ch.effects[region];
        const rn = REGION_META[region] ? REGION_META[region].name : region;
        const statNames = {p:'\u5174',m:'\u6B66',c:'\u6587',t:'\u5546'};
        for (let sk in statNames) {
          if (eff[sk] && eff[sk] !== 0) {
            const cls = eff[sk] > 0 ? 'positive' : 'negative';
            const sign = eff[sk] > 0 ? '+' : '';
            html += '<span class="effect-tag ' + cls + '">' + rn + ' ' + statNames[sk] + sign + eff[sk] + '</span>';
          }
        }
      }
      html += '</div>';
    }
  } else {
    html += '<div style="color:#6a5a3a;font-size:0.88em;text-align:center;margin:12px 0;">\u5C1A\u672A\u505A\u51FA\u62C9\u62E9</div>';
  }

  html += '<button class="review-dismiss" onclick="closeEventReview()">\u5173 \u95ED</button>';
  card.innerHTML = html;
  modal.classList.add('active');
  SFX.click();
}

function closeEventReview() {
  document.getElementById('event-review-modal').classList.remove('active');
  SFX.click();
}

function showFutureTeaser() {
  const modal = document.getElementById('event-review-modal');
  const card = document.getElementById('review-card-content');
  card.innerHTML = '<h2 style="margin-bottom:16px;">\u672A\u77E5\u5929\u547D</h2><div style="color:#8a7a5a;font-size:1em;text-align:center;line-height:2;margin-bottom:20px;">\u6B64\u4E8B\u5C1A\u672A\u53D1\u751F\u2026\u2026<br><br>\u5929\u547D\u96BE\u6D4B\uFF0C\u4F46\u8D24\u8005\u53EF\u4EE5\u51C6\u5907\u3002<br>\u5F53\u65F6\u673A\u5230\u6765\uFF0C\u4F60\u5C06\u505A\u51FA\u62C9\u62E9\u3002</div><button class="review-dismiss" onclick="closeEventReview()">\u77E5 \u9053 \u4E86</button>';
  modal.classList.add('active');
  SFX.click();
}

// ==================== Region Detail Panel ====================

let _regionDetailActive = false;
let _crisisPanelBackup = '';

function selectRegion(k) {
  showRegionDetail(k);
}

function showRegionDetail(regionKey) {
  const meta = REGION_META[regionKey];
  const region = G.regions[regionKey];
  if (!meta || !region) return;

  SFX.click();

  // Highlight selected path on map
  document.querySelectorAll('.region-path').forEach(p => p.classList.remove('selected'));
  const pathEl = document.querySelector(`[data-region="${regionKey}"]`);
  if (pathEl) pathEl.classList.add('selected');

  const total = region.prosperity + region.military + region.culture + region.trade;
  const lore = REGION_LORE[regionKey] ? (REGION_LORE[regionKey][G.era] || '') : '';
  const figures = REGION_FIGURES[regionKey] ? (REGION_FIGURES[regionKey][G.era] || []) : [];

  // Find events that affected this region
  const affectedEvents = [];
  for (let era = 1; era <= G.era; era++) {
    const events = EVENTS[era];
    events.forEach((ev, ei) => {
      if (era > G.era || (era === G.era && ei >= G.eventIdx)) return;
      const choiceRecord = G.choices.find(c => c.event === ev.id);
      if (!choiceRecord) return;
      const ch = ev.choices[choiceRecord.choice];
      if (ch && ch.effects && ch.effects[regionKey]) {
        const eff = ch.effects[regionKey];
        const parts = [];
        if (eff.p) parts.push('兴' + (eff.p > 0 ? '+' : '') + eff.p);
        if (eff.m) parts.push('武' + (eff.m > 0 ? '+' : '') + eff.m);
        if (eff.c) parts.push('文' + (eff.c > 0 ? '+' : '') + eff.c);
        if (eff.t) parts.push('商' + (eff.t > 0 ? '+' : '') + eff.t);
        if (parts.length > 0) {
          affectedEvents.push({title: ev.title, effects: parts.join(' ')});
        }
      }
    });
  }

  const statDefs = [
    {key:'prosperity',label:'经济繁荣',short:'兴'},
    {key:'military',label:'军事力量',short:'武'},
    {key:'culture',label:'文化影响',short:'文'},
    {key:'trade',label:'商贸活力',short:'商'}
  ];

  // Use modal overlay instead of replacing crisis panel
  const modal = document.getElementById('event-review-modal');
  const card = document.getElementById('review-card-content');

  const statColor = v => v <= 2 ? '#c56b6b' : v <= 4 ? '#b8860b' : v <= 6 ? '#8a8a7a' : v <= 8 ? '#7cb87c' : '#dbb978';
  const statTier = v => v <= 2 ? '衰败' : v <= 4 ? '薄弱' : v <= 6 ? '平常' : v <= 8 ? '兴盛' : '极盛';

  let html = '<div style="border-bottom:1px solid rgba(201,169,110,0.2);padding-bottom:12px;margin-bottom:12px;">';
  html += '<div style="display:flex;align-items:center;gap:10px;">';
  html += '<div style="width:16px;height:16px;border-radius:50%;background:' + meta.color + ';box-shadow:0 0 8px ' + meta.color + '40;"></div>';
  html += '<h2 style="color:var(--bright-gold);letter-spacing:4px;margin:0;">' + meta.name + '</h2>';
  html += '</div>';
  html += '<div style="color:#8a7a5a;font-size:0.85em;margin-top:4px;">' + meta.desc + '</div>';
  html += '</div>';

  // Stats with color-coded bars
  html += '<div class="rd-stats" style="margin-bottom:14px;">';
  statDefs.forEach(s => {
    const val = region[s.key];
    const barColor = statColor(val);
    html += '<div class="rd-stat"><div class="rd-stat-label">' + s.short + ' ' + s.label + '</div>';
    html += '<div class="rd-stat-bar"><div class="rd-stat-fill" style="width:' + (val * 10) + '%;background:' + barColor + ';"></div></div>';
    html += '<div class="rd-stat-val" style="color:' + barColor + '">' + val + ' <small>' + statTier(val) + '</small></div></div>';
  });
  html += '</div>';
  const tierLabel = total <= 12 ? '危' : total <= 20 ? '弱' : total <= 28 ? '平' : total <= 35 ? '盛' : '极';
  const tierColor = total <= 12 ? '#c56b6b' : total <= 20 ? '#b8860b' : total <= 28 ? '#aaa' : total <= 35 ? '#7cb87c' : '#dbb978';
  html += '<div style="text-align:center;color:' + tierColor + ';font-size:0.95em;margin-bottom:14px;letter-spacing:2px;font-weight:bold;">综合实力：' + total + '/40 · ' + tierLabel + '</div>';

  // Lore
  if (lore) {
    html += '<div class="rd-lore"><h3>📜 ' + ERA_NAMES[G.era] + ' · ' + meta.name + '</h3>';
    html += '<p>' + lore + '</p></div>';
  }

  // Figures
  if (figures.length > 0) {
    html += '<div class="rd-figures"><h3>👤 关键人物</h3>';
    figures.forEach(f => { html += '<span class="rd-figure">' + f + '</span>'; });
    html += '</div>';
  }

  // Region dynamics - interaction with other regions
  if (typeof REGION_DYNAMICS !== 'undefined' && REGION_DYNAMICS[G.era]) {
    const dynamics = REGION_DYNAMICS[G.era];
    const relatedDynamics = [];
    for (let pair in dynamics) {
      const parts = pair.split('-');
      if (parts[0] === regionKey || parts[1] === regionKey) {
        const otherKey = parts[0] === regionKey ? parts[1] : parts[0];
        const otherName = REGION_META[otherKey] ? REGION_META[otherKey].name : otherKey;
        relatedDynamics.push({other: otherName, text: dynamics[pair]});
      }
    }
    if (relatedDynamics.length > 0) {
      html += '<div class="rd-dynamics"><h3>🔗 区域互动（' + ERA_NAMES[G.era] + '）</h3>';
      relatedDynamics.forEach(d => {
        html += '<div style="margin-bottom:8px;"><strong style="color:var(--bright-gold);">↔ ' + d.other + '</strong><br>' + d.text + '</div>';
      });
      html += '</div>';
    }
  }

  // Event history
  if (affectedEvents.length > 0) {
    html += '<div class="rd-history"><h3>📅 影响事件</h3>';
    affectedEvents.forEach(ae => {
      html += '<div class="rd-event-entry"><span>' + ae.title + '</span> → ' + ae.effects + '</div>';
    });
    html += '</div>';
  }

  html += '<button class="review-dismiss" onclick="closeEventReview()">关 闭</button>';
  card.innerHTML = html;
  modal.classList.add('active');
}

function closeRegionDetail() {
  // Region detail now uses modal overlay - close it
  closeEventReview();
  document.querySelectorAll('.region-path').forEach(p => p.classList.remove('selected'));
}

// ==================== Strategic Phase ====================

function showStrategicPhase() {
  G._inStrategicPhase = true;
  _regionDetailActive = false;
  _crisisPanelBackup = '';
  _clearMapHighlights();

  const content = document.getElementById('crisis-content');
  const panel = document.getElementById('crisis-panel');

  // Remove scene classes (preserve tab-active for mobile)
  const _spHadTab = panel.classList.contains('tab-active');
  panel.className = '';
  panel.id = 'crisis-panel';
  if (_spHadTab) panel.classList.add('tab-active');

  const knowledge = ERA_KNOWLEDGE[G.era] || {};
  // Build summary of region states
  const ranked = Object.keys(REGION_META).map(k => {
    const r = G.regions[k];
    return {name: REGION_META[k].name, total: r.prosperity + r.military + r.culture + r.trade};
  }).sort((a,b) => b.total - a.total);

  let summaryHtml = '';
  ranked.forEach(item => {
    summaryHtml += item.name + '\uFF1A' + item.total + ' &nbsp; ';
  });

  let html = '<div class="strategic-phase">';
  html += '<div class="sp-title">\u5929\u4E0B\u5C40\u52BF</div>';
  html += '<div class="sp-era-context">' + ERA_NAMES[G.era] + '</div>';
  html += '<div class="sp-divider"></div>';

  if (knowledge.theme) {
    html += '<div class="sp-knowledge">';
    html += '<p><strong style="color:var(--bright-gold);font-size:1.05em;">\uD83D\uDD0D ' + knowledge.theme + '</strong></p>';
    if (knowledge.world) html += '<div class="sp-world">\uD83C\uDF0D ' + knowledge.world + '</div>';
    html += '</div>';
  }

  // Compact summary with visual bars
  html += '<div class="sp-summary" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;">';
  ranked.forEach(item => {
    const pct = Math.round(item.total / 40 * 100);
    html += `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 8px;background:rgba(201,169,110,0.06);border-radius:10px;font-size:0.82em;">`;
    html += `<span style="color:var(--gold);">${item.name}</span>`;
    html += `<span style="display:inline-block;width:32px;height:4px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;"><span style="display:block;width:${pct}%;height:100%;background:var(--gold);border-radius:2px;"></span></span>`;
    html += `<span style="color:#aaa;font-size:0.9em;">${item.total}</span></span>`;
  });
  html += '</div>';

  // Era objectives checklist
  const objectives = ERA_OBJECTIVES[G.era];
  if (objectives) {
    html += '<div class="sp-objectives">';
    html += '<strong>\uD83C\uDFAF 目标</strong>';
    objectives.forEach(obj => {
      const met = obj.check();
      const icon = met ? '\u2705' : '\u2B1C';
      const cls = met ? 'obj-met' : 'obj-unmet';
      html += `<div class="sp-obj ${cls}">${icon} ${obj.text}</div>`;
    });
    html += '</div>';
  }

  // Mini-investment: pick one region to boost
  if (!G._investedThisTurn) {
    html += '<div class="sp-invest">';
    html += '<strong>\uD83D\uDCB0 余力投入</strong><div style="color:#aaa;font-size:0.82em;margin:4px 0;">选一区域 +1 随机属性</div>';
    html += '<div class="sp-invest-grid">';
    Object.keys(REGION_META).forEach(k => {
      html += `<button class="sp-invest-btn" onclick="investRegion('${k}')" style="border-color:${REGION_META[k].color}40;">${REGION_META[k].name}</button>`;
    });
    html += '</div></div>';
  }

  // Random Shizhan insight — collapsible
  if (typeof SHIZHAN_INSIGHTS !== 'undefined') {
    const eraInsights = SHIZHAN_INSIGHTS.filter(si => si.era === G.era);
    if (eraInsights.length > 0) {
      const si = eraInsights[Math.floor(Math.random() * eraInsights.length)];
      html += `<div class="event-bg-toggle" onclick="this.classList.toggle('expanded');var s=this.nextElementSibling;s.classList.toggle('collapsed');s.classList.toggle('expanded');"><span class="toggle-arrow">\u25B6</span> \uD83D\uDCA1 施展洞见 \u00B7 ${si.tag}</div>`;
      html += `<div class="event-background collapsed" style="font-size:0.85em;color:#b8a878;line-height:1.65;">${si.text}</div>`;
    }
  }

  html += '<div class="sp-hint" style="margin-top:12px;">点击地图浏览 \u00B7 时间线回顾</div>';
  html += '<button class="sp-next-btn" onclick="exitStrategicPhase()">\u8FCE \u63A5 \u5929 \u547D</button>';
  html += '</div>';

  content.innerHTML = html;
  content.scrollTop = 0;
  _crisisPanelBackup = html;
}

function investRegion(k) {
  if (G._investedThisTurn) return;
  G._investedThisTurn = true;
  const stats = ['prosperity','military','culture','trade'];
  const statNames = {prosperity:'兴',military:'武',culture:'文',trade:'商'};
  const rstat = stats[Math.floor(Math.random()*4)];
  const before = G.regions[k][rstat];
  G.regions[k][rstat] = clamp(G.regions[k][rstat] + 1, 0, 10);
  const actual = G.regions[k][rstat] - before;
  SFX.positiveChime();
  addLog('投资' + REGION_META[k].name + '：' + statNames[rstat] + '+' + actual);
  pulseMapNode(k);
  renderMap();
  renderTopBar();
  // Refresh strategic phase to remove invest buttons (bypass random event override)
  _origShowStrategicPhase();
}

function exitStrategicPhase() {
  SFX.click();
  G._inStrategicPhase = false;
  _regionDetailActive = false;
  _crisisPanelBackup = '';
  G._investedThisTurn = false;
  showEvent();
}

// ==================== Event Icon Builder ====================

function _buildEventIcon(crisisType) {
  let inner = '';
  switch(crisisType) {
    case 'war':
      inner = '<div class="spark"></div><div class="spark"></div><div class="spark"></div>';
      break;
    case 'trade':
      inner = '<div class="silk"></div><div class="silk"></div><div class="silk"></div><div class="coin"></div>';
      break;
    case 'culture':
      inner = '<div class="brush"></div><div class="ink-trail"></div>';
      break;
    case 'gov':
      inner = '<div class="seal"></div><div class="stamp-ring"></div>';
      break;
    case 'transform':
      inner = '<div class="bolt-glow"></div><div class="bolt"></div>';
      break;
    case 'finale':
      inner = '<div class="crown">\uD83D\uDC51</div>';
      break;
    default:
      inner = '<div class="seal"></div><div class="stamp-ring"></div>';
  }
  return `<div class="event-icon-scene icon-${crisisType}">${inner}</div>`;
}

// ==================== Event Background Toggle ====================

function toggleEventBg() {
  const toggle = document.getElementById('ev-bg-toggle');
  const bg = document.getElementById('ev-bg');
  if (!toggle || !bg) return;
  if (bg.classList.contains('collapsed')) {
    bg.classList.remove('collapsed');
    bg.classList.add('expanded');
    toggle.classList.add('expanded');
  } else {
    bg.classList.remove('expanded');
    bg.classList.add('collapsed');
    toggle.classList.remove('expanded');
  }
}

function toggleEventDetail() {
  const panel = document.getElementById('ev-detail');
  const btn = document.getElementById('ev-expand');
  if (!panel) return;
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    if (btn) btn.textContent = '📜 收起';
  } else {
    panel.style.display = 'none';
    if (btn) btn.textContent = '📜 了解更多';
  }
}

// ==================== Stat Explanation Popup ====================

function showStatExplain(eventId, choiceIdx, regionKey, statLabel, val, statKey) {
  const box = document.getElementById('stat-explain-box');
  const overlay = document.getElementById('stat-explain-overlay');
  if (!box || !overlay) return;

  const regionName = REGION_META[regionKey] ? REGION_META[regionKey].name : regionKey;
  const sign = val > 0 ? '+' : '';
  const cls = val > 0 ? 'pos' : 'neg';
  const statFullNames = {'兴':'繁荣（兴）','武':'军事（武）','文':'文化（文）','商':'商贸（商）'};

  let html = '<div class="se-header">';
  html += `<span class="se-region">${regionName}</span>`;
  html += `<span class="se-stat-label">${statFullNames[statLabel] || statLabel}</span>`;
  html += `<span class="se-val ${cls}">${sign}${val}</span>`;
  html += '</div>';

  // Get per-stat reason from EFFECT_REASONS (new structure: [eventId][choiceIdx][regionKey][statKey])
  let reason = null;
  if (typeof EFFECT_REASONS !== 'undefined' && EFFECT_REASONS[eventId] && EFFECT_REASONS[eventId][choiceIdx] && EFFECT_REASONS[eventId][choiceIdx][regionKey]) {
    const regionReasons = EFFECT_REASONS[eventId][choiceIdx][regionKey];
    if (typeof regionReasons === 'object' && statKey) {
      reason = regionReasons[statKey];
    } else if (typeof regionReasons === 'string') {
      reason = regionReasons; // fallback for old format
    }
  }

  if (reason) {
    html += `<div class="se-reason">${reason}</div>`;
  }

  // Get consequence from event choice
  const ev = EVENTS[G.era] && EVENTS[G.era].find(e => e.id === eventId);
  if (ev && ev.choices[choiceIdx] && ev.choices[choiceIdx].consequence) {
    html += `<div class="se-consequence">${ev.choices[choiceIdx].consequence}</div>`;
  }

  // Deep knowledge snippet
  const dk = (typeof DEEP_KNOWLEDGE !== 'undefined') ? DEEP_KNOWLEDGE[eventId] : null;
  if (dk) {
    html += '<div class="se-knowledge">';
    if (dk.shiZhanInsight) html += `<div class="se-insight">💡 ${dk.shiZhanInsight.substring(0, 150)}…</div>`;
    if (dk.dilemma) html += `<div class="se-dilemma">⚖️ ${dk.dilemma.substring(0, 120)}…</div>`;
    html += '</div>';
  }

  html += '<button class="se-close" onclick="closeStatExplain(event)">关 闭</button>';
  box.innerHTML = html;
  overlay.classList.add('active');
}

function closeStatExplain(e) {
  if (e.target === document.getElementById('stat-explain-overlay') || e.target.classList.contains('se-close')) {
    document.getElementById('stat-explain-overlay').classList.remove('active');
  }
}

// ==================== Compact Advisor Builder ====================

function buildAdvisorCompactHtml(eventId) {
  const comments = ADVISOR_COMMENTS[eventId];
  if (!comments) return '';

  let html = '<div class="advisor-section-compact">';
  html += '<h3>\u8C0B\u58EB\u8FDB\u8A00</h3>';
  html += '<div class="advisor-icons-row">';
  ADVISORS.forEach((advisor, ai) => {
    const comment = comments[advisor.id];
    if (!comment) return;
    html += `<div class="advisor-icon-btn" onclick="toggleCompactAdvisor(${ai},this)" title="${advisor.name}">${advisor.icon}</div>`;
  });
  html += '</div>';
  html += '<div class="advisor-expand-content" id="advisor-expand">';
  ADVISORS.forEach((advisor, ai) => {
    const comment = comments[advisor.id];
    if (!comment) return;
    const recIdx = comments.recs ? comments.recs[ai] : -1;
    const recText = recIdx >= 0 ? '\u2192 \u63A8\u8350\u7B2C' + ['\u7532','\u4E59','\u4E19'][recIdx] + '\u7B56' : '';
    html += `<div class="advisor-expand-text" data-advisor="${ai}" style="display:none;">`;
    html += `<div class="aq-name">${advisor.icon} ${advisor.name}</div>`;
    html += `\u201C${comment}\u201D`;
    if (recText) html += `<div class="aq-rec">${recText}</div>`;
    html += '</div>';
  });
  html += '</div>';
  html += '</div>';
  return html;
}

function toggleCompactAdvisor(idx, btn) {
  const container = document.getElementById('advisor-expand');
  if (!container) return;
  const allBtns = document.querySelectorAll('.advisor-icon-btn');
  const allTexts = container.querySelectorAll('.advisor-expand-text');
  const targetText = container.querySelector(`[data-advisor="${idx}"]`);
  const isOpen = targetText && targetText.style.display !== 'none';

  allBtns.forEach(b => b.classList.remove('active'));
  allTexts.forEach(t => t.style.display = 'none');

  if (!isOpen && targetText) {
    targetText.style.display = 'block';
    btn.classList.add('active');
    container.classList.add('open');
  } else {
    container.classList.remove('open');
  }
}

// ==================== Advisor System ====================

function buildAdvisorHtml(eventId) {
  const comments = ADVISOR_COMMENTS[eventId];
  if (!comments) return '';

  let html = '<div class="advisor-section">';
  html += '<h3>\u8C0B\u58EB\u8FDB\u8A00</h3>';
  html += '<div class="advisor-quotes">';

  ADVISORS.forEach((advisor, ai) => {
    const commentKey = advisor.id;
    const comment = comments[commentKey];
    if (!comment) return;
    const recIdx = comments.recs ? comments.recs[ai] : -1;
    const recText = recIdx >= 0 ? '\u2192 \u63A8\u8350\u7B2C' + ['\u7532','\u4E59','\u4E19'][recIdx] + '\u7B56' : '';

    html += '<div class="advisor-quote" onclick="toggleAdvisorDetail(this)">';
    html += '<span class="aq-icon">' + advisor.icon + '</span>';
    html += '<div class="aq-body">';
    html += '<div class="aq-name">' + advisor.name + '</div>';
    html += '<div class="aq-text">\u201C' + comment + '\u201D</div>';
    if (recText) html += '<div class="aq-rec">' + recText + '</div>';
    html += '</div></div>';
  });

  html += '</div></div>';
  return html;
}

function toggleAdvisorDetail(el) {
  // Simple toggle - could expand to show more detail
  el.style.transform = el.style.transform === 'translateX(6px)' ? '' : 'translateX(6px)';
}

function getAdvisorRecsForEvent(eventId) {
  const comments = ADVISOR_COMMENTS[eventId];
  if (!comments || !comments.recs) return {};
  const result = {};
  comments.recs.forEach((recIdx, ai) => {
    if (!result[recIdx]) result[recIdx] = [];
    result[recIdx].push(ADVISORS[ai].icon);
  });
  return result;
}

// ==================== Scene Background Particles ====================

function applySceneBackground(crisisType) {
  const panel = document.getElementById('crisis-panel');
  if (!panel) return;

  // Remove old scene classes and particles
  panel.classList.remove('scene-war','scene-trade','scene-culture','scene-gov','scene-transform','scene-finale');
  const oldParticles = panel.querySelector('.scene-particles');
  if (oldParticles) oldParticles.remove();

  const config = SCENE_CONFIGS[crisisType];
  if (!config) return;

  panel.classList.add('scene-' + crisisType);

  // Create particles (skip on mobile)
  if (window.innerWidth <= 768) return;
  const particleContainer = document.createElement('div');
  particleContainer.className = 'scene-particles';
  for (let i = 0; i < config.particleCount; i++) {
    const p = document.createElement('div');
    p.className = 'scene-particle';
    p.style.left = (Math.random() * 100) + '%';
    p.style.bottom = -(Math.random() * 20) + '%';
    p.style.width = (2 + Math.random() * 3) + 'px';
    p.style.height = p.style.width;
    p.style.background = config.particleColor;
    p.style.setProperty('--sdx', (Math.random() * 40 - 20) + 'px');
    p.style.animationDuration = (8 + Math.random() * 12) + 's';
    p.style.animationDelay = (Math.random() * 6) + 's';
    particleContainer.appendChild(p);
  }
  panel.appendChild(particleContainer);
}

// ==================== Map Era Tinting ====================

function updateMapEraTint() {
  const mapArea = document.getElementById('map-area');
  if (!mapArea) return;
  mapArea.classList.remove('era-1','era-2','era-3','era-4');
  mapArea.classList.add('era-' + G.era);
  // Render living world for this era
  renderMapWorld(G.era);
}

// ==================== Map World Rendering (Living World) ====================

const BUILDING_ICONS = {
  palace:'🏛',city:'🏘',fort:'🏰',temple:'⛩',market:'🏪',port:'⚓',wall:'🧱',camp:'⛺',academy:'📚',farm:'🌾',mine:'⛏',lighthouse:'🗼'
};

let _worldEra = 0; // track which era world is rendered for

function renderMapWorld(era) {
  const layer = document.getElementById('map-world-layer');
  if (!layer) return;
  if (typeof MAP_WORLD_DATA === 'undefined') return;

  // Skip if already rendered for this era
  if (_worldEra === era) return;
  _worldEra = era;

  const data = MAP_WORLD_DATA.eras ? MAP_WORLD_DATA.eras[era] : null;
  if (!data) { layer.innerHTML = ''; return; }

  let html = '';

  // --- Weather / atmosphere particles ---
  const weather = data.weather || 'clear';
  if (weather === 'snow') {
    for (let i = 0; i < 20; i++) {
      const x = 50 + Math.random() * 500;
      const y = Math.random() * 400;
      const d = (2 + Math.random() * 4);
      html += `<circle class="world-snow" cx="${x}" cy="${y}" r="${1+Math.random()}" style="animation-delay:${Math.random()*6}s;animation-duration:${d}s;"/>`;
    }
  } else if (weather === 'rain') {
    for (let i = 0; i < 25; i++) {
      const x = 50 + Math.random() * 500;
      const y = Math.random() * 400;
      html += `<line class="world-rain" x1="${x}" y1="${y}" x2="${x-1}" y2="${y+6}" stroke="rgba(100,150,220,0.3)" stroke-width="0.5" style="animation-delay:${Math.random()*1.5}s;"/>`;
    }
  } else if (weather === 'sandstorm') {
    for (let i = 0; i < 15; i++) {
      const x = 60 + Math.random() * 200;
      const y = 100 + Math.random() * 180;
      html += `<circle class="world-sand" cx="${x}" cy="${y}" r="${1+Math.random()*2}" style="animation-delay:${Math.random()*5}s;"/>`;
    }
  }

  // --- Clouds ---
  if (weather !== 'sandstorm') {
    for (let i = 0; i < 5; i++) {
      const cx = 50 + Math.random() * 500;
      const cy = 20 + Math.random() * 60;
      const rx = 15 + Math.random() * 25;
      const ry = 4 + Math.random() * 4;
      html += `<ellipse class="world-cloud" cx="${cx}" cy="${cy}" rx="${rx}" ry="${ry}" style="animation-delay:${Math.random()*35}s;animation-duration:${25+Math.random()*20}s;"/>`;
    }
  }

  // --- Ocean waves ---
  for (let i = 0; i < 8; i++) {
    const x = 430 + Math.random() * 120;
    const y = 150 + Math.random() * 230;
    const w = 10 + Math.random() * 20;
    html += `<path class="world-wave" d="M${x},${y} Q${x+w/2},${y-2} ${x+w},${y}" style="animation-delay:${Math.random()*4}s;"/>`;
  }

  // --- Landmarks ---
  if (data.landmarks) {
    data.landmarks.forEach(lm => {
      if (lm.type === 'river' && lm.path) {
        html += `<path class="world-river" d="${lm.path}"/>`;
        if (lm.label) {
          // Place label near midpoint of path
          const mx = lm.x || 200;
          const my = lm.y || 200;
          html += `<text class="world-landmark-label" x="${mx}" y="${my}" text-anchor="middle">${lm.label}</text>`;
        }
      } else if (lm.type === 'mountain') {
        // Small triangle mountain symbol
        const x = lm.x, y = lm.y;
        html += `<path class="world-mountain" d="M${x-8},${y+4} L${x},${y-6} L${x+8},${y+4} Z"/>`;
        html += `<path class="world-mountain" d="M${x+5},${y+4} L${x+12},${y-3} L${x+19},${y+4} Z" style="opacity:0.06;"/>`;
        if (lm.label) html += `<text class="world-landmark-label" x="${x}" y="${y+12}" text-anchor="middle">${lm.label}</text>`;
      } else if (lm.type === 'desert') {
        const x = lm.x, y = lm.y;
        html += `<text class="world-landmark-label" x="${x}" y="${y}" text-anchor="middle" style="font-size:5px;letter-spacing:3px;">${lm.label || '沙漠'}</text>`;
      } else if (lm.type === 'forest') {
        const x = lm.x, y = lm.y;
        html += `<text class="world-building" x="${x}" y="${y}" text-anchor="middle" style="font-size:6px;opacity:0.3;">🌲🌳🌲</text>`;
        if (lm.label) html += `<text class="world-landmark-label" x="${x}" y="${y+10}" text-anchor="middle">${lm.label}</text>`;
      } else if (lm.type === 'lake' || lm.type === 'sea') {
        const x = lm.x, y = lm.y;
        html += `<ellipse class="world-river" cx="${x}" cy="${y}" rx="8" ry="5" style="fill:rgba(80,140,200,0.06);"/>`;
        if (lm.label) html += `<text class="world-landmark-label" x="${x}" y="${y+10}" text-anchor="middle">${lm.label}</text>`;
      } else if (lm.type === 'pass' || lm.type === 'grassland') {
        if (lm.label) html += `<text class="world-landmark-label" x="${lm.x}" y="${lm.y}" text-anchor="middle">${lm.label}</text>`;
      }
    });
  }

  // --- Buildings ---
  if (data.buildings) {
    data.buildings.forEach((b, i) => {
      const icon = BUILDING_ICONS[b.type] || '●';
      const delay = 0.1 + i * 0.08;
      html += `<text class="world-building type-${b.type}" x="${b.x}" y="${b.y}" text-anchor="middle" style="animation-delay:${delay}s;">${icon}</text>`;
      if (b.label) {
        html += `<text class="world-building-label" x="${b.x}" y="${b.y+8}" text-anchor="middle" style="animation-delay:${delay+0.1}s;opacity:0;animation:worldFadeIn 0.5s ease ${delay+0.1}s forwards;">${b.label}</text>`;
      }
    });
  }

  // --- Population indicators ---
  if (data.populations) {
    data.populations.forEach(pop => {
      const meta = REGION_META[pop.region];
      if (!meta) return;
      const cx = meta.x, cy = meta.y;
      const count = pop.density === 'high' ? 6 : pop.density === 'medium' ? 4 : 2;
      for (let i = 0; i < count; i++) {
        const px = cx - 15 + Math.random() * 30;
        const py = cy - 10 + Math.random() * 20;
        const r = pop.density === 'high' ? 1.5 + Math.random() : 1 + Math.random() * 0.5;
        html += `<circle class="world-pop-dot" cx="${px}" cy="${py}" r="${r}" style="animation-delay:${Math.random()*3}s;"/>`;
      }
    });
  }

  // --- Culture tags ---
  if (data.cultures) {
    data.cultures.forEach(cult => {
      const meta = REGION_META[cult.region];
      if (!meta || !cult.items) return;
      cult.items.forEach((item, i) => {
        const ox = meta.x + (i - cult.items.length/2) * 18;
        const oy = meta.y + 22;
        html += `<text class="world-culture-tag" x="${ox}" y="${oy}" text-anchor="middle">${item}</text>`;
      });
    });
  }

  // --- Banners ---
  if (data.banners) {
    data.banners.forEach(bn => {
      html += `<text class="world-banner" x="${bn.x}" y="${bn.y}" text-anchor="middle" fill="${bn.color || '#c9a96e'}" style="font-size:10px;">🚩${bn.text}</text>`;
    });
  }

  // --- Ambient elements (caravans, birds, boats, etc.) ---
  if (data.ambientElements) {
    data.ambientElements.forEach(ae => {
      if (ae.type === 'caravan' && ae.fromX !== undefined) {
        const dx = (ae.toX || ae.fromX + 60) - ae.fromX;
        const dy = (ae.toY || ae.fromY) - ae.fromY;
        html += `<text class="world-caravan" x="${ae.fromX}" y="${ae.fromY}" text-anchor="middle" style="--cx:0px;--cy:0px;--tx:${dx}px;--ty:${dy}px;font-size:6px;animation-delay:${Math.random()*5}s;">🐫${ae.label||''}</text>`;
      } else if (ae.type === 'bird_flock') {
        const dir = ae.direction === 'east' ? 60 : ae.direction === 'west' ? -60 : 40;
        html += `<text class="world-bird" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="--bx:${dir}px;--by:-15px;font-size:5px;animation-delay:${Math.random()*8}s;">🕊🕊🕊</text>`;
      } else if (ae.type === 'fishing_boats' || ae.type === 'ships') {
        html += `<text class="world-boat" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="--sx:${15+Math.random()*15}px;--sy:${Math.random()*8-4}px;font-size:7px;animation-delay:${Math.random()*6}s;">${ae.type==='ships'?'⛵':'🚣'}</text>`;
      } else if (ae.type === 'army') {
        html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:${ae.size==='large'?'9px':'6px'};opacity:0.4;">⚔${ae.label||''}</text>`;
      } else if (ae.type === 'nomads') {
        html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:6px;opacity:0.4;">🏇${ae.label||''}</text>`;
      } else if (ae.type === 'monks' || ae.type === 'scholars') {
        const icon = ae.type === 'monks' ? '🧘' : '📖';
        html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:6px;opacity:0.4;">${icon}</text>`;
      }
    });
  }

  layer.innerHTML = html;
}

// Also render event-specific world enhancements
function renderEventWorldExtras(eventId) {
  if (typeof MAP_WORLD_DATA === 'undefined' || !MAP_WORLD_DATA.eventScenes) return;
  const scene = MAP_WORLD_DATA.eventScenes[eventId];
  if (!scene) return;

  const layer = document.getElementById('map-world-layer');
  if (!layer) return;

  let html = layer.innerHTML;

  if (scene.extraBuildings) {
    scene.extraBuildings.forEach(b => {
      const icon = BUILDING_ICONS[b.type] || '●';
      html += `<text class="world-building type-${b.type}" x="${b.x}" y="${b.y}" text-anchor="middle" style="animation-delay:0.3s;filter:brightness(1.3);">${icon}</text>`;
      if (b.label) html += `<text class="world-building-label" x="${b.x}" y="${b.y+8}" text-anchor="middle" style="animation-delay:0.4s;opacity:0;animation:worldFadeIn 0.5s ease 0.4s forwards;fill:#e8c060;">${b.label}</text>`;
    });
  }

  if (scene.extraAmbient) {
    scene.extraAmbient.forEach(ae => {
      if (ae.type === 'scholars') html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:7px;opacity:0.5;">📖</text>`;
      else if (ae.type === 'army') html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:7px;opacity:0.5;">⚔</text>`;
      else if (ae.type === 'merchants') html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:7px;opacity:0.5;">💰</text>`;
      else if (ae.type === 'monks') html += `<text class="world-building" x="${ae.x}" y="${ae.y}" text-anchor="middle" style="font-size:7px;opacity:0.5;">🧘</text>`;
    });
  }

  layer.innerHTML = html;
}

// ==================== Map Node Critical Check ====================

function updateMapNodeCritical() {
  const keys = Object.keys(REGION_META);
  const nodes = document.querySelectorAll('.region-node');
  keys.forEach((k, i) => {
    const r = G.regions[k];
    const total = r.prosperity + r.military + r.culture + r.trade;
    if (nodes[i]) {
      const circle = nodes[i].querySelector('.node-circle');
      if (circle) {
        if (total <= 12) {
          circle.classList.add('critical-pulse');
        } else {
          circle.classList.remove('critical-pulse');
        }
      }
    }
  });
}

function saveGame() {
  SFX.click();
  localStorage.setItem('pivot_save', JSON.stringify(G));
  addLog('📜 存档成功');
}

function loadGame() {
  SFX.click();
  const data = localStorage.getItem('pivot_save');
  if (data) {
    // Clear all overlay active states first
    document.getElementById('era-transition').classList.remove('active');
    document.getElementById('ending-screen').classList.remove('active');

    G = JSON.parse(data);
    // Default value protection for old saves
    G.mandateScore = G.mandateScore || 0;
    G.unlockedAchievements = G.unlockedAchievements || [];
    G.eraStartSnapshot = G.eraStartSnapshot || null;
    G._choosing = false;
    G._inStrategicPhase = false;

    renderAll();
    addLog('📜 读档成功');
    showEvent();
  }
}

function showHelp() {
  SFX.click();
  document.getElementById('help-modal').classList.add('active');
}

function closeHelp() {
  SFX.click();
  document.getElementById('help-modal').classList.remove('active');
}

function renderPowerRanking() {
  const ranked = Object.keys(REGION_META).map(k => {
    const r = G.regions[k];
    return {key:k, name:REGION_META[k].name, color:REGION_META[k].color, total:r.prosperity+r.military+r.culture+r.trade};
  }).sort((a,b) => b.total - a.total);

  let html = '';
  ranked.forEach((item, i) => {
    const crown = i === 0 ? '👑 ' : '';
    html += `<div class="rank-item ${i===0?'rank-1':''}"><span class="rank-dot" style="background:${item.color}"></span>${crown}${item.name} <span class="rank-val">${item.total}</span></div>`;
  });
  document.getElementById('power-ranking').innerHTML = html;

  // Hegemony check
  if (ranked.length >= 2 && ranked[0].total > ranked[1].total * 1.5) {
    showHegemonyNotif(ranked[0].name);
  }
}

function showHegemonyNotif(name) {
  const el = document.getElementById('hegemony-notif');
  el.textContent = `👑 ${name} 称霸天下！`;
  el.style.display = 'block';
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = 'hegemonyPop 3.5s forwards';
  setTimeout(() => { el.style.display = 'none'; }, 3600);
}

function checkAchievements() {
  ACHIEVEMENTS.forEach(ach => {
    if (G.unlockedAchievements.includes(ach.id)) return;
    if (ach.check()) {
      G.unlockedAchievements.push(ach.id);
      showAchievementNotif(ach);
    }
  });
}

function showAchievementNotif(ach) {
  SFX.achieveChime();
  const container = document.getElementById('achievement-container');
  const notif = document.createElement('div');
  notif.className = 'achievement-notif';
  notif.innerHTML = `<span class="ach-icon">${ach.icon}</span>${ach.name}`;
  container.appendChild(notif);
  setTimeout(() => notif.remove(), 3600);
}

function renderTimeline() {
  const dotsContainer = document.getElementById('timeline-dots');
  if (!dotsContainer) return;
  let html = '';
  let totalEventsAll = 0;
  let completedAll = 0;
  const eraCounts = {};
  for (let era = 1; era <= 4; era++) {
    eraCounts[era] = EVENTS[era].length;
    totalEventsAll += eraCounts[era];
  }
  // Calculate position for each event dot
  let idx = 0;
  for (let era = 1; era <= 4; era++) {
    const events = EVENTS[era];
    events.forEach((ev, ei) => {
      const pct = (idx + 0.5) / totalEventsAll * 100;
      let cls = 'future';
      let tooltipText = ev.title;
      if (era < G.era || (era === G.era && ei < G.eventIdx)) {
        cls = 'completed';
        // Find what choice was made
        const choiceRecord = G.choices.find(c => c.event === ev.id);
        if (choiceRecord) {
          const ch = ev.choices[choiceRecord.choice];
          tooltipText += ' \u2192 ' + (ch ? ch.text.slice(0,15) : '');
        }
      } else if (era === G.era && ei === G.eventIdx) {
        cls = 'current';
      }
      let onclick = '';
      if (cls === 'completed') {
        onclick = ' onclick="event.stopPropagation();showEventReview(\'' + ev.id + '\')"';
      } else if (cls === 'current') {
        onclick = ' onclick="event.stopPropagation();document.getElementById(\'crisis-content\').scrollTop=0"';
      } else {
        onclick = ' onclick="event.stopPropagation();showFutureTeaser()"';
      }
      // Short label for the dot (first 4 chars of title)
      const dotLabel = ev.title.replace(/[【】]/g,'').slice(0,4);
      html += '<div class="timeline-dot '+cls+'" style="left:'+pct+'%"'+onclick+' title="'+ev.title+'"><div class="timeline-tooltip">'+tooltipText+'</div><div class="dot-label">'+dotLabel+'</div></div>';
      idx++;
    });
  }
  dotsContainer.innerHTML = html;

  // Highlight active era segment
  document.querySelectorAll('.timeline-era-seg').forEach(seg => {
    seg.classList.toggle('active-era', +seg.dataset.era === G.era);
  });
}

function initMapTooltip() {
  const svg = document.getElementById('map-svg');
  const tooltip = document.getElementById('map-tooltip');
  if (!svg || !tooltip) return;

  svg.addEventListener('mousemove', function(e) {
    const node = e.target.closest('.region-node');
    if (!node) { tooltip.classList.remove('visible'); return; }

    const regionKey = Object.keys(REGION_META)[Array.from(document.querySelectorAll('.region-node')).indexOf(node)];
    if (!regionKey) return;
    const meta = REGION_META[regionKey];
    const region = G.regions[regionKey];
    if (!meta || !region) return;

    document.getElementById('tt-name').textContent = meta.name;
    document.getElementById('tt-desc').textContent = meta.desc;

    const statsEl = document.getElementById('tt-stats');
    const statDefs = [{k:'prosperity',l:'\u5174',n:'\u7ECF\u6D4E\u7E41\u8363'},{k:'military',l:'\u6B66',n:'\u519B\u4E8B\u529B\u91CF'},{k:'culture',l:'\u6587',n:'\u6587\u5316\u5F71\u54CD'},{k:'trade',l:'\u5546',n:'\u5546\u8D38\u6D3B\u529B'}];
    statsEl.innerHTML = statDefs.map(s =>
      '<div class="tt-stat"><span class="tt-stat-label" title="'+s.n+'">'+s.l+'</span><div class="tt-stat-bar"><div class="tt-stat-fill" style="width:'+region[s.k]*10+'%;background:'+meta.color+';box-shadow:0 0 4px '+meta.color+'"></div></div><span class="tt-stat-val">'+region[s.k]+'</span></div>'
    ).join('');

    // Position tooltip near mouse
    const mapArea = document.getElementById('map-area');
    const rect = mapArea.getBoundingClientRect();
    let x = e.clientX - rect.left + 16;
    let y = e.clientY - rect.top - 10;
    if (x + 220 > rect.width) x = e.clientX - rect.left - 220;
    if (y + 140 > rect.height) y = rect.height - 150;
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
    tooltip.classList.add('visible');
  });

  svg.addEventListener('mouseleave', function() {
    tooltip.classList.remove('visible');
  });
}

function initGameParticles() {
  const container = document.getElementById('game-particles');
  if (!container) return;
  for (let i = 0; i < 25; i++) {
    const p = document.createElement('div');
    p.className = 'game-particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.top = (Math.random() * 100 + 100) + '%';
    p.style.animationDuration = (15 + Math.random() * 25) + 's';
    p.style.animationDelay = (Math.random() * 15) + 's';
    p.style.opacity = (0.1 + Math.random() * 0.2);
    container.appendChild(p);
  }
}

function checkCriticalResources() {
  let p=0,m=0,c=0;
  for (let k in G.regions) {
    const r = G.regions[k];
    p += r.prosperity; m += r.military; c += r.culture;
  }
  // Check if any individual region stat is <= 2
  let anyCritical = false;
  for (let k in G.regions) {
    const r = G.regions[k];
    if (r.prosperity <= 2 || r.military <= 2 || r.culture <= 2 || r.trade <= 2) {
      anyCritical = true; break;
    }
  }
  const riPower = document.getElementById('ri-power');
  const riMilitary = document.getElementById('ri-military');
  const riCulture = document.getElementById('ri-culture');
  const riTrade = document.getElementById('ri-trade');
  if (riPower) riPower.classList.toggle('critical', p <= 25);
  if (riMilitary) riMilitary.classList.toggle('critical', m <= 25);
  if (riCulture) riCulture.classList.toggle('critical', c <= 25);
}

function showHistory() {
  SFX.click();
  document.getElementById('history-modal').classList.add('active');
}

function closeHistory() {
  SFX.click();
  document.getElementById('history-modal').classList.remove('active');
}

function renderAll() {
  renderMap();
  renderTopBar();
  renderPowerRanking();
  renderTimeline();
  checkCriticalResources();
  updateMapEraTint();
  updateMapNodeCritical();
  const newMandate = calculateMandateScore();
  document.getElementById('mandate-val').textContent = newMandate;
  G.mandateScore = newMandate;
}

// ==================== 启动 ====================

// Opening screen animation
function initStartScreen() {
  // Generate particles: 50 gold particles + 8 ember particles
  const particleContainer = document.getElementById('start-particles');
  if (particleContainer) {
    for (let i = 0; i < 50; i++) {
      const p = document.createElement('div');
      p.className = 'start-particle';
      p.style.left = Math.random() * 100 + '%';
      p.style.top = Math.random() * 100 + '%';
      p.style.setProperty('--dx', (Math.random() * 80 - 40) + 'px');
      p.style.setProperty('--dy', (Math.random() * 80 - 40) + 'px');
      p.style.animationDuration = (8 + Math.random() * 12) + 's';
      p.style.animationDelay = (Math.random() * 6) + 's';
      p.style.width = (1.5 + Math.random() * 2) + 'px';
      p.style.height = p.style.width;
      particleContainer.appendChild(p);
    }
    // Ember particles (larger, orange-red, slow rise)
    for (let i = 0; i < 8; i++) {
      const p = document.createElement('div');
      p.className = 'start-particle ember';
      p.style.left = Math.random() * 100 + '%';
      p.style.top = (60 + Math.random() * 40) + '%';
      p.style.setProperty('--dx', (Math.random() * 40 - 20) + 'px');
      p.style.setProperty('--dy', -(80 + Math.random() * 60) + 'px');
      p.style.animationDuration = (12 + Math.random() * 10) + 's';
      p.style.animationDelay = (Math.random() * 8) + 's';
      const size = (3 + Math.random() * 2) + 'px';
      p.style.width = size;
      p.style.height = size;
      particleContainer.appendChild(p);
    }
  }

  // Title animation with shockwave
  const mainTitle = document.getElementById('main-title');
  const mainSubtitle = document.getElementById('main-subtitle');
  if (mainTitle) {
    mainTitle.style.opacity = '0';
    mainTitle.style.letterSpacing = '40px';
    setTimeout(() => {
      mainTitle.classList.add('animate-in');
      // Trigger shockwave when title appears
      setTimeout(() => {
        const sw = document.getElementById('title-shockwave');
        if (sw) sw.classList.add('active');
      }, 600);
    }, 200);
  }
  if (mainSubtitle) {
    mainSubtitle.style.opacity = '0';
    setTimeout(() => {
      mainSubtitle.classList.add('animate-in');
      // Trigger gold line after subtitle appears
      setTimeout(() => {
        const gl = document.getElementById('title-gold-line');
        if (gl) gl.classList.add('expand');
      }, 400);
    }, 1200);
  }

  // Staggered poem lines
  const poemLines = document.querySelectorAll('.poem-line');
  poemLines.forEach((line, i) => {
    const delay = 1800 + i * 700;
    // Last line (gold) has extra delay + mandate shake
    const extra = line.classList.contains('gold-line') ? 500 : 0;
    setTimeout(() => {
      line.classList.add('visible');
      // "天命在手" shake
      if (line.classList.contains('gold-line')) {
        const screen = document.getElementById('start-screen');
        screen.classList.add('mandate-shake');
        setTimeout(() => screen.classList.remove('mandate-shake'), 500);
      }
    }, delay + extra);
  });

  // Show start button after poems
  const startBtn = document.getElementById('start-btn');
  if (startBtn) {
    startBtn.style.opacity = '0';
    startBtn.style.transition = 'opacity 0.8s ease';
    setTimeout(() => { startBtn.style.opacity = '1'; }, 1800 + poemLines.length * 700 + 600);
  }

  // Bind start button click
  if (startBtn) {
    startBtn.addEventListener('click', startGame);
  }

  // Continue button is now dynamically created in makeChoice()

  // Sound state: ON by default each session
  localStorage.removeItem('pivot_muted');
  SFX.muted = false;
  SFX._openingPlayed = false;

  const startScreen = document.getElementById('start-screen');

  // Start ambient + gong on first interaction with start screen
  function _tryStartAmbient() {
    if (!SFX._initialized) SFX.init();
    if (SFX.muted) return; // muted, skip
    if (!SFX._openingPlayed) {
      SFX.openingGong();
      SFX._openingPlayed = true;
    }
    SFX.ambient();
  }

  // First click/touch on start screen triggers ambient
  let _ambientStarted = false;
  const _startAmbient = (e) => {
    // Skip if the click was on the mute button (mute handler handles it)
    if (e.target.closest && e.target.closest('.mute-btn')) return;
    if (_ambientStarted) return;
    _ambientStarted = true;
    _tryStartAmbient();
    startScreen.removeEventListener('click', _startAmbient);
    startScreen.removeEventListener('touchstart', _startAmbient);
  };
  startScreen.addEventListener('click', _startAmbient);
  startScreen.addEventListener('touchstart', _startAmbient, {passive:true});

  // Bind mute buttons
  document.querySelectorAll('.mute-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation(); // Don't bubble to start screen
      // Init audio context on first user gesture
      if (!SFX._initialized) SFX.init();
      SFX.toggleMute();
      if (!SFX.muted) {
        // Unmuting: play confirmation sound + start ambient if not yet playing
        SFX.click();
        if (!_ambientStarted) {
          _ambientStarted = true;
          if (!SFX._openingPlayed) {
            SFX.openingGong();
            SFX._openingPlayed = true;
          }
          SFX.ambient();
          startScreen.removeEventListener('click', _startAmbient);
          startScreen.removeEventListener('touchstart', _startAmbient);
        }
      }
    });
  });
}

function startGame() {
  // Init audio on first user interaction and play effects
  if (!SFX._initialized) SFX.init();
  // If opening gong hasn't played yet (user clicked start directly), play it now
  if (!SFX._openingPlayed) {
    SFX.openingGong();
    SFX._openingPlayed = true;
  }
  SFX.gameStartChord();
  SFX.fadeOutAmbient(1.5);

  document.getElementById('start-screen').style.display = 'none';
  document.getElementById('game').classList.add('active');
  initRegions();
  G.turn = 1;
  G.era = 1;
  G.eventIdx = 0;
  G.log = [];
  G.choices = [];
  G._choosing = false;
  G._inStrategicPhase = false;
  G.unlockedAchievements = [];
  // Snapshot for era 1
  G.eraStartSnapshot = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    G.eraStartSnapshot[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }
  // Calculate initial mandate score from region stats (not 0!)
  G.mandateScore = calculateMandateScore();
  renderAll();
  initMapTooltip();
  initGameParticles();
  addLog('\u5929\u547D\u521D\u5F00\uFF0C\u7ECF\u7565\u5929\u4E0B');

  setTimeout(() => showEvent(), 500);
}

// ==================== 移动端适配 ====================

const isMobile = () => window.innerWidth <= 768;

function setupMapPinchZoom() {
  const svg = document.getElementById('map-svg');
  if (!svg) return;
  let scale = 1, originX = 300, originY = 225;
  let startDist = 0, startScale = 1;
  let lastPanX = 0, lastPanY = 0;
  let isPanning = false;

  svg.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      startDist = getTouchDist(e.touches);
      startScale = scale;
    } else if (e.touches.length === 1 && scale > 1) {
      lastPanX = e.touches[0].clientX;
      lastPanY = e.touches[0].clientY;
      isPanning = true;
    }
  }, { passive: false });

  svg.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const dist = getTouchDist(e.touches);
      scale = Math.min(3, Math.max(1, startScale * (dist / startDist)));
      applyMapTransform(svg, scale, originX, originY);
    } else if (e.touches.length === 1 && isPanning && scale > 1) {
      const dx = e.touches[0].clientX - lastPanX;
      const dy = e.touches[0].clientY - lastPanY;
      lastPanX = e.touches[0].clientX;
      lastPanY = e.touches[0].clientY;
      originX -= dx / scale;
      originY -= dy / scale;
      originX = Math.max(0, Math.min(600, originX));
      originY = Math.max(0, Math.min(450, originY));
      applyMapTransform(svg, scale, originX, originY);
    }
  }, { passive: false });

  svg.addEventListener('touchend', (e) => {
    if (e.touches.length < 2) isPanning = false;
    if (scale <= 1) { scale = 1; originX = 300; originY = 225; applyMapTransform(svg, 1, 300, 225); }
  }, { passive: true });

  let lastTap = 0;
  svg.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTap < 300 && e.changedTouches.length === 1) {
      scale = 1; originX = 300; originY = 225;
      svg.style.transition = 'transform 0.3s';
      applyMapTransform(svg, 1, 300, 225);
      setTimeout(() => { svg.style.transition = ''; }, 300);
    }
    lastTap = now;
  }, { passive: true });
}

function getTouchDist(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

function applyMapTransform(svg, scale, ox, oy) {
  if (scale <= 1) { svg.removeAttribute('style'); return; }
  const w = 600 / scale, h = 450 / scale;
  const vx = Math.max(0, Math.min(600 - w, ox - w / 2));
  const vy = Math.max(0, Math.min(450 - h, oy - h / 2));
  svg.setAttribute('viewBox', vx + ' ' + vy + ' ' + w + ' ' + h);
}

// 覆盖 renderTopBar/renderPowerRanking to also check critical and update timeline
const _origRenderTopBar = renderTopBar;
renderTopBar = function() {
  _origRenderTopBar();
  checkCriticalResources();
};

const _origRenderPowerRanking = renderPowerRanking;
renderPowerRanking = function() {
  _origRenderPowerRanking();
};

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  initStartScreen();
});

// ==================== Tutorial System ====================

const TUTORIAL_STEPS = [
  {icon:'🗺️', text:'这是<b>天下七大空间</b>。每个区域有四项属性：<b>兴</b>（经济）、<b>武</b>（军事）、<b>文</b>（文化）、<b>商</b>（商贸），每项0-10分。<br><br>地图上的数字是区域总实力（满分40），旁边的字表示等级：<b>危·弱·平·盛·极</b>'},
  {icon:'📊', text:'顶栏显示七区汇总和<b>天命值</b>。<br><br><b>兴/武/文/商</b> 是全部区域的总和（满分70）。<br><b>天命</b> = 总实力 + 均衡加成 —— 区域越均衡，天命越高。'},
  {icon:'⚖️', text:'<b>你的目标</b>：让七大空间均衡发展。<br><br>追求<b>多元共生</b>而非一家独大。天命值越高，结局越好。共有8种结局——最佳结局是"天下枢纽"。<br><br>⚠ 任何区域总实力跌至12以下将陷入<b>衰落螺旋</b>！'},
  {icon:'📜', text:'右侧是<b>事件面板</b>。每个事件有三种选择：<br><br>• 悬停选项可<b>预览效果</b><br>• 左侧色带表示风险：🟢稳妥 🟡有风险 🔴高风险<br>• 谋士会给出建议，但各有立场<br><br>你的每个选择都会在区域间产生<b>连锁反应</b>。'},
  {icon:'🏛️', text:'每个纪元有<b>本纪目标</b>，完成目标有助于通往最佳结局。<br><br>点击地图区域可查看详情。点击时间线节点可回顾历史。<br><br><b>好了，开始经略天下吧！</b>'}
];

let _tutorialStep = 0;

function showTutorial() {
  if (localStorage.getItem('pivot_tutorial_done')) return false;
  _tutorialStep = 0;
  document.getElementById('tutorial-overlay').style.display = 'flex';
  renderTutorialStep();
  return true;
}

function renderTutorialStep() {
  const step = TUTORIAL_STEPS[_tutorialStep];
  const text = document.getElementById('tutorial-step-text');
  text.innerHTML = '<span class="tutorial-icon">' + step.icon + '</span>' + step.text;

  let dots = '';
  for (let i = 0; i < TUTORIAL_STEPS.length; i++) {
    dots += '<div class="tutorial-dot' + (i === _tutorialStep ? ' active' : '') + '"></div>';
  }
  document.getElementById('tutorial-progress').innerHTML = dots;
  document.getElementById('tutorial-btn').textContent = _tutorialStep < TUTORIAL_STEPS.length - 1 ? '继续' : '开始游戏';
}

function advanceTutorial() {
  SFX.click();
  _tutorialStep++;
  if (_tutorialStep >= TUTORIAL_STEPS.length) {
    document.getElementById('tutorial-overlay').style.display = 'none';
    localStorage.setItem('pivot_tutorial_done', '1');
    return;
  }
  renderTutorialStep();
}

// 覆盖原始的 startGame 以在启动时初始化
const _origStartGame = startGame;
startGame = function() {
  _origStartGame();
  if (isMobile()) {
    setupMapPinchZoom();
    initMobileTabs();
  }
  // Show tutorial for first-time players (after a short delay so game UI is visible)
  setTimeout(() => { showTutorial(); }, 600);
};

// ==================== Narrative Callback System ====================

function processNarrative(text) {
  // Parse {if:eventId:choiceIdx:text} templates
  return text.replace(/\{if:(\w+):(\d+):([^}]+)\}/g, (match, eventId, choiceIdx, narrative) => {
    const record = G.choices.find(c => c.event === eventId);
    if (record && record.choice === parseInt(choiceIdx)) {
      return narrative;
    }
    return '';
  });
}

// ==================== Random Events System ====================

function tryRandomEvent() {
  if (typeof RANDOM_EVENTS === 'undefined') return null;
  if (Math.random() > 0.3) return null; // 30% chance
  const eraEvents = RANDOM_EVENTS[G.era];
  if (!eraEvents || eraEvents.length === 0) return null;
  const ev = eraEvents[Math.floor(Math.random() * eraEvents.length)];
  return ev;
}

function showRandomEvent(ev, callback) {
  const content = document.getElementById('crisis-content');
  const panel = document.getElementById('crisis-panel');
  const _reHadTab = panel.classList.contains('tab-active');
  panel.className = '';
  panel.id = 'crisis-panel';
  if (_reHadTab) panel.classList.add('tab-active');

  // Apply effects
  const effectTags = [];
  for (let region in ev.effects) {
    const eff = ev.effects[region];
    const r = G.regions[region];
    if (!r) continue;
    if (eff.p) { const b=r.prosperity; r.prosperity=clamp(r.prosperity+eff.p,0,10); const a=r.prosperity-b; if(a!==0) effectTags.push({region:REGION_META[region].name,stat:'兴',val:a}); }
    if (eff.m) { const b=r.military; r.military=clamp(r.military+eff.m,0,10); const a=r.military-b; if(a!==0) effectTags.push({region:REGION_META[region].name,stat:'武',val:a}); }
    if (eff.c) { const b=r.culture; r.culture=clamp(r.culture+eff.c,0,10); const a=r.culture-b; if(a!==0) effectTags.push({region:REGION_META[region].name,stat:'文',val:a}); }
    if (eff.t) { const b=r.trade; r.trade=clamp(r.trade+eff.t,0,10); const a=r.trade-b; if(a!==0) effectTags.push({region:REGION_META[region].name,stat:'商',val:a}); }
  }

  let html = '<div class="random-event-popup">';
  html += '<div class="crisis-tag tag-gov" style="margin:0 auto 10px;">🎲 天命异变</div>';
  html += '<div class="re-title">' + ev.title + '</div>';
  html += '<div class="re-desc">' + ev.desc + '</div>';
  html += '<div class="re-effects">';
  effectTags.forEach(t => {
    const cls = t.val > 0 ? 'positive' : 'negative';
    const sign = t.val > 0 ? '+' : '';
    html += '<span class="effect-tag revealed ' + cls + '">' + t.region + ' ' + t.stat + sign + t.val + '</span>';
  });
  html += '</div>';
  html += '<button class="continue-btn" style="margin-top:14px;" onclick="this.onclick=null;(' + callback.toString() + ')()">' + '继 续' + '</button>';
  html += '</div>';

  content.innerHTML = html;
  content.scrollTop = 0;

  renderMap();
  renderTopBar();
  addLog('天命异变：' + ev.title);
}

// ==================== Event Insights ====================

function getEventInsight(eventId) {
  if (typeof EVENT_INSIGHTS === 'undefined') return '';
  return EVENT_INSIGHTS[eventId] || '';
}

// ==================== Mobile Tab System ====================

let _currentMobileTab = 'event';

function initMobileTabs() {
  if (!isMobile()) return;
  const crisisPanel = document.getElementById('crisis-panel');
  const mapArea = document.getElementById('map-area');
  if (crisisPanel) crisisPanel.classList.add('tab-active');
  if (mapArea) mapArea.classList.remove('tab-active');
  _currentMobileTab = 'event';

  // Setup gestures
  setupSwipeGestures();

  // Setup mobile region tap
  setupMobileRegionTap();
}

function switchMobileTab(tab) {
  _currentMobileTab = tab;
  const crisisPanel = document.getElementById('crisis-panel');
  const mapArea = document.getElementById('map-area');
  const tabs = document.querySelectorAll('.mobile-tab');

  tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));

  if (tab === 'map') {
    mapArea.classList.add('tab-active');
    crisisPanel.classList.remove('tab-active');
  } else {
    crisisPanel.classList.add('tab-active');
    mapArea.classList.remove('tab-active');
    // Clear update indicator
    tabs.forEach(t => { if (t.dataset.tab === 'event') t.classList.remove('has-update'); });
  }

  // Close bottom sheet when switching
  closeMobileSheet();
  SFX.click();
}

function notifyEventTab() {
  if (!isMobile() || _currentMobileTab === 'event') return;
  const tab = document.querySelector('.mobile-tab[data-tab="event"]');
  if (tab) tab.classList.add('has-update');
}

function setupSwipeGestures() {
  const gameBody = document.getElementById('game-body');
  if (!gameBody) return;
  let startX = 0, startY = 0, startTime = 0;

  gameBody.addEventListener('touchstart', e => {
    if (e.touches.length !== 1) return;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startTime = Date.now();
  }, {passive:true});

  gameBody.addEventListener('touchend', e => {
    if (e.changedTouches.length !== 1) return;
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    const dt = Date.now() - startTime;
    if (dt > 400 || Math.abs(dy) > Math.abs(dx) * 0.8) return;
    if (Math.abs(dx) < 60) return;

    if (dx < 0 && _currentMobileTab === 'map') {
      switchMobileTab('event');
    } else if (dx > 0 && _currentMobileTab === 'event') {
      switchMobileTab('map');
    }
  }, {passive:true});
}

function setupMobileRegionTap() {
  const paths = document.querySelectorAll('.region-path');
  paths.forEach(path => {
    path.addEventListener('click', (e) => {
      if (!isMobile()) return;
      e.stopPropagation();
      const regionKey = path.getAttribute('data-region');
      if (regionKey) showMobileSheet(regionKey);
    });
  });

  // Close sheet on tap outside
  document.addEventListener('click', (e) => {
    const sheet = document.getElementById('mobile-region-sheet');
    if (sheet && sheet.classList.contains('visible') && !sheet.contains(e.target) && !e.target.closest('.region-path')) {
      closeMobileSheet();
    }
  });
}

function showMobileSheet(regionKey) {
  const meta = REGION_META[regionKey];
  const region = G.regions[regionKey];
  if (!meta || !region) return;

  const sheet = document.getElementById('mobile-region-sheet');
  document.getElementById('sheet-name').textContent = meta.name;
  document.getElementById('sheet-desc').textContent = meta.desc;

  const statDefs = [{k:'prosperity',l:'兴',n:'经济繁荣'},{k:'military',l:'武',n:'军事力量'},{k:'culture',l:'文',n:'文化影响'},{k:'trade',l:'商',n:'商贸活力'}];
  document.getElementById('sheet-stats').innerHTML = statDefs.map(s =>
    `<div class="sheet-stat"><span class="sheet-stat-label">${s.l}</span><div class="sheet-stat-bar"><div class="sheet-stat-fill" style="width:${region[s.k]*10}%;background:${meta.color}"></div></div><span class="sheet-stat-val">${region[s.k]}</span></div>`
  ).join('');

  const lore = REGION_LORE[regionKey] ? (REGION_LORE[regionKey][G.era] || '') : '';
  document.getElementById('sheet-lore').textContent = lore;

  sheet.classList.add('visible');
  // Force reflow for animation
  void sheet.offsetWidth;
  SFX.click();
}

function closeMobileSheet() {
  const sheet = document.getElementById('mobile-region-sheet');
  if (sheet) sheet.classList.remove('visible');
}

// ==================== Enhanced showEvent with narrative ====================

const _origShowEvent = showEvent;
showEvent = function() {
  _origShowEvent();

  // Apply narrative processing to event description
  const descEl = document.querySelector('#crisis-content .event-desc');
  if (descEl) {
    descEl.innerHTML = processNarrative(descEl.innerHTML);
  }

  // Add world context for transformation events
  const events = EVENTS[G.era];
  if (events && events[G.eventIdx]) {
    const ev = events[G.eventIdx];
    if (ev.isTransformation) {
      const knowledge = ERA_KNOWLEDGE[G.era];
      if (knowledge && knowledge.world && descEl) {
        descEl.innerHTML += '<br><br><em style="color:#8a8a7a;font-size:0.9em;">🌍 ' + knowledge.world + '</em>';
      }
    }
  }

  // Notify mobile event tab
  notifyEventTab();
};

// ==================== Enhanced showStrategicPhase with random events ====================

const _origShowStrategicPhase = showStrategicPhase;
showStrategicPhase = function() {
  // Try random event first
  const randomEv = tryRandomEvent();
  if (randomEv) {
    showRandomEvent(randomEv, function() {
      _origShowStrategicPhase();
    });
    return;
  }
  _origShowStrategicPhase();
};

// ==================== Insight injection (called from _executeChoice) ====================

function _injectEventInsight() {
  const lastChoice = G.choices[G.choices.length - 1];
  if (!lastChoice) return;
  const insight = getEventInsight(lastChoice.event);
  if (!insight) return;
  const resultSection = document.querySelector('.result-section');
  if (!resultSection) return;
  const insightDiv = document.createElement('div');
  insightDiv.className = 'event-insight';
  insightDiv.textContent = insight;
  const continueBtn = resultSection.querySelector('.continue-btn');
  if (continueBtn) {
    resultSection.insertBefore(insightDiv, continueBtn);
  } else {
    resultSection.appendChild(insightDiv);
  }
}

// ==================== Enhanced selectRegion for mobile ====================

const _origSelectRegion = selectRegion;
selectRegion = function(k) {
  if (isMobile()) {
    showMobileSheet(k);
    // Highlight region path
    document.querySelectorAll('.region-path').forEach(p => p.classList.remove('selected'));
    const path = document.querySelector(`[data-region="${k}"]`);
    if (path) path.classList.add('selected');
  } else {
    showRegionDetail(k);
  }
};

// ==================== Fix pulseMapNode for new path-based map ====================

const _origPulseMapNode = pulseMapNode;
pulseMapNode = function(regionKey) {
  const path = document.querySelector(`[data-region="${regionKey}"]`);
  if (path) {
    path.style.transition = 'none';
    path.style.filter = 'brightness(1.8)';
    setTimeout(() => {
      path.style.transition = 'all 0.4s';
      path.style.filter = '';
    }, 400);
  }
};

// ==================== Fix updateMapNodeCritical for new paths ====================

const _origUpdateMapNodeCritical = updateMapNodeCritical;
updateMapNodeCritical = function() {
  const keys = Object.keys(REGION_META);
  keys.forEach(k => {
    const r = G.regions[k];
    const total = r.prosperity + r.military + r.culture + r.trade;
    const path = document.querySelector(`[data-region="${k}"]`);
    if (path) {
      if (total <= 12) {
        path.style.filter = 'url(#statusGlow-weak)';
        path.style.animation = 'nodeCriticalPulse 1.2s ease-in-out infinite';
      } else {
        path.style.animation = '';
      }
    }
  });
};

// ==================== Fix highlightConnection for data attributes ====================

const _origHighlightConnection = highlightConnection;
highlightConnection = function(fromKey, toKey) {
  const lines = document.querySelectorAll('#trade-routes .connection-line');
  lines.forEach(line => {
    const from = line.getAttribute('data-from');
    const to = line.getAttribute('data-to');
    if ((from === fromKey && to === toKey) || (from === toKey && to === fromKey)) {
      line.classList.add('chain-active');
      setTimeout(() => line.classList.remove('chain-active'), 1200);
    }
  });
};

// ================================================================
//  HERO'S JOURNEY SYSTEM
//  Scoring, ranking, streaks, prologue, progress bar, mandate health
// ================================================================

// ==================== Rank Definitions ====================
const HERO_RANKS = [
  {min:0,    title:'草莽布衣'},
  {min:201,  title:'乡野贤士'},
  {min:501,  title:'朝堂谋臣'},
  {min:1001, title:'治世能臣'},
  {min:2001, title:'一代明主'},
  {min:3501, title:'千古一帝'},
  {min:5001, title:'天命之子'}
];

function getHeroRank(score) {
  let rank = HERO_RANKS[0];
  for (let i = HERO_RANKS.length - 1; i >= 0; i--) {
    if (score >= HERO_RANKS[i].min) { rank = HERO_RANKS[i]; break; }
  }
  return rank;
}

// ==================== Total Event Count ====================
function getTotalEventCount() {
  let total = 0;
  for (let era = 1; era <= 4; era++) {
    if (EVENTS[era]) total += EVENTS[era].length;
  }
  return total;
}

function getCompletedEventCount() {
  return G.choices.length;
}

// ==================== Journey Progress Bar ====================
function updateJourneyProgress() {
  const total = getTotalEventCount();
  const completed = getCompletedEventCount();
  const pct = Math.min(100, (completed / total) * 100);
  const fill = document.getElementById('journey-progress-fill');
  const text = document.getElementById('journey-progress-text');
  if (fill) fill.style.width = pct + '%';
  if (text) text.textContent = '\u65C5\u7A0B ' + completed + '/' + total;
}

// ==================== Score Display ====================
function updateScoreDisplay(animate) {
  const el = document.getElementById('score-display');
  if (!el) return;
  if (animate) {
    const oldVal = parseInt(el.textContent) || 0;
    const newVal = G.score;
    const diff = newVal - oldVal;
    if (diff === 0) return;
    let current = oldVal;
    const steps = 15;
    const stepVal = diff / steps;
    let step = 0;
    const timer = setInterval(() => {
      step++;
      current += stepVal;
      el.textContent = Math.round(current);
      if (step >= steps) { clearInterval(timer); el.textContent = newVal; }
    }, 30);
  } else {
    el.textContent = G.score;
  }
}

// ==================== Rank Display ====================
function updateRankDisplay() {
  const el = document.getElementById('rank-display');
  if (!el) return;
  const rank = getHeroRank(G.score);
  el.textContent = rank.title;
}

// ==================== Floating Score Animation ====================
function showFloatingScore(amount, anchorEl) {
  if (amount === 0) return;
  const el = document.createElement('div');
  el.className = 'floating-score ' + (amount > 0 ? 'gain' : 'loss');
  el.textContent = (amount > 0 ? '+' : '') + amount;

  // Position near the score display in top bar
  const scoreEl = document.getElementById('score-display');
  if (scoreEl) {
    const rect = scoreEl.getBoundingClientRect();
    el.style.left = rect.left + 'px';
    el.style.top = (rect.bottom + 4) + 'px';
  } else {
    el.style.left = '50%';
    el.style.top = '80px';
  }
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1600);
}

// ==================== Streak Badge ====================
function showStreakBadge(streak, multiplier) {
  const el = document.createElement('div');
  el.className = 'streak-badge';
  if (streak >= 5) {
    el.textContent = '\u5929\u547D\u5E87\u62A4 \u00D7' + streak + ' \u2014 \u5F97\u5206\u00D73';
  } else {
    el.textContent = '\u8FDE\u80DC\u00D7' + streak + ' \u2014 \u5F97\u5206\u00D7' + multiplier;
  }
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3100);
}

// ==================== Rank Up Notification ====================
function showRankUpNotification(oldTitle, newTitle) {
  const el = document.createElement('div');
  el.className = 'rankup-notif';
  el.innerHTML = '<div class="ru-label">\u79F0\u53F7\u63D0\u5347\uFF01</div>'
    + '<div class="ru-old">' + oldTitle + '</div>'
    + '<div class="ru-arrow">\u2193</div>'
    + '<div class="ru-title">' + newTitle + '</div>';
  document.body.appendChild(el);
  SFX.eraGong && SFX.eraGong();
  setTimeout(() => el.remove(), 4200);
}

// ==================== Score Milestone ====================
let _lastMilestone = 0;
function checkScoreMilestone() {
  const milestone = Math.floor(G.score / 500) * 500;
  if (milestone > _lastMilestone && milestone > 0) {
    _lastMilestone = milestone;
    const el = document.createElement('div');
    el.className = 'score-milestone';
    el.textContent = '\u2605 ' + milestone + ' \u5206\u7A81\u7834\uFF01';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2600);
  }
}

// ==================== Mandate Health Bar ====================
let _mandateWarnShown = {};

function updateMandateHealthVisual(score) {
  const container = document.getElementById('mandate-display');
  if (!container) return;
  container.classList.remove('mandate-high','mandate-ok','mandate-warn','mandate-danger');

  // Remove existing screen glows
  const oldGlow = document.getElementById('screen-glow');
  if (oldGlow) { oldGlow.style.display = 'none'; oldGlow.className = ''; }

  if (score > 200) {
    container.classList.add('mandate-high');
    if (oldGlow) { oldGlow.style.display = 'block'; oldGlow.className = 'screen-golden-glow'; }
  } else if (score > 150) {
    container.classList.add('mandate-ok');
  } else if (score >= 100) {
    // normal, no special class needed
  } else if (score >= 50) {
    container.classList.add('mandate-warn');
    if (!_mandateWarnShown['warn100']) {
      _mandateWarnShown['warn100'] = true;
      showMandateWarning('\u26A0\uFE0F', '\u5929\u547D\u5C06\u5C3D\uFF01');
    }
  } else if (score > 0) {
    container.classList.add('mandate-danger');
    if (oldGlow) { oldGlow.style.display = 'block'; oldGlow.className = 'screen-danger-glow'; }
    if (!_mandateWarnShown['warn50']) {
      _mandateWarnShown['warn50'] = true;
      showMandateWarning('\u2620\uFE0F', '\u5929\u547D\u5371\u6025\uFF01\u6587\u660E\u5C06\u706D\uFF01');
    }
  } else {
    // mandate 0 or below — game over (but not during initial render!)
    container.classList.add('mandate-danger');
    if (G._totalEventsCompleted > 0) {
      triggerGameOver();
    }
  }
}

function showMandateWarning(icon, text) {
  const el = document.createElement('div');
  el.className = 'mandate-warning';
  el.innerHTML = '<div class="mw-icon">' + icon + '</div><div class="mw-text">' + text + '</div>';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ==================== Game Over ====================
function triggerGameOver() {
  const overlay = document.getElementById('gameover-overlay');
  if (!overlay) return;
  const scoreEl = document.getElementById('gameover-score');
  if (scoreEl) scoreEl.textContent = '\u6700\u7EC8\u5F97\u5206\uFF1A' + G.score;
  document.getElementById('game').classList.remove('active');
  overlay.classList.add('active');
}

// ==================== Scoring Calculation ====================
function calculateEventScore(effectTags, chains) {
  let baseScore = 0;
  let posCount = 0, negCount = 0;

  effectTags.forEach(t => {
    if (t.val > 0) {
      baseScore += t.val * 20;
      posCount++;
    } else {
      baseScore += t.val * 15; // negative * 15 = loses points
      negCount++;
    }
  });

  // Perfect decision bonus (all positive)
  let perfectBonus = 0;
  if (posCount > 0 && negCount === 0) {
    perfectBonus = 50;
  }

  // High risk success bonus
  let riskBonus = 0;
  if (posCount > negCount && negCount > 0) {
    riskBonus = 30;
  }

  // Chain reaction bonus
  let chainBonus = 0;
  if (chains && chains.length > 0) {
    chains.forEach(ch => {
      // Each positive chain reaction = +25
      chainBonus += 25;
    });
  }

  let rawScore = baseScore + perfectBonus + riskBonus + chainBonus;

  // Streak multiplier
  let multiplier = 1;
  const isPositive = rawScore > 0;
  if (isPositive) {
    G._streak = (G._streak || 0) + 1;
  } else {
    if (G._streak >= 2) {
      // Show streak broken message
      showStreakBroken();
    }
    G._streak = 0;
  }

  if (G._streak >= 5) multiplier = 3;
  else if (G._streak >= 3) multiplier = 2;
  else if (G._streak >= 2) multiplier = 1.5;

  const finalScore = Math.round(rawScore * multiplier);

  return {
    baseScore: rawScore,
    multiplier: multiplier,
    finalScore: finalScore,
    posCount: posCount,
    negCount: negCount,
    perfectBonus: perfectBonus > 0,
    riskBonus: riskBonus > 0,
    chainBonus: chainBonus,
    streak: G._streak,
    isPositive: isPositive
  };
}

function showStreakBroken() {
  const el = document.createElement('div');
  el.className = 'streak-badge';
  el.style.borderColor = '#c56b6b';
  el.style.color = '#c56b6b';
  el.textContent = '\u8FDE\u80DC\u4E2D\u65AD';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2500);
}

// ==================== Prologue System ====================
function showPrologue() {
  const overlay = document.getElementById('prologue-overlay');
  if (!overlay) return;
  overlay.style.display = 'flex';

  // Staggered reveal
  const book = document.getElementById('prologue-book');
  const divider = document.getElementById('prologue-divider');
  const role = document.getElementById('prologue-role');
  const howto = document.getElementById('prologue-howto');
  const cta = document.getElementById('prologue-cta');

  setTimeout(() => book && book.classList.add('visible'), 500);
  setTimeout(() => divider && divider.classList.add('expand'), 1500);
  setTimeout(() => role && role.classList.add('visible'), 2000);
  setTimeout(() => howto && howto.classList.add('visible'), 3200);
  setTimeout(() => {
    if (cta) { cta.classList.add('visible'); cta.classList.add('pulse'); }
  }, 4200);
}

function closePrologueAndStart() {
  const overlay = document.getElementById('prologue-overlay');
  if (overlay) {
    overlay.style.transition = 'opacity 0.6s';
    overlay.style.opacity = '0';
    setTimeout(() => { overlay.style.display = 'none'; }, 600);
  }
  // The actual game start is handled by startGame which was already called
}

// ==================== Hook into startGame ====================
const _heroStartGame = startGame;
startGame = function() {
  // Initialize hero's journey state
  G.score = 0;
  G._streak = 0;
  G._totalEventsCompleted = 0;
  _lastMilestone = 0;
  _mandateWarnShown = {};

  _heroStartGame();

  // Update displays
  updateScoreDisplay(false);
  updateRankDisplay();
  updateJourneyProgress();

  // Show prologue after a brief delay (game UI loads first)
  setTimeout(() => showPrologue(), 800);
};

// ==================== Hook into _executeChoice for scoring ====================
const _origExecuteChoice = _executeChoice;
_executeChoice = function(idx, ev, choice) {
  // Snapshot before execution to compute our own effect tags
  const beforeStats = {};
  for (let k in G.regions) {
    const r = G.regions[k];
    beforeStats[k] = {prosperity:r.prosperity, military:r.military, culture:r.culture, trade:r.trade};
  }

  // Call original
  _origExecuteChoice(idx, ev, choice);

  // Compute effect tags from the before/after difference
  const effectTags = [];
  for (let k in G.regions) {
    const r = G.regions[k];
    const b = beforeStats[k];
    if (!b) continue;
    const dp = r.prosperity - b.prosperity;
    const dm = r.military - b.military;
    const dc = r.culture - b.culture;
    const dt = r.trade - b.trade;
    if (dp !== 0) effectTags.push({region:REGION_META[k].name, regionKey:k, stat:'\u5174', val:dp});
    if (dm !== 0) effectTags.push({region:REGION_META[k].name, regionKey:k, stat:'\u6B66', val:dm});
    if (dc !== 0) effectTags.push({region:REGION_META[k].name, regionKey:k, stat:'\u6587', val:dc});
    if (dt !== 0) effectTags.push({region:REGION_META[k].name, regionKey:k, stat:'\u5546', val:dt});
  }

  // Get chain reactions (already applied, just count them)
  const chains = []; // We approximate — chains were already applied

  // Calculate score
  const scoreResult = calculateEventScore(effectTags, chains);
  const oldScore = G.score;
  G.score = Math.max(0, G.score + scoreResult.finalScore);
  G._totalEventsCompleted = getCompletedEventCount();

  // Check rank change
  const oldRank = getHeroRank(oldScore);
  const newRank = getHeroRank(G.score);
  if (newRank.title !== oldRank.title) {
    setTimeout(() => showRankUpNotification(oldRank.title, newRank.title), 800);
  }

  // Show floating score
  showFloatingScore(scoreResult.finalScore);

  // Show streak badge (if streak >= 2)
  if (scoreResult.streak >= 2 && scoreResult.isPositive) {
    setTimeout(() => showStreakBadge(scoreResult.streak, scoreResult.multiplier), 400);
  }

  // Inject score display into the result panel
  injectEventScoreDisplay(scoreResult);

  // Update displays
  updateScoreDisplay(true);
  updateRankDisplay();
  updateJourneyProgress();
  checkScoreMilestone();

  // Update mandate health visual
  setTimeout(() => updateMandateHealthVisual(G.mandateScore), 600);
};

// ==================== Inject Score Display Into Result Panel ====================
function injectEventScoreDisplay(scoreResult) {
  const resultSection = document.querySelector('.result-section');
  if (!resultSection) return;

  // Create score display elements
  const scoreDiv = document.createElement('div');
  const sign = scoreResult.finalScore >= 0 ? '+' : '';
  const cls = scoreResult.finalScore >= 0 ? 'positive' : 'negative';
  scoreDiv.className = 'event-score-display ' + cls;
  scoreDiv.textContent = sign + scoreResult.finalScore + ' \u5206';

  // Insert after verdict
  const verdict = resultSection.querySelector('.result-verdict');
  if (verdict && verdict.nextSibling) {
    resultSection.insertBefore(scoreDiv, verdict.nextSibling);
  } else {
    resultSection.insertBefore(scoreDiv, resultSection.firstChild.nextSibling || resultSection.firstChild);
  }

  // Perfect decision indicator
  if (scoreResult.perfectBonus) {
    const perfectEl = document.createElement('div');
    perfectEl.className = 'event-perfect';
    perfectEl.textContent = '\uD83C\uDF89 \u5B8C\u7F8E\u51B3\u7B56\uFF01';
    scoreDiv.after(perfectEl);
  }

  // Streak display
  if (scoreResult.streak >= 2 && scoreResult.isPositive) {
    const streakEl = document.createElement('div');
    streakEl.className = 'event-streak-display';
    let streakText = '';
    if (scoreResult.streak >= 5) streakText = '\uD83D\uDD25 \u5929\u547D\u5E87\u62A4 \u00D7' + scoreResult.streak + ' \u2014 \u5F97\u5206\u00D73';
    else streakText = '\uD83D\uDD25 \u8FDE\u80DC \u00D7' + scoreResult.streak + ' \u2014 \u5F97\u5206\u00D7' + scoreResult.multiplier;
    streakEl.textContent = streakText;
    const afterEl = resultSection.querySelector('.event-perfect') || scoreDiv;
    afterEl.after(streakEl);
  }
}

// ==================== Hook into renderTopBar for mandate health ====================
const _heroRenderTopBar = renderTopBar;
renderTopBar = function() {
  _heroRenderTopBar();
  // Update mandate health visual whenever top bar refreshes
  updateMandateHealthVisual(G.mandateScore);
  updateJourneyProgress();
};

// ==================== Hook into nextEra for era score summary ====================
const _origNextEra = nextEra;
nextEra = function() {
  // Show era score in the transition
  const eraScore = G.score;
  _origNextEra();

  // After era transition starts, inject score info
  setTimeout(() => {
    const summary = document.getElementById('era-trans-summary');
    if (summary && summary.textContent) {
      summary.textContent += '  |  \u5F53\u524D\u5F97\u5206\uFF1A' + eraScore;
    }
  }, 600);
};

// ==================== Hook into showEnding for final score ====================
const _heroShowEnding = showEnding;
showEnding = function(endingKey) {
  _heroShowEnding(endingKey);

  // Enhance ending with hero score
  const endingScoreEl = document.getElementById('ending-score');
  if (endingScoreEl) {
    const origText = endingScoreEl.textContent;
    setTimeout(() => {
      const rank = getHeroRank(G.score);
      endingScoreEl.textContent = origText + '  |  \u82F1\u96C4\u5F97\u5206\uFF1A' + G.score + '  |  \u79F0\u53F7\uFF1A' + rank.title;
    }, 4000);
  }
};

// ==================== Hook into animateMandateScore for health check ====================
const _heroAnimateMandate = animateMandateScore;
animateMandateScore = function(newScore) {
  _heroAnimateMandate(newScore);
  // Delayed check for game over (after animation completes)
  setTimeout(() => {
    updateMandateHealthVisual(G.mandateScore);
  }, 1000);
};

// ==================== Save/Load support for hero fields ====================
const _origSaveGame = typeof saveGame === 'function' ? saveGame : null;
if (_origSaveGame) {
  saveGame = function() {
    // Ensure hero fields are part of G before saving
    _origSaveGame();
  };
}

const _origLoadGame = typeof loadGame === 'function' ? loadGame : null;
if (_origLoadGame) {
  loadGame = function() {
    _origLoadGame();
    // Restore hero displays after load
    if (typeof G.score === 'undefined') G.score = 0;
    if (typeof G._streak === 'undefined') G._streak = 0;
    _lastMilestone = Math.floor(G.score / 500) * 500;
    updateScoreDisplay(false);
    updateRankDisplay();
    updateJourneyProgress();
    updateMandateHealthVisual(G.mandateScore);
  };
}
</script>
</body>
</html>
